<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SwimLabs Announcer</title>
  <style>
    :root{
      --bg:#070b14;
      --cardA:rgba(255,255,255,.06);
      --cardB:rgba(255,255,255,.03);
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --btn:#1f2a44;
      --btn2:#2a3a63;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(255,255,255,.06);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #0e1b3a 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    .wrap{ max-width: 1250px; margin: 0 auto; }
    .topbar{ display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap; padding-bottom: 4px; }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:14px; }
    .tiny{ font-size:12px; }
    .right{ margin-left:auto; }
    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin-top:14px;
      box-shadow: 0 12px 34px rgba(0,0,0,.30);
      backdrop-filter: blur(8px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    button{
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    button:hover{ filter: brightness(1.08); }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(34,197,94,.45); }
    button.secondary{ border-color: rgba(245,158,11,.35); }
    button.danger{ border-color: rgba(239,68,68,.35); }

    button.tab{ padding:9px 12px; border-radius:999px; background: transparent; border-color: transparent; }
    button.tab.active{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.14);
      outline: 2px solid rgba(255,255,255,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      line-height: 1.2;
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); font-weight:900; }
    .ok{ color: var(--good); font-weight:900; }
    .warn{ color: var(--warn); font-weight:900; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 520px 1fr; } }

    .blocks{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .blocks button{ min-width: 120px; }
    .blocks button.active{
      outline:2px solid rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.28);
      filter: brightness(1.10);
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size:14px;
      line-height: 1.4;
    }

    /* readable black inputs + dropdowns */
    select, input[type="text"], input[type="password"]{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: #000;
      color: #fff;
      font-weight:900;
      outline: none;
      cursor:pointer;
    }
    input[type="text"], input[type="password"]{
      cursor:text;
      font-weight:800;
    }
    input[type="text"]:focus, input[type="password"]:focus{
      border-color: #04D9FF;
      box-shadow: 0 0 0 3px rgba(4,217,255,.15);
    }
    select option{
      background:#000;
      color:#fff;
    }

    /* Search bar */
    .searchWrap{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .searchInput{
      width: 280px;
      padding: 9px 34px 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.75);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      outline: none;
      transition: all .15s ease;
    }
    .searchInput:focus{
      border-color: #04D9FF;
      box-shadow: 0 0 0 3px rgba(4,217,255,.15);
      background: #000;
    }
    .searchInput::placeholder{
      color: rgba(159,176,208,.6);
      font-weight: 600;
    }
    .searchClear{
      position: absolute;
      right: 8px;
      padding: 4px 6px;
      background: transparent;
      border: none;
      color: rgba(159,176,208,.8);
      font-size: 16px;
      cursor: pointer;
      min-height: auto;
      line-height: 1;
      border-radius: 6px;
      transition: all .12s ease;
    }
    .searchClear:hover{
      color: #04D9FF;
      background: rgba(4,217,255,.1);
    }
    .searchClear:active{
      transform: scale(0.95);
    }
    .searchClear.hidden{
      display: none;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    thead th{
      position: sticky;
      top: 0;
      background: rgba(10, 16, 34, .92);
      backdrop-filter: blur(8px);
      z-index: 5;
      border-bottom: 1px solid var(--line2);
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align: top;
      font-size:14px;
    }
    th{ color:var(--muted); font-weight:900; font-size:12px; text-transform: uppercase; letter-spacing: .5px; }
    tbody tr:hover{ background: rgba(255,255,255,.035); }

    /* Program type color coding */
    tbody tr.program-group{ background: rgba(34,197,94,0.08); }
    tbody tr.program-group:hover{ background: rgba(34,197,94,0.14); }

    tbody tr.program-semi-private{ background: rgba(59,130,246,0.08); }
    tbody tr.program-semi-private:hover{ background: rgba(59,130,246,0.14); }

    tbody tr.program-private{ background: rgba(168,85,247,0.08); }
    tbody tr.program-private:hover{ background: rgba(168,85,247,0.14); }

    tbody tr.program-parent-tot{ background: rgba(249,115,22,0.08); }
    tbody tr.program-parent-tot:hover{ background: rgba(249,115,22,0.14); }

    tbody tr.program-trial{ background: rgba(234,179,8,0.08); }
    tbody tr.program-trial:hover{ background: rgba(234,179,8,0.14); }

    .zone{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.04);
      font-size:13px;
      font-weight:900;
      white-space: nowrap;
      cursor: pointer;
      user-select:none;
    }
    .zone.locked{ cursor: not-allowed; opacity:.85; }

    .hidden{ display:none; }

    .level{ font-weight:900; color: rgba(232,238,252,.95); line-height: 1.2; }
    .nowrap{ white-space: nowrap; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      margin-left:8px;
      vertical-align: middle;
    }
    .badge.addon{ border-color: rgba(245,158,11,.40); }
    .badge.over{ border-color: rgba(34,197,94,.35); }

    /* Attendance buttons */
    .attWrap{ display:flex; gap:6px; align-items:center; }
    .attBtn{
      padding:7px 9px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .attBtn.here.active{ border-color: rgba(34,197,94,.5); background: rgba(34,197,94,.12); }
    .attBtn.absent.active{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.12); }
    .attBtn.clear.active{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.08); }

    /* Flags */
    .flags{ display:flex; gap:8px; margin-top:6px; align-items:center; flex-wrap:wrap; }
    .flag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:26px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size:16px;
      opacity:.35;
      transition: filter .12s ease, opacity .12s ease, transform .05s ease;
    }
    .flag:hover{ filter: brightness(1.15); }
    .flag:active{ transform: translateY(1px); }
    .flag.on{ opacity:1; border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .flagHelp{ font-size:12px; color: rgba(159,176,208,.9); margin-left:8px; }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(20,26,50,.92), rgba(10,12,24,.92));
      border:1px solid var(--line2);
      border-radius:18px;
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .modal h3{ margin:4px 0 10px; font-size:16px; }
    .modal .grid2{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width: 640px){ .modal .grid2{ grid-template-columns: 1fr 1fr; } }
    .field label{
      display:block;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .field .hint{
      margin-top:6px;
      font-size:12px;
      color: rgba(159,176,208,.85);
      line-height:1.35;
    }
    .modalFooter{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    /* TABLET & MOBILE OPTIMIZATION */
    @media (max-width: 900px) {
      body { padding: 10px; }
      .wrap { max-width: 100%; }
      .card { padding: 12px; }
      h1 { font-size: 20px; }
      button { min-height: 48px; padding: 12px 16px; font-size: 15px; }
      th, td { padding: 10px 8px; font-size: 14px; }
      .level { font-size: 15px; font-weight: 700; }
      .blocks button { min-height: 48px; padding: 10px 14px; font-size: 15px; }
    }

    @media (max-width: 600px) {
      body { padding: 6px; }
      .card { padding: 10px; border-radius: 12px; }
      h1 { font-size: 18px; }
      button { min-height: 44px; padding: 10px 14px; font-size: 14px; }
      th, td { padding: 8px 6px; font-size: 13px; }
      .level { font-size: 14px; }
      .blocks button { min-height: 44px; padding: 8px 12px; font-size: 14px; }
      .pill { padding: 6px 8px; font-size: 12px; }
      .attBtn { padding: 6px 10px; font-size: 13px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>SwimLabs Announcer</h1>
      <div class="muted" id="status">Loading‚Ä¶</div>
    </div>

    <div class="right row">
      <select id="locationSelect" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
        <option value="">Loading locations...</option>
      </select>
      <select id="viewSelect" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); min-width: 150px;">
        <option value="roster">Roster</option>
        <option value="lifeguard">Lifeguard üèä</option>
        <option value="announcements">Announcements</option>
        <option value="virtualDesk">Virtual Desk</option>
        <option value="admin">‚öôÔ∏è Admin</option>
      </select>
      <span class="pill">Device: <strong id="deviceModeLabel">Deck</strong></span>
      <button id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <span class="pill">Last: <strong id="lastAt">None</strong></span>
      <span class="pill" id="nextAnnouncementPill">Next: <strong id="nextAnnouncementTimer" style="color:#04D9FF;">‚Äî</strong></span>
    </div>
  </div>

  <div id="panelRoster">
    <div class="card">
      <div class="row">
        <button class="primary" id="importBtn">Import Today (PDF)</button>
        <button class="primary" id="uploadHtmlBtn">Upload HTML</button>
        <input type="file" id="htmlFileInput" accept=".html" style="display: none;">
        <button class="secondary" id="exportJsonBtn" title="Download a JSON backup of the active roster">Export JSON</button>
        <button class="secondary" id="importJsonBtn" title="Upload a JSON export to restore a roster">Import JSON</button>
        <input type="file" id="jsonFileInput" accept="application/json,.json" style="display:none;">

        <div class="spacer"></div>
        <span class="pill tiny">Auto announcement runs about 3 minutes before each time block.</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Time Blocks <span class="muted">(Date:</span> <input id="rosterDate" type="date" class="dateInput" /> <button id="setDateBtn" class="miniBtn">Set</button> <span class="muted">)</span> <span id="blockHint" class="muted"></span></div>
        <div class="spacer"></div>
        <div class="pill">Selected: <strong id="selectedBlock">None</strong></div>
      </div>
      <div class="blocks" id="blocks"></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Roster <span id="rosterMeta" class="muted"></span></div>
        <div class="legend" id="tagLegend">
          <span class="legendItem"><span class="flagBadge on">‚≠ê</span><span class="legendText">First time</span></span>
          <span class="legendItem"><span class="flagBadge on">üîÑ</span><span class="legendText">Makeup</span></span>
          <span class="legendItem"><span class="flagBadge on">üìú</span><span class="legendText">Policy</span></span>
          <span class="legendItem"><span class="flagBadge on">üí≥</span><span class="legendText">Balance</span></span>
          <span class="legendItem"><span class="flagBadge on">üß™</span><span class="legendText">Trial</span></span>
        </div>

        <div class="spacer"></div>

        <div class="searchWrap">
          <input type="text" id="rosterSearch" class="searchInput" placeholder="Search roster..." />
          <button class="searchClear hidden" id="searchClear" title="Clear search">‚úï</button>
        </div>

        <button class="secondary" id="addSwimmerBtn">+ Add swimmer</button>
        <span class="pill">Sort</span>
        <select id="sortBy">
          <option value="instructor" selected>Instructor + A-Z</option>
          <option value="name">Swimmer A-Z</option>
        </select>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px;">Attendance</th>
            <th>Swimmer</th>
            <th style="width:110px;">Age</th>
            <th style="width:150px;">Type</th>
            <th style="width:170px;">Level</th>
            <th style="width:170px;">Instructor</th>
            <th style="width:140px;">Zone</th>
            <th style="width:170px;">Action</th>
          </tr>
        </thead>
        <tbody id="roster"></tbody>
      </table>

    </div>
  </div>

  <div id="panelAnnouncements" class="hidden">
    <div class="grid">
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <button class="secondary" id="repeatBtn">Repeat last</button>
          <button class="secondary" id="forceTimeBtn">Force time-block</button>
        </div>

        <textarea id="customText" placeholder="Type an announcement here, then click Speak."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="speakBtn">Speak typed message</button>
          <button class="danger" id="clearBtn">Clear</button>
        </div>

        <div class="card" style="margin-top:12px; background: rgba(255,255,255,.03);">
          <div class="pill" style="margin-bottom:8px;">Last announcement</div>
          <div id="lastText" class="tiny" style="line-height:1.45; color: rgba(232,238,252,.92);">None</div>
        </div>
      </div>

      <div class="card">
        <div class="pill" style="margin-bottom:10px;">Quick presets</div>
        <div class="row">
          <button class="secondary" id="presetFrontDeck">Front desk to deck</button>
          <button class="secondary" id="presetCodeGreen">Code Green</button>
          <button class="secondary" id="presetCodeBrown">Code Brown</button>
        </div>
      </div>
    </div>
  </div>

  <div id="panelVirtualDesk" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">Virtual Desk Dashboard</h2>

      <!-- Quick Stats -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin-bottom:20px;">
        <div class="card" style="background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.2);">
          <div class="tiny" style="color:var(--muted); margin-bottom:4px;">Swimmers Today</div>
          <div style="font-size:28px; font-weight:900; color:#22c55e;" id="adminStatSwimmers">‚Äî</div>
        </div>

        <div class="card" style="background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2);">
          <div class="tiny" style="color:var(--muted); margin-bottom:4px;">Attendance Rate</div>
          <div style="font-size:28px; font-weight:900; color:#3b82f6;" id="adminStatAttendance">‚Äî</div>
        </div>

        <div class="card" style="background: rgba(234,179,8,0.08); border-color: rgba(234,179,8,0.2);">
          <div class="tiny" style="color:var(--muted); margin-bottom:4px;">Trials This Week</div>
          <div style="font-size:28px; font-weight:900; color:#eab308;" id="adminStatTrials">‚Äî</div>
        </div>
      </div>

      <!-- Swimmer Details View -->
      <div class="card" id="swimmerDetailsView">
        <div class="row" style="margin-bottom:12px;">
          <h3 style="margin:0; font-size:18px;">üë• Today's Swimmers - Detailed View</h3>
          <div class="spacer"></div>
          <select id="swimmerSortBy" style="padding:6px 10px; border-radius:8px; font-size:13px; font-weight:600; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
            <option value="name">Sort: Name A-Z</option>
            <option value="time">Sort: Time</option>
            <option value="instructor">Sort: Instructor</option>
            <option value="attendance_rate">Sort: Attendance Rate</option>
            <option value="missed">Sort: Missed Classes</option>
            <option value="balance">Sort: Balance Status</option>
          </select>
          <button id="refreshSwimmers" class="secondary" style="padding:6px 12px; font-size:13px;">üîÑ Refresh</button>
        </div>

        <div id="swimmerDetailsTable"></div>
      </div>

      <!-- Navigation Cards -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:14px; margin-top:20px;">
        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavAbsence">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üìä Absence Tracker</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Track multi-week absences and follow up with families</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavTrials">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üß™ Trial Follow-up</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Manage trial swimmers and conversion tracking</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavHistory">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üìÖ Attendance History</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">View 30-day attendance patterns and reports</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavObservations">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üìù Instructor Observations</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Generate evaluation forms and track progress</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease; background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.3);" id="adminNavClearRoster">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px; color:#ef4444;">üóëÔ∏è Clear Roster</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Remove all uploaded roster data for current location</div>
        </div>
      </div>

      <div class="tiny" style="margin-top:16px; color: rgba(159,176,208,.7);">
        Virtual Desk features are protected by PIN authentication. Session expires after 2 hours.
      </div>
    </div>
  </div>

  <!-- System Admin Panel -->
  <div id="panelAdmin" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">‚öôÔ∏è System Administration</h2>

      <!-- Location Management -->
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üìç Location Management</h3>
        <div id="locationsList" style="margin-bottom:12px;"></div>
        <button id="addLocationBtn" class="secondary">+ Add New Location</button>
      </div>

      <!-- Staff Management -->
      <div class="card">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üë• Staff Management</h3>
        <div id="staffList" style="margin-bottom:12px;"></div>
        <button id="addStaffBtn" class="secondary">+ Add New Staff</button>
      </div>

      <div class="tiny" style="margin-top:16px; color: rgba(159,176,208,.7);">
        System administration features require elevated privileges. Changes affect all locations.
      </div>
    </div>
  </div>
</div>

<!-- PIN Authentication Modal -->
<div class="modalBackdrop" id="pinModal">
  <div class="modal" style="max-width: 420px;">
    <h3>Admin Access</h3>

    <div class="field">
      <label>Enter 4-digit PIN</label>
      <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" style="font-size:24px; text-align:center; letter-spacing:8px;" />
      <div class="hint" id="pinError" style="color:#ef4444; display:none;">Incorrect PIN. Try again.</div>
      <div class="hint" id="pinLockout" style="color:#ef4444; display:none;">Too many attempts. Locked for 2 minutes.</div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="pinCancel">Cancel</button>
      <button class="primary" id="pinSubmit">Unlock</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modalBackdrop" id="settingsModal">
  <div class="modal">
    <h3>Device settings</h3>
    <div class="field">
      <label>Set device mode</label>
      <select id="deviceModeSelect">
        <option value="deck">Deck (tablet)</option>
        <option value="frontdesk">Front Desk (computer)</option>
      </select>
      <div class="hint">Deck requires manager approval to change zones.</div>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="settingsClose">Close</button>
      <button class="primary" id="settingsSave">Save</button>
    </div>
  </div>
</div>

<!-- Add Swimmer Modal -->
<div class="modalBackdrop" id="addModal">
  <div class="modal">
    <h3>Add swimmer (Add-on)</h3>

    <div class="grid2">
      <div class="field">
        <label>Swimmer name</label>
        <input type="text" id="addName" placeholder="First Last" />
      </div>

      <div class="field">
        <label>Age (optional)</label>
        <input type="text" id="addAge" placeholder="Example: 6y 2m" />
      </div>

      <div class="field">
        <label>Class type</label>
        <select id="addProgram">
          <option value="GROUP: Beginner 1">GROUP: Beginner 1</option>
          <option value="GROUP: Beginner 2">GROUP: Beginner 2</option>
          <option value="GROUP: Beginner 3">GROUP: Beginner 3</option>
          <option value="GROUP: Beginner 4">GROUP: Beginner 4</option>
          <option value="GROUP: Intermediate 1">GROUP: Intermediate 1</option>
          <option value="GROUP: Intermediate 2">GROUP: Intermediate 2</option>
          <option value="GROUP: Intermediate 3">GROUP: Intermediate 3</option>
          <option value="GROUP: Advanced 1">GROUP: Advanced 1</option>
          <option value="GROUP: Advanced 2">GROUP: Advanced 2</option>
          <option value="Private">Private</option>
          <option value="Semi-Private">Semi-Private</option>
          <option value="ParentTot">ParentTot</option>
          <option value="Toddler Transition">Toddler Transition</option>
          <option value="Adult">Adult</option>
        </select>
      </div>

      <div class="field">
        <label>Instructor (optional)</label>
        <select id="addInstructor">
          <option value="">(loading...)</option>
        </select>
      </div>

      <div class="field">
        <label>Zone (optional)</label>
        <select id="addZone">
          <option value="">(leave blank)</option>
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field">
        <label>Time block</label>
        <input type="text" id="addTime" disabled />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addCancel">Cancel</button>
      <button class="primary" id="addSave">Add swimmer</button>
    </div>
  </div>
</div>

<!-- Zone Override Modal -->
<div class="modalBackdrop" id="zoneModal">
  <div class="modal">
    <h3>Change zone</h3>

    <div class="row">
      <span class="pill">Swimmer: <strong id="zoneWho">‚Äî</strong></span>
      <div class="spacer"></div>
      <span class="pill">Mode: <strong id="zoneMode">Deck</strong></span>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div class="field">
        <label>New zone</label>
        <select id="zoneSelect">
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field" id="managerCodeField">
        <label>Manager code (required on Deck)</label>
        <input type="password" id="managerCode" placeholder="Enter code" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="zoneCancel">Cancel</button>
      <button class="primary" id="zoneSave">Save zone</button>
    </div>
  </div>
</div>

<!-- Add Location Modal -->
<div class="modalBackdrop" id="addLocationModal">
  <div class="modal">
    <h3>Add New Location</h3>

    <div class="field">
      <label>Location Name *</label>
      <input type="text" id="newLocationName" placeholder="e.g., SwimLabs Westchester" />
    </div>

    <div class="field">
      <label>Short Code</label>
      <input type="text" id="newLocationShortCode" placeholder="e.g., SLW" maxlength="10" />
    </div>

    <div class="field">
      <label>Brand</label>
      <select id="newLocationBrand">
        <option value="swimlabs">SwimLabs</option>
        <option value="safesplash">SafeSplash</option>
      </select>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addLocationCancel">Cancel</button>
      <button class="primary" id="addLocationSave">Add Location</button>
    </div>
  </div>
</div>

<!-- Add Staff Modal -->
<div class="modalBackdrop" id="addStaffModal">
  <div class="modal">
    <h3>Add New Staff Member</h3>

    <div class="grid2">
      <div class="field">
        <label>First Name *</label>
        <input type="text" id="newStaffFirstName" placeholder="First name" />
      </div>

      <div class="field">
        <label>Last Name *</label>
        <input type="text" id="newStaffLastName" placeholder="Last name" />
      </div>

      <div class="field">
        <label>Location *</label>
        <select id="newStaffLocation">
          <option value="New York">New York</option>
          <option value="California">California</option>
          <option value="Texas">Texas</option>
          <option value="Nevada">Nevada</option>
        </select>
      </div>

      <div class="field">
        <label>Phone</label>
        <input type="text" id="newStaffPhone" placeholder="1234567890" />
      </div>

      <div class="field">
        <label>Birthday</label>
        <input type="text" id="newStaffBirthday" placeholder="MM/DD/YY" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addStaffCancel">Cancel</button>
      <button class="primary" id="addStaffSave">Add Staff</button>
    </div>
  </div>
</div>

<!-- Attendance History Modal -->
<div class="modalBackdrop" id="attendanceHistoryModal">
  <div class="modal" style="max-width:700px;">
    <h3 id="attendanceHistoryTitle">Attendance History</h3>

    <div id="attendanceHistoryContent" style="margin-top:12px; max-height:500px; overflow-y:auto;">
      <!-- Content will be populated by JavaScript -->
    </div>

    <div class="modalFooter">
      <button class="secondary" id="attendanceHistoryClose">Close</button>
    </div>
  </div>
</div>

<script>
  let currentBlock = null;
  let zoneTarget = null;
  let deviceMode = localStorage.getItem('deviceMode') || 'deck';
  let activeDateISO = null;
  let blocksList = [];
  let autoTimers = [];
  let currentLocation = null;
  let allLocations = [];
  let searchFilter = '';
  let pendingPinPanel = null; // Track which panel requested PIN auth ('virtualDesk' or 'admin')
  let nextAnnouncementTime = null; // Track next scheduled announcement
  let countdownInterval = null; // Interval for countdown updates

  const el = (id) => document.getElementById(id);

  // Load locations on startup
  async function loadLocations() {
    try {
      const resp = await api('/api/locations');
      allLocations = resp.locations;
      
      const select = el('locationSelect');
      select.innerHTML = '';
      
      allLocations.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = loc.id;
        opt.textContent = loc.name;
        select.appendChild(opt);
      });
      
      // Load saved location or default to first
      const savedLocId = localStorage.getItem('location_id') || allLocations[0]?.id;
      select.value = savedLocId;
      currentLocation = allLocations.find(l => l.id == savedLocId);
      
      // Show/hide announcements tab based on location
      updateAnnouncementsVisibility();
      
    } catch (e) {
      console.error('Failed to load locations:', e);
    }
  }

  function updateAnnouncementsVisibility() {
    const announcementsTab = el('tabAnnouncements');
    const announcementsSection = el('announcements-section');
    
    if (currentLocation && currentLocation.has_announcements) {
      announcementsTab.style.display = '';
      if (announcementsSection) announcementsSection.style.display = '';
    } else {
      announcementsTab.style.display = 'none';
      if (announcementsSection) announcementsSection.style.display = 'none';
      // Switch to Roster tab if on Announcements
      if (announcementsTab.classList.contains('active')) {
        el('tabRoster').click();
      }
    }
  }

  el('locationSelect').addEventListener('change', async (e) => {
    const locId = e.target.value;
    currentLocation = allLocations.find(l => l.id == locId);
    localStorage.setItem('location_id', locId);
    
    try {
      await api('/api/set-location', {
        method: 'POST',
        body: JSON.stringify({ location_id: locId })
      });
      
      updateAnnouncementsVisibility();
      await loadStatus();
      await loadBlocks();
      if (currentBlock) await loadRoster();
      
    } catch (e) {
      alert('Failed to switch location: ' + e.message);
    }
  });

  function escapeHtml(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function fmtTime(time24){
    if(!time24) return '‚Äî';
    const parts = String(time24).split(':');
    const hh = parseInt(parts[0], 10);
    const mm = parseInt(parts[1] || '0', 10);
    const ampm = hh >= 12 ? 'PM' : 'AM';
    const h12 = ((hh + 11) % 12) + 1;
    if(mm === 0) return `${h12} ${ampm}`;
    return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
  }

  function parseTypeLevel(program){
    const p = String(program || '').trim();
    if(!p) return { type: '‚Äî', level: '‚Äî' };
    const up = p.toUpperCase();
    if(up.startsWith('GROUP:')){
      const level = p.split(':').slice(1).join(':').trim();
      return { type: 'Group', level: level || '‚Äî' };
    }
    // Non-group
    return { type: p, level: '‚Äî' };
  }

  function getProgramColorClass(program){
    const p = String(program || '').toUpperCase().trim();
    if(!p) return '';

    // Check for GROUP programs
    if(p.startsWith('GROUP:')) return 'program-group';

    // Check for SEMI-PRIVATE
    if(p.includes('SEMI') && p.includes('PRIVATE')) return 'program-semi-private';
    if(p.includes('SEMI-PRIVATE')) return 'program-semi-private';

    // Check for PRIVATE (but not semi-private)
    if(p.includes('PRIVATE')) return 'program-private';

    // Check for PARENT-TOT
    if(p.includes('PARENT') && p.includes('TOT')) return 'program-parent-tot';
    if(p.includes('PARENTTOT')) return 'program-parent-tot';

    // Check for TRIAL (could be in program name or as a flag indicator)
    if(p.includes('TRIAL')) return 'program-trial';

    return '';
  }

  async function api(path, opts={}){
    const res = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    const data = await res.json().catch(() => ({}));
    if(!res.ok || data.ok === false){
      const details = data && data.details ? ` | ${typeof data.details === 'string' ? data.details : JSON.stringify(data.details)}` : '';
      const msg = (data.error || `Request failed: ${res.status}`) + details;
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(text, kind){
    const s = el('status');
    s.textContent = text;
    s.classList.remove('ok','warn');
    if(kind) s.classList.add(kind);
  }
  function toast(msg){
    const prev = el('status').textContent;
    setStatus(msg, 'ok');
    setTimeout(() => {
      if (el('status').textContent === msg) el('status').textContent = prev;
    }, 1800);
  }


  function showModal(id, on=true){
    el(id).style.display = on ? 'flex' : 'none';
  }

  function syncDeviceUI(){
    el('deviceModeLabel').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('deviceModeSelect').value = deviceMode;
    el('zoneMode').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('managerCodeField').style.display = (deviceMode === 'deck') ? 'block' : 'none';
  }

  function setLastAnnouncementUI(last){
    const at = last?.at ? new Date(last.at) : null;
    el('lastAt').textContent = at ? at.toLocaleTimeString() : 'None';
    el('lastText').textContent = last?.text || 'None';
  }

  function setSelectedBlockUI(){
    el('selectedBlock').textContent = currentBlock ? fmtTime(currentBlock) : 'None';
    [...el('blocks').querySelectorAll('button')].forEach(b => {
      b.classList.toggle('active', b.dataset.time === currentBlock);
    });
    el('addSwimmerBtn').disabled = !currentBlock;
  }

  async function loadStatus(){
    const st = await api('/api/status');

    const activeDate = st.activeDate || st.todayISO;
    const ttsOk = (st.piperBinExists && st.voiceModelExists);
    const ttsMsg = ttsOk ? 'TTS ready' : 'TTS missing (piper/model)';
    const rosterMsg = st.htmlExists ? `Roster loaded (${Math.round((st.htmlSizeBytes||0)/1024)} KB)` : 'No roster uploaded yet';

    setStatus(`${ttsMsg} ‚Ä¢ ${rosterMsg}`, (ttsOk ? 'ok' : 'warn'));

    const di = el('rosterDate');
    if (di && activeDate) di.value = activeDate;

    setLastAnnouncementUI(st.lastAnnouncement);
    el('blockHint').textContent = '';
  }

  async function loadBlocks(){
    const locId = currentLocation?.id || 1;
    const b = await api(`/api/blocks?location_id=${locId}`);
    const wrap = el('blocks');
    wrap.innerHTML = '';

    blocksList = (b.blocks || []);

    blocksList.forEach((t) => {
      const btn = document.createElement('button');
      btn.textContent = fmtTime(t);
      btn.dataset.time = t;
      btn.addEventListener('click', () => {
        currentBlock = t;
        setSelectedBlockUI();
        loadRoster();
      });
      wrap.appendChild(btn);
    });

    if(!currentBlock && (b.blocks || []).length){
      currentBlock = b.blocks[0];
    }

    setSelectedBlockUI();
    if(currentBlock) await loadRoster();
    scheduleAutoAnnouncements();
  }


  function parseBlockDateTime(dateISO, time24){
    if(!dateISO || !time24) return null;
    const [y,m,d] = dateISO.split('-').map(n=>parseInt(n,10));
    const [hh,mm] = String(time24).split(':').map(n=>parseInt(n,10));
    if(!y||!m||!d||Number.isNaN(hh)) return null;
    return new Date(y, (m-1), d, hh, mm||0, 0, 0);
  }

  function scheduleAutoAnnouncements(){
    // clear existing timers
    autoTimers.forEach(id => clearTimeout(id));
    autoTimers = [];

    // Reset next announcement tracking
    nextAnnouncementTime = null;

    if(!activeDateISO || !blocksList.length) {
      stopCountdown();
      return;
    }

    const now = new Date();

    blocksList.forEach((t, idxBlock) => {
      const classAt = parseBlockDateTime(activeDateISO, t);
      if(!classAt) return;

      const announceAt = new Date(classAt.getTime() - 3*60*1000);
      const delay = announceAt.getTime() - now.getTime();
      if(delay <= 0) return; // too late, don't back-announce

      // cap: only schedule within 36 hours to avoid weird multi-day timers
      if(delay > 36*60*60*1000) return;

      const id = setTimeout(async () => {
        try{
          // First block: call-up only. Subsequent blocks: pick-up + call-up.
          const timeLabel = fmtTime(t);
          const text = (idxBlock === 0)
            ? `Attention. ${timeLabel} classes. Instructors, please call up your first swimmer.`
            : `Attention. ${timeLabel} classes. Front desk, please pick up swimmers for this time block. Instructors, please call up your next swimmer.`;

          const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
          setLastAnnouncementUI(resp.lastAnnouncement);

          // After announcement, reschedule to update next timer
          setTimeout(() => scheduleAutoAnnouncements(), 1000);
        }catch(e){
          // don't spam alerts for background timers
          console.error('auto announcement failed', e);
        }
      }, delay);

      autoTimers.push(id);

      // Track the earliest announcement time
      if (!nextAnnouncementTime || announceAt < nextAnnouncementTime) {
        nextAnnouncementTime = announceAt;
      }
    });

    // Start countdown if we have scheduled announcements
    if (nextAnnouncementTime) {
      startCountdown();
    } else {
      stopCountdown();
    }
  }

  function startCountdown() {
    // Clear existing interval
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    // Update immediately
    updateCountdown();

    // Update every second
    countdownInterval = setInterval(updateCountdown, 1000);
  }

  function stopCountdown() {
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }

    // Hide the countdown pill
    el('nextAnnouncementPill').style.display = 'none';
  }

  function updateCountdown() {
    if (!nextAnnouncementTime) {
      stopCountdown();
      return;
    }

    const now = new Date();
    const diff = nextAnnouncementTime - now;

    // If time has passed, hide countdown
    if (diff <= 0) {
      stopCountdown();
      return;
    }

    // Calculate minutes and seconds
    const totalSeconds = Math.floor(diff / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    // Format the countdown
    let display = '';
    if (minutes > 0) {
      display = `${minutes}m ${seconds}s`;
    } else {
      display = `${seconds}s`;
    }

    // Update the display
    el('nextAnnouncementTimer').textContent = display;
    el('nextAnnouncementPill').style.display = '';
  }

  function sortKids(kids){
    const sortBy = el('sortBy').value;
    const key = (s) => String(s || '').toLowerCase();

    const arr = [...kids];
    arr.sort((a,b) => {
      if(sortBy === 'instructor'){
        const ia = key(a.instructor_name);
        const ib = key(b.instructor_name);
        if(ia !== ib) return ia.localeCompare(ib);
        return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
      }
      return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
    });
    return arr;
  }

  function renderAttendance(kid){
    const w = document.createElement('div');
    w.className = 'attWrap';

    const mk = (label, cls, val) => {
      const b = document.createElement('div');
      b.className = `attBtn ${cls}`;
      b.textContent = label;
      b.classList.toggle('active', kid.attendance === val);
      b.addEventListener('click', async () => {
        try{
          // toggle behavior: clicking active sets to null
          const next = (kid.attendance === val) ? null : val;
          await api('/api/attendance', {
            method:'POST',
            body: JSON.stringify({
              start_time: currentBlock,
              swimmer_name: kid.swimmer_name,
              attendance: next,
              device_mode: deviceMode
            })
          });
          kid.attendance = next;
          loadRoster();
        }catch(e){
          alert(e.message);
        }
      });
      return b;
    };

    w.appendChild(mk('Here','here',1));
    w.appendChild(mk('Absent','absent',0));
    w.appendChild(mk('Clear','clear',null));
    return w;
  }

  function renderFlags(kid){
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '6px';
    row.style.alignItems = 'center';

    // Only show ACTIVE flags to save space
    if (kid.flag_new) {
      const emoji = document.createElement('span');
      emoji.textContent = '‚≠ê';
      emoji.title = 'First time (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_new'));
      row.appendChild(emoji);
    }

    if (kid.flag_makeup) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üîÑ';
      emoji.title = 'Makeup (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_makeup'));
      row.appendChild(emoji);
    }

    if (kid.flag_policy) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üìú';
      emoji.title = 'Policy (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_policy'));
      row.appendChild(emoji);
    }

    if (kid.flag_owes) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üí≥';
      emoji.title = 'Balance (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_owes'));
      row.appendChild(emoji);
    }

    if (kid.flag_trial) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üß™';
      emoji.title = 'Trial (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_trial'));
      row.appendChild(emoji);
    }

    // Add edit button
    const editBtn = document.createElement('button');
    editBtn.textContent = '‚úèÔ∏è';
    editBtn.title = 'Edit swimmer';
    editBtn.style.padding = '4px 8px';
    editBtn.style.fontSize = '14px';
    editBtn.style.minHeight = '28px';
    editBtn.style.cursor = 'pointer';
    editBtn.addEventListener('click', () => openEditModal(kid));
    row.appendChild(editBtn);

    return row;
  }

  async function toggleFlag(kid, flagKey) {
    try {
      const flags = {
        flag_new: !!kid.flag_new,
        flag_makeup: !!kid.flag_makeup,
        flag_policy: !!kid.flag_policy,
        flag_owes: !!kid.flag_owes,
        flag_trial: !!kid.flag_trial
      };
      flags[flagKey] = !flags[flagKey];
      
      const resp = await api('/api/update-flags', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name: kid.swimmer_name,
          device_mode: deviceMode,
          flags
        })
      });
      
      kid.flag_new = resp.flags.flag_new;
      kid.flag_makeup = resp.flags.flag_makeup;
      kid.flag_policy = resp.flags.flag_policy;
      kid.flag_owes = resp.flags.flag_owes;
      kid.flag_trial = resp.flags.flag_trial;
      loadRoster();
    } catch(e) {
      alert(e.message);
    }
  }

  function openEditModal(kid) {
    // TODO: Implement edit modal
    alert(`Edit ${kid.swimmer_name}\n\nEdit functionality coming soon!\n\nFor now, you can:\n- Click icons to remove them\n- Use zone button to change zone\n- Use attendance buttons`);
  }

  function renderZoneChip(kid){
    const z = kid.zone ? `Zone ${kid.zone}` : '‚Äî';
    const chip = document.createElement('div');
    chip.className = 'zone' + (deviceMode === 'deck' ? ' locked' : '');
    chip.textContent = z;
    chip.title = (deviceMode === 'deck') ? 'Deck mode: requires manager code' : 'Click to change zone';
    chip.addEventListener('click', () => {
      zoneTarget = kid;
      el('zoneWho').textContent = kid.swimmer_name;
      el('zoneSelect').value = String(kid.zone || 1);
      el('managerCode').value = '';
      syncDeviceUI();
      showModal('zoneModal', true);
    });
    return chip;
  }

  async function loadRoster(){
    if(!currentBlock){
      el('roster').innerHTML = '';
      el('rosterMeta').textContent = '';
      return;
    }

    const locId = currentLocation?.id || 1;
    const data = await api(`/api/blocks/${encodeURIComponent(currentBlock)}?location_id=${locId}`);
    let kids = sortKids(data.kids || []);

    // Apply search filter
    const totalCount = kids.length;
    if (searchFilter.trim()) {
      const query = searchFilter.toLowerCase();
      kids = kids.filter(kid => {
        const name = (kid.swimmer_name || '').toLowerCase();
        const instructor = (kid.instructor_name || '').toLowerCase();
        const zone = (kid.zone || '').toString().toLowerCase();
        const program = (kid.program || '').toLowerCase();

        return name.includes(query) ||
               instructor.includes(query) ||
               zone.includes(query) ||
               program.includes(query);
      });
    }

    // Update roster meta with filter info
    if (searchFilter.trim()) {
      el('rosterMeta').textContent = `(Showing ${kids.length} of ${totalCount} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;
    } else {
      el('rosterMeta').textContent = `(${kids.length} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;
    }

    const tbody = el('roster');
    tbody.innerHTML = '';

    for(const kid of kids){
      const tr = document.createElement('tr');

      // Apply program type color class
      const colorClass = getProgramColorClass(kid.program);
      if(colorClass) tr.className = colorClass;

      // Attendance
      const tdAtt = document.createElement('td');
      tdAtt.appendChild(renderAttendance(kid));
      tr.appendChild(tdAtt);

      // Swimmer (with badges + flags)
      const tdName = document.createElement('td');
      const nameLine = document.createElement('div');
      nameLine.className = 'level';
      nameLine.textContent = kid.swimmer_name || '‚Äî';

      if(kid.is_addon){
        const b = document.createElement('span');
        b.className = 'badge addon';
        b.textContent = 'ADD-ON';
        nameLine.appendChild(b);
      }

      if(kid.zone_overridden){
        const b = document.createElement('span');
        b.className = 'badge over';
        b.textContent = 'OVERRIDE';
        nameLine.appendChild(b);
      }

      tdName.appendChild(nameLine);
      tdName.appendChild(renderFlags(kid));
      tr.appendChild(tdName);

      // Age
      const tdAge = document.createElement('td');
      tdAge.className = 'nowrap';
      tdAge.textContent = kid.age_text || '‚Äî';
      tr.appendChild(tdAge);

      // Type / Level
      const tl = parseTypeLevel(kid.program);
      const tdType = document.createElement('td');
      tdType.textContent = tl.type;
      tr.appendChild(tdType);

      const tdLevel = document.createElement('td');
      tdLevel.textContent = tl.level;
      tr.appendChild(tdLevel);

      // Instructor (with substitute indicator if applicable)
      const tdInst = document.createElement('td');
      if (kid.substitute_instructor) {
        // Show substitute with indicator
        const subName = document.createElement('span');
        subName.style.fontWeight = '700';
        subName.textContent = kid.substitute_instructor;

        const subBadge = document.createElement('span');
        subBadge.className = 'badge';
        subBadge.style.cssText = 'background:rgba(251,191,36,0.15); color:#fbbf24; border-color:rgba(251,191,36,0.3); margin-left:6px; font-size:10px; padding:2px 6px;';
        subBadge.textContent = 'SUB';

        const originalName = document.createElement('div');
        originalName.className = 'tiny';
        originalName.style.cssText = 'color:var(--muted); margin-top:2px; text-decoration:line-through;';
        originalName.textContent = kid.instructor_name || '';

        tdInst.appendChild(subName);
        tdInst.appendChild(subBadge);
        if (kid.instructor_name) {
          tdInst.appendChild(originalName);
        }
      } else {
        tdInst.textContent = kid.instructor_name || '‚Äî';
      }
      tr.appendChild(tdInst);

      // Zone
      const tdZone = document.createElement('td');
      tdZone.appendChild(renderZoneChip(kid));
      tr.appendChild(tdZone);

      // Action
      const tdAction = document.createElement('td');

      const callBtn = document.createElement('button');
      callBtn.className = 'secondary';
      callBtn.textContent = 'Call parent';
      callBtn.addEventListener('click', async () => {
        try{
          await api('/api/call-parent', {
            method:'POST',
            body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
          });
        }catch(e){
          alert(e.message);
        }
      });
      tdAction.appendChild(callBtn);

      if(kid.is_addon){
        const rm = document.createElement('button');
        rm.className = 'danger';
        rm.style.marginLeft = '8px';
        rm.textContent = 'Remove';
        rm.addEventListener('click', async () => {
          if(!confirm(`Remove add-on swimmer: ${kid.swimmer_name}?`)) return;
          try{
            await api('/api/remove-addon', {
              method:'POST',
              body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
            });
            loadRoster();
          }catch(e){
            alert(e.message);
          }
        });
        tdAction.appendChild(rm);
      }

      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  }

  // ---- Announcements ----
  async function speakTyped(text){
    const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
    setLastAnnouncementUI(resp.lastAnnouncement);
  }

  // ---- Wire up UI ----
  // View selector dropdown
  el('viewSelect').addEventListener('change', async (e) => {
    const view = e.target.value;

    // Hide all panels
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.add('hidden');

    if (view === 'roster') {
      el('panelRoster').classList.remove('hidden');
    } else if (view === 'lifeguard') {
      alert('Lifeguard Tracker\n\nComing soon!\n\nThis will track lifeguard schedules and certifications.');
      el('viewSelect').value = 'roster'; // Reset to roster
      el('panelRoster').classList.remove('hidden');
    } else if (view === 'announcements') {
      el('panelAnnouncements').classList.remove('hidden');
    } else if (view === 'virtualDesk') {
      // Check PIN authentication
      const pinAuth = sessionStorage.getItem('admin_pin_auth');
      const pinExpiry = sessionStorage.getItem('admin_pin_expiry');

      if (pinAuth && pinExpiry && Date.now() < parseInt(pinExpiry)) {
        showVirtualDeskPanel();
      } else {
        pendingPinPanel = 'virtualDesk';
        showModal('pinModal', true);
        el('pinInput').value = '';
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'none';
        el('pinInput').focus();
      }
    } else if (view === 'admin') {
      // Check PIN authentication
      const pinAuth = sessionStorage.getItem('admin_pin_auth');
      const pinExpiry = sessionStorage.getItem('admin_pin_expiry');

      if (pinAuth && pinExpiry && Date.now() < parseInt(pinExpiry)) {
        showAdminPanel();
      } else {
        pendingPinPanel = 'admin';
        showModal('pinModal', true);
        el('pinInput').value = '';
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'none';
        el('pinInput').focus();
      }
    }
  });

  function showVirtualDeskPanel() {
    el('viewSelect').value = 'virtualDesk';
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.remove('hidden');
    el('panelAdmin').classList.add('hidden');

    // Load virtual desk stats and swimmer details
    loadAdminStats();
    loadSwimmerDetails();
  }

  function showAdminPanel() {
    el('viewSelect').value = 'admin';
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.remove('hidden');

    // Load locations and staff
    loadAdminLocations();
    loadStaff();
  }

  async function loadAdminStats() {
    try {
      const resp = await api('/api/admin/stats');
      if (resp.ok) {
        el('adminStatSwimmers').textContent = resp.stats.swimmers_today;
        el('adminStatAttendance').textContent = resp.stats.attendance_rate + '%';
        el('adminStatTrials').textContent = resp.stats.trials_this_week;
      }
    } catch (e) {
      console.error('Failed to load admin stats:', e);
    }
  }

  async function loadAdminLocations() {
    try {
      const resp = await api('/api/locations');
      const list = el('locationsList');
      list.innerHTML = '';

      (resp.locations || []).forEach(loc => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,0.03); border-radius:8px;';

        const info = document.createElement('div');
        info.innerHTML = `<strong>${loc.name}</strong> (${loc.code}) <span class="tiny" style="color:var(--muted);">${loc.brand}</span>`;
        item.appendChild(info);

        const actions = document.createElement('div');
        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.style.cssText = 'padding:4px 12px; font-size:12px;';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeLocation(loc.id, loc.name));
        actions.appendChild(delBtn);
        item.appendChild(actions);

        list.appendChild(item);
      });
    } catch (e) {
      console.error('Failed to load admin locations:', e);
    }
  }

  async function loadStaff() {
    try {
      const resp = await api('/api/staff');
      const list = el('staffList');
      list.innerHTML = '';

      (resp.staff || []).forEach(staff => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,0.03); border-radius:8px;';

        const info = document.createElement('div');

        // Format birthday to show only month/day (remove year)
        let birthdayDisplay = '';
        if (staff.birthday) {
          const parts = staff.birthday.split('/');
          if (parts.length >= 2) {
            birthdayDisplay = `${parts[0]}/${parts[1]}`; // MM/DD only
          }
        }

        // Build info HTML with phone and birthday
        let infoHTML = `<strong>${staff.firstName} ${staff.lastName}</strong>`;
        infoHTML += ` <span class="tiny" style="color:var(--muted);">${staff.location}</span>`;
        if (staff.phone) {
          infoHTML += `<br><span class="tiny" style="color:var(--muted);">üìû ${staff.phone}</span>`;
        }
        if (birthdayDisplay) {
          infoHTML += ` <span class="tiny" style="color:var(--muted);">üéÇ ${birthdayDisplay}</span>`;
        }

        info.innerHTML = infoHTML;
        item.appendChild(info);

        const actions = document.createElement('div');
        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.style.cssText = 'padding:4px 12px; font-size:12px;';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeStaff(staff.id || `${staff.firstName}_${staff.lastName}`, `${staff.firstName} ${staff.lastName}`));
        actions.appendChild(delBtn);
        item.appendChild(actions);

        list.appendChild(item);
      });
    } catch (e) {
      console.error('Failed to load staff:', e);
    }
  }

  async function removeLocation(id, name) {
    if (!confirm(`Remove location: ${name}?\n\nThis will affect all rosters and settings for this location.`)) return;

    try {
      await api('/api/admin/remove-location', {
        method: 'POST',
        body: JSON.stringify({ id })
      });
      alert(`Location "${name}" removed successfully.`);
      loadAdminLocations();
      await loadLocations(); // Also update main dropdown
    } catch (e) {
      alert(`Failed to remove location: ${e.message}`);
    }
  }

  async function removeStaff(id, name) {
    if (!confirm(`Remove staff member: ${name}?`)) return;

    try {
      await api('/api/admin/remove-staff', {
        method: 'POST',
        body: JSON.stringify({ id })
      });
      alert(`Staff member "${name}" removed successfully.`);
      loadStaff();
    } catch (e) {
      alert(`Failed to remove staff: ${e.message}`);
    }
  }

  // Store swimmer data globally for attendance modal
  let swimmersData = [];

  // Load detailed swimmer information for Virtual Desk
  async function loadSwimmerDetails() {
    try {
      const date = activeDateISO || new Date().toISOString().split('T')[0];
      const location_id = currentLocation?.id || 1;

      const resp = await api(`/api/virtual-desk/swimmers?date=${date}&location_id=${location_id}`);

      if (!resp.ok || !resp.swimmers) {
        el('swimmerDetailsTable').innerHTML = '<p style="color:var(--muted); text-align:center; padding:20px;">No swimmers found for today.</p>';
        return;
      }

      // Store data globally
      swimmersData = resp.swimmers;

      // Apply sorting
      let swimmers = swimmersData;
      const sortBy = el('swimmerSortBy').value;

      if (sortBy === 'name') {
        swimmers.sort((a, b) => a.swimmer_name.localeCompare(b.swimmer_name));
      } else if (sortBy === 'time') {
        swimmers.sort((a, b) => a.start_time.localeCompare(b.start_time));
      } else if (sortBy === 'instructor') {
        swimmers.sort((a, b) => (a.instructor_name || '').localeCompare(b.instructor_name || ''));
      } else if (sortBy === 'attendance_rate') {
        swimmers.sort((a, b) => (b.stats?.attendance_rate || 0) - (a.stats?.attendance_rate || 0));
      } else if (sortBy === 'missed') {
        swimmers.sort((a, b) => (b.stats?.missed || 0) - (a.stats?.missed || 0));
      } else if (sortBy === 'balance') {
        const statusOrder = { 'owes': 3, 'policy': 2, 'current': 1 };
        swimmers.sort((a, b) => (statusOrder[b.balance_status] || 0) - (statusOrder[a.balance_status] || 0));
      }

      // Build table
      let html = '<table><thead><tr>';
      html += '<th>Swimmer</th>';
      html += '<th>Time</th>';
      html += '<th>Program</th>';
      html += '<th>Instructor</th>';
      html += '<th>Total Classes</th>';
      html += '<th>Attended</th>';
      html += '<th>Missed</th>';
      html += '<th>Attendance %</th>';
      html += '<th>Balance</th>';
      html += '<th>Flags</th>';
      html += '</tr></thead><tbody>';

      swimmers.forEach(s => {
        html += '<tr>';

        // Swimmer name
        html += `<td><strong>${s.swimmer_name}</strong>`;
        if (s.age_text) html += `<br><span class="tiny" style="color:var(--muted);">${s.age_text}</span>`;
        html += '</td>';

        // Time
        html += `<td>${fmtTime(s.start_time)}</td>`;

        // Program
        html += `<td><span class="tiny">${s.program || '‚Äî'}</span></td>`;

        // Instructor
        html += '<td>';
        if (s.substitute_instructor) {
          html += `<span style="font-weight:700;">${s.substitute_instructor}</span>`;
          html += `<span class="badge" style="background:rgba(251,191,36,0.15); color:#fbbf24; border-color:rgba(251,191,36,0.3); margin-left:4px; font-size:10px;">SUB</span>`;
          if (s.instructor_name) html += `<br><span class="tiny" style="color:var(--muted); text-decoration:line-through;">${s.instructor_name}</span>`;
        } else {
          html += s.instructor_name || '‚Äî';
        }
        html += '</td>';

        // Stats
        html += `<td style="text-align:center;">${s.stats?.total_classes || 0}</td>`;
        html += `<td style="text-align:center; color:var(--good);">${s.stats?.attended || 0}</td>`;
        html += `<td style="text-align:center; color:var(--bad);">${s.stats?.missed || 0}</td>`;

        // Attendance rate with color (clickable)
        const rate = s.stats?.attendance_rate || 0;
        let rateColor = 'var(--good)';
        if (rate < 70) rateColor = 'var(--bad)';
        else if (rate < 85) rateColor = 'var(--warn)';
        const swimmerIndex = swimmers.indexOf(s);
        html += `<td style="text-align:center;">`;
        html += `<span onclick="showAttendanceHistory(${swimmerIndex})" style="color:${rateColor}; font-weight:700; cursor:pointer; text-decoration:underline; padding:4px 8px; border-radius:4px; background:rgba(255,255,255,0.05);">${rate}%</span>`;
        html += `</td>`;

        // Balance - show actual dollar amount or status
        html += '<td style="text-align:center;">';
        if (s.balance_amount !== null && s.balance_amount !== undefined) {
          const balStr = s.balance_amount < 0 ? `-$${Math.abs(s.balance_amount).toFixed(2)}` : `$${s.balance_amount.toFixed(2)}`;
          const balColor = s.balance_amount > 0 ? 'var(--bad)' : s.balance_amount < 0 ? 'var(--good)' : 'var(--muted)';
          html += `<span style="color:${balColor}; font-weight:700;">${balStr}</span>`;
        } else if (s.balance_status === 'owes') {
          html += '<span class="badge" style="background:rgba(239,68,68,0.15); color:#ef4444; border-color:rgba(239,68,68,0.3);">Owes</span>';
        } else if (s.balance_status === 'policy') {
          html += '<span class="badge" style="background:rgba(245,158,11,0.15); color:#f59e0b; border-color:rgba(245,158,11,0.3);">Policy</span>';
        } else {
          html += '<span class="tiny" style="color:var(--muted);">‚Äî</span>';
        }
        html += '</td>';

        // Flags
        html += '<td>';
        const flags = [];
        if (s.flags?.new) flags.push('<span class="badge" style="background:rgba(34,197,94,0.15); color:#22c55e;">New</span>');
        if (s.flags?.makeup) flags.push('<span class="badge" style="background:rgba(59,130,246,0.15); color:#3b82f6;">Makeup</span>');
        if (s.flags?.trial) flags.push('<span class="badge" style="background:rgba(234,179,8,0.15); color:#eab308;">Trial</span>');
        if (s.is_addon) flags.push('<span class="badge addon">Add-on</span>');
        html += flags.join(' ') || '‚Äî';
        html += '</td>';

        html += '</tr>';
      });

      html += '</tbody></table>';

      el('swimmerDetailsTable').innerHTML = html;

    } catch (e) {
      console.error('Failed to load swimmer details:', e);
      el('swimmerDetailsTable').innerHTML = `<p style="color:var(--bad); text-align:center; padding:20px;">Error: ${e.message}</p>`;
    }
  }

  // Event handlers for swimmer details view
  el('swimmerSortBy').addEventListener('change', loadSwimmerDetails);
  el('refreshSwimmers').addEventListener('click', loadSwimmerDetails);

  // Show attendance history modal
  window.showAttendanceHistory = function(swimmerIndex) {
    const swimmer = swimmersData[swimmerIndex];
    if (!swimmer || !swimmer.attendance_history) return;

    el('attendanceHistoryTitle').textContent = `Attendance History: ${swimmer.swimmer_name}`;

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>Date</th>';
    html += '<th>Time</th>';
    html += '<th>Status</th>';
    html += '<th>Program</th>';
    html += '<th>Instructor</th>';
    html += '</tr></thead><tbody>';

    swimmer.attendance_history.forEach(record => {
      const statusText = record.attendance === 1 ? 'Attended' : record.attendance === 0 ? 'Missed' : '‚Äî';
      const statusColor = record.attendance === 1 ? 'var(--good)' : record.attendance === 0 ? 'var(--bad)' : 'var(--muted)';

      html += '<tr>';
      html += `<td>${record.date}</td>`;
      html += `<td>${fmtTime(record.start_time)}</td>`;
      html += `<td style="color:${statusColor}; font-weight:700;">${statusText}</td>`;
      html += `<td><span class="tiny">${record.program || '‚Äî'}</span></td>`;
      html += `<td>${record.instructor_name || '‚Äî'}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';

    // Add summary
    const attended = swimmer.stats?.attended || 0;
    const missed = swimmer.stats?.missed || 0;
    const rate = swimmer.stats?.attendance_rate || 0;

    html += '<div style="margin-top:16px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">';
    html += '<div style="display:flex; gap:20px; justify-content:center;">';
    html += `<div><span class="tiny" style="color:var(--muted);">Total:</span> <strong>${swimmer.stats?.total_classes || 0}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Attended:</span> <strong style="color:var(--good);">${attended}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Missed:</span> <strong style="color:var(--bad);">${missed}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Rate:</span> <strong style="color:var(--good);">${rate}%</strong></div>`;
    html += '</div></div>';

    el('attendanceHistoryContent').innerHTML = html;
    showModal('attendanceHistoryModal', true);
  };

  el('attendanceHistoryClose').addEventListener('click', () => showModal('attendanceHistoryModal', false));
  el('attendanceHistoryModal').addEventListener('click', (e) => {
    if (e.target === el('attendanceHistoryModal')) showModal('attendanceHistoryModal', false);
  });

  // Add Location Modal
  el('addLocationBtn').addEventListener('click', () => {
    el('newLocationName').value = '';
    el('newLocationShortCode').value = '';
    el('newLocationBrand').value = 'swimlabs';
    showModal('addLocationModal', true);
  });

  el('addLocationCancel').addEventListener('click', () => showModal('addLocationModal', false));
  el('addLocationModal').addEventListener('click', (e) => {
    if (e.target === el('addLocationModal')) showModal('addLocationModal', false);
  });

  el('addLocationSave').addEventListener('click', async () => {
    const name = el('newLocationName').value.trim();
    const short_code = el('newLocationShortCode').value.trim();
    const brand = el('newLocationBrand').value;

    if (!name) {
      alert('Location name is required');
      return;
    }

    try {
      await api('/api/admin/add-location', {
        method: 'POST',
        body: JSON.stringify({ name, short_code, brand })
      });
      alert(`Location "${name}" added successfully.`);
      showModal('addLocationModal', false);
      loadAdminLocations();
      // Reload location dropdown
      await loadLocations();
    } catch (e) {
      alert(`Failed to add location: ${e.message}`);
    }
  });

  // Add Staff Modal
  el('addStaffBtn').addEventListener('click', () => {
    el('newStaffFirstName').value = '';
    el('newStaffLastName').value = '';
    el('newStaffLocation').value = 'New York';
    el('newStaffPhone').value = '';
    el('newStaffBirthday').value = '';
    showModal('addStaffModal', true);
  });

  el('addStaffCancel').addEventListener('click', () => showModal('addStaffModal', false));
  el('addStaffModal').addEventListener('click', (e) => {
    if (e.target === el('addStaffModal')) showModal('addStaffModal', false);
  });

  el('addStaffSave').addEventListener('click', async () => {
    const firstName = el('newStaffFirstName').value.trim();
    const lastName = el('newStaffLastName').value.trim();
    const location = el('newStaffLocation').value;
    const phone = el('newStaffPhone').value.trim();
    const birthday = el('newStaffBirthday').value.trim();

    if (!firstName || !lastName) {
      alert('First name and last name are required');
      return;
    }

    try {
      await api('/api/admin/add-staff', {
        method: 'POST',
        body: JSON.stringify({ firstName, lastName, location, phone, birthday })
      });
      alert(`Staff member "${firstName} ${lastName}" added successfully.`);
      showModal('addStaffModal', false);
      loadStaff();
    } catch (e) {
      alert(`Failed to add staff: ${e.message}`);
    }
  });

  // PIN modal handlers
  el('pinCancel').addEventListener('click', () => {
    showModal('pinModal', false);
  });

  el('pinSubmit').addEventListener('click', async () => {
    const pin = el('pinInput').value.trim();

    if (!pin || pin.length !== 4) {
      el('pinError').textContent = 'Please enter a 4-digit PIN';
      el('pinError').style.display = 'block';
      return;
    }

    try {
      const resp = await api('/api/verify-pin', {
        method: 'POST',
        body: JSON.stringify({ pin })
      });

      if (resp.ok && resp.authenticated) {
        // Success!
        sessionStorage.setItem('admin_pin_auth', 'true');
        sessionStorage.setItem('admin_pin_expiry', resp.expires_at.toString());

        showModal('pinModal', false);

        // Show the panel that requested auth
        if (pendingPinPanel === 'admin') {
          showAdminPanel();
        } else {
          showVirtualDeskPanel();
        }
        pendingPinPanel = null;
      }
    } catch (e) {
      if (e.message.includes('Too many failed attempts')) {
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'block';
      } else {
        el('pinLockout').style.display = 'none';
        el('pinError').textContent = e.message || 'Incorrect PIN. Try again.';
        el('pinError').style.display = 'block';
      }
      el('pinInput').value = '';
      el('pinInput').focus();
    }
  });

  // Allow Enter key to submit PIN
  el('pinInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      el('pinSubmit').click();
    }
  });

  // Admin navigation cards (placeholders for future sessions)
  el('adminNavAbsence').addEventListener('click', () => {
    alert('Absence Tracker\n\nComing in Session 9!\n\nThis will track multi-week absences and help you follow up with families.');
  });

  el('adminNavTrials').addEventListener('click', () => {
    alert('Trial Follow-up\n\nComing in Session 10!\n\nThis will manage trial swimmers and track conversion rates.');
  });

  el('adminNavHistory').addEventListener('click', () => {
    alert('Attendance History\n\nComing in Session 12 (Optional)!\n\nThis will show 30-day attendance patterns and reports.');
  });

  el('adminNavObservations').addEventListener('click', () => {
    alert('Instructor Observations\n\nComing in Session 13 (Optional)!\n\nThis will generate evaluation forms for instructor observations.');
  });

  el('adminNavClearRoster').addEventListener('click', async () => {
    const locationName = currentLocation?.name || 'Unknown';
    const locationCode = currentLocation?.code || 'Unknown';

    const confirmMsg = `‚ö†Ô∏è CLEAR ROSTER FOR ${locationName.toUpperCase()}\n\n` +
      `This will permanently delete ALL uploaded roster data for ${locationName} (${locationCode}).\n\n` +
      `‚Ä¢ All swimmers will be removed\n` +
      `‚Ä¢ All attendance records will be deleted\n` +
      `‚Ä¢ All flags and notes will be lost\n\n` +
      `The roster will be auto-exported as a backup before deletion.\n\n` +
      `Type "DELETE" to confirm:`;

    const userInput = prompt(confirmMsg);

    if (userInput !== 'DELETE') {
      if (userInput !== null) {
        alert('Cancelled. Roster was NOT cleared.');
      }
      return;
    }

    try {
      const resp = await api('/api/clear-roster', {
        method: 'POST',
        body: JSON.stringify({
          location_id: currentLocation?.id || 1
        })
      });

      if (resp.ok) {
        alert(`‚úÖ Roster Cleared!\n\nDeleted ${resp.deleted_count} swimmers for ${locationName}.\n\nBackup saved to: ${resp.backup_file || 'N/A'}`);
        await loadBlocks();
        await loadRoster();
      }
    } catch (e) {
      alert(`‚ùå Clear Failed\n\n${e.message}`);
    }
  });

  el('settingsBtn').addEventListener('click', () => {
    syncDeviceUI();
    showModal('settingsModal', true);
  });
  el('settingsClose').addEventListener('click', () => showModal('settingsModal', false));
  el('settingsModal').addEventListener('click', (e) => { if(e.target === el('settingsModal')) showModal('settingsModal', false); });

  el('settingsSave').addEventListener('click', () => {
    deviceMode = el('deviceModeSelect').value;
    localStorage.setItem('deviceMode', deviceMode);
    syncDeviceUI();
    showModal('settingsModal', false);
    loadRoster();
  });

  el('importBtn').addEventListener('click', async () => {
    try{
      el('importBtn').disabled = true;
      await api('/api/import-today', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      await loadStatus();
      await loadBlocks();
    }catch(e){
      alert(e.message);
    }finally{
      el('importBtn').disabled = false;
    }
  });

  // HTML Upload handlers
  el('uploadHtmlBtn').addEventListener('click', () => {
    el('htmlFileInput').click();
  });

  el('htmlFileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      el('uploadHtmlBtn').disabled = true;
      el('uploadHtmlBtn').textContent = 'Uploading...';

      // Use FormData for clean file upload without credential issues
      const formData = new FormData();
      formData.append('html', file);
      formData.append('location_id', currentLocation?.id || 1);

      const response = await fetch('/api/upload-html', {
        method: 'POST',
        body: formData
        // No headers, no credentials - browser handles multipart automatically
      });

      if (!response.ok) {
        throw new Error(`Upload failed: ${response.statusText}`);
      }

      const result = await response.json();

      if (result.ok) {
        alert(`Success! Imported ${result.count} swimmers`);
        await loadStatus();
        await loadBlocks();
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (e) {
      alert(`Upload failed: ${e.message}`);
      console.error('Upload error details:', e);
    } finally {
      el('uploadHtmlBtn').disabled = false;
      el('uploadHtmlBtn').textContent = 'Upload HTML';
      el('htmlFileInput').value = '';
    }
  });

  el('exportJsonBtn').addEventListener('click', () => {
    window.location.href = '/api/export-json';
  });

  el('importJsonBtn').addEventListener('click', () => el('jsonFileInput').click());
  el('jsonFileInput').addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    try{
      const txt = await f.text();
      const payload = JSON.parse(txt);
      await api('/api/import-json', { method:'POST', body: JSON.stringify(payload) });
      await loadStatus();
      await loadBlocks();
      await loadRoster();
      toast('JSON import complete');
    }catch(err){
      alert('Import failed: ' + (err.message || err));
    }finally{
      e.target.value = '';
    }
  });

  el('setDateBtn').addEventListener('click', async () => {
    const d = el('rosterDate').value;
    if (!d) return;
    try{
      await api('/api/set-active-date', { method:'POST', body: JSON.stringify({date:d}) });
      await loadStatus();
      await loadBlocks();
      await loadRoster();
      toast('Roster date updated');
    }catch(err){
      alert('Set date failed: ' + (err.message || err));
    }
  });

  el('sortBy').addEventListener('change', () => loadRoster());

  // Load instructors for dropdown
  async function loadInstructors() {
    try {
      const locId = currentLocation?.id || 1;
      const resp = await api(`/api/instructors?location_id=${locId}`);
      const select = el('addInstructor');

      // Clear existing options
      select.innerHTML = '';

      // Add blank option
      const blankOpt = document.createElement('option');
      blankOpt.value = '';
      blankOpt.textContent = '(select instructor)';
      select.appendChild(blankOpt);

      // Add instructor options
      (resp.instructors || []).forEach(instructor => {
        const opt = document.createElement('option');
        opt.value = instructor.displayName;
        opt.textContent = instructor.displayName;
        select.appendChild(opt);
      });

    } catch (e) {
      console.error('Failed to load instructors:', e);
      const select = el('addInstructor');
      select.innerHTML = '<option value="">(error loading instructors)</option>';
    }
  }

  // Add-on modal
  el('addSwimmerBtn').addEventListener('click', async () => {
    if(!currentBlock) return;
    el('addName').value = '';
    el('addAge').value = '';
    el('addInstructor').value = '';
    el('addZone').value = '';
    el('addProgram').value = 'GROUP: Beginner 1';
    el('addTime').value = fmtTime(currentBlock);

    // Load instructors for current location
    await loadInstructors();

    showModal('addModal', true);
  });
  el('addCancel').addEventListener('click', () => showModal('addModal', false));
  el('addModal').addEventListener('click', (e) => { if(e.target === el('addModal')) showModal('addModal', false); });

  el('addSave').addEventListener('click', async () => {
    try{
      const swimmer_name = el('addName').value.trim();
      if(!swimmer_name){
        alert('Swimmer name is required');
        return;
      }
      await api('/api/add-swimmer', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name,
          age_text: el('addAge').value.trim() || null,
          program: el('addProgram').value,
          instructor_name: el('addInstructor').value.trim() || null,
          zone: el('addZone').value || null,
          location_id: currentLocation?.id || 1,
          device_mode: deviceMode
        })
      });
      showModal('addModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Zone modal
  el('zoneCancel').addEventListener('click', () => showModal('zoneModal', false));
  el('zoneModal').addEventListener('click', (e) => { if(e.target === el('zoneModal')) showModal('zoneModal', false); });

  el('zoneSave').addEventListener('click', async () => {
    if(!zoneTarget) return;
    try{
      const payload = {
        start_time: currentBlock,
        swimmer_name: zoneTarget.swimmer_name,
        new_zone: el('zoneSelect').value,
        device_mode: deviceMode,
        manager_code: (deviceMode === 'deck') ? el('managerCode').value : undefined
      };
      await api('/api/update-zone', { method:'POST', body: JSON.stringify(payload) });
      showModal('zoneModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Announcements
  el('speakBtn').addEventListener('click', async () => {
    try{
      const text = el('customText').value.trim();
      await speakTyped(text);
    }catch(e){
      alert(e.message);
    }
  });

  el('clearBtn').addEventListener('click', () => { el('customText').value = ''; });

  el('repeatBtn').addEventListener('click', async () => {
    try{
      const resp = await api('/api/repeat-last', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('forceTimeBtn').addEventListener('click', async () => {
    try{
      if(!currentBlock){
        alert('Select a time block first');
        return;
      }
      const resp = await api('/api/force-time-announcement', {
        method:'POST',
        body: JSON.stringify({ start_time: currentBlock, device_mode: deviceMode })
      });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('presetFrontDeck').addEventListener('click', () => {
    el('customText').value = 'Front desk to deck';
  });
  el('presetCodeGreen').addEventListener('click', () => {
    el('customText').value = 'Code green';
  });
  el('presetCodeBrown').addEventListener('click', () => {
    el('customText').value = 'Code Brown';
  });

  // Search functionality
  el('rosterSearch').addEventListener('input', (e) => {
    searchFilter = e.target.value;

    // Show/hide clear button
    const clearBtn = el('searchClear');
    if (searchFilter.trim()) {
      clearBtn.classList.remove('hidden');
    } else {
      clearBtn.classList.add('hidden');
    }

    // Reload roster with filter
    if (currentBlock) {
      loadRoster();
    }
  });

  el('searchClear').addEventListener('click', () => {
    searchFilter = '';
    el('rosterSearch').value = '';
    el('searchClear').classList.add('hidden');

    // Reload roster without filter
    if (currentBlock) {
      loadRoster();
    }
  });

  // Boot
  (async function init(){
    try{
      syncDeviceUI();
      await loadLocations();
      await loadStatus();
      await loadBlocks();
    }catch(e){
      setStatus(e.message || 'Failed to load', 'warn');
    }
  })();
</script>
</body>
</html>
