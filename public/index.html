<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="api-base" content="" />
  <title>SwimLabs Announcer</title>
  <style>
    :root{
      --bg:#070b14;
      --cardA:rgba(255,255,255,.06);
      --cardB:rgba(255,255,255,.03);
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --btn:#1f2a44;
      --btn2:#2a3a63;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(255,255,255,.06);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #0e1b3a 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    .wrap{ max-width: 1250px; margin: 0 auto; }
    .topbar{ display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap; padding-bottom: 4px; }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:14px; }
    .tiny{ font-size:12px; }
    .right{ margin-left:auto; }
    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin-top:14px;
      box-shadow: 0 12px 34px rgba(0,0,0,.30);
      backdrop-filter: blur(8px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    button{
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    button:hover{ filter: brightness(1.08); }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(34,197,94,.45); }
    button.secondary{ border-color: rgba(245,158,11,.35); }
    button.danger{ border-color: rgba(239,68,68,.35); }

    button.tab{ padding:9px 12px; border-radius:999px; background: transparent; border-color: transparent; }
    button.tab.active{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.14);
      outline: 2px solid rgba(255,255,255,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      line-height: 1.2;
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); font-weight:900; }
    .ok{ color: var(--good); font-weight:900; }
    .warn{ color: var(--warn); font-weight:900; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 520px 1fr; } }

    .blocks{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .blocks button{ min-width: 120px; }
    .blocks button.active{
      outline:2px solid rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.28);
      filter: brightness(1.10);
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size:14px;
      line-height: 1.4;
    }

    /* readable black inputs + dropdowns */
    select, input[type="text"], input[type="password"]{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: #000;
      color: #fff;
      font-weight:900;
      outline: none;
      cursor:pointer;
    }
    input[type="text"], input[type="password"]{
      cursor:text;
      font-weight:800;
    }
    input[type="text"]:focus, input[type="password"]:focus{
      border-color: #04D9FF;
      box-shadow: 0 0 0 3px rgba(4,217,255,.15);
    }
    select option{
      background:#000;
      color:#fff;
    }

    /* Search bar */
    .searchWrap{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .searchInput{
      width: 280px;
      padding: 9px 34px 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.75);
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      outline: none;
      transition: all .15s ease;
    }
    .searchInput:focus{
      border-color: #04D9FF;
      box-shadow: 0 0 0 3px rgba(4,217,255,.15);
      background: #000;
    }
    .searchInput::placeholder{
      color: rgba(159,176,208,.6);
      font-weight: 600;
    }
    .searchClear{
      position: absolute;
      right: 8px;
      padding: 4px 6px;
      background: transparent;
      border: none;
      color: rgba(159,176,208,.8);
      font-size: 16px;
      cursor: pointer;
      min-height: auto;
      line-height: 1;
      border-radius: 6px;
      transition: all .12s ease;
    }
    .searchClear:hover{
      color: #04D9FF;
      background: rgba(4,217,255,.1);
    }
    .searchClear:active{
      transform: scale(0.95);
    }
    .searchClear.hidden{
      display: none;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    thead th{
      position: sticky;
      top: 0;
      background: rgba(10, 16, 34, .92);
      backdrop-filter: blur(8px);
      z-index: 5;
      border-bottom: 1px solid var(--line2);
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align: top;
      font-size:14px;
    }
    th{ color:var(--muted); font-weight:900; font-size:12px; text-transform: uppercase; letter-spacing: .5px; }
    tbody tr:hover{ background: rgba(255,255,255,.035); }

    /* Program type color coding */
    tbody tr.program-group{ background: rgba(34,197,94,0.08); }
    tbody tr.program-group:hover{ background: rgba(34,197,94,0.14); }

    tbody tr.program-semi-private{ background: rgba(59,130,246,0.08); }
    tbody tr.program-semi-private:hover{ background: rgba(59,130,246,0.14); }

    tbody tr.program-private{ background: rgba(168,85,247,0.08); }
    tbody tr.program-private:hover{ background: rgba(168,85,247,0.14); }

    tbody tr.program-parent-tot{ background: rgba(249,115,22,0.08); }
    tbody tr.program-parent-tot:hover{ background: rgba(249,115,22,0.14); }

    tbody tr.program-trial{ background: rgba(234,179,8,0.08); }
    tbody tr.program-trial:hover{ background: rgba(234,179,8,0.14); }

    .zone{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.04);
      font-size:13px;
      font-weight:900;
      white-space: nowrap;
      cursor: pointer;
      user-select:none;
    }
    .zone.locked{ cursor: not-allowed; opacity:.85; }

    .hidden{ display:none; }

    .level{ font-weight:900; color: rgba(232,238,252,.95); line-height: 1.2; }
    .nowrap{ white-space: nowrap; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      margin-left:8px;
      vertical-align: middle;
    }
    .badge.addon{ border-color: rgba(245,158,11,.40); }
    .badge.over{ border-color: rgba(34,197,94,.35); }
    
    .badge.sub {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 0.5px;
      border: 1px solid rgba(249,115,22,0.45);
      background: rgba(249,115,22,0.15);
      color: rgb(249,115,22);
      cursor: help;
    }
    
    .badge.sub:hover {
      background: rgba(249,115,22,0.25);
      transform: scale(1.05);
      transition: all 0.15s ease;
    }

    tbody tr.row-sub { background: rgba(249,115,22,0.06); }
    tbody tr.row-sub:hover { background: rgba(249,115,22,0.12); }

    .guard-section {
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .guard-section h4 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 900;
    }
    .guard-task {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      margin-bottom: 8px;
    }
    .guard-task.done {
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
    }
    .guard-task input[type="text"] {
      width: 72px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      text-align: center;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      padding: 6px 8px;
      color: #fff;
    }
    .guard-task span { flex: 1; }
    .guard-group-title {
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      color: rgba(148,163,184,.9);
      margin: 10px 0 6px;
      letter-spacing: 0.4px;
    }
    .guard-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }
    .guard-rotation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .guard-rotation-table th,
    .guard-rotation-table td {
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding: 8px;
      text-align: left;
    }
    .guard-rotation-table input {
      width: 100%;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      padding: 6px 8px;
      color: #fff;
    }

    /* Attendance buttons */
    .attWrap{ display:flex; gap:6px; align-items:center; }
    .attBtn{
      padding:7px 9px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .attBtn.here.active{ border-color: rgba(34,197,94,.5); background: rgba(34,197,94,.12); }
    .attBtn.absent.active{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.12); }
    .attBtn.clear.active{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.08); }

    /* Flags */
    .flags{ display:flex; gap:8px; margin-top:6px; align-items:center; flex-wrap:wrap; }
    .flag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:26px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size:16px;
      opacity:.35;
      transition: filter .12s ease, opacity .12s ease, transform .05s ease;
    }
    .flag:hover{ filter: brightness(1.15); }
    .flag:active{ transform: translateY(1px); }
    .flag.on{ opacity:1; border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .flagHelp{ font-size:12px; color: rgba(159,176,208,.9); margin-left:8px; }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(20,26,50,.92), rgba(10,12,24,.92));
      border:1px solid var(--line2);
      border-radius:18px;
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .modal h3{ margin:4px 0 10px; font-size:16px; }
    .modal .grid2{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width: 640px){ .modal .grid2{ grid-template-columns: 1fr 1fr; } }
    .field label{
      display:block;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .field .hint{
      margin-top:6px;
      font-size:12px;
      color: rgba(159,176,208,.85);
      line-height:1.35;
    }
    .modalFooter{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    /* TABLET & MOBILE OPTIMIZATION */
    @media (max-width: 900px) {
      body { padding: 10px; }
      .wrap { max-width: 100%; }
      .card { padding: 12px; }
      h1 { font-size: 20px; }
      button { min-height: 48px; padding: 12px 16px; font-size: 15px; }
      th, td { padding: 10px 8px; font-size: 14px; }
      .level { font-size: 15px; font-weight: 700; }
      .blocks button { min-height: 48px; padding: 10px 14px; font-size: 15px; }
    }

    @media (max-width: 600px) {
      body { padding: 6px; }
      .card { padding: 10px; border-radius: 12px; }
      h1 { font-size: 18px; }
      button { min-height: 44px; padding: 10px 14px; font-size: 14px; }
      th, td { padding: 8px 6px; font-size: 13px; }
      .level { font-size: 14px; }
      .blocks button { min-height: 44px; padding: 8px 12px; font-size: 14px; }
      .pill { padding: 6px 8px; font-size: 12px; }
      .attBtn { padding: 6px 10px; font-size: 13px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>SwimLabs Announcer <span style="font-size:14px; color:var(--muted); font-weight:400;">v4.7.0</span></h1>
      <div class="muted" id="status">Loading‚Ä¶</div>
    </div>

    <div class="right row">
      <select id="locationSelect" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
        <option value="">Loading locations...</option>
      </select>
      <select id="viewSelect" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); min-width: 150px;">
        <option value="roster">Roster</option>
        <option value="lifeguard">Lifeguard üèä</option>
        <option value="announcements">Announcements</option>
        <option value="virtualDesk">Manager</option>
        <option value="admin">‚öôÔ∏è Admin</option>
      </select>
      <span class="pill">Device: <strong id="deviceModeLabel">Deck</strong></span>
      <button id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <span class="pill">
        <span style="font-size:11px; color:var(--muted);">Current Time:</span>
        <strong id="currentTime" style="color:#04D9FF; margin-left:4px;">‚Äî</strong>
      </span>
      <span class="pill" id="nextAnnouncementPill">
        <span style="font-size:11px; color:var(--muted);">Next Announcement:</span>
        <strong id="nextAnnouncementTimer" style="color:#04D9FF; margin-left:4px;">‚Äî</strong>
      </span>
      <span class="pill">Last: <strong id="lastAt">None</strong></span>
    </div>
  </div>

  <div id="panelRoster">
    <div class="card">
      <div class="row">
        <button class="primary" id="importBtn">Import Today (PDF)</button>
        <button class="primary" id="uploadHtmlBtn">Upload HTML</button>
        <input type="file" id="htmlFileInput" accept=".html" style="display: none;">
        <button class="secondary" id="exportServerBtn" title="Save a JSON backup on the server">Export to Server</button>
        <button class="secondary" id="importServerBtn" title="Restore a roster from server backups">Import from Server</button>

        <div class="spacer"></div>
        <span class="pill tiny">Auto announcement runs about 3 minutes before each time block.</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Time Blocks <span class="muted">(Date:</span> <input id="rosterDate" type="date" class="dateInput" /> <button id="setDateBtn" class="miniBtn">Set</button> <span class="muted">)</span> <span id="blockHint" class="muted"></span></div>
        <div class="spacer"></div>
        <div class="pill">Selected: <strong id="selectedBlock">None</strong></div>
      </div>
      <div class="blocks" id="blocks"></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Roster <span id="rosterMeta" class="muted"></span></div>
        <div class="legend" id="tagLegend">
          <span class="legendItem"><span class="flagBadge on">‚≠ê</span><span class="legendText">First time</span></span>
          <span class="legendItem"><span class="flagBadge on">üîÑ</span><span class="legendText">Makeup</span></span>
          <span class="legendItem"><span class="flagBadge on">üìú</span><span class="legendText">Policy</span></span>
          <span class="legendItem"><span class="flagBadge on">üí≥</span><span class="legendText">Balance</span></span>
          <span class="legendItem"><span class="flagBadge on">üß™</span><span class="legendText">Trial</span></span>
        </div>

        <div class="spacer"></div>

        <div class="searchWrap">
          <input type="text" id="rosterSearch" class="searchInput" placeholder="Search roster..." />
          <button class="searchClear hidden" id="searchClear" title="Clear search">‚úï</button>
        </div>

        <button class="secondary" id="addSwimmerBtn">+ Add swimmer</button>
        <span class="pill">Sort</span>
        <select id="sortBy">
          <option value="instructor" selected>Instructor + A-Z</option>
          <option value="name">Swimmer A-Z</option>
        </select>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px;">Attendance</th>
            <th>Swimmer</th>
            <th style="width:110px;">Age</th>
            <th style="width:150px;">Type</th>
            <th style="width:170px;">Level</th>
            <th style="width:170px;">Instructor</th>
            <th style="width:140px;">Zone</th>
            <th style="width:170px;">Action</th>
          </tr>
        </thead>
        <tbody id="roster"></tbody>
      </table>

    </div>
  </div>

  <div id="panelAnnouncements" class="hidden">
    <div class="grid">
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <button class="secondary" id="repeatBtn">Repeat last</button>
          <button class="secondary" id="forceTimeBtn">Force time-block</button>
        </div>

        <textarea id="customText" placeholder="Type an announcement here, then click Speak."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="speakBtn">Speak typed message</button>
          <button class="danger" id="clearBtn">Clear</button>
        </div>

        <div class="card" style="margin-top:12px; background: rgba(255,255,255,.03);">
          <div class="pill" style="margin-bottom:8px;">Last announcement</div>
          <div id="lastText" class="tiny" style="line-height:1.45; color: rgba(232,238,252,.92);">None</div>
        </div>
      </div>

      <div class="card">
        <div class="pill" style="margin-bottom:10px;">Quick presets</div>
        <div class="row">
          <button class="secondary" id="presetFrontDeck">Front desk to deck</button>
          <button class="secondary" id="presetCodeGreen">Code Green</button>
          <button class="secondary" id="presetCodeBrown">Code Brown</button>
        </div>
      </div>
    </div>
  </div>

  <div id="panelVirtualDesk" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">Manager Dashboard</h2>

      <!-- Quick Stats -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:14px; margin-bottom:20px;">
        <div class="card" style="background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.2);">
          <div class="tiny" style="color:var(--muted); margin-bottom:4px;">Swimmers Today</div>
          <div style="font-size:28px; font-weight:900; color:#22c55e;" id="adminStatSwimmers">‚Äî</div>
        </div>

        <div class="card" style="background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2);">
          <div class="tiny" style="color:var(--muted); margin-bottom:4px;">Attendance Rate</div>
          <div style="font-size:28px; font-weight:900; color:#3b82f6;" id="adminStatAttendance">‚Äî</div>
        </div>

        <div class="card" style="background: rgba(234,179,8,0.08); border-color: rgba(234,179,8,0.2);">
          <div class="tiny" style="color:var(--muted); margin-bottom:4px;">Trials This Week</div>
          <div style="font-size:28px; font-weight:900; color:#eab308;" id="adminStatTrials">‚Äî</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin:0 0 12px; font-size:18px;">üìÖ Manager Date Brackets</h3>
        <div class="grid2" style="margin-bottom:10px;">
          <div class="field">
            <label>Start date</label>
            <input type="date" id="managerRangeStart" />
          </div>
          <div class="field">
            <label>End date</label>
            <input type="date" id="managerRangeEnd" />
          </div>
        </div>
        <div class="row" style="flex-wrap:wrap; gap:8px;">
          <button class="secondary" id="managerRangeWeek">This Week</button>
          <button class="secondary" id="managerRangeNextTwo">Next 14 Days</button>
          <button class="secondary" id="managerRangeMonth">This Month</button>
          <div class="spacer"></div>
          <button class="primary" id="managerRangeSave">Save Brackets</button>
        </div>
        <div class="tiny" style="margin-top:8px; color:var(--muted);" id="managerRangeHint">Saved range syncs report defaults and guard tasks.</div>
      </div>

      <!-- Swimmer Details View -->
      <div class="card" id="swimmerDetailsView">
        <div class="row" style="margin-bottom:12px;">
          <h3 style="margin:0; font-size:18px;">üë• Today's Swimmers - Detailed View</h3>
          <div class="spacer"></div>
          <select id="swimmerSortBy" style="padding:6px 10px; border-radius:8px; font-size:13px; font-weight:600; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
            <option value="name">Sort: Name A-Z</option>
            <option value="time">Sort: Time</option>
            <option value="instructor">Sort: Instructor</option>
            <option value="attendance_rate">Sort: Attendance Rate</option>
            <option value="missed">Sort: Missed Classes</option>
            <option value="balance">Sort: Balance Status</option>
          </select>
          <button id="refreshSwimmers" class="secondary" style="padding:6px 12px; font-size:13px;">üîÑ Refresh</button>
          <button id="exportVirtualDeskBtn" class="secondary" style="padding:6px 12px; font-size:13px;">üì• Export</button>
        </div>

        <div id="swimmerDetailsTable"></div>
      </div>

      <!-- Reports Section -->
      <div class="card" style="margin-top:20px;">
        <div class="row" style="margin-bottom:12px;">
          <h3 style="margin:0; font-size:18px;">üìà Reports & Analytics</h3>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
          <button id="openAttendanceReportBtn" class="secondary" style="padding:12px; text-align:left;">
            <div style="font-weight:700;">üìä Attendance Report</div>
            <div class="tiny" style="color:var(--muted); margin-top:4px;">Daily/weekly/monthly attendance analytics</div>
          </button>
          <button id="openInstructorReportBtn" class="secondary" style="padding:12px; text-align:left;">
            <div style="font-weight:700;">üë®‚Äçüè´ Instructor Analytics</div>
            <div class="tiny" style="color:var(--muted); margin-top:4px;">Performance metrics per instructor</div>
          </button>
        </div>
      </div>

      <!-- Navigation Cards -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:14px; margin-top:20px;">
        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavAbsence">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üìä Absence Tracker</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Track multi-week absences and follow up with families</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavTrials">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üß™ Trial Follow-up</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Manage trial swimmers and conversion tracking</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavGuards">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üõü Guard Tasks</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Opening, midday, closing checklists + rotation plan</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavHistory">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üìÖ Attendance History</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">View 30-day attendance patterns and reports</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease;" id="adminNavObservations">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px;">üìù Instructor Observations</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Generate evaluation forms and track progress</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease; background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.3);" id="adminNavClearRoster">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px; color:#ef4444;">üóëÔ∏è Clear Roster</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Remove all uploaded roster data for current location</div>
        </div>

        <div class="card" style="cursor:pointer; transition: all .15s ease; background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.45);" id="adminNavClearAllRosters">
          <div style="font-size:16px; font-weight:900; margin-bottom:6px; color:#ef4444;">üß® Master Clear All Uploads</div>
          <div class="tiny" style="color:var(--muted); line-height:1.4;">Permanently delete all roster data + uploaded files for every location</div>
        </div>
      </div>

      <div class="tiny" style="margin-top:16px; color: rgba(159,176,208,.7);">
        Manager features are protected by PIN authentication. Session expires after 2 hours.
      </div>
    </div>
  </div>

  <div id="panelLifeguard" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">üõü Lifeguard Dashboard</h2>
      <div class="tiny" style="color:var(--muted); margin-bottom:12px;">
        Guard tasks are available for SwimLabs Westchester.
      </div>
    </div>
  </div>

  <div id="panelGuardTasks" class="hidden">
    <div class="card">
      <div class="row" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
        <button class="secondary" id="guardTasksBack">‚Üê Back</button>
        <div class="pill">üõü Guard Tasks</div>
        <div class="spacer"></div>
        <div class="guard-meta" id="guardTasksMeta">No date selected</div>
      </div>

      <div class="row" style="margin-bottom:16px; flex-wrap:wrap; gap:10px;">
        <div class="field">
          <label>Task date</label>
          <input type="date" id="guardTasksDate" />
        </div>
        <div class="field">
          <label>Guard 1</label>
          <input type="text" id="guardName1" placeholder="Name..." />
        </div>
        <div class="field">
          <label>Guard 2</label>
          <input type="text" id="guardName2" placeholder="Name..." />
        </div>
        <div class="field">
          <label>Guard 3</label>
          <input type="text" id="guardName3" placeholder="Name..." />
        </div>
        <div class="spacer"></div>
        <button class="secondary" id="guardTasksShuffle">Randomize guard numbers</button>
        <button class="danger" id="guardTasksReset">Reset</button>
      </div>

      <div class="tiny" style="color:var(--muted); margin-bottom:16px;">
        Manager: enter the guard names for the day. Weekdays have no rotation unless manually added. Weekends rotate Guard 2 + 3 first, then 3 + 1, then 1 + 2.
      </div>
      <div class="tiny" style="color:rgba(248,250,252,0.9); font-weight:700; margin-bottom:16px;">
        IF YOU ARE DOWN AND DON'T KNOW WHAT TO WORK ON OR DO, SEE MANAGER.
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:14px;">
        <div class="guard-section">
          <h4>üåÖ Opening Checklist</h4>
          <div id="guardOpeningList"></div>
        </div>

        <div class="guard-section">
          <h4>üå§Ô∏è Midday Checklist</h4>
          <div id="guardMiddayList"></div>
        </div>

        <div class="guard-section">
          <h4>üåô Closing Checklist</h4>
          <div id="guardClosingList"></div>
        </div>
      </div>

      <div class="guard-section" style="margin-top:16px;">
        <h4>üîÅ Rotation Plan</h4>
        <div class="tiny" style="color:var(--muted); margin-bottom:8px;" id="guardRotationHint">Log rotations by time, guard, and zone.</div>
        <table class="guard-rotation-table">
          <thead>
            <tr>
              <th style="width:25%;">Time / Block</th>
              <th style="width:40%;">Guards Up</th>
              <th style="width:25%;">Notes</th>
              <th style="width:10%;"></th>
            </tr>
          </thead>
          <tbody id="guardRotationBody"></tbody>
        </table>
        <button class="secondary" id="guardRotationAdd" style="margin-top:10px;">+ Add rotation</button>
      </div>

      <div class="guard-section" style="margin-top:16px;">
        <h4>üìù Notes</h4>
        <textarea id="guardNotes" rows="4" style="width:100%; border-radius:12px; padding:10px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); color:#fff;" placeholder="Document incidents, reminders, or handoff notes..."></textarea>
      </div>
    </div>
  </div>

  <!-- System Admin Panel -->
  <div id="panelAdmin" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">‚öôÔ∏è System Administration</h2>

      <!-- Location Management -->
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üìç Location Management</h3>
        <div id="locationsList" style="margin-bottom:12px;"></div>
        <button id="addLocationBtn" class="secondary">+ Add New Location</button>
      </div>

      <!-- Staff Management -->
      <div class="card">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üë• Staff Management</h3>
        <div id="staffList" style="margin-bottom:12px;"></div>
        <button id="addStaffBtn" class="secondary">+ Add New Staff</button>
      </div>

      <div class="tiny" style="margin-top:16px; color: rgba(159,176,208,.7);">
        System administration features require elevated privileges. Changes affect all locations.
      </div>
    </div>
  </div>
</div>

<!-- PIN Authentication Modal -->
<div class="modalBackdrop" id="pinModal">
  <div class="modal" style="max-width: 420px;">
    <h3>Admin Access</h3>

    <div class="field">
      <label>Enter 4-digit PIN</label>
      <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" style="font-size:24px; text-align:center; letter-spacing:8px;" />
      <div class="hint" id="pinError" style="color:#ef4444; display:none;">Incorrect PIN. Try again.</div>
      <div class="hint" id="pinLockout" style="color:#ef4444; display:none;">Too many attempts. Locked for 2 minutes.</div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="pinCancel">Cancel</button>
      <button class="primary" id="pinSubmit">Unlock</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modalBackdrop" id="settingsModal">
  <div class="modal">
    <h3>Device settings</h3>
    <div class="field">
      <label>Set device mode</label>
      <select id="deviceModeSelect">
        <option value="deck">Deck (tablet)</option>
        <option value="frontdesk">Front Desk (computer)</option>
      </select>
      <div class="hint">Deck requires manager approval to change zones.</div>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="settingsClose">Close</button>
      <button class="primary" id="settingsSave">Save</button>
    </div>
  </div>
</div>

<!-- Add Swimmer Modal -->
<div class="modalBackdrop" id="addModal">
  <div class="modal">
    <h3>Add swimmer (Add-on)</h3>

    <div class="grid2">
      <div class="field">
        <label>Swimmer name</label>
        <input type="text" id="addName" placeholder="First Last" />
      </div>

      <div class="field">
        <label>Age (optional)</label>
        <input type="text" id="addAge" placeholder="Example: 6y 2m" />
      </div>

      <div class="field">
        <label>Class type</label>
        <select id="addProgram">
          <option value="GROUP: Beginner 1">GROUP: Beginner 1</option>
          <option value="GROUP: Beginner 2">GROUP: Beginner 2</option>
          <option value="GROUP: Beginner 3">GROUP: Beginner 3</option>
          <option value="GROUP: Beginner 4">GROUP: Beginner 4</option>
          <option value="GROUP: Intermediate 1">GROUP: Intermediate 1</option>
          <option value="GROUP: Intermediate 2">GROUP: Intermediate 2</option>
          <option value="GROUP: Intermediate 3">GROUP: Intermediate 3</option>
          <option value="GROUP: Advanced 1">GROUP: Advanced 1</option>
          <option value="GROUP: Advanced 2">GROUP: Advanced 2</option>
          <option value="Private">Private</option>
          <option value="Semi-Private">Semi-Private</option>
          <option value="ParentTot">ParentTot</option>
          <option value="Toddler Transition">Toddler Transition</option>
          <option value="Adult">Adult</option>
        </select>
      </div>

      <div class="field">
        <label>Instructor (optional)</label>
        <select id="addInstructor">
          <option value="">(loading...)</option>
        </select>
      </div>

      <div class="field">
        <label>Zone (optional)</label>
        <select id="addZone">
          <option value="">(leave blank)</option>
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field">
        <label>Time block</label>
        <input type="text" id="addTime" disabled />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addCancel">Cancel</button>
      <button class="primary" id="addSave">Add swimmer</button>
    </div>
  </div>
</div>

<!-- Zone Override Modal -->
<div class="modalBackdrop" id="zoneModal">
  <div class="modal">
    <h3>Change zone</h3>

    <div class="row">
      <span class="pill">Swimmer: <strong id="zoneWho">‚Äî</strong></span>
      <div class="spacer"></div>
      <span class="pill">Mode: <strong id="zoneMode">Deck</strong></span>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div class="field">
        <label>New zone</label>
        <select id="zoneSelect">
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field" id="managerCodeField">
        <label>Manager code (required on Deck)</label>
        <input type="password" id="managerCode" placeholder="Enter code" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="zoneCancel">Cancel</button>
      <button class="primary" id="zoneSave">Save zone</button>
    </div>
  </div>
</div>

<!-- Add Location Modal -->
<div class="modalBackdrop" id="addLocationModal">
  <div class="modal">
    <h3>Add New Location</h3>

    <div class="field">
      <label>Location Name *</label>
      <input type="text" id="newLocationName" placeholder="e.g., SwimLabs Westchester" />
    </div>

    <div class="field">
      <label>Short Code</label>
      <input type="text" id="newLocationShortCode" placeholder="e.g., SLW" maxlength="10" />
    </div>

    <div class="field">
      <label>Brand</label>
      <select id="newLocationBrand">
        <option value="swimlabs">SwimLabs</option>
        <option value="safesplash">SafeSplash</option>
      </select>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addLocationCancel">Cancel</button>
      <button class="primary" id="addLocationSave">Add Location</button>
    </div>
  </div>
</div>

<!-- Add Staff Modal -->
<div class="modalBackdrop" id="addStaffModal">
  <div class="modal">
    <h3>Add New Staff Member</h3>

    <div class="grid2">
      <div class="field">
        <label>First Name *</label>
        <input type="text" id="newStaffFirstName" placeholder="First name" />
      </div>

      <div class="field">
        <label>Last Name *</label>
        <input type="text" id="newStaffLastName" placeholder="Last name" />
      </div>

      <div class="field">
        <label>Location *</label>
        <select id="newStaffLocation">
          <option value="New York">New York</option>
          <option value="California">California</option>
          <option value="Texas">Texas</option>
          <option value="Nevada">Nevada</option>
        </select>
      </div>

      <div class="field">
        <label>Phone</label>
        <input type="text" id="newStaffPhone" placeholder="1234567890" />
      </div>

      <div class="field">
        <label>Birthday</label>
        <input type="text" id="newStaffBirthday" placeholder="MM/DD/YY" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addStaffCancel">Cancel</button>
      <button class="primary" id="addStaffSave">Add Staff</button>
    </div>
  </div>
</div>

<!-- Attendance History Modal -->
<div class="modalBackdrop" id="attendanceHistoryModal">
  <div class="modal" style="max-width:700px;">
    <h3 id="attendanceHistoryTitle">Attendance History</h3>

    <div id="attendanceHistoryContent" style="margin-top:12px; max-height:500px; overflow-y:auto;">
      <!-- Content will be populated by JavaScript -->
    </div>

    <div class="modalFooter">
      <button class="secondary" id="attendanceHistoryClose">Close</button>
    </div>
  </div>
</div>

<!-- Trial Follow-up Modal -->
<div class="modalBackdrop" id="trialFollowupModal">
  <div class="modal" style="max-width:900px;">
    <h3>üß™ Trial Follow-up Report</h3>

    <div class="row" style="margin:10px 0 12px;">
      <span class="pill">Last <strong id="trialDaysLabel">30</strong> days</span>
      <div class="spacer"></div>
      <button class="secondary" id="trialRefreshBtn">Refresh</button>
    </div>

    <div id="trialSummary" class="tiny" style="color:var(--muted); margin-bottom:10px;">Loading‚Ä¶</div>
    <div id="trialReportTable" style="max-height:520px; overflow-y:auto;"></div>

    <div class="modalFooter">
      <button class="secondary" id="trialCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- Server Import Modal -->
<div class="modalBackdrop" id="serverImportModal">
  <div class="modal" style="max-width:720px;">
    <h3>üì¶ Server Backups</h3>

    <div class="row" style="margin:10px 0 12px;">
      <span class="pill">Location: <strong id="serverExportLocation">‚Äî</strong></span>
      <div class="spacer"></div>
      <button class="secondary" id="serverExportRefresh">Refresh</button>
    </div>

    <div id="serverExportList" style="max-height:420px; overflow-y:auto;"></div>

    <div class="modalFooter">
      <button class="secondary" id="serverImportClose">Close</button>
    </div>
  </div>
</div>

<!-- Attendance Report Modal -->
<div class="modalBackdrop" id="attendanceReportModal">
  <div class="modal" style="max-width:900px;">
    <h3>üìä Attendance Report</h3>

    <div class="row" style="margin:10px 0 16px; flex-wrap:wrap; gap:10px;">
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">Start Date</label>
        <input type="date" id="attendanceReportStartDate" style="width:100%;">
      </div>
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">End Date</label>
        <input type="date" id="attendanceReportEndDate" style="width:100%;">
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button class="secondary" id="attendanceReportGenerate" style="padding:8px 16px;">Generate Report</button>
      </div>
    </div>

    <div id="attendanceReportContent" style="max-height:450px; overflow-y:auto;">
      <div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">
        Select a date range and click "Generate Report" to view attendance analytics.
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="attendanceReportExportCSV">Export CSV</button>
      <button class="secondary" id="attendanceReportExportJSON">Export JSON</button>
      <button class="secondary" id="attendanceReportClose">Close</button>
    </div>
  </div>
</div>

<!-- Instructor Report Modal -->
<div class="modalBackdrop" id="instructorReportModal">
  <div class="modal" style="max-width:900px;">
    <h3>üë®‚Äçüè´ Instructor Performance Analytics</h3>

    <div class="row" style="margin:10px 0 16px; flex-wrap:wrap; gap:10px;">
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">Start Date</label>
        <input type="date" id="instructorReportStartDate" style="width:100%;">
      </div>
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">End Date</label>
        <input type="date" id="instructorReportEndDate" style="width:100%;">
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button class="secondary" id="instructorReportGenerate" style="padding:8px 16px;">Generate Report</button>
      </div>
    </div>

    <div id="instructorReportContent" style="max-height:450px; overflow-y:auto;">
      <div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">
        Select a date range and click "Generate Report" to view instructor analytics.
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="instructorReportExportCSV">Export CSV</button>
      <button class="secondary" id="instructorReportExportJSON">Export JSON</button>
      <button class="secondary" id="instructorReportClose">Close</button>
    </div>
  </div>
</div>

<script>
  let currentBlock = null;
  let zoneTarget = null;
  let deviceMode = localStorage.getItem('deviceMode') || 'deck';
  let activeDateISO = null;
  let managerDateRange = null;
  let blocksList = [];
  let autoTimers = [];
  let currentLocation = null;
  let allLocations = [];
  let searchFilter = '';
  let pendingPinPanel = null; // Track which panel requested PIN auth ('virtualDesk' or 'admin')
  let nextAnnouncementTime = null; // Track next scheduled announcement
  let countdownInterval = null; // Interval for countdown updates
  let lastPanel = 'roster';

  const el = (id) => document.getElementById(id);
  const escapeSelector = (value) => {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(value);
    }
    return String(value).replace(/["\\]/g, '\\$&');
  };
  const normalizeKey = (value) => String(value || '').trim().toLowerCase();
  const locationTimeZones = new Map([
    ['new york', 'America/New_York'],
    ['ny', 'America/New_York'],
    ['westchester', 'America/New_York'],
    ['riverdale', 'America/New_York'],
    ['swimlabs westchester', 'America/New_York'],
    ['safesplash riverdale', 'America/New_York'],
    ['slw', 'America/New_York'],
    ['ssr', 'America/New_York'],
    ['texas', 'America/Chicago'],
    ['tx', 'America/Chicago'],
    ['woodlands', 'America/Chicago'],
    ['swimlabs woodlands', 'America/Chicago'],
    ['slx', 'America/Chicago'],
    ['california', 'America/Los_Angeles'],
    ['ca', 'America/Los_Angeles'],
    ['santa monica', 'America/Los_Angeles'],
    ['torrance', 'America/Los_Angeles'],
    ['safesplash santa monica', 'America/Los_Angeles'],
    ['safesplash torrance', 'America/Los_Angeles'],
    ['ssm', 'America/Los_Angeles'],
    ['sst', 'America/Los_Angeles'],
    ['nevada', 'America/Los_Angeles'],
    ['nv', 'America/Los_Angeles'],
    ['summerlin', 'America/Los_Angeles'],
    ['safesplash summerlin', 'America/Los_Angeles'],
    ['sss', 'America/Los_Angeles']
  ]);

  function getLocationTimeZone() {
    const fallbackZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if (!currentLocation) return fallbackZone;
    const candidates = [
      currentLocation.name,
      currentLocation.code,
      currentLocation.short_code,
      currentLocation.shortCode
    ].map(normalizeKey);
    for (const key of candidates) {
      if (locationTimeZones.has(key)) {
        return locationTimeZones.get(key);
      }
    }
    return fallbackZone;
  }

  function getTimeZoneOffsetMinutes(date, timeZone) {
    const dtf = new Intl.DateTimeFormat('en-US', {
      timeZone,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    const parts = Object.fromEntries(
      dtf.formatToParts(date).map((p) => [p.type, p.value])
    );
    const asUTC = Date.UTC(
      Number(parts.year),
      Number(parts.month) - 1,
      Number(parts.day),
      Number(parts.hour),
      Number(parts.minute),
      Number(parts.second)
    );
    return (asUTC - date.getTime()) / 60000;
  }

  // Load locations on startup
  async function loadLocations() {
    try {
      const resp = await api('/api/locations');
      allLocations = resp.locations;
      
      const select = el('locationSelect');
      select.innerHTML = '';
      
      allLocations.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = loc.id;
        opt.textContent = loc.name;
        select.appendChild(opt);
      });
      
      // Load saved location or default to first
      const savedLocId = localStorage.getItem('location_id') || allLocations[0]?.id;
      select.value = savedLocId;
      currentLocation = allLocations.find(l => l.id == savedLocId);
      
      // Show/hide announcements tab based on location
      updateAnnouncementsVisibility();
      updateGuardTasksVisibility();
      
    } catch (e) {
      console.error('Failed to load locations:', e);
    }
  }

  function updateAnnouncementsVisibility() {
    const viewSelect = el('viewSelect');
    const panelAnnouncements = el('panelAnnouncements');
    const panelRoster = el('panelRoster');
    const announcementsOption = viewSelect?.querySelector('option[value="announcements"]');
    const hasAnnouncements = Boolean(currentLocation && currentLocation.has_announcements);

    if (announcementsOption) {
      announcementsOption.hidden = !hasAnnouncements;
      announcementsOption.disabled = !hasAnnouncements;
    }

    if (!hasAnnouncements) {
      if (viewSelect && viewSelect.value === 'announcements') {
        viewSelect.value = 'roster';
        panelRoster?.classList.remove('hidden');
        panelAnnouncements?.classList.add('hidden');
      }
      return;
    }

    if (panelAnnouncements && viewSelect?.value === 'announcements') {
      panelAnnouncements.classList.remove('hidden');
    }
  }

  function isWestchesterLocation() {
    if (!currentLocation) return false;
    const code = String(currentLocation.code || '').toUpperCase();
    const name = String(currentLocation.name || '').toLowerCase();
    return code === 'SLW' || name.includes('westchester');
  }

  function updateGuardTasksVisibility() {
    const guardCard = el('adminNavGuards');
    if (!guardCard) return;
    const isWestchester = isWestchesterLocation();
    guardCard.style.display = isWestchester ? '' : 'none';
    const lifeguardOption = el('viewSelect')?.querySelector('option[value="lifeguard"]');
    if (lifeguardOption) lifeguardOption.hidden = !isWestchester;
    if (!isWestchester && el('viewSelect')?.value === 'lifeguard') {
      el('viewSelect').value = 'roster';
      el('panelGuardTasks').classList.add('hidden');
      el('panelRoster').classList.remove('hidden');
    }
  }

  el('locationSelect').addEventListener('change', async (e) => {
    const locId = e.target.value;
    currentLocation = allLocations.find(l => l.id == locId);
    localStorage.setItem('location_id', locId);
    
    try {
      await api('/api/set-location', {
        method: 'POST',
        body: JSON.stringify({ location_id: locId })
      });
      
      updateAnnouncementsVisibility();
      updateGuardTasksVisibility();
      await loadStatus();
      await loadBlocks();
      if (currentBlock) await loadRoster();
      
    } catch (e) {
      alert('Failed to switch location: ' + e.message);
    }
  });

  function escapeHtml(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function fmtTime(time24){
    if(!time24) return '‚Äî';
    const parts = String(time24).split(':');
    const hh = parseInt(parts[0], 10);
    const mm = parseInt(parts[1] || '0', 10);
    const ampm = hh >= 12 ? 'PM' : 'AM';
    const h12 = ((hh + 11) % 12) + 1;
    if(mm === 0) return `${h12} ${ampm}`;
    return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
  }

  function fmtCurrentTime(date, timeZone) {
    try {
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone,
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      const parts = formatter.formatToParts(date);
      const hour = parts.find((p) => p.type === 'hour')?.value;
      const minute = parts.find((p) => p.type === 'minute')?.value;
      const dayPeriod = parts.find((p) => p.type === 'dayPeriod')?.value;
      if (hour && minute && dayPeriod) {
        return `${hour}:${minute}${dayPeriod}`;
      }
      return formatter.format(date).replace(/\s+/g, '');
    } catch (e) {
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      const displayMinutes = String(minutes).padStart(2, '0');
      return `${displayHours}:${displayMinutes}${ampm}`;
    }
  }

  function parseTypeLevel(program){
    const p = String(program || '').trim();
    if(!p) return { type: '‚Äî', level: '‚Äî' };
    const up = p.toUpperCase();
    if(up.startsWith('GROUP:')){
      const level = p.split(':').slice(1).join(':').trim();
      return { type: 'Group', level: level || '‚Äî' };
    }
    // Non-group
    return { type: p, level: '‚Äî' };
  }

  function getSubMeta(kid){
    const rawInstructor = String(kid?.instructor_name || '');
    const rawSub = String(kid?.substitute_instructor || '');
    const rawOriginal = String(kid?.original_instructor || '');
    const hasMarker = /\*|\(sub\)|\bsub\b/i.test(rawInstructor);
    const cleanedInstructor = rawInstructor.replace(/\(sub\)/ig, '').replace(/\*/g, '').trim();
    const cleanedSub = rawSub.replace(/\(sub\)/ig, '').replace(/\*/g, '').trim();

    let hasSub = Boolean(kid?.is_substitute || rawSub || rawOriginal || hasMarker);
    let subName = cleanedSub || cleanedInstructor || rawSub || rawInstructor;
    let originalName = rawOriginal || '';

    if (!originalName && cleanedSub && cleanedInstructor && cleanedSub !== cleanedInstructor) {
      originalName = cleanedInstructor;
    }

    return {
      hasSub,
      subName: subName || '‚Äî',
      originalName
    };
  }

  function getProgramColorClass(program){
    const p = String(program || '').toUpperCase().trim();
    if(!p) return '';

    // Check for GROUP programs
    if(p.startsWith('GROUP:')) return 'program-group';

    // Check for SEMI-PRIVATE
    if(p.includes('SEMI') && p.includes('PRIVATE')) return 'program-semi-private';
    if(p.includes('SEMI-PRIVATE')) return 'program-semi-private';

    // Check for PRIVATE (but not semi-private)
    if(p.includes('PRIVATE')) return 'program-private';

    // Check for PARENT-TOT
    if(p.includes('PARENT') && p.includes('TOT')) return 'program-parent-tot';
    if(p.includes('PARENTTOT')) return 'program-parent-tot';

    // Check for TRIAL (could be in program name or as a flag indicator)
    if(p.includes('TRIAL')) return 'program-trial';

    return '';
  }

  const apiBase = (() => {
    const metaBase = document.querySelector('meta[name="api-base"]')?.content?.trim();
    const base = (window.API_BASE || metaBase || '').trim();
    if (!base) return '';
    let cleaned = base;
    try {
      const url = new URL(base, window.location.origin);
      if (url.username || url.password) {
        url.username = '';
        url.password = '';
        cleaned = `${url.origin}${url.pathname}${url.search}${url.hash}`;
      }
    } catch (err) {
      // Leave base as-is if it cannot be parsed as a URL.
    }
    return cleaned.endsWith('/') ? cleaned.slice(0, -1) : cleaned;
  })();

  function apiUrl(path) {
    if (!path) return path;
    const isAbsolute = /^https?:\/\//i.test(path);
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const base = apiBase || window.location.origin;
    const rawUrl = isAbsolute ? path : `${base}${normalizedPath}`;
    try {
      const url = new URL(rawUrl);
      if (url.username || url.password) {
        url.username = '';
        url.password = '';
      }
      return url.toString();
    } catch (err) {
      return rawUrl;
    }
  }

  async function api(path, opts={}){
    const res = await fetch(apiUrl(path), {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    const data = await res.json().catch(() => ({}));
    if(!res.ok || data.ok === false){
      const details = data && data.details ? ` | ${typeof data.details === 'string' ? data.details : JSON.stringify(data.details)}` : '';
      const msg = (data.error || `Request failed: ${res.status}`) + details;
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(text, kind){
    const s = el('status');
    s.textContent = text;
    s.classList.remove('ok','warn');
    if(kind) s.classList.add(kind);
  }
  function toast(msg){
    const prev = el('status').textContent;
    setStatus(msg, 'ok');
    setTimeout(() => {
      if (el('status').textContent === msg) el('status').textContent = prev;
    }, 1800);
  }


  function showModal(id, on=true){
    el(id).style.display = on ? 'flex' : 'none';
  }

  function syncDeviceUI(){
    el('deviceModeLabel').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('deviceModeSelect').value = deviceMode;
    el('zoneMode').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('managerCodeField').style.display = (deviceMode === 'deck') ? 'block' : 'none';
  }

  function setLastAnnouncementUI(last){
    const at = last?.at ? new Date(last.at) : null;
    el('lastAt').textContent = at ? at.toLocaleTimeString() : 'None';
    el('lastText').textContent = last?.text || 'None';
  }

  function setSelectedBlockUI(){
    el('selectedBlock').textContent = currentBlock ? fmtTime(currentBlock) : 'None';
    [...el('blocks').querySelectorAll('button[data-time]')].forEach(b => {
      b.classList.toggle('active', b.dataset.time === currentBlock);
    });
    el('addSwimmerBtn').disabled = !currentBlock;
  }

  function getTodayISO(){
    return new Date().toISOString().split('T')[0];
  }

  function applyManagerDateRange(range){
    managerDateRange = range;
    if (el('managerRangeStart')) el('managerRangeStart').value = range?.start || '';
    if (el('managerRangeEnd')) el('managerRangeEnd').value = range?.end || '';

    const hint = el('managerRangeHint');
    if (hint) {
      hint.textContent = range
        ? `Saved range: ${range.start} ‚Üí ${range.end}. Applies to reports + guard tasks.`
        : 'Saved range syncs report defaults and guard tasks.';
    }

    if (range?.start && range?.end) {
      if (el('attendanceReportStartDate')) el('attendanceReportStartDate').value = range.start;
      if (el('attendanceReportEndDate')) el('attendanceReportEndDate').value = range.end;
      if (el('instructorReportStartDate')) el('instructorReportStartDate').value = range.start;
      if (el('instructorReportEndDate')) el('instructorReportEndDate').value = range.end;
      if (el('guardTasksDate') && !el('guardTasksDate').value) el('guardTasksDate').value = range.start;
    }
  }

  async function loadStatus(){
    const st = await api('/api/status');

    const activeDate = st.activeDate || st.todayISO;
    if (activeDate) {
      activeDateISO = activeDate;
    }
    const ttsOk = (st.piperBinExists && st.voiceModelExists);
    const ttsMsg = ttsOk ? 'TTS ready' : 'TTS missing (piper/model)';
    const rosterMsg = st.htmlExists ? `Roster loaded (${Math.round((st.htmlSizeBytes||0)/1024)} KB)` : 'No roster uploaded yet';

    setStatus(`${ttsMsg} ‚Ä¢ ${rosterMsg}`, (ttsOk ? 'ok' : 'warn'));

    const di = el('rosterDate');
    if (di && activeDate) di.value = activeDate;

    setLastAnnouncementUI(st.lastAnnouncement);
    el('blockHint').textContent = '';

    if (st.managerDateRange) {
      applyManagerDateRange(st.managerDateRange);
    }
  }

  async function loadBlocks(){
    const locId = currentLocation?.id || 1;
    const b = await api(`/api/blocks?location_id=${locId}`);
    const wrap = el('blocks');
    wrap.innerHTML = '';

    blocksList = (b.blocks || []);

    const issuesResp = await api(`/api/safety-issues?location_id=${locId}&date=${activeDateISO || ''}`);
    const safetyMap = new Map((issuesResp.issues || []).map((i) => [i.start_time, i]));

    blocksList.forEach((t) => {
      const holder = document.createElement('div');
      holder.style.display = 'flex';
      holder.style.gap = '6px';
      holder.style.alignItems = 'center';

      const btn = document.createElement('button');
      btn.textContent = fmtTime(t);
      btn.dataset.time = t;
      btn.addEventListener('click', () => {
        currentBlock = t;
        setSelectedBlockUI();
        loadRoster();
      });
      holder.appendChild(btn);

      const issueBtn = document.createElement('button');
      issueBtn.className = 'miniBtn';
      issueBtn.title = 'Flag safety issue for this block';
      issueBtn.textContent = safetyMap.has(t) ? '‚ö†Ô∏è' : '‚öë';
      issueBtn.style.minWidth = '40px';
      issueBtn.addEventListener('click', async (event) => {
        event.stopPropagation();
        const existing = safetyMap.get(t);
        const note = prompt(
          `Safety issue for ${fmtTime(t)}.\n\nEnter details (leave blank to clear):`,
          existing?.note || ''
        );
        if (note === null) return;
        try {
          await api('/api/safety-issues', {
            method: 'POST',
            body: JSON.stringify({
              date: activeDateISO,
              start_time: t,
              location_id: currentLocation?.id || 1,
              note
            })
          });
          await loadBlocks();
          toast('Safety issue updated');
        } catch (err) {
          alert('Safety issue failed: ' + (err.message || err));
        }
      });
      holder.appendChild(issueBtn);

      if (safetyMap.has(t)) {
        holder.title = safetyMap.get(t)?.note || 'Safety issue flagged';
      }

      wrap.appendChild(holder);
    });

    if(!currentBlock && (b.blocks || []).length){
      currentBlock = b.blocks[0];
    }

    setSelectedBlockUI();
    if(currentBlock) await loadRoster();
    scheduleAutoAnnouncements();
  }


  function parseBlockDateTime(dateISO, time24, timeZone){
    if(!dateISO || !time24) return null;
    const [y,m,d] = dateISO.split('-').map(n=>parseInt(n,10));
    const [hh,mm] = String(time24).split(':').map(n=>parseInt(n,10));
    if(!y||!m||!d||Number.isNaN(hh)) return null;
    const utcGuess = new Date(Date.UTC(y, (m-1), d, hh, mm||0, 0, 0));
    const offsetMinutes = getTimeZoneOffsetMinutes(utcGuess, timeZone);
    return new Date(utcGuess.getTime() - offsetMinutes * 60000);
  }

  function scheduleAutoAnnouncements(){
    // clear existing timers
    autoTimers.forEach(id => clearTimeout(id));
    autoTimers = [];

    // Reset next announcement tracking
    nextAnnouncementTime = null;

    if(!activeDateISO || !blocksList.length) {
      stopCountdown();
      return;
    }

    const now = new Date();
    const timeZone = getLocationTimeZone();

    blocksList.forEach((t, idxBlock) => {
      const classAt = parseBlockDateTime(activeDateISO, t, timeZone);
      if(!classAt) return;

      const announceAt = new Date(classAt.getTime() - 3*60*1000);
      const delay = announceAt.getTime() - now.getTime();
      if(delay <= 0) return; // too late, don't back-announce

      // cap: only schedule within 36 hours to avoid weird multi-day timers
      if(delay > 36*60*60*1000) return;

      const id = setTimeout(async () => {
        try{
          // First block: call-up only. Subsequent blocks: pick-up + call-up.
          const timeLabel = fmtTime(t);
          const text = (idxBlock === 0)
            ? `Attention. ${timeLabel} classes. Instructors, please call up your first swimmer.`
            : `Attention. ${timeLabel} classes. Front desk, please pick up swimmers for this time block. Instructors, please call up your next swimmer.`;

          const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
          setLastAnnouncementUI(resp.lastAnnouncement);

          // After announcement, reschedule to update next timer
          setTimeout(() => scheduleAutoAnnouncements(), 1000);
        }catch(e){
          // don't spam alerts for background timers
          console.error('auto announcement failed', e);
        }
      }, delay);

      autoTimers.push(id);

      // Track the earliest announcement time
      if (!nextAnnouncementTime || announceAt < nextAnnouncementTime) {
        nextAnnouncementTime = announceAt;
      }
    });

    // Start countdown if we have scheduled announcements
    if (nextAnnouncementTime) {
      startCountdown();
    } else {
      stopCountdown();
    }
  }

  function startCountdown() {
    // Clear existing interval
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    // Update immediately
    updateCountdown();

    // Update every second
    countdownInterval = setInterval(updateCountdown, 1000);
  }

  function stopCountdown() {
    // Show timer pill but with dash
    el('nextAnnouncementTimer').textContent = '‚Äî';
    el('nextAnnouncementPill').style.display = '';
  }

  function updateCountdown() {
    const now = new Date();
    const timeZone = getLocationTimeZone();

    // Update current time display
    el('currentTime').textContent = fmtCurrentTime(now, timeZone);

    if (!nextAnnouncementTime) {
      el('nextAnnouncementTimer').textContent = '‚Äî';
      el('nextAnnouncementTimer').style.color = '#04D9FF';
      el('nextAnnouncementPill').style.display = '';
      return;
    }

    const diff = nextAnnouncementTime - now;

    // If time has passed, show NOW for 3 seconds
    if (diff <= 0) {
      el('nextAnnouncementTimer').textContent = 'NOW';
      el('nextAnnouncementTimer').style.color = '#22c55e';
      setTimeout(() => {
        stopCountdown();
      }, 3000);
      return;
    }

    // Calculate minutes and seconds
    const totalSeconds = Math.floor(diff / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    // Format as :MM or :SS
    let display = '';
    if (minutes > 0) {
      display = `:${String(minutes).padStart(2, '0')}`;
    } else {
      display = `:${String(seconds).padStart(2, '0')}`;
    }

    // Update the display
    el('nextAnnouncementTimer').textContent = display;
    el('nextAnnouncementTimer').style.color = '#04D9FF';
    el('nextAnnouncementPill').style.display = '';
  }

  function sortKids(kids){
    const sortBy = el('sortBy').value;
    const key = (s) => String(s || '').toLowerCase();

    const arr = [...kids];
    arr.sort((a,b) => {
      if(sortBy === 'instructor'){
        const ia = key(a.instructor_name);
        const ib = key(b.instructor_name);
        if(ia !== ib) return ia.localeCompare(ib);
        return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
      }
      return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
    });
    return arr;
  }

  function renderAttendance(kid){
    const w = document.createElement('div');
    w.className = 'attWrap';

    const mk = (label, cls, val) => {
      const b = document.createElement('div');
      b.className = `attBtn ${cls}`;
      b.textContent = label;
      b.classList.toggle('active', kid.attendance === val);
      b.addEventListener('click', async () => {
        try{
          // toggle behavior: clicking active sets to null
          const next = (kid.attendance === val) ? null : val;
          await api('/api/attendance', {
            method:'POST',
            body: JSON.stringify({
              start_time: currentBlock,
              swimmer_name: kid.swimmer_name,
              attendance: next,
              device_mode: deviceMode
            })
          });
          kid.attendance = next;
          loadRoster();
        }catch(e){
          alert(e.message);
        }
      });
      return b;
    };

    w.appendChild(mk('Here','here',1));
    w.appendChild(mk('Absent','absent',0));
    w.appendChild(mk('Clear','clear',null));
    return w;
  }

  function renderFlags(kid){
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.gap = '6px';
    row.style.alignItems = 'center';

    // Only show ACTIVE flags to save space
    if (kid.flag_new) {
      const emoji = document.createElement('span');
      emoji.textContent = '‚≠ê';
      emoji.title = 'First time (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_new'));
      row.appendChild(emoji);
    }

    if (kid.flag_makeup) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üîÑ';
      emoji.title = 'Makeup (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_makeup'));
      row.appendChild(emoji);
    }

    if (kid.flag_policy) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üìú';
      emoji.title = 'Policy (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_policy'));
      row.appendChild(emoji);
    }

    if (kid.flag_owes) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üí≥';
      emoji.title = 'Balance (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_owes'));
      row.appendChild(emoji);
    }

    if (kid.flag_trial) {
      const emoji = document.createElement('span');
      emoji.textContent = 'üß™';
      emoji.title = 'Trial (click to remove)';
      emoji.style.fontSize = '18px';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_trial'));
      row.appendChild(emoji);
    }

    // Add edit button
    const editBtn = document.createElement('button');
    editBtn.textContent = '‚úèÔ∏è';
    editBtn.title = 'Edit swimmer';
    editBtn.style.padding = '4px 8px';
    editBtn.style.fontSize = '14px';
    editBtn.style.minHeight = '28px';
    editBtn.style.cursor = 'pointer';
    editBtn.addEventListener('click', () => openEditModal(kid));
    row.appendChild(editBtn);

    return row;
  }

  async function toggleFlag(kid, flagKey) {
    try {
      const flags = {
        flag_new: !!kid.flag_new,
        flag_makeup: !!kid.flag_makeup,
        flag_policy: !!kid.flag_policy,
        flag_owes: !!kid.flag_owes,
        flag_trial: !!kid.flag_trial
      };
      flags[flagKey] = !flags[flagKey];
      
      const resp = await api('/api/update-flags', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name: kid.swimmer_name,
          device_mode: deviceMode,
          flags
        })
      });
      
      kid.flag_new = resp.flags.flag_new;
      kid.flag_makeup = resp.flags.flag_makeup;
      kid.flag_policy = resp.flags.flag_policy;
      kid.flag_owes = resp.flags.flag_owes;
      kid.flag_trial = resp.flags.flag_trial;
      loadRoster();
    } catch(e) {
      alert(e.message);
    }
  }

  function openEditModal(kid) {
    // TODO: Implement edit modal
    alert(`Edit ${kid.swimmer_name}\n\nEdit functionality coming soon!\n\nFor now, you can:\n- Click icons to remove them\n- Use zone button to change zone\n- Use attendance buttons`);
  }

  function renderZoneChip(kid){
    const z = kid.zone ? `Zone ${kid.zone}` : '‚Äî';
    const chip = document.createElement('div');
    chip.className = 'zone' + (deviceMode === 'deck' ? ' locked' : '');
    chip.textContent = z;
    chip.title = (deviceMode === 'deck') ? 'Deck mode: requires manager code' : 'Click to change zone';
    chip.addEventListener('click', () => {
      zoneTarget = kid;
      el('zoneWho').textContent = kid.swimmer_name;
      el('zoneSelect').value = String(kid.zone || 1);
      el('managerCode').value = '';
      syncDeviceUI();
      showModal('zoneModal', true);
    });
    return chip;
  }

  async function loadRoster(){
    if(!currentBlock){
      el('roster').innerHTML = '';
      el('rosterMeta').textContent = '';
      return;
    }

    const locId = currentLocation?.id || 1;
    const data = await api(`/api/blocks/${encodeURIComponent(currentBlock)}?location_id=${locId}`);
    let kids = sortKids(data.kids || []);

    // Apply search filter
    const totalCount = kids.length;
    if (searchFilter.trim()) {
      const query = searchFilter.toLowerCase();
      kids = kids.filter(kid => {
        const name = (kid.swimmer_name || '').toLowerCase();
        const instructor = (kid.instructor_name || '').toLowerCase();
        const substitute = (kid.substitute_instructor || '').toLowerCase();
        const original = (kid.original_instructor || '').toLowerCase();
        const zone = (kid.zone || '').toString().toLowerCase();
        const program = (kid.program || '').toLowerCase();

        return name.includes(query) ||
               instructor.includes(query) ||
               substitute.includes(query) ||
               original.includes(query) ||
               zone.includes(query) ||
               program.includes(query);
      });
    }

    // Update roster meta with filter info
    if (searchFilter.trim()) {
      el('rosterMeta').textContent = `(Showing ${kids.length} of ${totalCount} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;
    } else {
      el('rosterMeta').textContent = `(${kids.length} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;
    }

    const tbody = el('roster');
    tbody.innerHTML = '';

    for(const kid of kids){
      const tr = document.createElement('tr');

      // Apply program type color class
      const colorClass = getProgramColorClass(kid.program);
      if(colorClass) tr.className = colorClass;

      // Attendance
      const tdAtt = document.createElement('td');
      tdAtt.appendChild(renderAttendance(kid));
      tr.appendChild(tdAtt);

      const hasSub = kid.is_substitute || kid.original_instructor || kid.substitute_instructor;
      const originalSubLabel = kid.original_instructor ||
        ((kid.substitute_instructor && kid.instructor_name && kid.substitute_instructor !== kid.instructor_name)
          ? kid.instructor_name
          : '');

      // Swimmer (with badges + flags)
      const tdName = document.createElement('td');
      const nameLine = document.createElement('div');
      nameLine.className = 'level';
      nameLine.textContent = kid.swimmer_name || '‚Äî';

      if(kid.is_addon){
        const b = document.createElement('span');
        b.className = 'badge addon';
        b.textContent = 'ADD-ON';
        nameLine.appendChild(b);
      }

      if(kid.zone_overridden){
        const b = document.createElement('span');
        b.className = 'badge over';
        b.textContent = 'OVERRIDE';
        nameLine.appendChild(b);
      }

      if (hasSub) {
        const b = document.createElement('span');
        b.className = 'badge sub';
        b.textContent = 'SUB';
        b.title = originalSubLabel ? `Subbing for ${originalSubLabel}` : 'Substitute';
        nameLine.appendChild(b);
      }

      tdName.appendChild(nameLine);
      tdName.appendChild(renderFlags(kid));
      tr.appendChild(tdName);

      // Age
      const tdAge = document.createElement('td');
      tdAge.className = 'nowrap';
      tdAge.textContent = kid.age_text || '‚Äî';
      tr.appendChild(tdAge);

      // Type / Level
      const tl = parseTypeLevel(kid.program);
      const tdType = document.createElement('td');
      tdType.textContent = tl.type;
      tr.appendChild(tdType);

      const tdLevel = document.createElement('td');
      tdLevel.textContent = tl.level;
      tr.appendChild(tdLevel);

      // Instructor (show substitute name + original when applicable)
      const tdInst = document.createElement('td');
      if (hasSub) {
        const instDiv = document.createElement('div');
        instDiv.style.display = 'flex';
        instDiv.style.alignItems = 'center';
        instDiv.style.gap = '8px';
        instDiv.style.flexWrap = 'wrap';

        const subNameValue = kid.substitute_instructor || kid.instructor_name || '‚Äî';
        const originalValue = originalSubLabel;

        const instName = document.createElement('span');
        instName.textContent = `${subNameValue} (Sub)`;
        instName.style.fontWeight = '900';

        const subBadge = document.createElement('span');
        subBadge.className = 'badge sub';
        subBadge.textContent = 'SUB';
        subBadge.title = originalValue ? `Subbing for ${originalValue}` : 'Substitute';

        instDiv.appendChild(instName);
        instDiv.appendChild(subBadge);

        if (originalValue) {
          const originalName = document.createElement('span');
          originalName.className = 'tiny';
          originalName.style.cssText = 'color:var(--muted);';
          originalName.textContent = `(${originalValue})`;
          instDiv.appendChild(originalName);
        }

        tdInst.appendChild(instDiv);
      } else {
        // Regular instructor - no substitute
        tdInst.textContent = kid.instructor_name || '‚Äî';
      }
      tr.appendChild(tdInst);

      // Zone
      const tdZone = document.createElement('td');
      tdZone.appendChild(renderZoneChip(kid));
      tr.appendChild(tdZone);

      // Action
      const tdAction = document.createElement('td');

      const callBtn = document.createElement('button');
      callBtn.className = 'secondary';
      callBtn.textContent = 'Call parent';
      callBtn.addEventListener('click', async () => {
        try{
          await api('/api/call-parent', {
            method:'POST',
            body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
          });
        }catch(e){
          alert(e.message);
        }
      });
      tdAction.appendChild(callBtn);

      if(kid.is_addon){
        const rm = document.createElement('button');
        rm.className = 'danger';
        rm.style.marginLeft = '8px';
        rm.textContent = 'Remove';
        rm.addEventListener('click', async () => {
          if(!confirm(`Remove add-on swimmer: ${kid.swimmer_name}?`)) return;
          try{
            await api('/api/remove-addon', {
              method:'POST',
              body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
            });
            loadRoster();
          }catch(e){
            alert(e.message);
          }
        });
        tdAction.appendChild(rm);
      }

      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  }

  // ---- Announcements ----
  async function speakTyped(text){
    const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
    setLastAnnouncementUI(resp.lastAnnouncement);
  }

  // ---- Wire up UI ----
  // View selector dropdown
  el('viewSelect').addEventListener('change', async (e) => {
    const view = e.target.value;
    lastPanel = view;

    // Hide all panels
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.add('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.add('hidden');

    if (view === 'roster') {
      el('panelRoster').classList.remove('hidden');
    } else if (view === 'lifeguard') {
      showLifeguardPanel();
    } else if (view === 'announcements') {
      el('panelAnnouncements').classList.remove('hidden');
    } else if (view === 'virtualDesk') {
      // Check PIN authentication
      const pinAuth = sessionStorage.getItem('admin_pin_auth');
      const pinExpiry = sessionStorage.getItem('admin_pin_expiry');

      if (pinAuth && pinExpiry && Date.now() < parseInt(pinExpiry)) {
        showVirtualDeskPanel();
      } else {
        pendingPinPanel = 'virtualDesk';
        showModal('pinModal', true);
        el('pinInput').value = '';
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'none';
        el('pinInput').focus();
      }
    } else if (view === 'admin') {
      // Check PIN authentication
      const pinAuth = sessionStorage.getItem('admin_pin_auth');
      const pinExpiry = sessionStorage.getItem('admin_pin_expiry');

      if (pinAuth && pinExpiry && Date.now() < parseInt(pinExpiry)) {
        showAdminPanel();
      } else {
        pendingPinPanel = 'admin';
        showModal('pinModal', true);
        el('pinInput').value = '';
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'none';
        el('pinInput').focus();
      }
    }
  });

  function showVirtualDeskPanel() {
    el('viewSelect').value = 'virtualDesk';
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.remove('hidden');
    el('panelAdmin').classList.add('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.add('hidden');

    // Load virtual desk stats and swimmer details
    loadAdminStats();
    loadSwimmerDetails();
  }

  function showAdminPanel() {
    el('viewSelect').value = 'admin';
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.remove('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.add('hidden');

    // Load locations and staff
    loadAdminLocations();
    loadStaff();
  }

  function showLifeguardPanel() {
    showGuardTasksPanel('lifeguard');
  }

  async function loadAdminStats() {
    try {
      const resp = await api('/api/admin/stats');
      if (resp.ok) {
        el('adminStatSwimmers').textContent = resp.stats.swimmers_today;
        el('adminStatAttendance').textContent = resp.stats.attendance_rate + '%';
        el('adminStatTrials').textContent = resp.stats.trials_this_week;
      }
    } catch (e) {
      console.error('Failed to load admin stats:', e);
    }
  }

  const guardTaskTemplates = {
    weekday: {
      opening: [
        { group: 'Guard 1 (First Guard In)', label: 'Chemicals check' },
        { group: 'Guard 1 (First Guard In)', label: 'Make sure each pool has a bin' },
        { group: 'Guard 1 (First Guard In)', label: 'Vacuum pools' },
        { group: 'Guard 2 (Second Guard In)', label: 'Cycle laundry' },
        { group: 'Guard 2 (Second Guard In)', label: 'Empty dehumidifiers' },
        { group: 'Guard 2 (Second Guard In)', label: 'Check playpen' },
        { group: 'Front Desk', label: 'Set up lobby' },
        { group: 'All Guards', label: 'Pick up a walkie' }
      ],
      closing: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Clean pool deck and close deck doors' },
        { group: 'Guard 1', label: 'Empty dehumidifiers' },
        { group: 'Guard 1', label: 'Cycle laundry' },
        { group: 'Guard 1', label: 'Clean bathrooms and leave doors open' },
        { group: 'Guard 2', label: 'Empty and change garbage bags' },
        { group: 'Guard 2', label: 'Vacuum facility (include playpen)' },
        { group: 'Guard 2', label: 'Mop floors' },
        { group: 'All Guards', label: 'Return walkie' }
      ]
    },
    weekend: {
      opening: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Make sure each pool has a bin' },
        { group: 'Guard 1', label: 'Vacuum pools' },
        { group: 'Guard 2', label: 'Set up lobby' },
        { group: 'Guard 2', label: 'Cycle laundry' },
        { group: 'Guard 2', label: 'Empty dehumidifiers' },
        { group: 'Guard 3 (Up for first rotation)', label: 'Check playpen' },
        { group: 'Guard 3 (Up for first rotation)', label: 'Restock snack wall, fridge, and coffee station' },
        { group: 'All Guards', label: 'Pick up a walkie' }
      ],
      closing: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Clean pool deck and close doors' },
        { group: 'Guard 2', label: 'Empty dehumidifiers' },
        { group: 'Guard 2', label: 'Empty and change garbage bags' },
        { group: 'Guard 2', label: 'Clean bathrooms and leave doors open' },
        { group: 'Guard 2', label: 'Cycle laundry' },
        { group: 'Guard 3 (Down for last rotation)', label: 'Vacuum facility/ include playpen' },
        { group: 'Guard 3 (Down for last rotation)', label: 'Mop floors' },
        { group: 'Front Desk', label: 'Tidy playpen / Close lobby' }
      ]
    },
    midday: [
      { group: 'All Guards', label: 'Check bathrooms during each rotation' },
      { group: 'All Guards', label: 'Sweep/Mop, clean toilet, stock TP' },
      { group: 'All Guards', label: 'Mirrors, hand railings, doorknob, walls' },
      { group: 'All Guards', label: 'Sign bathroom log' },
      { group: 'All Guards', label: 'Empty dehumidifiers' },
      { group: 'All Guards', label: 'Midday chemical check' },
      { group: 'All Guards', label: 'Laundry (client towels only)' },
      { group: 'All Guards', label: 'Do not start washer with fewer than 5 towels' },
      { group: 'All Guards', label: 'Do not change washer settings and use heavy duty setting for the dryer' },
      { group: 'All Guards', label: 'Hand vacuum / Sweep / Dry Mop' },
      { group: 'All Guards', label: 'Lobby, bathrooms, staff room, locker rooms' },
      { group: 'All Guards', label: 'Deck windows when time allows' }
    ]
  };

  let guardState = null;

  function guardStorageKey(date) {
    const locId = currentLocation?.id || 1;
    return `guardTasks_${locId}_${date}`;
  }

  function buildGuardTasks(template) {
    return template.map((item, idx) => ({
      id: `task_${idx}_${Math.random().toString(36).slice(2, 7)}`,
      label: item.label || item,
      group: item.group || null,
      initials: '',
      custom: false
    }));
  }

  function isWeekendDate(dateStr) {
    if (!dateStr) return false;
    const d = new Date(`${dateStr}T00:00:00`);
    const day = d.getDay();
    return day === 0 || day === 6;
  }

  function normalizeGuardTasks(list) {
    return (list || []).map((task) => ({
      ...task,
      group: task.group || null,
      initials: task.initials || (task.done ? '‚úì' : '')
    }));
  }

  function loadGuardState(date) {
    if (!date) return null;
    const key = guardStorageKey(date);
    const existing = localStorage.getItem(key);
    if (existing) {
      try {
        const parsed = JSON.parse(existing);
        const weekend = isWeekendDate(date);
        const dayType = weekend ? 'weekend' : 'weekday';
        return {
          date,
          dayType,
          guardNames: parsed.guardNames || { 1: '', 2: '', 3: '' },
          opening: normalizeGuardTasks(parsed.opening || buildGuardTasks(guardTaskTemplates[dayType].opening)),
          midday: normalizeGuardTasks(parsed.midday || buildGuardTasks(guardTaskTemplates.midday)),
          closing: normalizeGuardTasks(parsed.closing || buildGuardTasks(guardTaskTemplates[dayType].closing)),
          rotation: parsed.rotation || [],
          notes: parsed.notes || ''
        };
      } catch (_) {}
    }
    const weekend = isWeekendDate(date);
    const dayType = weekend ? 'weekend' : 'weekday';
    return {
      date,
      dayType,
      guardNames: { 1: '', 2: '', 3: '' },
      opening: normalizeGuardTasks(buildGuardTasks(guardTaskTemplates[dayType].opening)),
      midday: normalizeGuardTasks(buildGuardTasks(guardTaskTemplates.midday)),
      closing: normalizeGuardTasks(buildGuardTasks(guardTaskTemplates[dayType].closing)),
      rotation: [],
      notes: ''
    };
  }

  function saveGuardState() {
    if (!guardState?.date) return;
    localStorage.setItem(guardStorageKey(guardState.date), JSON.stringify(guardState));
  }

  function setGuardMeta() {
    if (!guardState?.date) return;
    const allTasks = [...guardState.opening, ...guardState.midday, ...guardState.closing];
    const doneCount = allTasks.filter(t => (t.initials || '').trim().length > 0).length;
    const totalCount = allTasks.length;
    const locName = currentLocation?.name || 'Unknown location';
    const dayLabel = guardState.dayType === 'weekend' ? 'Weekend' : 'Weekday';
    el('guardTasksMeta').textContent = `${locName} ‚Ä¢ ${guardState.date} ‚Ä¢ ${dayLabel} ‚Ä¢ ${doneCount}/${totalCount} tasks complete`;
  }

  function renderGuardSection(list, containerId, sectionKey) {
    const container = el(containerId);
    container.innerHTML = '';
    let lastGroup = null;
    list.forEach((task) => {
      if (task.group && task.group !== lastGroup) {
        const group = document.createElement('div');
        group.className = 'guard-group-title';
        group.textContent = task.group;
        container.appendChild(group);
        lastGroup = task.group;
      }
      const row = document.createElement('div');
      const isDone = (task.initials || '').trim().length > 0;
      row.className = `guard-task ${isDone ? 'done' : ''}`;

      const label = document.createElement('span');
      label.textContent = task.label;
      row.appendChild(label);

      const initials = document.createElement('input');
      initials.type = 'text';
      initials.maxLength = 4;
      initials.placeholder = 'Init';
      initials.value = task.initials || '';
      initials.addEventListener('input', () => {
        task.initials = initials.value.toUpperCase();
        saveGuardState();
        renderGuardTasks();
      });
      row.appendChild(initials);

      if (task.custom) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'miniBtn';
        removeBtn.textContent = '‚úï';
        removeBtn.addEventListener('click', () => {
          guardState[sectionKey] = guardState[sectionKey].filter(t => t.id !== task.id);
          saveGuardState();
          renderGuardTasks();
        });
        row.appendChild(removeBtn);
      }

      container.appendChild(row);
    });
  }

  function renderGuardRotation() {
    const body = el('guardRotationBody');
    body.innerHTML = '';
    const weekend = guardState.dayType === 'weekend';
    const rotationHint = el('guardRotationHint');
    if (weekend) {
      rotationHint.textContent = 'Weekend rotation starts with Guard 2 + 3, then 3 + 1, then 1 + 2 (repeat).';
      const guardLabels = {
        1: guardState.guardNames?.[1] ? `Guard 1 (${guardState.guardNames[1]})` : 'Guard 1',
        2: guardState.guardNames?.[2] ? `Guard 2 (${guardState.guardNames[2]})` : 'Guard 2',
        3: guardState.guardNames?.[3] ? `Guard 3 (${guardState.guardNames[3]})` : 'Guard 3'
      };
      const pattern = [
        [2, 3],
        [3, 1],
        [1, 2]
      ];
      const totalBlocks = 6;
      for (let i = 0; i < totalBlocks; i += 1) {
        const pair = pattern[i % pattern.length];
        const tr = document.createElement('tr');

        const tdBlock = document.createElement('td');
        tdBlock.textContent = `Block ${i + 1}`;
        tr.appendChild(tdBlock);

        const tdGuard = document.createElement('td');
        tdGuard.textContent = `${guardLabels[pair[0]]} + ${guardLabels[pair[1]]}`;
        tr.appendChild(tdGuard);

        const tdZone = document.createElement('td');
        tdZone.textContent = 'Rotation';
        tr.appendChild(tdZone);

        const tdRemove = document.createElement('td');
        tr.appendChild(tdRemove);

        body.appendChild(tr);
      }
      return;
    }

    rotationHint.textContent = 'Weekdays have no rotation unless updated manually.';
    guardState.rotation.forEach((entry, idx) => {
      const tr = document.createElement('tr');

      const tdTime = document.createElement('td');
      const timeInput = document.createElement('input');
      timeInput.value = entry.time || '';
      timeInput.addEventListener('input', () => {
        entry.time = timeInput.value;
        saveGuardState();
      });
      tdTime.appendChild(timeInput);
      tr.appendChild(tdTime);

      const tdGuard = document.createElement('td');
      const guardInput = document.createElement('input');
      guardInput.value = entry.guard || '';
      guardInput.addEventListener('input', () => {
        entry.guard = guardInput.value;
        saveGuardState();
      });
      tdGuard.appendChild(guardInput);
      tr.appendChild(tdGuard);

      const tdZone = document.createElement('td');
      const zoneInput = document.createElement('input');
      zoneInput.value = entry.zone || '';
      zoneInput.addEventListener('input', () => {
        entry.zone = zoneInput.value;
        saveGuardState();
      });
      tdZone.appendChild(zoneInput);
      tr.appendChild(tdZone);

      const tdRemove = document.createElement('td');
      const removeBtn = document.createElement('button');
      removeBtn.className = 'miniBtn';
      removeBtn.textContent = '‚úï';
      removeBtn.addEventListener('click', () => {
        guardState.rotation.splice(idx, 1);
        saveGuardState();
        renderGuardRotation();
      });
      tdRemove.appendChild(removeBtn);
      tr.appendChild(tdRemove);

      body.appendChild(tr);
    });
  }

  function renderGuardTasks() {
    if (!guardState) return;
    renderGuardSection(guardState.opening, 'guardOpeningList', 'opening');
    renderGuardSection(guardState.midday, 'guardMiddayList', 'midday');
    renderGuardSection(guardState.closing, 'guardClosingList', 'closing');
    renderGuardRotation();
    el('guardNotes').value = guardState.notes || '';
    el('guardName1').value = guardState.guardNames?.[1] || '';
    el('guardName2').value = guardState.guardNames?.[2] || '';
    el('guardName3').value = guardState.guardNames?.[3] || '';
    el('guardRotationAdd').style.display = guardState.dayType === 'weekend' ? 'none' : '';
    setGuardMeta();
  }

  function showGuardTasksPanel(fromPanel) {
    lastPanel = fromPanel;
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.add('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.remove('hidden');

    const defaultDate = managerDateRange?.start || activeDateISO || getTodayISO();
    const dateInput = el('guardTasksDate');
    if (dateInput && !dateInput.value) dateInput.value = defaultDate;
    guardState = loadGuardState(dateInput.value);
    renderGuardTasks();
  }

  async function loadAdminLocations() {
    try {
      const resp = await api('/api/locations');
      const list = el('locationsList');
      list.innerHTML = '';

      (resp.locations || []).forEach(loc => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,0.03); border-radius:8px;';

        const info = document.createElement('div');
        info.innerHTML = `<strong>${loc.name}</strong> (${loc.code}) <span class="tiny" style="color:var(--muted);">${loc.brand}</span>`;
        item.appendChild(info);

        const actions = document.createElement('div');
        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.style.cssText = 'padding:4px 12px; font-size:12px;';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeLocation(loc.id, loc.name));
        actions.appendChild(delBtn);
        item.appendChild(actions);

        list.appendChild(item);
      });
    } catch (e) {
      console.error('Failed to load admin locations:', e);
    }
  }

  async function loadStaff() {
    try {
      const resp = await api('/api/staff');
      const list = el('staffList');
      list.innerHTML = '';

      (resp.staff || []).forEach(staff => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,0.03); border-radius:8px;';

        const info = document.createElement('div');

        // Format birthday to show only month/day (remove year)
        let birthdayDisplay = '';
        if (staff.birthday) {
          const parts = staff.birthday.split('/');
          if (parts.length >= 2) {
            birthdayDisplay = `${parts[0]}/${parts[1]}`; // MM/DD only
          }
        }

        // Build info HTML with phone and birthday
        let infoHTML = `<strong>${staff.firstName} ${staff.lastName}</strong>`;
        infoHTML += ` <span class="tiny" style="color:var(--muted);">${staff.location}</span>`;
        if (staff.phone) {
          infoHTML += `<br><span class="tiny" style="color:var(--muted);">üìû ${staff.phone}</span>`;
        }
        if (birthdayDisplay) {
          infoHTML += ` <span class="tiny" style="color:var(--muted);">üéÇ ${birthdayDisplay}</span>`;
        }

        info.innerHTML = infoHTML;
        item.appendChild(info);

        const actions = document.createElement('div');
        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.style.cssText = 'padding:4px 12px; font-size:12px;';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeStaff(staff.id || `${staff.firstName}_${staff.lastName}`, `${staff.firstName} ${staff.lastName}`));
        actions.appendChild(delBtn);
        item.appendChild(actions);

        list.appendChild(item);
      });
    } catch (e) {
      console.error('Failed to load staff:', e);
    }
  }

  async function removeLocation(id, name) {
    if (!confirm(`Remove location: ${name}?\n\nThis will affect all rosters and settings for this location.`)) return;

    try {
      await api('/api/admin/remove-location', {
        method: 'POST',
        body: JSON.stringify({ id })
      });
      alert(`Location "${name}" removed successfully.`);
      loadAdminLocations();
      await loadLocations(); // Also update main dropdown
    } catch (e) {
      alert(`Failed to remove location: ${e.message}`);
    }
  }

  async function removeStaff(id, name) {
    if (!confirm(`Remove staff member: ${name}?`)) return;

    try {
      await api('/api/admin/remove-staff', {
        method: 'POST',
        body: JSON.stringify({ id })
      });
      alert(`Staff member "${name}" removed successfully.`);
      loadStaff();
    } catch (e) {
      alert(`Failed to remove staff: ${e.message}`);
    }
  }

  // Store swimmer data globally for attendance modal
  let swimmersData = [];

  // Load detailed swimmer information for Virtual Desk
  async function loadSwimmerDetails() {
    try {
      const date = activeDateISO || new Date().toISOString().split('T')[0];
      const location_id = currentLocation?.id || 1;

      const resp = await api(`/api/virtual-desk/swimmers?date=${date}&location_id=${location_id}`);

      if (!resp.ok || !resp.swimmers) {
        el('swimmerDetailsTable').innerHTML = '<p style="color:var(--muted); text-align:center; padding:20px;">No swimmers found for today.</p>';
        return;
      }

      // Store data globally
      swimmersData = resp.swimmers;

      // Apply sorting
      let swimmers = swimmersData;
      const sortBy = el('swimmerSortBy').value;

      if (sortBy === 'name') {
        swimmers.sort((a, b) => a.swimmer_name.localeCompare(b.swimmer_name));
      } else if (sortBy === 'time') {
        swimmers.sort((a, b) => a.start_time.localeCompare(b.start_time));
      } else if (sortBy === 'instructor') {
        swimmers.sort((a, b) => (a.instructor_name || '').localeCompare(b.instructor_name || ''));
      } else if (sortBy === 'attendance_rate') {
        swimmers.sort((a, b) => (b.stats?.attendance_rate || 0) - (a.stats?.attendance_rate || 0));
      } else if (sortBy === 'missed') {
        swimmers.sort((a, b) => (b.stats?.missed || 0) - (a.stats?.missed || 0));
      } else if (sortBy === 'balance') {
        const statusOrder = { 'owes': 3, 'policy': 2, 'current': 1 };
        swimmers.sort((a, b) => (statusOrder[b.balance_status] || 0) - (statusOrder[a.balance_status] || 0));
      }

      // Build table
      let html = '<table><thead><tr>';
      html += '<th>Swimmer</th>';
      html += '<th>Time</th>';
      html += '<th>Program</th>';
      html += '<th>Instructor</th>';
      html += '<th>Total Classes</th>';
      html += '<th>Attended</th>';
      html += '<th>Missed</th>';
      html += '<th>Attendance %</th>';
      html += '<th>Balance</th>';
      html += '<th>Flags</th>';
      html += '</tr></thead><tbody>';

      swimmers.forEach(s => {
        html += '<tr>';

        // Swimmer name
        html += `<td><strong>${s.swimmer_name}</strong>`;
        if (s.age_text) html += `<br><span class="tiny" style="color:var(--muted);">${s.age_text}</span>`;
        html += '</td>';

        // Time
        html += `<td>${fmtTime(s.start_time)}</td>`;

        // Program
        html += `<td><span class="tiny">${s.program || '‚Äî'}</span></td>`;

        // Instructor
        html += '<td>';
        if (s.substitute_instructor) {
          html += `<span style="font-weight:700;">${s.substitute_instructor}</span>`;
          html += `<span class="badge" style="background:rgba(251,191,36,0.15); color:#fbbf24; border-color:rgba(251,191,36,0.3); margin-left:4px; font-size:10px;">SUB</span>`;
          if (s.instructor_name) html += `<br><span class="tiny" style="color:var(--muted); text-decoration:line-through;">${s.instructor_name}</span>`;
        } else {
          html += s.instructor_name || '‚Äî';
        }
        html += '</td>';

        // Stats
        html += `<td style="text-align:center;">${s.stats?.total_classes || 0}</td>`;
        html += `<td style="text-align:center; color:var(--good);">${s.stats?.attended || 0}</td>`;
        html += `<td style="text-align:center; color:var(--bad);">${s.stats?.missed || 0}</td>`;

        // Attendance rate with color (clickable)
        const rate = s.stats?.attendance_rate || 0;
        let rateColor = 'var(--good)';
        if (rate < 70) rateColor = 'var(--bad)';
        else if (rate < 85) rateColor = 'var(--warn)';
        const swimmerIndex = swimmers.indexOf(s);
        html += `<td style="text-align:center;">`;
        html += `<span onclick="showAttendanceHistory(${swimmerIndex})" style="color:${rateColor}; font-weight:700; cursor:pointer; text-decoration:underline; padding:4px 8px; border-radius:4px; background:rgba(255,255,255,0.05);">${rate}%</span>`;
        html += `</td>`;

        // Balance - show actual dollar amount or status
        html += '<td style="text-align:center;">';
        if (s.balance_amount !== null && s.balance_amount !== undefined) {
          const balStr = s.balance_amount < 0 ? `-$${Math.abs(s.balance_amount).toFixed(2)}` : `$${s.balance_amount.toFixed(2)}`;
          const balColor = s.balance_amount > 0 ? 'var(--bad)' : s.balance_amount < 0 ? 'var(--good)' : 'var(--muted)';
          html += `<span style="color:${balColor}; font-weight:700;">${balStr}</span>`;
        } else if (s.balance_status === 'owes') {
          html += '<span class="badge" style="background:rgba(239,68,68,0.15); color:#ef4444; border-color:rgba(239,68,68,0.3);">Owes</span>';
        } else if (s.balance_status === 'policy') {
          html += '<span class="badge" style="background:rgba(245,158,11,0.15); color:#f59e0b; border-color:rgba(245,158,11,0.3);">Policy</span>';
        } else {
          html += '<span class="tiny" style="color:var(--muted);">‚Äî</span>';
        }
        html += '</td>';

        // Flags
        html += '<td>';
        const flags = [];
        if (s.flags?.new) flags.push('<span class="badge" style="background:rgba(34,197,94,0.15); color:#22c55e;">New</span>');
        if (s.flags?.makeup) flags.push('<span class="badge" style="background:rgba(59,130,246,0.15); color:#3b82f6;">Makeup</span>');
        if (s.flags?.trial) flags.push('<span class="badge" style="background:rgba(234,179,8,0.15); color:#eab308;">Trial</span>');
        if (s.is_addon) flags.push('<span class="badge addon">Add-on</span>');
        html += flags.join(' ') || '‚Äî';
        html += '</td>';

        html += '</tr>';
      });

      html += '</tbody></table>';

      el('swimmerDetailsTable').innerHTML = html;

    } catch (e) {
      console.error('Failed to load swimmer details:', e);
      el('swimmerDetailsTable').innerHTML = `<p style="color:var(--bad); text-align:center; padding:20px;">Error: ${e.message}</p>`;
    }
  }

  // Event handlers for swimmer details view
  el('swimmerSortBy').addEventListener('change', loadSwimmerDetails);
  el('refreshSwimmers').addEventListener('click', loadSwimmerDetails);

  // Show attendance history modal
  window.showAttendanceHistory = function(swimmerIndex) {
    const swimmer = swimmersData[swimmerIndex];
    if (!swimmer || !swimmer.attendance_history) return;

    el('attendanceHistoryTitle').textContent = `Attendance History: ${swimmer.swimmer_name}`;

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>Date</th>';
    html += '<th>Time</th>';
    html += '<th>Status</th>';
    html += '<th>Program</th>';
    html += '<th>Instructor</th>';
    html += '</tr></thead><tbody>';

    swimmer.attendance_history.forEach(record => {
      const statusText = record.attendance === 1 ? 'Attended' : record.attendance === 0 ? 'Missed' : '‚Äî';
      const statusColor = record.attendance === 1 ? 'var(--good)' : record.attendance === 0 ? 'var(--bad)' : 'var(--muted)';

      html += '<tr>';
      html += `<td>${record.date}</td>`;
      html += `<td>${fmtTime(record.start_time)}</td>`;
      html += `<td style="color:${statusColor}; font-weight:700;">${statusText}</td>`;
      html += `<td><span class="tiny">${record.program || '‚Äî'}</span></td>`;
      html += `<td>${record.instructor_name || '‚Äî'}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';

    // Add summary
    const attended = swimmer.stats?.attended || 0;
    const missed = swimmer.stats?.missed || 0;
    const rate = swimmer.stats?.attendance_rate || 0;

    html += '<div style="margin-top:16px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">';
    html += '<div style="display:flex; gap:20px; justify-content:center;">';
    html += `<div><span class="tiny" style="color:var(--muted);">Total:</span> <strong>${swimmer.stats?.total_classes || 0}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Attended:</span> <strong style="color:var(--good);">${attended}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Missed:</span> <strong style="color:var(--bad);">${missed}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Rate:</span> <strong style="color:var(--good);">${rate}%</strong></div>`;
    html += '</div></div>';

    el('attendanceHistoryContent').innerHTML = html;
    showModal('attendanceHistoryModal', true);
  };

  el('attendanceHistoryClose').addEventListener('click', () => showModal('attendanceHistoryModal', false));
  el('attendanceHistoryModal').addEventListener('click', (e) => {
    if (e.target === el('attendanceHistoryModal')) showModal('attendanceHistoryModal', false);
  });

  function formatBytes(bytes) {
    if (!bytes && bytes !== 0) return '‚Äî';
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let idx = 0;
    while (size >= 1024 && idx < units.length - 1) {
      size /= 1024;
      idx += 1;
    }
    return `${size.toFixed(size >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;
  }

  function formatShortDate(dateStr) {
    if (!dateStr) return '‚Äî';
    const parts = String(dateStr).split('T')[0].split('-');
    if (parts.length !== 3) return dateStr;
    return `${parts[1]}/${parts[2]}/${parts[0]}`;
  }

  async function loadServerExports() {
    const locId = currentLocation?.id || 1;
    const resp = await api(`/api/server-exports?location_id=${locId}`);
    const list = resp.exports || [];
    el('serverExportLocation').textContent = currentLocation?.name || 'Unknown';

    if (!list.length) {
      el('serverExportList').innerHTML = '<div class="tiny" style="color:var(--muted); padding:8px;">No server backups found.</div>';
      return;
    }

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>File</th><th>Modified</th><th>Size</th><th>Action</th>';
    html += '</tr></thead><tbody>';
    list.forEach((item) => {
      html += '<tr>';
      html += `<td><span class="tiny">${escapeHtml(item.filename)}</span></td>`;
      html += `<td>${formatShortDate(item.modified_at)}</td>`;
      html += `<td>${formatBytes(item.size)}</td>`;
      html += `<td><button class="secondary" data-file="${escapeHtml(item.filename)}">Import</button></td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';
    el('serverExportList').innerHTML = html;

    el('serverExportList').querySelectorAll('button[data-file]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const filename = btn.getAttribute('data-file');
        if (!filename) return;
        if (!confirm(`Import server backup: ${filename}?\n\nThis will replace the current roster for the active date.`)) return;
        try {
          btn.disabled = true;
          await api('/api/import-server', {
            method: 'POST',
            body: JSON.stringify({
              location_id: currentLocation?.id || 1,
              filename
            })
          });
          showModal('serverImportModal', false);
          await loadStatus();
          await loadBlocks();
          await loadRoster();
          toast('Server import complete');
        } catch (err) {
          alert('Import failed: ' + (err.message || err));
        } finally {
          btn.disabled = false;
        }
      });
    });
  }

  async function loadTrialReport() {
    const locId = currentLocation?.id || 1;
    const days = 30;
    el('trialDaysLabel').textContent = String(days);
    const resp = await api(`/api/trials?location_id=${locId}&days=${days}`);
    const trials = resp.trials || [];

    if (!trials.length) {
      el('trialSummary').textContent = 'No trial swimmers found for this period.';
      el('trialReportTable').innerHTML = '';
      return;
    }

    const statusCounts = trials.reduce((acc, t) => {
      const status = t.follow_up?.status || 'new';
      acc[status] = (acc[status] || 0) + 1;
      return acc;
    }, {});
    const summary = Object.entries(statusCounts)
      .map(([status, count]) => `${status}: ${count}`)
      .join(' ‚Ä¢ ');
    el('trialSummary').textContent = `Total trials: ${trials.length} ‚Ä¢ ${summary}`;

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>Swimmer</th><th>Last Seen</th><th>Program</th><th>Instructor</th><th>Visits</th><th>Status</th><th>Last Contact</th><th>Next Follow-up</th><th>Notes</th><th>Save</th>';
    html += '</tr></thead><tbody>';

    trials.forEach((t) => {
      const follow = t.follow_up || {};
      const status = follow.status || 'new';
      html += '<tr>';
      html += `<td><strong>${escapeHtml(t.swimmer_name)}</strong></td>`;
      html += `<td>${formatShortDate(t.last_date)}</td>`;
      html += `<td><span class="tiny">${escapeHtml(t.program || '‚Äî')}</span></td>`;
      html += `<td>${escapeHtml(t.instructor_name || '‚Äî')}</td>`;
      html += `<td style="text-align:center;">${t.trial_visits || 0}</td>`;
      html += '<td>';
      html += `<select data-field="status" data-swimmer="${escapeHtml(t.swimmer_name)}">`;
      ['new','contacted','scheduled','converted','lost'].forEach((opt) => {
        html += `<option value="${opt}" ${opt === status ? 'selected' : ''}>${opt}</option>`;
      });
      html += '</select>';
      html += '</td>';
      html += `<td><input type="date" data-field="last_contact" data-swimmer="${escapeHtml(t.swimmer_name)}" value="${escapeHtml(follow.last_contact_at || '')}" /></td>`;
      html += `<td><input type="date" data-field="next_follow" data-swimmer="${escapeHtml(t.swimmer_name)}" value="${escapeHtml(follow.next_follow_up_at || '')}" /></td>`;
      html += `<td><input type="text" data-field="notes" data-swimmer="${escapeHtml(t.swimmer_name)}" value="${escapeHtml(follow.notes || '')}" placeholder="Notes" /></td>`;
      html += `<td><button class="secondary" data-action="save" data-swimmer="${escapeHtml(t.swimmer_name)}">Save</button></td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    el('trialReportTable').innerHTML = html;

    el('trialReportTable').querySelectorAll('button[data-action="save"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const swimmer = btn.getAttribute('data-swimmer');
        if (!swimmer) return;
        const safeSwimmer = escapeSelector(swimmer);
        const status = el('trialReportTable').querySelector(`select[data-field="status"][data-swimmer="${safeSwimmer}"]`)?.value;
        const lastContact = el('trialReportTable').querySelector(`input[data-field="last_contact"][data-swimmer="${safeSwimmer}"]`)?.value || '';
        const nextFollow = el('trialReportTable').querySelector(`input[data-field="next_follow"][data-swimmer="${safeSwimmer}"]`)?.value || '';
        const notes = el('trialReportTable').querySelector(`input[data-field="notes"][data-swimmer="${safeSwimmer}"]`)?.value || '';
        try {
          btn.disabled = true;
          await api('/api/trials/followup', {
            method: 'POST',
            body: JSON.stringify({
              swimmer_name: swimmer,
              location_id: currentLocation?.id || 1,
              status,
              last_contact_at: lastContact || null,
              next_follow_up_at: nextFollow || null,
              notes
            })
          });
          toast('Follow-up saved');
        } catch (err) {
          alert('Save failed: ' + (err.message || err));
        } finally {
          btn.disabled = false;
        }
      });
    });
  }

  el('trialCloseBtn').addEventListener('click', () => showModal('trialFollowupModal', false));
  el('trialFollowupModal').addEventListener('click', (e) => {
    if (e.target === el('trialFollowupModal')) showModal('trialFollowupModal', false);
  });
  el('trialRefreshBtn').addEventListener('click', loadTrialReport);

  el('serverImportClose').addEventListener('click', () => showModal('serverImportModal', false));
  el('serverImportModal').addEventListener('click', (e) => {
    if (e.target === el('serverImportModal')) showModal('serverImportModal', false);
  });
  el('serverExportRefresh').addEventListener('click', loadServerExports);

  // Add Location Modal
  el('addLocationBtn').addEventListener('click', () => {
    el('newLocationName').value = '';
    el('newLocationShortCode').value = '';
    el('newLocationBrand').value = 'swimlabs';
    showModal('addLocationModal', true);
  });

  el('addLocationCancel').addEventListener('click', () => showModal('addLocationModal', false));
  el('addLocationModal').addEventListener('click', (e) => {
    if (e.target === el('addLocationModal')) showModal('addLocationModal', false);
  });

  el('addLocationSave').addEventListener('click', async () => {
    const name = el('newLocationName').value.trim();
    const short_code = el('newLocationShortCode').value.trim();
    const brand = el('newLocationBrand').value;

    if (!name) {
      alert('Location name is required');
      return;
    }

    try {
      await api('/api/admin/add-location', {
        method: 'POST',
        body: JSON.stringify({ name, short_code, brand })
      });
      alert(`Location "${name}" added successfully.`);
      showModal('addLocationModal', false);
      loadAdminLocations();
      // Reload location dropdown
      await loadLocations();
    } catch (e) {
      alert(`Failed to add location: ${e.message}`);
    }
  });

  // Add Staff Modal
  el('addStaffBtn').addEventListener('click', () => {
    el('newStaffFirstName').value = '';
    el('newStaffLastName').value = '';
    el('newStaffLocation').value = 'New York';
    el('newStaffPhone').value = '';
    el('newStaffBirthday').value = '';
    showModal('addStaffModal', true);
  });

  el('addStaffCancel').addEventListener('click', () => showModal('addStaffModal', false));
  el('addStaffModal').addEventListener('click', (e) => {
    if (e.target === el('addStaffModal')) showModal('addStaffModal', false);
  });

  el('addStaffSave').addEventListener('click', async () => {
    const firstName = el('newStaffFirstName').value.trim();
    const lastName = el('newStaffLastName').value.trim();
    const location = el('newStaffLocation').value;
    const phone = el('newStaffPhone').value.trim();
    const birthday = el('newStaffBirthday').value.trim();

    if (!firstName || !lastName) {
      alert('First name and last name are required');
      return;
    }

    try {
      await api('/api/admin/add-staff', {
        method: 'POST',
        body: JSON.stringify({ firstName, lastName, location, phone, birthday })
      });
      alert(`Staff member "${firstName} ${lastName}" added successfully.`);
      showModal('addStaffModal', false);
      loadStaff();
    } catch (e) {
      alert(`Failed to add staff: ${e.message}`);
    }
  });

  // PIN modal handlers
  el('pinCancel').addEventListener('click', () => {
    showModal('pinModal', false);
  });

  el('pinSubmit').addEventListener('click', async () => {
    const pin = el('pinInput').value.trim();

    if (!pin || pin.length !== 4) {
      el('pinError').textContent = 'Please enter a 4-digit PIN';
      el('pinError').style.display = 'block';
      return;
    }

    try {
      const resp = await api('/api/verify-pin', {
        method: 'POST',
        body: JSON.stringify({ pin })
      });

      if (resp.ok && resp.authenticated) {
        // Success!
        sessionStorage.setItem('admin_pin_auth', 'true');
        sessionStorage.setItem('admin_pin_expiry', resp.expires_at.toString());

        showModal('pinModal', false);

        // Show the panel that requested auth
        if (pendingPinPanel === 'admin') {
          showAdminPanel();
        } else {
          showVirtualDeskPanel();
        }
        pendingPinPanel = null;
      }
    } catch (e) {
      if (e.message.includes('Too many failed attempts')) {
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'block';
      } else {
        el('pinLockout').style.display = 'none';
        el('pinError').textContent = e.message || 'Incorrect PIN. Try again.';
        el('pinError').style.display = 'block';
      }
      el('pinInput').value = '';
      el('pinInput').focus();
    }
  });

  // Allow Enter key to submit PIN
  el('pinInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      el('pinSubmit').click();
    }
  });

  // Admin navigation cards
  el('adminNavAbsence').addEventListener('click', () => {
    alert('Absence Tracker\n\nComing in Session 9!\n\nThis will track multi-week absences and help you follow up with families.');
  });

  el('adminNavTrials').addEventListener('click', () => {
    loadTrialReport();
    showModal('trialFollowupModal', true);
  });

  el('adminNavGuards').addEventListener('click', () => {
    showGuardTasksPanel('virtualDesk');
  });

  el('adminNavHistory').addEventListener('click', () => {
    openAttendanceReport();
  });

  el('adminNavObservations').addEventListener('click', () => {
    openInstructorReport();
  });

  el('guardTasksBack').addEventListener('click', () => {
    if (lastPanel === 'virtualDesk') {
      showVirtualDeskPanel();
    } else if (lastPanel === 'lifeguard') {
      el('viewSelect').value = 'roster';
      el('panelRoster').classList.remove('hidden');
      el('panelGuardTasks').classList.add('hidden');
    } else {
      el('viewSelect').value = 'roster';
      el('panelRoster').classList.remove('hidden');
      el('panelGuardTasks').classList.add('hidden');
    }
  });

  el('guardTasksDate').addEventListener('change', () => {
    guardState = loadGuardState(el('guardTasksDate').value);
    renderGuardTasks();
  });

  ['guardName1', 'guardName2', 'guardName3'].forEach((id, idx) => {
    el(id).addEventListener('input', () => {
      if (!guardState) return;
      guardState.guardNames = guardState.guardNames || { 1: '', 2: '', 3: '' };
      guardState.guardNames[idx + 1] = el(id).value.trim();
      saveGuardState();
      renderGuardRotation();
    });
  });

  el('guardTasksShuffle').addEventListener('click', () => {
    if (!guardState) return;
    const names = [el('guardName1').value.trim(), el('guardName2').value.trim(), el('guardName3').value.trim()].filter(Boolean);
    if (names.length < 2) {
      alert('Enter at least two guard names to randomize.');
      return;
    }
    for (let i = names.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [names[i], names[j]] = [names[j], names[i]];
    }
    guardState.guardNames = {
      1: names[0] || '',
      2: names[1] || '',
      3: names[2] || ''
    };
    saveGuardState();
    renderGuardTasks();
  });

  el('guardRotationAdd').addEventListener('click', () => {
    guardState.rotation.push({ time: '', guard: '', zone: '' });
    saveGuardState();
    renderGuardRotation();
  });

  el('guardNotes').addEventListener('input', () => {
    if (!guardState) return;
    guardState.notes = el('guardNotes').value;
    saveGuardState();
  });

  el('guardTasksReset').addEventListener('click', () => {
    const date = el('guardTasksDate').value;
    if (!date) return;
    if (!confirm('Reset all guard tasks and notes for this date?')) return;
    localStorage.removeItem(guardStorageKey(date));
    guardState = loadGuardState(date);
    saveGuardState();
    renderGuardTasks();
  });

  // Virtual Desk Export
  el('exportVirtualDeskBtn').addEventListener('click', async () => {
    if (!currentLocation || !activeDateISO) {
      alert('Please select a location and date first.');
      return;
    }
    const format = prompt('Export format: Enter "csv" or "json" (default: csv)', 'csv');
    if (format === null) return;
    const fmt = format.toLowerCase() === 'json' ? 'json' : 'csv';
    window.location.href = `/api/reports/virtual-desk/export?date=${activeDateISO}&location_id=${currentLocation.id}&format=${fmt}`;
  });

  // Open Attendance Report Modal
  el('openAttendanceReportBtn').addEventListener('click', openAttendanceReport);
  el('openInstructorReportBtn').addEventListener('click', openInstructorReport);

  function openAttendanceReport() {
    if (managerDateRange?.start && managerDateRange?.end) {
      el('attendanceReportStartDate').value = managerDateRange.start;
      el('attendanceReportEndDate').value = managerDateRange.end;
    } else {
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      el('attendanceReportEndDate').value = today.toISOString().split('T')[0];
      el('attendanceReportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    el('attendanceReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Select a date range and click "Generate Report" to view attendance analytics.</div>`;
    showModal('attendanceReportModal', true);
  }

  function openInstructorReport() {
    if (managerDateRange?.start && managerDateRange?.end) {
      el('instructorReportStartDate').value = managerDateRange.start;
      el('instructorReportEndDate').value = managerDateRange.end;
    } else {
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      el('instructorReportEndDate').value = today.toISOString().split('T')[0];
      el('instructorReportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    el('instructorReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Select a date range and click "Generate Report" to view instructor analytics.</div>`;
    showModal('instructorReportModal', true);
  }

  function toISODate(date) {
    return date.toISOString().split('T')[0];
  }

  function getWeekRange(date = new Date()) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    const start = new Date(d);
    start.setDate(d.getDate() + diff);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return { start: toISODate(start), end: toISODate(end) };
  }

  function getMonthRange(date = new Date()) {
    const start = new Date(date.getFullYear(), date.getMonth(), 1);
    const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    return { start: toISODate(start), end: toISODate(end) };
  }

  function setManagerRangeInputsOnly(range) {
    if (el('managerRangeStart')) el('managerRangeStart').value = range.start;
    if (el('managerRangeEnd')) el('managerRangeEnd').value = range.end;
  }

  el('managerRangeWeek').addEventListener('click', () => setManagerRangeInputsOnly(getWeekRange()));
  el('managerRangeNextTwo').addEventListener('click', () => {
    const start = new Date();
    const end = new Date();
    end.setDate(start.getDate() + 13);
    setManagerRangeInputsOnly({ start: toISODate(start), end: toISODate(end) });
  });
  el('managerRangeMonth').addEventListener('click', () => setManagerRangeInputsOnly(getMonthRange()));
  el('managerRangeSave').addEventListener('click', async () => {
    const start = el('managerRangeStart').value;
    const end = el('managerRangeEnd').value;
    if (!start || !end) {
      alert('Please select both start and end dates.');
      return;
    }
    try {
      const resp = await api('/api/manager-date-range', {
        method: 'POST',
        body: JSON.stringify({ start, end })
      });
      applyManagerDateRange(resp.range);
      toast('Manager date brackets saved');
    } catch (err) {
      alert('Save failed: ' + (err.message || err));
    }
  });

  // Attendance Report Handlers
  el('attendanceReportGenerate').addEventListener('click', async () => {
    const startDate = el('attendanceReportStartDate').value;
    const endDate = el('attendanceReportEndDate').value;
    if (!startDate || !endDate) {
      alert('Please select both start and end dates.');
      return;
    }
    if (!currentLocation) {
      alert('Please select a location first.');
      return;
    }

    el('attendanceReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Loading report...</div>`;

    try {
      const resp = await api(`/api/reports/attendance?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}`);
      if (!resp.ok) throw new Error(resp.error || 'Failed to generate report');

      const report = resp.report;
      const summary = report.summary;

      let html = `
        <div style="margin-bottom:20px;">
          <div class="row" style="gap:12px; flex-wrap:wrap;">
            <div class="card" style="flex:1; min-width:140px; background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.2);">
              <div class="tiny" style="color:var(--muted);">Attendance Rate</div>
              <div style="font-size:24px; font-weight:900; color:#22c55e;">${summary.overall_attendance_rate}%</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2);">
              <div class="tiny" style="color:var(--muted);">Total Swimmers</div>
              <div style="font-size:24px; font-weight:900; color:#3b82f6;">${summary.unique_swimmers}</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(234,179,8,0.08); border-color: rgba(234,179,8,0.2);">
              <div class="tiny" style="color:var(--muted);">Class Entries</div>
              <div style="font-size:24px; font-weight:900; color:#eab308;">${summary.total_entries}</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(168,85,247,0.08); border-color: rgba(168,85,247,0.2);">
              <div class="tiny" style="color:var(--muted);">Days Tracked</div>
              <div style="font-size:24px; font-weight:900; color:#a855f7;">${summary.days_with_classes}</div>
            </div>
          </div>
        </div>

        <div class="row" style="gap:12px; margin-bottom:16px; flex-wrap:wrap;">
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#22c55e;">${summary.total_present}</div>
            <div class="tiny" style="color:var(--muted);">Present</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#ef4444;">${summary.total_absent}</div>
            <div class="tiny" style="color:var(--muted);">Absent</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#f97316;">${summary.total_trials}</div>
            <div class="tiny" style="color:var(--muted);">Trials</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#06b6d4;">${summary.total_new_swimmers}</div>
            <div class="tiny" style="color:var(--muted);">New</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#8b5cf6;">${summary.total_makeups}</div>
            <div class="tiny" style="color:var(--muted);">Makeups</div>
          </div>
        </div>

        <h4 style="margin:16px 0 8px; font-size:14px;">By Program</h4>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                <th style="padding:8px;">Program</th>
                <th style="padding:8px;">Total</th>
                <th style="padding:8px;">Present</th>
                <th style="padding:8px;">Absent</th>
                <th style="padding:8px;">Rate</th>
              </tr>
            </thead>
            <tbody>
              ${report.by_program.map(p => `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                  <td style="padding:8px;">${p.program || 'Unknown'}</td>
                  <td style="padding:8px;">${p.total}</td>
                  <td style="padding:8px; color:#22c55e;">${p.present}</td>
                  <td style="padding:8px; color:#ef4444;">${p.absent}</td>
                  <td style="padding:8px;"><span style="color:${p.attendance_rate >= 80 ? '#22c55e' : p.attendance_rate >= 60 ? '#eab308' : '#ef4444'}">${p.attendance_rate}%</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${report.low_attendance_swimmers.length > 0 ? `
          <h4 style="margin:16px 0 8px; font-size:14px; color:#ef4444;">Low Attendance Swimmers (&lt;70%)</h4>
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                  <th style="padding:8px;">Swimmer</th>
                  <th style="padding:8px;">Classes</th>
                  <th style="padding:8px;">Attended</th>
                  <th style="padding:8px;">Missed</th>
                  <th style="padding:8px;">Rate</th>
                </tr>
              </thead>
              <tbody>
                ${report.low_attendance_swimmers.map(s => `
                  <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                    <td style="padding:8px;">${s.swimmer_name}</td>
                    <td style="padding:8px;">${s.total_classes}</td>
                    <td style="padding:8px; color:#22c55e;">${s.attended}</td>
                    <td style="padding:8px; color:#ef4444;">${s.missed}</td>
                    <td style="padding:8px; color:#ef4444;">${s.attendance_rate}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      `;

      el('attendanceReportContent').innerHTML = html;
    } catch (e) {
      el('attendanceReportContent').innerHTML = `<div class="tiny" style="color:#ef4444; text-align:center; padding:40px;">Error: ${e.message}</div>`;
    }
  });

  el('attendanceReportExportCSV').addEventListener('click', () => {
    const startDate = el('attendanceReportStartDate').value;
    const endDate = el('attendanceReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/attendance/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=csv`;
  });

  el('attendanceReportExportJSON').addEventListener('click', () => {
    const startDate = el('attendanceReportStartDate').value;
    const endDate = el('attendanceReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/attendance/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=json`;
  });

  el('attendanceReportClose').addEventListener('click', () => showModal('attendanceReportModal', false));
  el('attendanceReportModal').addEventListener('click', (e) => { if(e.target === el('attendanceReportModal')) showModal('attendanceReportModal', false); });

  // Instructor Report Handlers
  el('instructorReportGenerate').addEventListener('click', async () => {
    const startDate = el('instructorReportStartDate').value;
    const endDate = el('instructorReportEndDate').value;
    if (!startDate || !endDate) {
      alert('Please select both start and end dates.');
      return;
    }
    if (!currentLocation) {
      alert('Please select a location first.');
      return;
    }

    el('instructorReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Loading report...</div>`;

    try {
      const resp = await api(`/api/reports/instructors?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}`);
      if (!resp.ok) throw new Error(resp.error || 'Failed to generate report');

      const report = resp.report;
      const summary = report.summary;

      let html = `
        <div style="margin-bottom:20px;">
          <div class="row" style="gap:12px; flex-wrap:wrap;">
            <div class="card" style="flex:1; min-width:140px; background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2);">
              <div class="tiny" style="color:var(--muted);">Total Instructors</div>
              <div style="font-size:24px; font-weight:900; color:#3b82f6;">${summary.total_instructors}</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.2);">
              <div class="tiny" style="color:var(--muted);">Avg Attendance Rate</div>
              <div style="font-size:24px; font-weight:900; color:#22c55e;">${summary.average_attendance_rate}%</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(234,179,8,0.08); border-color: rgba(234,179,8,0.2);">
              <div class="tiny" style="color:var(--muted);">Total Class Entries</div>
              <div style="font-size:24px; font-weight:900; color:#eab308;">${summary.total_class_entries}</div>
            </div>
          </div>
        </div>

        ${report.highlights.top_by_attendance.length > 0 ? `
          <h4 style="margin:16px 0 8px; font-size:14px;">Top Performers (by Class Attendance Rate)</h4>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:16px;">
            ${report.highlights.top_by_attendance.map((i, idx) => `
              <div class="card" style="flex:1; min-width:150px; text-align:center; background: ${idx === 0 ? 'rgba(234,179,8,0.15)' : 'rgba(255,255,255,0.05)'};">
                <div style="font-size:11px; color:var(--muted);">#${idx + 1}</div>
                <div style="font-weight:700; font-size:14px;">${i.name}</div>
                <div style="font-size:20px; font-weight:900; color:#22c55e;">${i.attendance_rate}%</div>
                <div class="tiny" style="color:var(--muted);">${i.total_entries} entries</div>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <h4 style="margin:16px 0 8px; font-size:14px;">All Instructors</h4>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                <th style="padding:8px;">Instructor</th>
                <th style="padding:8px;">Days</th>
                <th style="padding:8px;">Entries</th>
                <th style="padding:8px;">Swimmers</th>
                <th style="padding:8px;">Present</th>
                <th style="padding:8px;">Absent</th>
                <th style="padding:8px;">Rate</th>
                <th style="padding:8px;">Programs</th>
              </tr>
            </thead>
            <tbody>
              ${report.instructors.map(i => `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                  <td style="padding:8px; font-weight:600;">${i.instructor_name}</td>
                  <td style="padding:8px;">${i.days_worked}</td>
                  <td style="padding:8px;">${i.total_class_entries}</td>
                  <td style="padding:8px;">${i.unique_swimmers}</td>
                  <td style="padding:8px; color:#22c55e;">${i.swimmers_present}</td>
                  <td style="padding:8px; color:#ef4444;">${i.swimmers_absent}</td>
                  <td style="padding:8px;"><span style="color:${i.class_attendance_rate >= 80 ? '#22c55e' : i.class_attendance_rate >= 60 ? '#eab308' : '#ef4444'}">${i.class_attendance_rate}%</span></td>
                  <td style="padding:8px;">${i.programs_taught}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      el('instructorReportContent').innerHTML = html;
    } catch (e) {
      el('instructorReportContent').innerHTML = `<div class="tiny" style="color:#ef4444; text-align:center; padding:40px;">Error: ${e.message}</div>`;
    }
  });

  el('instructorReportExportCSV').addEventListener('click', () => {
    const startDate = el('instructorReportStartDate').value;
    const endDate = el('instructorReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/instructors/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=csv`;
  });

  el('instructorReportExportJSON').addEventListener('click', () => {
    const startDate = el('instructorReportStartDate').value;
    const endDate = el('instructorReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/instructors/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=json`;
  });

  el('instructorReportClose').addEventListener('click', () => showModal('instructorReportModal', false));
  el('instructorReportModal').addEventListener('click', (e) => { if(e.target === el('instructorReportModal')) showModal('instructorReportModal', false); });

  el('adminNavClearRoster').addEventListener('click', async () => {
    const locationName = currentLocation?.name || 'Unknown';
    const locationCode = currentLocation?.code || 'Unknown';

    const confirmMsg = `‚ö†Ô∏è CLEAR ROSTER FOR ${locationName.toUpperCase()}\n\n` +
      `This will permanently delete ALL uploaded roster data for ${locationName} (${locationCode}).\n\n` +
      `‚Ä¢ All swimmers will be removed\n` +
      `‚Ä¢ All attendance records will be deleted\n` +
      `‚Ä¢ All flags and notes will be lost\n\n` +
      `The roster will be auto-exported as a backup before deletion.\n\n` +
      `Type "DELETE" to confirm:`;

    const userInput = prompt(confirmMsg);

    if (userInput !== 'DELETE') {
      if (userInput !== null) {
        alert('Cancelled. Roster was NOT cleared.');
      }
      return;
    }

    try {
      const resp = await api('/api/clear-roster', {
        method: 'POST',
        body: JSON.stringify({
          location_id: currentLocation?.id || 1
        })
      });

      if (resp.ok) {
        alert(`‚úÖ Roster Cleared!\n\nDeleted ${resp.deleted_count} swimmers for ${locationName}.\n\nBackup saved to: ${resp.backup_file || 'N/A'}`);
        await loadBlocks();
        await loadRoster();
      }
    } catch (e) {
      alert(`‚ùå Clear Failed\n\n${e.message}`);
    }
  });

  el('adminNavClearAllRosters').addEventListener('click', async () => {
    const confirmMsg = `‚ö†Ô∏è MASTER DELETE ALL ROSTERS\n\n` +
      `This will permanently delete ALL roster data and uploaded files for EVERY location.\n\n` +
      `‚Ä¢ All swimmers will be removed\n` +
      `‚Ä¢ All attendance records will be deleted\n` +
      `‚Ä¢ All flags and notes will be lost\n` +
      `‚Ä¢ All uploaded PDFs/HTML and server exports will be deleted\n\n` +
      `A full roster backup will be auto-exported before deletion.\n\n` +
      `Type "DELETE ALL" to confirm:`;

    const userInput = prompt(confirmMsg);

    if (userInput !== 'DELETE ALL') {
      if (userInput !== null) {
        alert('Cancelled. No rosters were deleted.');
      }
      return;
    }

    try {
      const resp = await api('/api/clear-roster-all', {
        method: 'POST'
      });

      if (resp.ok) {
        alert(`‚úÖ All Rosters Cleared!\n\nDeleted ${resp.deleted_count} total swimmers.\n\nBackup saved to: ${resp.backup_file || 'N/A'}`);
        await loadBlocks();
        await loadRoster();
      }
    } catch (e) {
      alert(`‚ùå Clear Failed\n\n${e.message}`);
    }
  });

  el('settingsBtn').addEventListener('click', () => {
    syncDeviceUI();
    showModal('settingsModal', true);
  });
  el('settingsClose').addEventListener('click', () => showModal('settingsModal', false));
  el('settingsModal').addEventListener('click', (e) => { if(e.target === el('settingsModal')) showModal('settingsModal', false); });

  el('settingsSave').addEventListener('click', () => {
    deviceMode = el('deviceModeSelect').value;
    localStorage.setItem('deviceMode', deviceMode);
    syncDeviceUI();
    showModal('settingsModal', false);
    loadRoster();
  });

  el('importBtn').addEventListener('click', async () => {
    try{
      el('importBtn').disabled = true;
      await api('/api/import-today', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      await loadStatus();
      await loadBlocks();
    }catch(e){
      alert(e.message);
    }finally{
      el('importBtn').disabled = false;
    }
  });

  // HTML Upload handlers
  el('uploadHtmlBtn').addEventListener('click', () => {
    el('htmlFileInput').click();
  });

  el('htmlFileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      el('uploadHtmlBtn').disabled = true;
      el('uploadHtmlBtn').textContent = 'Uploading...';

      // Use FormData for clean file upload without credential issues
      const formData = new FormData();
      formData.append('html', file);
      formData.append('location_id', currentLocation?.id || 1);

      const response = await fetch(apiUrl('/api/upload-html'), {
        method: 'POST',
        body: formData
        // No headers, no credentials - browser handles multipart automatically
      });

      const result = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(result.error || `Upload failed: ${response.statusText}`);
      }

      if (result.ok) {
        alert(`Success! Imported ${result.count} swimmers`);
        await loadStatus();
        await loadBlocks();
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (e) {
      alert(`Upload failed: ${e.message}`);
      console.error('Upload error details:', e);
    } finally {
      el('uploadHtmlBtn').disabled = false;
      el('uploadHtmlBtn').textContent = 'Upload HTML';
      el('htmlFileInput').value = '';
    }
  });

  el('exportServerBtn').addEventListener('click', async () => {
    try {
      el('exportServerBtn').disabled = true;
      const date = el('rosterDate').value || activeDateISO;
      const resp = await api('/api/export-server', {
        method: 'POST',
        body: JSON.stringify({
          location_id: currentLocation?.id || 1,
          date
        })
      });
      alert(`‚úÖ Exported ${resp.count} swimmers to server.\n\nFile: ${resp.filename}`);
    } catch (err) {
      alert('Export failed: ' + (err.message || err));
    } finally {
      el('exportServerBtn').disabled = false;
    }
  });

  el('importServerBtn').addEventListener('click', async () => {
    await loadServerExports();
    showModal('serverImportModal', true);
  });

  el('setDateBtn').addEventListener('click', async () => {
    const d = el('rosterDate').value;
    if (!d) return;
    try{
      await api('/api/set-active-date', { method:'POST', body: JSON.stringify({date:d}) });
      await loadStatus();
      await loadBlocks();
      await loadRoster();
      toast('Roster date updated');
    }catch(err){
      alert('Set date failed: ' + (err.message || err));
    }
  });

  el('sortBy').addEventListener('change', () => loadRoster());

  // Load instructors for dropdown
  async function loadInstructors() {
    try {
      const locId = currentLocation?.id || 1;
      const resp = await api(`/api/instructors?location_id=${locId}`);
      const select = el('addInstructor');

      // Clear existing options
      select.innerHTML = '';

      // Add blank option
      const blankOpt = document.createElement('option');
      blankOpt.value = '';
      blankOpt.textContent = '(select instructor)';
      select.appendChild(blankOpt);

      // Add instructor options
      (resp.instructors || []).forEach(instructor => {
        const opt = document.createElement('option');
        opt.value = instructor.displayName;
        opt.textContent = instructor.displayName;
        select.appendChild(opt);
      });

    } catch (e) {
      console.error('Failed to load instructors:', e);
      const select = el('addInstructor');
      select.innerHTML = '<option value="">(error loading instructors)</option>';
    }
  }

  // Add-on modal
  el('addSwimmerBtn').addEventListener('click', async () => {
    if(!currentBlock) return;
    el('addName').value = '';
    el('addAge').value = '';
    el('addInstructor').value = '';
    el('addZone').value = '';
    el('addProgram').value = 'GROUP: Beginner 1';
    el('addTime').value = fmtTime(currentBlock);

    // Load instructors for current location
    await loadInstructors();

    showModal('addModal', true);
  });
  el('addCancel').addEventListener('click', () => showModal('addModal', false));
  el('addModal').addEventListener('click', (e) => { if(e.target === el('addModal')) showModal('addModal', false); });

  el('addSave').addEventListener('click', async () => {
    try{
      const swimmer_name = el('addName').value.trim();
      if(!swimmer_name){
        alert('Swimmer name is required');
        return;
      }
      await api('/api/add-swimmer', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name,
          age_text: el('addAge').value.trim() || null,
          program: el('addProgram').value,
          instructor_name: el('addInstructor').value.trim() || null,
          zone: el('addZone').value || null,
          location_id: currentLocation?.id || 1,
          device_mode: deviceMode
        })
      });
      showModal('addModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Zone modal
  el('zoneCancel').addEventListener('click', () => showModal('zoneModal', false));
  el('zoneModal').addEventListener('click', (e) => { if(e.target === el('zoneModal')) showModal('zoneModal', false); });

  el('zoneSave').addEventListener('click', async () => {
    if(!zoneTarget) return;
    try{
      const payload = {
        start_time: currentBlock,
        swimmer_name: zoneTarget.swimmer_name,
        new_zone: el('zoneSelect').value,
        device_mode: deviceMode,
        manager_code: (deviceMode === 'deck') ? el('managerCode').value : undefined
      };
      await api('/api/update-zone', { method:'POST', body: JSON.stringify(payload) });
      showModal('zoneModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Announcements
  el('speakBtn').addEventListener('click', async () => {
    try{
      const text = el('customText').value.trim();
      await speakTyped(text);
    }catch(e){
      alert(e.message);
    }
  });

  el('clearBtn').addEventListener('click', () => { el('customText').value = ''; });

  el('repeatBtn').addEventListener('click', async () => {
    try{
      const resp = await api('/api/repeat-last', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('forceTimeBtn').addEventListener('click', async () => {
    try{
      if(!currentBlock){
        alert('Select a time block first');
        return;
      }
      const resp = await api('/api/force-time-announcement', {
        method:'POST',
        body: JSON.stringify({ start_time: currentBlock, device_mode: deviceMode })
      });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('presetFrontDeck').addEventListener('click', () => {
    el('customText').value = 'Front desk to deck';
  });
  el('presetCodeGreen').addEventListener('click', () => {
    el('customText').value = 'Code green';
  });
  el('presetCodeBrown').addEventListener('click', () => {
    el('customText').value = 'Code Brown';
  });

  // Search functionality
  el('rosterSearch').addEventListener('input', (e) => {
    searchFilter = e.target.value;

    // Show/hide clear button
    const clearBtn = el('searchClear');
    if (searchFilter.trim()) {
      clearBtn.classList.remove('hidden');
    } else {
      clearBtn.classList.add('hidden');
    }

    // Reload roster with filter
    if (currentBlock) {
      loadRoster();
    }
  });

  el('searchClear').addEventListener('click', () => {
    searchFilter = '';
    el('rosterSearch').value = '';
    el('searchClear').classList.add('hidden');

    // Reload roster without filter
    if (currentBlock) {
      loadRoster();
    }
  });

  // Boot
  (async function init(){
    try{
      syncDeviceUI();
      await loadLocations();
      await loadStatus();
      await loadBlocks();
    }catch(e){
      setStatus(e.message || 'Failed to load', 'warn');
    }finally{
      // Start clock update (runs independently of announcements)
      startCountdown();
    }
  })();
</script>
</body>
</html>
