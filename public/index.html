<!doctype html>
<!--
QA checklist (v4.8.5-beta):
1) Roster: Upload HTML roster ‚Üí auto-absent should detect ‚äò glyph or cancel.png in far-right cell; auto-absent rows highlight + chip, override to Here keeps chip.
2) Roster UI: Attendance icon buttons, single-line rows, instructor cell shows SUB for original instructor or SUB chip only.
3) Admin/System: MASTER ROSTER RESET requires DELETE + initials, logs in Admin Activity Log.
4) Manager: Sidebar navigation, alert strip, stat tiles, global trends toggle, global search + preview drawer, keyboard shortcuts modal.
5) Reports: Attendance Report (summary), Absence Tracker (actionable), Attendance History (read-only) are distinct.
6) Manager Reports cards: only Retention, Aged Accounts, Drop List.
7) Reports upload: strict location enforcement + pre-commit summary modal; Drop List always requires location selection.
8) Drop List: structured details (name, class/time, chips), date bracket filter, delete wrong-location upload.
9) Retention parser: multi-instructor blocks parsed, retention % from table[1] row0 col1.
10) Instructor Trainer: Retention, Drop Impact attribution, Attendance Impact views.
11) Billing Bundle Tracker: 12/24/52 week rules, expiring alerts, export scope modal.
12) Location visibility: Lifeguard/Guard Tasks/Announcements only for SwimLabs Westchester.
-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="api-base" content="" />
  <title>SwimLabs Announcer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --cardA:#ffffff;
      --cardB:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:rgba(15,23,42,.08);
      --line2:rgba(15,23,42,.12);
      --btn:#ffffff;
      --btn2:#f8fafc;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#e11d48;
      --chip:rgba(15,23,42,.04);
      --accent:#10b981;
      --accent-soft:#ecfdf5;
      --cat-client:#bff3ea;
      --cat-billing:#e6d9ff;
      --cat-instructors:#cfe4ff;
      --cat-guards:#f8d8bf;
      --cat-system:#e2e8f0;
      --cat-danger:#fecdd3;
      --cat-strong:#0f172a;
      --cat-border:rgba(15,23,42,.08);
    }
    *{ box-sizing:border-box; }
    body *{ transition: none !important; }
    body{
      margin:0;
      padding:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color:var(--text);
    }
    .wrap{ max-width: 1250px; margin: 0 auto; }
    .topbar{
      display:flex;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      padding:12px 12px 10px;
      border-radius:18px;
      border:1px solid var(--cat-border);
      background: var(--category-bg, #fff);
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; color: var(--text); }
    .muted{ color:var(--muted); font-size:14px; }
    .tiny{ font-size:12px; }
    .right{ margin-left:auto; }
    .card{
      background: var(--cardA);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin-top:14px;
      box-shadow: 0 10px 28px rgba(15,23,42,.08);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #fff;
    }
    button{
      border:1px solid rgba(148,163,184,.5);
      background: #fff;
      color:#0f172a;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
    }
    button:hover{ background:#f8fafc; }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(16,185,129,.45); }
    button.secondary{ border-color: rgba(148,163,184,.6); }
    button.danger{ border-color: rgba(225,29,72,.35); background:#e11d48; color:#fff; }
    button.danger:hover{ background:#be123c; }
    .miniBtn{
      padding:6px 10px;
      font-size:12px;
      min-height:34px;
      border-radius:10px;
    }
    button.disabled{
      opacity: .5;
      cursor: not-allowed;
    }
    button.admin-only.disabled::after{
      content: " üîí";
    }

    button.tab{ padding:9px 12px; border-radius:999px; background: transparent; border-color: transparent; color:#334155; }
    button.tab.active{
      background: var(--accent-soft);
      border-color: rgba(16,185,129,.2);
      outline: 2px solid rgba(16,185,129,.15);
      color:#065f46;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: #fff;
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      line-height: 1.2;
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); font-weight:800; }
    .ok{ color: var(--good); font-weight:900; }
    .warn{ color: var(--warn); font-weight:900; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 520px 1fr; } }

    .blocks{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .blocks button{ min-width: 120px; }
    .blocks button.active{
      outline:2px solid rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.28);
      filter: brightness(1.10);
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      background: #fff;
      color: var(--text);
      outline: none;
      font-size:14px;
      line-height: 1.4;
    }

    /* readable black inputs + dropdowns */
    select, input[type="text"], input[type="password"]{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      background: #fff;
      color: #0f172a;
      font-weight:600;
      outline: none;
      cursor:pointer;
    }
    input[type="text"], input[type="password"]{
      cursor:text;
      font-weight:600;
    }
    input[type="text"]:focus, input[type="password"]:focus{
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,.15);
    }
    select option{
      background:#fff;
      color:#0f172a;
    }

    /* Search bar */
    .searchWrap{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .searchInput{
      width: 280px;
      padding: 9px 34px 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.45);
      background: #fff;
      color: #0f172a;
      font-size: 14px;
      font-weight: 700;
      outline: none;
      transition: all .15s ease;
    }
    .searchInput:focus{
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16,185,129,.15);
      background: #fff;
    }
    .searchInput::placeholder{
      color: rgba(71,85,105,.6);
      font-weight: 600;
    }
    .searchClear{
      position: absolute;
      right: 8px;
      padding: 4px 6px;
      background: transparent;
      border: none;
      color: rgba(159,176,208,.8);
      font-size: 16px;
      cursor: pointer;
      min-height: auto;
      line-height: 1;
      border-radius: 6px;
      transition: all .12s ease;
    }
    .searchClear:hover{
      color: #04D9FF;
      background: rgba(4,217,255,.1);
    }
    .searchClear:active{
      transform: scale(0.95);
    }
    .searchClear.hidden{
      display: none;
    }

    .managerTabBtn{
      padding:8px 14px;
      border-radius:10px;
      font-size:13px;
      font-weight:700;
      border:1px solid rgba(148,163,184,.45);
      background:#fff;
      color:#0f172a;
      cursor:pointer;
    }
    .managerTabBtn.active{
      background:rgba(16,185,129,0.12);
      border-color:rgba(16,185,129,0.4);
      color:#065f46;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--category-border, var(--line));
      background: #fff;
    }
    .roster-table{
      table-layout: fixed;
      width: 100%;
    }
    thead th{
      position: sticky;
      top: 0;
      background: var(--category-soft, #f1f5f9);
      z-index: 5;
      border-bottom: 1px solid var(--category-border, var(--line2));
      color:#0f172a;
      font-weight:700;
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid rgba(148,163,184,.3);
      vertical-align: top;
      font-size:14px;
      color:#0f172a;
    }
    th{ color:#0f172a; font-weight:700; font-size:12px; text-transform: uppercase; letter-spacing: .5px; }
    tbody tr:nth-child(odd){ background:#fff; }
    tbody tr:nth-child(even){ background: var(--category-row, #f8fafc); }
    tbody tr:hover{ background: var(--category-hover, #eef2f7); }

    /* Keep roster rows neutral */
    tbody tr.program-group,
    tbody tr.program-semi-private,
    tbody tr.program-private,
    tbody tr.program-parent-tot,
    tbody tr.program-trial{
      background: inherit;
    }

    .zone{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: #fff;
      font-size:13px;
      font-weight:900;
      white-space: nowrap;
      cursor: pointer;
      user-select:none;
    }
    .zone.locked{ cursor: not-allowed; opacity:.85; }

    .hidden{ display:none; }

    .level{ font-weight:900; color: var(--text); line-height: 1.2; }
    .nowrap{ white-space: nowrap; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      margin-left:8px;
      vertical-align: middle;
    }
    .badge.addon{ border-color: rgba(245,158,11,.40); }
    .badge.over{ border-color: rgba(34,197,94,.35); }
    
    .badge.sub {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 0.5px;
      border: 1px solid rgba(249,115,22,0.45);
      background: rgba(249,115,22,0.15);
      color: rgb(249,115,22);
      cursor: help;
    }
    
    .badge.sub:hover {
      background: rgba(249,115,22,0.25);
    }

    tbody tr.row-sub { background: rgba(249,115,22,0.06); }
    tbody tr.row-sub:hover { background: rgba(249,115,22,0.12); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
      font-weight:700;
      border:1px solid rgba(148,163,184,.4);
      background:#fff;
      color:#0f172a;
    }
    .chip.auto-absent{
      border-color: rgba(225,29,72,.35);
      background: rgba(225,29,72,.08);
      color: #9f1239;
    }
    .chip.teal{ border-color: rgba(16,185,129,.35); background: var(--accent-soft); color:#065f46; }
    .chip.rose{ border-color: rgba(225,29,72,.35); background: rgba(225,29,72,.08); color:#9f1239; }
    .chip.amber{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.08); color:#92400e; }
    .chip.slate{ border-color: rgba(148,163,184,.35); background: rgba(148,163,184,.12); color:#1f2937; }

    .notification-card{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(16,185,129,.2);
      background: #fff;
    }
    .notification-card.danger{
      border-color: rgba(225,29,72,.35);
      background: rgba(225,29,72,.04);
    }
    .notification-card.warning{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.06);
    }
    .notification-card .dismiss{
      border: none;
      background: transparent;
      color: #64748b;
      font-weight:700;
      cursor:pointer;
    }
    .report-card{
      display:flex;
      gap:10px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      background:#fff;
    }
    .report-card .accent{
      width:8px;
      align-self:stretch;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(16,185,129,.9), rgba(20,184,166,.7));
    }
    .table-num{
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .drop-details{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .drop-details .name{
      font-weight:700;
      color:#0f172a;
    }
    .drop-details .meta{
      color:var(--muted);
      font-size:12px;
    }
    .drop-details .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .trend-card{
      background:#fff;
      border:1px solid rgba(148,163,184,.35);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
    }

    .flagBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:8px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.2);
      font-size: 13px;
    }
    .flagRow{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .rosterCell{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .rosterToolbar{
      position: sticky;
      top: 0;
      z-index: 8;
      background: #f8fafc;
      padding-bottom: 10px;
      margin-bottom: 4px;
    }
    .actionIconBtn{
      padding: 6px 8px;
      border-radius: 12px;
      font-size: 18px;
      min-height: 38px;
    }
    .row-auto-absent{
      background: rgba(250,204,214,0.4) !important;
    }
    .row-auto-absent:hover{
      background: rgba(250,204,214,0.55) !important;
    }

    .guard-section {
      padding: 14px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .guard-section h4 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 900;
    }
    .guard-task {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      margin-bottom: 8px;
    }
    .guard-task.done {
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.08);
    }
    .guard-task input[type="text"] {
      width: 72px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 700;
      text-align: center;
      background: #fff;
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 8px;
      padding: 6px 8px;
      color: #0f172a;
    }
    .guard-task span { flex: 1; }
    .guard-group-title {
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      color: rgba(148,163,184,.9);
      margin: 10px 0 6px;
      letter-spacing: 0.4px;
    }
    .guard-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }
    .guard-rotation-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .guard-rotation-table th,
    .guard-rotation-table td {
      border-bottom: 1px solid rgba(148,163,184,.3);
      padding: 8px;
      text-align: left;
    }
    .guard-rotation-table input {
      width: 100%;
      background: #fff;
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 8px;
      padding: 6px 8px;
      color: #0f172a;
    }

    /* Attendance buttons */
    .attWrap{ display:flex; gap:6px; align-items:center; }
    .attBtn{
      padding:6px 8px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background: #fff;
      cursor:pointer;
      user-select:none;
      line-height:1;
      color:#0f172a;
    }
    .attBtn.here.active{ border-color: rgba(34,197,94,.5); background: rgba(34,197,94,.12); }
    .attBtn.absent.active{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.12); }
    .attBtn.clear.active{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.08); }

    /* Flags */
    .flags{ display:flex; gap:8px; margin-top:6px; align-items:center; flex-wrap:wrap; }
    .flag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:26px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size:16px;
      opacity:.35;
      transition: filter .12s ease, opacity .12s ease, transform .05s ease;
    }
    .flag:hover{ filter: brightness(1.15); }
    .flag:active{ transform: translateY(1px); }
    .flag.on{ opacity:1; border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .flagHelp{ font-size:12px; color: rgba(159,176,208,.9); margin-left:8px; }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width: 100%;
      max-width: 560px;
      background: #fff;
      border:1px solid var(--line2);
      border-radius:18px;
      box-shadow: 0 22px 60px rgba(15,23,42,.25);
      padding:14px;
    }
    .modal h3{ margin:4px 0 10px; font-size:16px; }
    .modal .grid2{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width: 640px){ .modal .grid2{ grid-template-columns: 1fr 1fr; } }
    .field label{
      display:block;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .field .hint{
      margin-top:6px;
      font-size:12px;
      color: rgba(159,176,208,.85);
      line-height:1.35;
    }
    .modalFooter{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    body.deck-mode .deck-hide { display: none !important; }

    .category-client{
      --category-bg: var(--cat-client);
      --category-soft: rgba(191,243,234,0.55);
      --category-row: rgba(191,243,234,0.18);
      --category-hover: rgba(191,243,234,0.32);
      --category-border: rgba(14,116,144,.2);
    }
    .category-billing{
      --category-bg: var(--cat-billing);
      --category-soft: rgba(230,217,255,0.6);
      --category-row: rgba(230,217,255,0.2);
      --category-hover: rgba(230,217,255,0.3);
      --category-border: rgba(79,70,229,.18);
    }
    .category-instructors{
      --category-bg: var(--cat-instructors);
      --category-soft: rgba(207,228,255,0.6);
      --category-row: rgba(207,228,255,0.2);
      --category-hover: rgba(207,228,255,0.3);
      --category-border: rgba(37,99,235,.18);
    }
    .category-guards{
      --category-bg: var(--cat-guards);
      --category-soft: rgba(248,216,191,0.6);
      --category-row: rgba(248,216,191,0.22);
      --category-hover: rgba(248,216,191,0.35);
      --category-border: rgba(234,88,12,.2);
    }
    .category-system{
      --category-bg: var(--cat-system);
      --category-soft: rgba(226,232,240,0.7);
      --category-row: rgba(226,232,240,0.25);
      --category-hover: rgba(226,232,240,0.35);
      --category-border: rgba(71,85,105,.2);
    }
    .category-danger{
      --category-bg: var(--cat-danger);
      --category-soft: rgba(254,205,211,0.6);
      --category-row: rgba(254,205,211,0.25);
      --category-hover: rgba(254,205,211,0.35);
      --category-border: rgba(225,29,72,.25);
    }

    .icon-circle{
      width:28px;
      height:28px;
      border-radius:50%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.7);
      border:1px solid rgba(15,23,42,.12);
      font-size:15px;
    }

    .manager-shell{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
      align-items:start;
    }
    .manager-sidebar{
      position: sticky;
      top: 12px;
      align-self: start;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--line);
      background: #fff;
      min-height: 70vh;
    }
    .manager-sidebar.collapsed{
      transform: translateX(-120%);
      opacity: 0;
      pointer-events: none;
    }
    .manager-sidebar h3{
      margin:0 0 6px;
      font-size:14px;
      text-transform: uppercase;
      letter-spacing: .5px;
      color: var(--muted);
    }
    .sidebar-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.35);
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .sidebar-item.active{
      background: var(--category-soft, rgba(15,23,42,.05));
      border-color: var(--category-border, rgba(15,23,42,.2));
    }
    .sidebar-item.disabled{
      opacity: .55;
      cursor: not-allowed;
      position: relative;
    }
    .sidebar-item .lock{
      font-size:12px;
      margin-left:auto;
      color:#64748b;
    }
    .sidebar-toggle{
      position: fixed;
      left: 16px;
      bottom: 18px;
      z-index: 1001;
      display:none;
    }
    .sidebar-toggle.show{
      display:inline-flex;
    }
    .manager-content{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .manager-section{
      display:none;
    }
    .manager-section.active{
      display:block;
    }
    .alert-strip{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px;
      border-radius:14px;
      background: var(--category-soft, rgba(15,23,42,.05));
      border:1px solid var(--category-border, rgba(15,23,42,.12));
    }
    .alert-strip .pill{
      cursor: pointer;
    }
    .alert-strip button.pill{
      border:1px solid var(--line);
      background:#fff;
    }
    .stat-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
    }
    .stat-card{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--category-border, rgba(15,23,42,.12));
      background:#fff;
    }
    .stat-card .value{
      font-size:22px;
      font-weight:900;
    }
    .stat-card.alert{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.08);
    }
    .stat-card.danger{
      border-color: rgba(225,29,72,.35);
      background: rgba(225,29,72,.08);
    }
    .manager-subnav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .manager-subnav button.active{
      background: var(--category-soft, rgba(15,23,42,.05));
      border-color: var(--category-border, rgba(15,23,42,.2));
      color:#0f172a;
    }
    .drawer-backdrop{
      position: fixed;
      inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      z-index: 10000;
    }
    .preview-drawer{
      position: fixed;
      top:0;
      right:0;
      width: 360px;
      max-width: 90vw;
      height: 100%;
      background:#fff;
      border-left: 1px solid var(--line);
      box-shadow: -10px 0 24px rgba(15,23,42,.2);
      padding:16px;
      transform: translateX(100%);
      transition: none;
      z-index: 10001;
      overflow:auto;
    }
    .preview-drawer.open{
      transform: translateX(0);
    }
    .global-error{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(225,29,72,.35);
      background: rgba(225,29,72,.08);
      color:#9f1239;
      font-size:13px;
      display:none;
    }
    .inline-error{
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(225,29,72,.35);
      background: rgba(225,29,72,.06);
      color:#9f1239;
      font-size:12px;
    }
    .inline-error button{
      margin-top:8px;
    }
    @media (max-width: 980px){
      .manager-shell{
        grid-template-columns: 1fr;
      }
      .manager-sidebar{
        position: relative;
        min-height: auto;
      }
    }

    /* TABLET & MOBILE OPTIMIZATION */
    @media (max-width: 900px) {
      body { padding: 10px; }
      .wrap { max-width: 100%; }
      .card { padding: 12px; }
      h1 { font-size: 20px; }
      button { min-height: 48px; padding: 12px 16px; font-size: 15px; }
      th, td { padding: 8px 6px; font-size: 13px; }
      .level { font-size: 14px; font-weight: 700; }
      .blocks button { min-height: 48px; padding: 10px 14px; font-size: 15px; }
      .roster-table th, .roster-table td { font-size: 12px; }
      .attBtn { padding: 5px 6px; font-size: 11px; }
      .actionIconBtn { min-height: 34px; }
    }

    @media (max-width: 600px) {
      body { padding: 6px; }
      .card { padding: 10px; border-radius: 12px; }
      h1 { font-size: 18px; }
      button { min-height: 44px; padding: 10px 14px; font-size: 14px; }
      th, td { padding: 6px 4px; font-size: 12px; }
      .level { font-size: 13px; }
      .blocks button { min-height: 44px; padding: 8px 12px; font-size: 14px; }
      .pill { padding: 6px 8px; font-size: 12px; }
      .attBtn { padding: 5px 6px; font-size: 11px; }
      .roster-table th, .roster-table td { font-size: 11px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>SwimLabs Announcer <span style="font-size:14px; color:var(--muted); font-weight:400;">v4.8.5-beta</span></h1>
      <div class="muted" id="status">Loading‚Ä¶</div>
    </div>

    <div class="right row">
      <select id="locationSelect" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; background: #fff; color: #0f172a; border: 1px solid rgba(148,163,184,0.5);">
        <option value="">Loading locations...</option>
      </select>
      <select id="viewSelect" style="padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; background: #fff; color: #0f172a; border: 1px solid rgba(148,163,184,0.5); min-width: 150px;">
        <option value="roster">Roster</option>
        <option value="lifeguard">Lifeguard üèä</option>
        <option value="announcements">Announcements</option>
        <option value="virtualDesk">Manager</option>
        <option value="admin">‚öôÔ∏è Admin</option>
      </select>
      <span class="pill">Device: <strong id="deviceModeLabel">Deck</strong></span>
      <button id="globalSearchBtn" title="Global search">üîç</button>
      <button id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <span class="pill">
        <span style="font-size:11px; color:var(--muted);">Current Time:</span>
        <strong id="currentTime" style="color:var(--accent); margin-left:4px;">‚Äî</strong>
      </span>
      <span class="pill" id="nextAnnouncementPill">
        <span style="font-size:11px; color:var(--muted);">Next Announcement:</span>
        <strong id="nextAnnouncementTimer" style="color:var(--accent); margin-left:4px;">‚Äî</strong>
      </span>
      <span class="pill">Last: <strong id="lastAt">None</strong></span>
    </div>
  </div>

  <div id="readOnlyBanner" class="card hidden" style="background: rgba(16,185,129,.08); border-color: rgba(16,185,129,.3);">
    <div style="font-weight:900;">üîí Read-only mode enabled</div>
    <div class="tiny" style="color:var(--muted);">Uploads, edits, clears, and exports are disabled on this device.</div>
  </div>

  <div id="panelRoster">
    <div class="card">
      <div class="row rosterToolbar">
        <button class="primary deck-hide" id="importBtn">Import Today (PDF)</button>
        <button class="primary deck-hide" id="uploadHtmlBtn">Upload HTML</button>
        <input type="file" id="htmlFileInput" accept=".html" style="display: none;">
        <button class="secondary deck-hide" id="exportServerBtn" title="Save a JSON backup on the server">Export to Server</button>
        <button class="secondary deck-hide" id="importServerBtn" title="Restore a roster from server backups">Import from Server</button>

        <div class="spacer"></div>
        <span class="pill tiny">Auto announcement runs about 3 minutes before each time block.</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Time Blocks <span class="muted">(Date:</span> <input id="rosterDate" type="date" class="dateInput" /> <button id="setDateBtn" class="miniBtn">Set</button> <span class="muted">)</span> <span id="blockHint" class="muted"></span></div>
        <div class="spacer"></div>
        <div class="pill">Selected: <strong id="selectedBlock">None</strong></div>
      </div>
      <div class="blocks" id="blocks"></div>
    </div>

    <div id="deckDateWarning" class="card hidden" style="background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.4);">
      <div style="font-weight:900;">‚ö†Ô∏è Past-date roster</div>
      <div class="tiny" style="color:var(--muted);">Deck Mode is on and this roster date is not today.</div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Roster <span id="rosterMeta" class="muted"></span></div>
        <div class="legend" id="tagLegend">
          <span class="legendItem"><span class="flagBadge on">‚≠ê</span><span class="legendText">First time</span></span>
          <span class="legendItem"><span class="flagBadge on">üîÑ</span><span class="legendText">Makeup</span></span>
          <span class="legendItem"><span class="flagBadge on">üìú</span><span class="legendText">Policy</span></span>
          <span class="legendItem"><span class="flagBadge on">üí≥</span><span class="legendText">Balance</span></span>
          <span class="legendItem"><span class="flagBadge on">üß™</span><span class="legendText">Trial</span></span>
        </div>

        <div class="spacer"></div>

        <div class="searchWrap">
          <input type="text" id="rosterSearch" class="searchInput" placeholder="Search roster..." />
          <button class="searchClear hidden" id="searchClear" title="Clear search">‚úï</button>
        </div>

        <button class="secondary deck-hide" id="addSwimmerBtn">+ Add swimmer</button>
        <span class="pill">Sort</span>
        <select id="sortBy">
          <option value="instructor" selected>Instructor + A-Z</option>
          <option value="name">Swimmer A-Z</option>
        </select>

        <div id="bulkAttendanceActions" class="row" style="gap:6px;">
          <button class="secondary miniBtn" id="bulkMarkPresent">‚úÖ Mark all present</button>
          <button class="secondary miniBtn" id="bulkClearAttendance">‚≠ò Clear all attendance</button>
        </div>
      </div>

      <table class="roster-table">
        <thead>
          <tr>
            <th style="width:110px;">Attendance</th>
            <th>Swimmer</th>
            <th style="width:70px;">Age</th>
            <th style="width:110px;">Type</th>
            <th style="width:120px;">Level</th>
            <th style="width:130px;">Instructor</th>
            <th style="width:90px;">Zone</th>
            <th style="width:80px;">Action</th>
          </tr>
        </thead>
        <tbody id="roster"></tbody>
      </table>

    </div>
  </div>

  <div id="panelAnnouncements" class="hidden">
    <div class="grid">
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <button class="secondary" id="repeatBtn">Repeat last</button>
          <button class="secondary" id="forceTimeBtn">Force time-block</button>
        </div>

        <textarea id="customText" placeholder="Type an announcement here, then click Speak."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="speakBtn">Speak typed message</button>
          <button class="danger" id="clearBtn">Clear</button>
        </div>

        <div class="card" style="margin-top:12px; background: rgba(255,255,255,.03);">
          <div class="pill" style="margin-bottom:8px;">Last announcement</div>
          <div id="lastText" class="tiny" style="line-height:1.45; color: var(--text);">None</div>
        </div>
      </div>

      <div class="card">
        <div class="pill" style="margin-bottom:10px;">Quick presets</div>
        <div class="row">
          <button class="secondary" id="presetFrontDeck">Front desk to deck</button>
          <button class="secondary" id="presetCodeGreen">Code Green</button>
          <button class="secondary" id="presetCodeBrown">Code Brown</button>
        </div>
      </div>
    </div>
  </div>

  <div id="panelVirtualDesk" class="hidden">
    <div class="manager-shell">
      <aside class="manager-sidebar category-client" id="managerSidebar">
        <h3>Manager</h3>
        <button class="sidebar-item active" data-manager-section="client" id="managerNavClient">
          <span class="icon-circle">ü´ß</span> Client Relations
        </button>
        <button class="sidebar-item" data-manager-section="billing" id="managerNavBilling">
          <span class="icon-circle">üßæ</span> Billing
        </button>
        <button class="sidebar-item" data-manager-section="instructors" id="managerNavInstructors">
          <span class="icon-circle">üéì</span> Instructors
        </button>
        <button class="sidebar-item" data-manager-section="guards" id="managerNavGuards">
          <span class="icon-circle">üõü</span> Guards (SLW)
        </button>
        <h3 style="margin-top:10px;">System/Admin</h3>
        <button class="sidebar-item" data-manager-section="system" id="managerNavSystem">
          <span class="icon-circle">‚öôÔ∏è</span> System/Admin
          <span class="lock hidden" id="managerNavSystemLock">üîí</span>
        </button>
      </aside>
      <button class="secondary sidebar-toggle" id="sidebarToggleBtn">‚ò∞ Menu</button>

      <div class="manager-content">
        <div class="global-error" id="managerErrorBanner"></div>

        <section id="managerSectionClient" class="manager-section active category-client">
          <div class="alert-strip" id="clientAlertStrip"></div>
          <div class="stat-grid" id="clientStatGrid"></div>

          <div class="card">
            <div class="row" style="flex-wrap:wrap; gap:8px; margin-bottom:10px;">
              <div class="pill">Date Range</div>
              <input type="date" id="clientRangeStart" />
              <input type="date" id="clientRangeEnd" />
              <button class="secondary miniBtn" id="clientFiltersToggle">Filters</button>
              <div class="spacer"></div>
              <button class="secondary miniBtn" id="clientTrendsToggle">Hide trends</button>
            </div>
            <div id="clientFiltersAdvanced" class="row hidden" style="flex-wrap:wrap; gap:8px; margin-bottom:10px;">
              <select id="clientInstructorFilter"></select>
              <select id="clientStatusFilter">
                <option value="">All statuses</option>
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="rescheduled">Rescheduled</option>
                <option value="complete">Complete</option>
              </select>
            </div>
            <div class="manager-subnav" style="margin-bottom:10px;">
              <button class="secondary active" id="clientTabAttendance">Attendance Report</button>
              <button class="secondary" id="clientTabAbsence">Absence Tracker</button>
              <button class="secondary" id="clientTabHistory">Attendance History</button>
            </div>
            <div id="clientAttendanceReport">
              <div id="attendanceTrends" class="trend-card" style="margin-bottom:12px;"></div>
              <div id="attendanceSummaryTable"></div>
              <div id="attendanceInstructorTable" style="margin-top:12px;"></div>
            </div>
            <div id="clientAbsenceTracker" class="hidden">
              <div id="absenceTrackerTable"></div>
            </div>
            <div id="clientAttendanceHistory" class="hidden">
              <div id="attendanceHistoryTable"></div>
            </div>
          </div>

          <div class="card" id="clientDropListCard">
            <div class="row" style="margin-bottom:10px; flex-wrap:wrap; gap:8px;">
              <h3 style="margin:0; font-size:18px;">üìâ Drop List</h3>
              <div class="spacer"></div>
              <select id="clientDropRange">
                <option value="7">Last 7 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
                <option value="custom">Custom</option>
              </select>
              <input type="date" id="clientDropStart" />
              <input type="date" id="clientDropEnd" />
              <button class="secondary miniBtn" id="clientDropApply">Apply</button>
            </div>
            <div id="clientDropListTable"></div>
          </div>

          <div class="card" id="managerNotifications">
            <div class="row" style="margin-bottom:10px;">
              <h3 style="margin:0; font-size:18px;">üîî Notifications</h3>
              <div class="spacer"></div>
              <span class="chip teal">Persistent</span>
            </div>
            <div id="managerNotificationsList" class="row" style="flex-direction:column; gap:10px;"></div>
          </div>
        </section>

        <section id="managerSectionBilling" class="manager-section category-billing">
          <div class="alert-strip" id="billingAlertStrip"></div>
          <div class="stat-grid" id="billingStatGrid"></div>

          <div class="card">
            <h3 style="margin:0 0 10px; font-size:18px;">üíú Bundle Tracker</h3>
            <div class="grid2">
              <div class="field">
                <label>Location</label>
                <select id="bundleLocation"></select>
              </div>
              <div class="field">
                <label>Customer name</label>
                <input type="text" id="bundleCustomer" placeholder="Customer name" />
              </div>
              <div class="field">
                <label>Phone</label>
                <input type="text" id="bundlePhone" placeholder="(555) 555-5555" />
              </div>
              <div class="field">
                <label>Start date</label>
                <input type="date" id="bundleStartDate" />
              </div>
              <div class="field">
                <label>Duration</label>
                <select id="bundleDuration">
                  <option value="12">12 weeks</option>
                  <option value="24">24 weeks</option>
                  <option value="52">52 weeks</option>
                </select>
              </div>
              <div class="field">
                <label>Monthly price</label>
                <input type="text" id="bundleMonthlyPrice" placeholder="0.00" />
              </div>
              <div class="field" style="grid-column: 1 / -1;">
                <label>Notes</label>
                <input type="text" id="bundleNotes" placeholder="Optional notes..." />
              </div>
            </div>
            <div class="row" style="margin-top:10px; flex-wrap:wrap; gap:8px;">
              <button class="primary" id="bundleSaveBtn">Save bundle</button>
              <button class="secondary" id="bundleResetBtn">Clear</button>
              <div class="spacer"></div>
              <button class="secondary" id="bundleExportBtn">Export</button>
            </div>
            <div id="bundleFormHint" class="tiny" style="color:var(--muted); margin-top:8px;">Discounts auto-calculate by duration.</div>
          </div>

          <div class="card">
            <div class="row" style="margin-bottom:8px;">
              <h3 style="margin:0; font-size:18px;">‚è∞ Needs Follow-Up</h3>
            </div>
            <div id="bundleNeedsFollowUp"></div>
          </div>

          <div class="card">
            <div class="row" style="margin-bottom:8px;">
              <h3 style="margin:0; font-size:18px;">üì¶ Bundles</h3>
              <div class="spacer"></div>
              <span class="pill tiny">Sorted by soonest expiration</span>
            </div>
            <div id="bundleTable"></div>
          </div>
        </section>

        <section id="managerSectionInstructors" class="manager-section category-instructors">
          <div class="alert-strip" id="instructorsAlertStrip"></div>
          <div class="stat-grid" id="instructorsStatGrid"></div>

          <div class="card">
            <div class="row" style="margin-bottom:10px;">
              <div class="pill tiny">Global trends</div>
              <button class="secondary miniBtn" id="instructorTrendsToggle">Hide trends</button>
            </div>
            <div class="manager-subnav" style="margin-bottom:10px;">
              <button class="secondary active" id="trainerTabRetention">Retention</button>
              <button class="secondary" id="trainerTabDropImpact">Drop Impact</button>
              <button class="secondary" id="trainerTabAttendanceImpact">Attendance Impact</button>
            </div>
            <div id="trainerRetentionPanel">
              <div id="retentionTrends" class="trend-card" style="margin-bottom:12px;"></div>
              <div id="retentionTable"></div>
            </div>
            <div id="trainerDropImpactPanel" class="hidden">
              <div id="dropImpactTable"></div>
            </div>
            <div id="trainerAttendanceImpactPanel" class="hidden">
              <div id="attendanceImpactTable"></div>
            </div>
          </div>
        </section>

        <section id="managerSectionGuards" class="manager-section category-guards">
          <div class="alert-strip" id="guardsAlertStrip"></div>
          <div class="stat-grid" id="guardsStatGrid"></div>
          <div class="card">
            <h3 style="margin:0 0 10px; font-size:18px;">üõü Guard Tasks (SLW)</h3>
            <div class="tiny" style="color:var(--muted); margin-bottom:8px;">
              Guard Tasks are available only for SwimLabs Westchester.
            </div>
            <button class="secondary" id="openGuardTasksBtn">Open Guard Tasks</button>
          </div>
        </section>

        <section id="managerSectionSystem" class="manager-section category-system">
          <div class="alert-strip" id="systemAlertStrip"></div>
          <div class="stat-grid" id="systemStatGrid"></div>

          <div class="card" style="margin-bottom:16px;">
            <h3 style="margin:0 0 8px; font-size:18px;">üìÅ Manager Reports</h3>
            <div class="tiny" style="color:var(--muted); margin-bottom:16px;">Upload and track retention (HTML), drop list (HTML), and aged accounts reports per location.</div>
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:12px;">
              <div class="report-card">
                <div class="accent"></div>
                <div>
                  <div style="font-weight:800;">üìà Retention List (HTML)</div>
                  <div class="tiny" id="reportMetaRetention">No report uploaded yet.</div>
                </div>
                <div class="spacer"></div>
                <a class="secondary hidden" id="reportDownloadRetention" target="_blank" rel="noopener">View</a>
                <button class="secondary reportUploadBtn" data-report-type="retention">Upload</button>
                <input type="file" class="reportFileInput hidden" data-report-type="retention" accept=".html" />
              </div>
              <div class="report-card">
                <div class="accent"></div>
                <div>
                  <div style="font-weight:800;">üßæ Aged Accounts</div>
                  <div class="tiny" id="reportMetaAgedAccounts">No report uploaded yet.</div>
                </div>
                <div class="spacer"></div>
                <a class="secondary hidden" id="reportDownloadAgedAccounts" target="_blank" rel="noopener">View</a>
                <button class="secondary reportUploadBtn" data-report-type="aged_accounts">Upload</button>
                <input type="file" class="reportFileInput hidden" data-report-type="aged_accounts" accept=".html,.pdf,.csv,.xls,.xlsx" />
              </div>
              <div class="report-card">
                <div class="accent"></div>
                <div>
                  <div style="font-weight:800;">üìâ Drop List (HTML)</div>
                  <div class="tiny" id="reportMetaDropList">No report uploaded yet.</div>
                </div>
                <div class="spacer"></div>
                <a class="secondary hidden" id="reportDownloadDropList" target="_blank" rel="noopener">View</a>
                <button class="secondary reportUploadBtn" data-report-type="drop_list">Upload</button>
                <input type="file" class="reportFileInput hidden" data-report-type="drop_list" accept=".html" />
              </div>
            </div>
            <div class="row" style="margin-top:12px; gap:8px;">
              <button class="danger admin-only" id="deleteLatestDropListBtn">Delete latest Drop List upload</button>
            </div>
          </div>

          <div class="card">
            <h3 style="margin:0 0 10px; font-size:18px;">üß® MASTER ROSTER RESET</h3>
            <div class="tiny" style="color:var(--muted); margin-bottom:10px;">Wipes all roster data for all locations and dates. Admin only.</div>
            <button class="danger admin-only" id="masterRosterResetBtn">MASTER ROSTER RESET</button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="panelLifeguard" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">üõü Lifeguard Dashboard</h2>
      <div class="tiny" style="color:var(--muted); margin-bottom:12px;">
        Guard tasks are available for SwimLabs Westchester.
      </div>
    </div>
  </div>

  <div id="panelGuardTasks" class="hidden">
    <div class="card">
      <div class="row" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
        <button class="secondary" id="guardTasksBack">‚Üê Back</button>
        <div class="pill">üõü Guard Tasks</div>
        <div class="spacer"></div>
        <div class="guard-meta" id="guardTasksMeta">No date selected</div>
      </div>

      <div class="row" style="margin-bottom:16px; flex-wrap:wrap; gap:10px;">
        <div class="field">
          <label>Task date</label>
          <input type="date" id="guardTasksDate" />
        </div>
        <div class="field">
          <label>Guard 1</label>
          <input type="text" id="guardName1" placeholder="Name..." />
        </div>
        <div class="field">
          <label>Guard 2</label>
          <input type="text" id="guardName2" placeholder="Name..." />
        </div>
        <div class="field">
          <label>Guard 3</label>
          <input type="text" id="guardName3" placeholder="Name..." />
        </div>
        <div class="spacer"></div>
        <button class="secondary" id="guardTasksShuffle">Randomize guard numbers</button>
        <button class="secondary" id="guardTasksSnapshot">Save snapshot</button>
        <button class="danger" id="guardTasksReset">Reset</button>
      </div>

      <div class="tiny" style="color:var(--muted); margin-bottom:16px;">
        Manager: enter the guard names for the day. Guard numbers are randomized at the start of the day. Weekdays have no rotation unless manually updated. Weekends rotate Guard 2 + 3 first, then 3 + 1, then 1 + 2.
      </div>
      <div class="tiny" style="color:var(--text); font-weight:700; margin-bottom:16px;">
        IF YOU ARE DOWN AND DON'T KNOW WHAT TO WORK ON OR DO, SEE MANAGER.
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); gap:14px;">
        <div class="guard-section">
          <h4 id="guardOpeningTitle">üåÖ Opening Checklist</h4>
          <div id="guardOpeningList"></div>
          <div class="guard-add-row">
            <button class="secondary miniBtn guardAddTask" data-section="opening">+ Add task</button>
          </div>
        </div>

        <div class="guard-section">
          <h4>üå§Ô∏è Midday Checklist</h4>
          <div id="guardMiddayList"></div>
          <div class="guard-add-row">
            <button class="secondary miniBtn guardAddTask" data-section="midday">+ Add task</button>
          </div>
        </div>

        <div class="guard-section">
          <h4 id="guardClosingTitle">üåô Closing Checklist</h4>
          <div id="guardClosingList"></div>
          <div class="guard-add-row">
            <button class="secondary miniBtn guardAddTask" data-section="closing">+ Add task</button>
          </div>
        </div>
      </div>

      <div class="guard-section" style="margin-top:16px;">
        <h4>üîÅ Rotation Plan</h4>
        <div class="tiny" style="color:var(--muted); margin-bottom:8px;" id="guardRotationHint">Log rotations by time, guard, and zone.</div>
        <table class="guard-rotation-table">
          <thead>
            <tr>
              <th style="width:25%;">Time / Block</th>
              <th style="width:40%;">Guards Up</th>
              <th style="width:25%;">Notes</th>
              <th style="width:10%;"></th>
            </tr>
          </thead>
          <tbody id="guardRotationBody"></tbody>
        </table>
        <button class="secondary" id="guardRotationAdd" style="margin-top:10px;">+ Add rotation</button>
      </div>

      <div class="guard-section" style="margin-top:16px;">
        <h4>üìù Notes</h4>
        <textarea id="guardNotes" rows="4" style="width:100%; border-radius:12px; padding:10px; background:#fff; border:1px solid rgba(148,163,184,.35); color:#0f172a;" placeholder="Document incidents, reminders, or handoff notes..."></textarea>
      </div>
    </div>
  </div>

  <!-- System Admin Panel -->
  <div id="panelAdmin" class="hidden">
    <div class="card">
      <h2 style="margin:0 0 16px; font-size:20px;">‚öôÔ∏è System Administration</h2>

      <!-- Roster Controls -->
      <div class="card" style="margin-bottom:20px; border-color: rgba(239,68,68,0.45); background: rgba(239,68,68,0.12);">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900; color:#ef4444;">üß® MASTER ROSTER RESET</h3>
        <div class="tiny" style="color:var(--muted); line-height:1.4; margin-bottom:12px;">Permanently delete all roster data for every location</div>
        <button class="danger" id="adminNavClearAllRosters">MASTER ROSTER RESET</button>
      </div>

      <!-- Location Management -->
      <div class="card" style="margin-bottom:20px;">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üìç Location Management</h3>
        <div id="locationsList" style="margin-bottom:12px;"></div>
        <button id="addLocationBtn" class="secondary">+ Add New Location</button>
      </div>

      <!-- Staff Management -->
      <div class="card">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üë• Staff Management</h3>
        <div id="staffList" style="margin-bottom:12px;"></div>
        <button id="addStaffBtn" class="secondary">+ Add New Staff</button>
      </div>

      <div class="card" id="staffOverridesCard" style="margin-top:20px;">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üß© Location Overrides</h3>
        <div class="grid2" style="margin-bottom:10px;">
          <div class="field">
            <label>Location</label>
            <select id="overrideLocationSelect"></select>
          </div>
          <div class="field">
            <label>Staff member</label>
            <select id="overrideStaffSelect"></select>
          </div>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button class="secondary miniBtn" id="overrideRemoveBtn">Remove from location</button>
          <button class="secondary miniBtn" id="overrideRestoreBtn">Restore to location</button>
        </div>
        <div id="overrideList" class="tiny" style="margin-top:10px; color:var(--muted);"></div>
      </div>

      <div class="card" style="margin-top:20px;">
        <h3 style="margin:0 0 12px; font-size:16px; font-weight:900;">üîí Read-only Mode</h3>
        <div class="tiny" style="color:var(--muted); margin-bottom:10px;">When enabled, tablets become view-only (no uploads, edits, clears, or exports).</div>
        <button id="toggleReadOnlyBtn" class="secondary">Toggle Read-only Mode</button>
      </div>

      <div class="card" style="margin-top:20px;">
        <div class="row" style="margin-bottom:10px;">
          <h3 style="margin:0; font-size:16px; font-weight:900;">üßæ Activity Log</h3>
          <div class="spacer"></div>
          <button id="activityLogRefresh" class="secondary miniBtn">Refresh</button>
        </div>
        <div id="activityLogTable" style="max-height:320px; overflow:auto;"></div>
      </div>

      <div class="tiny" style="margin-top:16px; color: rgba(159,176,208,.7);">
        System administration features require elevated privileges. Changes affect all locations.
      </div>
    </div>
  </div>

  <div id="versionWatermark" class="tiny" style="margin:18px 6px 6px; text-align:right; color:rgba(159,176,208,.6);">
    v4.8.5-beta ‚Ä¢ <span id="buildStamp">‚Äî</span>
  </div>
</div>

<!-- PIN Authentication Modal -->
<div class="modalBackdrop" id="pinModal">
  <div class="modal" style="max-width: 420px;">
    <h3>Admin Access</h3>

    <div class="field">
      <label>Enter 4-digit PIN</label>
      <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" style="font-size:24px; text-align:center; letter-spacing:8px;" />
      <div class="hint" id="pinError" style="color:#ef4444; display:none;">Incorrect PIN. Try again.</div>
      <div class="hint" id="pinLockout" style="color:#ef4444; display:none;">Too many attempts. Locked for 2 minutes.</div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="pinCancel">Cancel</button>
      <button class="primary" id="pinSubmit">Unlock</button>
    </div>
  </div>
</div>

<!-- Protected Action Modal -->
<div class="modalBackdrop" id="confirmModal">
  <div class="modal" style="max-width: 520px;">
    <h3 id="confirmTitle">Confirm action</h3>
    <div class="tiny" id="confirmMessage" style="color:var(--muted); margin-bottom:12px; white-space:pre-line;"></div>
    <div id="confirmImpactField" class="card hidden" style="margin-top:0; margin-bottom:12px; padding:10px; background: rgba(248,250,252,.9); border-radius:12px;">
      <div class="tiny" style="font-weight:900; margin-bottom:6px;">Impact summary</div>
      <div class="tiny" id="confirmImpactText" style="color:var(--muted); white-space:pre-line;"></div>
    </div>
    <div class="grid2">
      <div class="field" id="confirmDeleteField">
        <label>Type DELETE to confirm</label>
        <input type="text" id="confirmDeleteInput" placeholder="DELETE" />
      </div>
      <div class="field" id="confirmInitialsField">
        <label>Your initials</label>
        <input type="text" id="confirmInitialsInput" placeholder="AB" maxlength="4" />
      </div>
      <div class="field" id="confirmPinField">
        <label>Manager PIN</label>
        <input type="password" id="confirmPinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" />
      </div>
      <div class="field" id="confirmLocationField">
        <label>Location</label>
        <select id="confirmLocationSelect"></select>
      </div>
    </div>
    <div class="field hidden" id="confirmCheckboxField">
      <label style="text-transform:none; letter-spacing:0;">Confirmation checkbox</label>
      <div class="row" style="gap:8px; align-items:center;">
        <input type="checkbox" id="confirmCheckboxInput" />
        <span class="tiny" id="confirmCheckboxLabel" style="color:var(--muted);">I understand the impact.</span>
      </div>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="confirmCancel">Cancel</button>
      <button class="primary" id="confirmSubmit">Confirm</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modalBackdrop" id="settingsModal">
  <div class="modal">
    <h3>Device settings</h3>
    <div class="field">
      <label>Set device mode</label>
      <select id="deviceModeSelect">
        <option value="deck">Deck (tablet)</option>
        <option value="frontdesk">Front Desk (computer)</option>
      </select>
      <div class="hint">Deck requires manager approval to change zones.</div>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="openShortcutsBtn">‚å®Ô∏è Keyboard Shortcuts</button>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="settingsClose">Close</button>
      <button class="primary" id="settingsSave">Save</button>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modalBackdrop" id="shortcutsModal">
  <div class="modal">
    <h3>Keyboard shortcuts</h3>
    <div class="card" style="background: #f8fafc; border-radius:12px;">
      <div class="tiny" style="font-weight:800;">Global</div>
      <ul class="tiny" style="margin:8px 0 0 16px; color:var(--muted); line-height:1.6;">
        <li><strong>Ctrl/‚åò + B</strong> ‚Äî Toggle manager sidebar</li>
        <li><strong>Ctrl/‚åò + K</strong> ‚Äî Global search</li>
        <li><strong>Ctrl/‚åò + E</strong> ‚Äî Export modal</li>
      </ul>
      <div class="tiny" style="font-weight:800; margin-top:12px;">Manager navigation</div>
      <ul class="tiny" style="margin:8px 0 0 16px; color:var(--muted); line-height:1.6;">
        <li><strong>Ctrl/‚åò + 1</strong> ‚Äî Client Relations</li>
        <li><strong>Ctrl/‚åò + 2</strong> ‚Äî Billing</li>
      </ul>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="shortcutsClose">Close</button>
    </div>
  </div>
</div>

<!-- Global Search Modal -->
<div class="modalBackdrop" id="globalSearchModal">
  <div class="modal" style="max-width:620px;">
    <h3>Global Search</h3>
    <div class="field">
      <label>Search roster + manager + reports</label>
      <input type="text" id="globalSearchInput" placeholder="Search swimmers, instructors, reports..." />
    </div>
    <div id="globalSearchResults" style="max-height:360px; overflow:auto;"></div>
    <div class="modalFooter">
      <button class="secondary" id="globalSearchClose">Close</button>
    </div>
  </div>
</div>

<div class="drawer-backdrop" id="previewBackdrop"></div>
<div class="preview-drawer" id="previewDrawer">
  <div class="row" style="margin-bottom:10px;">
    <strong id="previewTitle">Preview</strong>
    <div class="spacer"></div>
    <button class="secondary miniBtn" id="previewClose">‚úï</button>
  </div>
  <div id="previewContent" class="tiny" style="color:var(--muted);"></div>
  <div class="row" style="margin-top:12px;">
    <button class="primary miniBtn" id="previewJumpBtn">Jump to item</button>
  </div>
</div>

<!-- Export Modal -->
<div class="modalBackdrop" id="exportModal">
  <div class="modal">
    <h3 id="exportModalTitle">Export</h3>
    <div class="field">
      <label>Export scope</label>
      <select id="exportScopeSelect">
        <option value="">Select scope‚Ä¶</option>
        <option value="view">Current view</option>
        <option value="full">Full data</option>
      </select>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="exportModalCancel">Cancel</button>
      <button class="primary" id="exportModalConfirm">Export</button>
    </div>
  </div>
</div>

<!-- Add Swimmer Modal -->
<div class="modalBackdrop" id="addModal">
  <div class="modal">
    <h3>Add swimmer (Add-on)</h3>

    <div class="grid2">
      <div class="field">
        <label>Swimmer name</label>
        <input type="text" id="addName" placeholder="First Last" />
      </div>

      <div class="field">
        <label>Age (optional)</label>
        <input type="text" id="addAge" placeholder="Example: 6y 2m" />
      </div>

      <div class="field">
        <label>Class type</label>
        <select id="addProgram">
          <option value="GROUP: Beginner 1">GROUP: Beginner 1</option>
          <option value="GROUP: Beginner 2">GROUP: Beginner 2</option>
          <option value="GROUP: Beginner 3">GROUP: Beginner 3</option>
          <option value="GROUP: Beginner 4">GROUP: Beginner 4</option>
          <option value="GROUP: Intermediate 1">GROUP: Intermediate 1</option>
          <option value="GROUP: Intermediate 2">GROUP: Intermediate 2</option>
          <option value="GROUP: Intermediate 3">GROUP: Intermediate 3</option>
          <option value="GROUP: Advanced 1">GROUP: Advanced 1</option>
          <option value="GROUP: Advanced 2">GROUP: Advanced 2</option>
          <option value="Private">Private</option>
          <option value="Semi-Private">Semi-Private</option>
          <option value="ParentTot">ParentTot</option>
          <option value="Toddler Transition">Toddler Transition</option>
          <option value="Adult">Adult</option>
        </select>
      </div>

      <div class="field">
        <label>Instructor (optional)</label>
        <select id="addInstructor">
          <option value="">(loading...)</option>
        </select>
      </div>

      <div class="field">
        <label>Zone (optional)</label>
        <select id="addZone">
          <option value="">(leave blank)</option>
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field">
        <label>Time block</label>
        <input type="text" id="addTime" disabled />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addCancel">Cancel</button>
      <button class="primary" id="addSave">Add swimmer</button>
    </div>
  </div>
</div>

<!-- Zone Override Modal -->
<div class="modalBackdrop" id="zoneModal">
  <div class="modal">
    <h3>Change zone</h3>

    <div class="row">
      <span class="pill">Swimmer: <strong id="zoneWho">‚Äî</strong></span>
      <div class="spacer"></div>
      <span class="pill">Mode: <strong id="zoneMode">Deck</strong></span>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div class="field">
        <label>New zone</label>
        <select id="zoneSelect">
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field" id="managerCodeField">
        <label>Manager code (required on Deck)</label>
        <input type="password" id="managerCode" placeholder="Enter code" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="zoneCancel">Cancel</button>
      <button class="primary" id="zoneSave">Save zone</button>
    </div>
  </div>
</div>

<!-- Add Location Modal -->
<div class="modalBackdrop" id="addLocationModal">
  <div class="modal">
    <h3>Add New Location</h3>

    <div class="field">
      <label>Location Name *</label>
      <input type="text" id="newLocationName" placeholder="e.g., SwimLabs Westchester" />
    </div>

    <div class="field">
      <label>Short Code</label>
      <input type="text" id="newLocationShortCode" placeholder="e.g., SLW" maxlength="10" />
    </div>

    <div class="field">
      <label>Brand</label>
      <select id="newLocationBrand">
        <option value="swimlabs">SwimLabs</option>
        <option value="safesplash">SafeSplash</option>
      </select>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addLocationCancel">Cancel</button>
      <button class="primary" id="addLocationSave">Add Location</button>
    </div>
  </div>
</div>

<!-- Add Staff Modal -->
<div class="modalBackdrop" id="addStaffModal">
  <div class="modal">
    <h3>Add New Staff Member</h3>

    <div class="grid2">
      <div class="field">
        <label>First Name *</label>
        <input type="text" id="newStaffFirstName" placeholder="First name" />
      </div>

      <div class="field">
        <label>Last Name *</label>
        <input type="text" id="newStaffLastName" placeholder="Last name" />
      </div>

      <div class="field">
        <label>Scope *</label>
        <select id="newStaffScope">
          <option value="state">State staff (applies to all locations)</option>
          <option value="override">Location override (add only)</option>
        </select>
      </div>

      <div class="field">
        <label>State *</label>
        <select id="newStaffState">
          <option value="New York">New York</option>
          <option value="California">California</option>
          <option value="Texas">Texas</option>
          <option value="Nevada">Nevada</option>
        </select>
      </div>

      <div class="field">
        <label>Location override</label>
        <select id="newStaffLocationOverride">
          <option value="">(select location)</option>
        </select>
      </div>

      <div class="field">
        <label>Phone</label>
        <input type="text" id="newStaffPhone" placeholder="1234567890" />
      </div>

      <div class="field">
        <label>Birthday</label>
        <input type="text" id="newStaffBirthday" placeholder="MM/DD/YY" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addStaffCancel">Cancel</button>
      <button class="primary" id="addStaffSave">Add Staff</button>
    </div>
  </div>
</div>

<!-- Attendance History Modal -->
<div class="modalBackdrop" id="attendanceHistoryModal">
  <div class="modal" style="max-width:700px;">
    <h3 id="attendanceHistoryTitle">Attendance History</h3>

    <div id="attendanceHistoryContent" style="margin-top:12px; max-height:500px; overflow-y:auto;">
      <!-- Content will be populated by JavaScript -->
    </div>

    <div class="modalFooter">
      <button class="secondary" id="attendanceHistoryClose">Close</button>
    </div>
  </div>
</div>

<!-- Trial Follow-up Modal -->
<div class="modalBackdrop" id="trialFollowupModal">
  <div class="modal" style="max-width:900px;">
    <h3>üß™ Trial Follow-up Report</h3>

    <div class="row" style="margin:10px 0 12px;">
      <span class="pill">Last <strong id="trialDaysLabel">30</strong> days</span>
      <div class="spacer"></div>
      <button class="secondary" id="trialRefreshBtn">Refresh</button>
    </div>

    <div id="trialSummary" class="tiny" style="color:var(--muted); margin-bottom:10px;">Loading‚Ä¶</div>
    <div id="trialReportTable" style="max-height:520px; overflow-y:auto;"></div>

    <div class="modalFooter">
      <button class="secondary" id="trialCloseBtn">Close</button>
    </div>
  </div>
</div>

<!-- Server Import Modal -->
<div class="modalBackdrop" id="serverImportModal">
  <div class="modal" style="max-width:720px;">
    <h3>üì¶ Server Backups</h3>

    <div class="row" style="margin:10px 0 12px;">
      <span class="pill">Location: <strong id="serverExportLocation">‚Äî</strong></span>
      <div class="spacer"></div>
      <button class="secondary" id="serverExportRefresh">Refresh</button>
    </div>

    <div id="serverExportList" style="max-height:420px; overflow-y:auto;"></div>

    <div class="modalFooter">
      <button class="secondary" id="serverImportClose">Close</button>
    </div>
  </div>
</div>

<!-- Attendance Report Modal -->
<div class="modalBackdrop" id="attendanceReportModal">
  <div class="modal" style="max-width:900px;">
    <h3>üìä Attendance Report</h3>

    <div class="row" style="margin:10px 0 16px; flex-wrap:wrap; gap:10px;">
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">Start Date</label>
        <input type="date" id="attendanceReportStartDate" style="width:100%;">
      </div>
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">End Date</label>
        <input type="date" id="attendanceReportEndDate" style="width:100%;">
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button class="secondary" id="attendanceReportGenerate" style="padding:8px 16px;">Generate Report</button>
      </div>
    </div>

    <div id="attendanceReportContent" style="max-height:450px; overflow-y:auto;">
      <div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">
        Select a date range and click "Generate Report" to view attendance analytics.
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="attendanceReportExportCSV">Export CSV</button>
      <button class="secondary" id="attendanceReportExportJSON">Export JSON</button>
      <button class="secondary" id="attendanceReportClose">Close</button>
    </div>
  </div>
</div>

<!-- Instructor Report Modal -->
<div class="modalBackdrop" id="instructorReportModal">
  <div class="modal" style="max-width:900px;">
    <h3>üë®‚Äçüè´ Instructor Performance Analytics</h3>

    <div class="row" style="margin:10px 0 16px; flex-wrap:wrap; gap:10px;">
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">Start Date</label>
        <input type="date" id="instructorReportStartDate" style="width:100%;">
      </div>
      <div class="field" style="margin:0; flex:1; min-width:120px;">
        <label style="font-size:12px;">End Date</label>
        <input type="date" id="instructorReportEndDate" style="width:100%;">
      </div>
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <button class="secondary" id="instructorReportGenerate" style="padding:8px 16px;">Generate Report</button>
      </div>
    </div>

    <div id="instructorReportContent" style="max-height:450px; overflow-y:auto;">
      <div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">
        Select a date range and click "Generate Report" to view instructor analytics.
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="instructorReportExportCSV">Export CSV</button>
      <button class="secondary" id="instructorReportExportJSON">Export JSON</button>
      <button class="secondary" id="instructorReportClose">Close</button>
    </div>
  </div>
</div>

<script>
  let currentBlock = null;
  let zoneTarget = null;
  let deviceMode = localStorage.getItem('deviceMode') || 'deck';
  let activeDateISO = null;
  let managerDateRange = null;
  let blocksList = [];
  let autoTimers = [];
  let currentLocation = null;
  let allLocations = [];
  let searchFilter = '';
  let pendingPinPanel = null; // Track which panel requested PIN auth ('virtualDesk' or 'admin')
  let nextAnnouncementTime = null; // Track next scheduled announcement
  let countdownInterval = null; // Interval for countdown updates
  let lastPanel = 'roster';
  let managerRole = null;
  let readOnlyMode = false;
  let wakeLock = null;
  let managerReportsCache = null;
  let managerNotificationsCache = [];
  let retentionTrendChart = null;
  let dropTrendChart = null;
  let attendanceTrendChart = null;
  let managerSection = 'client';
  let globalSearchResults = [];
  let previewTarget = null;
  let managerSidebarCollapsed = false;
  let bundleEditingId = null;
  let rosterCache = [];
  let globalAttendanceSummary = null;
  const dismissedNotificationsKey = 'manager_notifications_dismissed';
  const managerSectionFilters = {
    client: { start: null, end: null, instructor: '', status: '', showTrends: true, dropRange: '7', dropStart: '', dropEnd: '' },
    instructors: { showTrends: true },
    billing: {},
    system: {},
    guards: {}
  };
  const managerReportTypes = [
    { type: 'retention', metaId: 'reportMetaRetention', downloadId: 'reportDownloadRetention', label: 'Retention list (HTML)' },
    { type: 'aged_accounts', metaId: 'reportMetaAgedAccounts', downloadId: 'reportDownloadAgedAccounts', label: 'Aged accounts' },
    { type: 'drop_list', metaId: 'reportMetaDropList', downloadId: 'reportDownloadDropList', label: 'Drop list (HTML)' }
  ];

  const el = (id) => document.getElementById(id);
  const escapeSelector = (value) => {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(value);
    }
    return String(value).replace(/["\\]/g, '\\$&');
  };
  const normalizeKey = (value) => String(value || '').trim().toLowerCase();
  const locationTimeZones = new Map([
    ['new york', 'America/New_York'],
    ['ny', 'America/New_York'],
    ['westchester', 'America/New_York'],
    ['riverdale', 'America/New_York'],
    ['swimlabs westchester', 'America/New_York'],
    ['safesplash riverdale', 'America/New_York'],
    ['slw', 'America/New_York'],
    ['ssr', 'America/New_York'],
    ['texas', 'America/Chicago'],
    ['tx', 'America/Chicago'],
    ['woodlands', 'America/Chicago'],
    ['swimlabs woodlands', 'America/Chicago'],
    ['slx', 'America/Chicago'],
    ['california', 'America/Los_Angeles'],
    ['ca', 'America/Los_Angeles'],
    ['santa monica', 'America/Los_Angeles'],
    ['torrance', 'America/Los_Angeles'],
    ['safesplash santa monica', 'America/Los_Angeles'],
    ['safesplash torrance', 'America/Los_Angeles'],
    ['ssm', 'America/Los_Angeles'],
    ['sst', 'America/Los_Angeles'],
    ['nevada', 'America/Los_Angeles'],
    ['nv', 'America/Los_Angeles'],
    ['summerlin', 'America/Los_Angeles'],
    ['safesplash summerlin', 'America/Los_Angeles'],
    ['sss', 'America/Los_Angeles']
  ]);

  function getLocationTimeZone() {
    const fallbackZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if (!currentLocation) return fallbackZone;
    const candidates = [
      currentLocation.name,
      currentLocation.code,
      currentLocation.short_code,
      currentLocation.shortCode
    ].map(normalizeKey);
    for (const key of candidates) {
      if (locationTimeZones.has(key)) {
        return locationTimeZones.get(key);
      }
    }
    return fallbackZone;
  }

  function getTimeZoneOffsetMinutes(date, timeZone) {
    const dtf = new Intl.DateTimeFormat('en-US', {
      timeZone,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
    const parts = Object.fromEntries(
      dtf.formatToParts(date).map((p) => [p.type, p.value])
    );
    const asUTC = Date.UTC(
      Number(parts.year),
      Number(parts.month) - 1,
      Number(parts.day),
      Number(parts.hour),
      Number(parts.minute),
      Number(parts.second)
    );
    return (asUTC - date.getTime()) / 60000;
  }

  // Load locations on startup
  async function loadLocations() {
    try {
      const resp = await api('/api/locations');
      allLocations = resp.locations;
      
      const select = el('locationSelect');
      select.innerHTML = '';
      
      allLocations.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = loc.id;
        opt.textContent = loc.name;
        select.appendChild(opt);
      });
      
      // Load saved location or default to first
      const savedLocId = localStorage.getItem('location_id') || allLocations[0]?.id;
      select.value = savedLocId;
      currentLocation = allLocations.find(l => l.id == savedLocId);
      
      // Show/hide announcements tab based on location
      updateAnnouncementsVisibility();
      updateGuardTasksVisibility();
      await loadManagerReports();
      
    } catch (e) {
      console.error('Failed to load locations:', e);
    }
  }

  function setManagerTab(tab) {
    const overviewBtn = el('managerTabOverviewBtn');
    const reportsBtn = el('managerTabReportsBtn');
    const overviewPanel = el('managerTabOverview');
    const reportsPanel = el('managerTabReports');
    const isReports = tab === 'reports';
    if (overviewBtn) overviewBtn.classList.toggle('active', !isReports);
    if (reportsBtn) reportsBtn.classList.toggle('active', isReports);
    if (overviewPanel) overviewPanel.classList.toggle('hidden', isReports);
    if (reportsPanel) reportsPanel.classList.toggle('hidden', !isReports);
    if (isReports) {
      loadManagerReports();
    } else if (managerReportsCache) {
      loadManagerNotifications(managerReportsCache);
    }
  }

  function setManagerSection(section) {
    managerSection = section;
    const sections = document.querySelectorAll('[data-manager-section]');
    sections.forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.managerSection === section);
    });
    const panels = document.querySelectorAll('.manager-section');
    panels.forEach((panel) => {
      panel.classList.toggle('active', panel.id === `managerSection${section.charAt(0).toUpperCase()}${section.slice(1)}`);
    });
    const category = categoryForManagerSection(section);
    setCategoryTheme(category);
    const sidebar = el('managerSidebar');
    if (sidebar) {
      sidebar.classList.remove(...categoryClasses);
      sidebar.classList.add(`category-${category}`);
    }
    if (section === 'guards' && !isWestchesterLocation()) {
      showInlineError('guardsAlertStrip', 'Guard Tasks are only available for SwimLabs Westchester.');
    }
  }

  function toggleManagerSidebar(force) {
    const sidebar = el('managerSidebar');
    if (!sidebar) return;
    const next = typeof force === 'boolean' ? force : !managerSidebarCollapsed;
    managerSidebarCollapsed = next;
    sidebar.classList.toggle('collapsed', managerSidebarCollapsed);
    const toggleBtn = el('sidebarToggleBtn');
    if (toggleBtn) toggleBtn.classList.toggle('show', managerSidebarCollapsed);
  }

  function handleManagerScroll() {
    if (window.scrollY > 120) {
      toggleManagerSidebar(true);
    }
  }

  function showGlobalError(message, retryFn) {
    const banner = el('managerErrorBanner');
    if (!banner) return;
    banner.style.display = message ? 'block' : 'none';
    if (!message) {
      banner.textContent = '';
      return;
    }
    banner.innerHTML = `${escapeHtml(message)}${retryFn ? ' <button class="secondary miniBtn" id="managerRetryBtn">Retry</button>' : ''}`;
    if (retryFn) {
      const retryBtn = el('managerRetryBtn');
      if (retryBtn) retryBtn.addEventListener('click', retryFn);
    }
  }

  function showInlineError(targetId, message, retryFn) {
    const container = el(targetId);
    if (!container) return;
    container.innerHTML = `
      <div class="inline-error">
        ${escapeHtml(message)}
        ${retryFn ? '<div><button class="secondary miniBtn" data-inline-retry>Retry</button></div>' : ''}
      </div>
    `;
    if (retryFn) {
      const btn = container.querySelector('[data-inline-retry]');
      if (btn) btn.addEventListener('click', retryFn);
    }
  }

  document.querySelectorAll('[data-breakdown]').forEach((btn) => {
    btn.addEventListener('click', () => setBreakdownType(btn.dataset.breakdown));
  });

  async function loadManagerReports() {
    if (!currentLocation) return;
    try {
      const role = managerRole || 'manager';
      const resp = await api(`/api/manager-reports?location_id=${currentLocation.id}&role=${role}`);
      if (!resp.ok) throw new Error(resp.error || 'Failed to load manager reports');
      managerReportsCache = resp;
      managerReportTypes.forEach((report) => {
        const metaEl = el(report.metaId);
        const linkEl = el(report.downloadId);
        const latest = resp.latest?.[report.type] || null;
        if (latest) {
          const uploaded = formatShortDate(latest.uploaded_at);
          const warnings = latest.warnings_json ? JSON.parse(latest.warnings_json) : [];
          const warningLabel = warnings?.length ? ' ‚ö†Ô∏è Warnings' : '';
          if (metaEl) metaEl.textContent = `Last upload ${uploaded}${warningLabel}`;
          if (linkEl) linkEl.classList.add('hidden');
        } else {
          if (metaEl) metaEl.textContent = 'No report uploaded yet.';
          if (linkEl) linkEl.classList.add('hidden');
        }
      });
      const systemGrid = el('systemStatGrid');
      if (systemGrid) {
        const latestCount = Object.values(resp.latest || {}).filter(Boolean).length;
        systemGrid.innerHTML = `
          <div class="stat-card">
            <div class="tiny" style="color:var(--muted);">Reports available</div>
            <div class="value">${latestCount}</div>
          </div>
          <div class="stat-card">
            <div class="tiny" style="color:var(--muted);">Uploads tracked</div>
            <div class="value">${resp.reports?.length || 0}</div>
          </div>
        `;
      }
      loadManagerNotifications(resp);
      renderRetentionPanel();
      renderDropImpactPanel();
    } catch (e) {
      console.error('Failed to load manager reports:', e);
    }
    if (el('managerBreakdownsCard') && !el('managerBreakdownsCard').classList.contains('hidden')) {
      loadBreakdown();
    }
  }

  let currentBreakdownType = 'aged_accounts';
  let breakdownFilters = {
    dropRange: '7',
    dropStart: '',
    dropEnd: '',
    showTrends: true
  };

  function setBreakdownType(type) {
    currentBreakdownType = type;
    document.querySelectorAll('[data-breakdown]').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.breakdown === type);
    });
    loadBreakdown();
  }

  function renderBreakdownFilters() {
    const container = el('breakdownFilters');
    container.innerHTML = '';
    if (currentBreakdownType === 'drop_list') {
      container.innerHTML = `
        <span class="pill tiny">Filter</span>
        <select id="dropRangeSelect">
          <option value="7">Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30">Last 30 days</option>
          <option value="custom">Custom</option>
        </select>
        <input type="date" id="dropStartDate" />
        <input type="date" id="dropEndDate" />
        <button class="secondary miniBtn" id="dropApplyBtn">Apply</button>
        <button class="secondary miniBtn" id="trendToggle">${breakdownFilters.showTrends ? 'Hide' : 'Show'} trends</button>
      `;
      el('dropRangeSelect').value = breakdownFilters.dropRange;
      el('dropStartDate').value = breakdownFilters.dropStart;
      el('dropEndDate').value = breakdownFilters.dropEnd;
      el('dropApplyBtn').addEventListener('click', () => {
        breakdownFilters.dropRange = el('dropRangeSelect').value;
        breakdownFilters.dropStart = el('dropStartDate').value;
        breakdownFilters.dropEnd = el('dropEndDate').value;
        loadBreakdown();
      });
      el('trendToggle').addEventListener('click', () => {
        breakdownFilters.showTrends = !breakdownFilters.showTrends;
        loadBreakdown();
      });
    } else if (currentBreakdownType === 'retention') {
      container.innerHTML = `
        <button class="secondary miniBtn" id="trendToggle">
          ${breakdownFilters.showTrends ? 'Hide' : 'Show'} trends
        </button>
      `;
      el('trendToggle').addEventListener('click', () => {
        breakdownFilters.showTrends = !breakdownFilters.showTrends;
        loadBreakdown();
      });
    } else {
      container.innerHTML = '';
    }
  }

  function renderWarningBanner(warnings) {
    const banner = el('breakdownWarning');
    const text = el('breakdownWarningText');
    if (warnings && warnings.length) {
      banner.classList.remove('hidden');
      text.textContent = warnings.join(' ‚Ä¢ ');
    } else {
      banner.classList.add('hidden');
      text.textContent = '';
    }
  }

  function applyDropFilters(entries) {
    if (!entries.length) return entries;
    const now = new Date();
    let start = null;
    let end = null;
    if (breakdownFilters.dropRange !== 'custom') {
      const days = parseInt(breakdownFilters.dropRange, 10);
      start = new Date(now);
      start.setDate(now.getDate() - (days - 1));
      end = now;
    } else {
      if (breakdownFilters.dropStart) start = new Date(`${breakdownFilters.dropStart}T00:00:00`);
      if (breakdownFilters.dropEnd) end = new Date(`${breakdownFilters.dropEnd}T23:59:59`);
    }
    return entries.filter((entry) => {
      if (!entry.drop_date) return false;
      const dt = new Date(`${entry.drop_date}T00:00:00`);
      if (start && dt < start) return false;
      if (end && dt > end) return false;
      return true;
    });
  }

  function formatPercent(value) {
    if (value === null || value === undefined || Number.isNaN(Number(value))) return '‚Äî';
    return `${Number(value).toFixed(1)}%`;
  }

  function formatDelta(value, suffix = '%', digits = 1) {
    if (value === null || value === undefined || Number.isNaN(Number(value))) return '‚Äî';
    const num = Number(value);
    const sign = num > 0 ? '+' : '';
    const fixed = digits === 0 ? Math.round(num).toString() : num.toFixed(digits);
    return `${sign}${fixed}${suffix}`;
  }

  function todayISO() {
    return new Date().toISOString().split('T')[0];
  }

  function formatDateUS(value) {
    if (!value) return '‚Äî';
    const d = new Date(`${value}T00:00:00`);
    if (Number.isNaN(d.getTime())) return value;
    return d.toLocaleDateString('en-US');
  }

  function parseDropDetails(raw) {
    const rawString = Array.isArray(raw) ? raw.join(' ‚Ä¢ ') : String(raw || '');
    const tokens = rawString.split(' ‚Ä¢ ').map((t) => t.trim()).filter(Boolean);
    const tags = [];
    const details = [];
    let name = '';
    let instructor = '';
    const tagKeywords = ['makeup', 'trial', 'policy', 'owes', 'balance', 'add-on', 'addon', 'new'];
    tokens.forEach((token) => {
      const lower = token.toLowerCase();
      if (!name && /[a-z]/i.test(token) && !/am|pm/.test(lower) && !/\d{1,2}\/\d{1,2}/.test(token) && !/^\d/.test(token)) {
        name = token;
        return;
      }
      if (lower.includes('with ')) {
        instructor = token.replace(/.*with\s+/i, '').trim();
        return;
      }
      if (tagKeywords.some((tag) => lower.includes(tag))) {
        tags.push(token);
        return;
      }
      details.push(token);
    });
    return { rawString, name, instructor, details, tags };
  }

  function renderDropDetails(entry, id = '') {
    const parsed = parseDropDetails(entry.raw || []);
    if (!parsed.rawString) {
      return '<div class="drop-details"><div class="meta">No details available.</div></div>';
    }
    if (!parsed.name && !parsed.details.length && !parsed.instructor && !parsed.tags.length) {
      return `<div class="drop-details"><div class="meta">${escapeHtml(parsed.rawString)}</div></div>`;
    }
    const line2Parts = [];
    if (parsed.details.length) line2Parts.push(parsed.details.join(' ‚Ä¢ '));
    if (parsed.instructor) line2Parts.push(`with ${parsed.instructor}`);
    const chips = parsed.tags.map((tag) => renderBadge(tag, 'amber')).join(' ');
    const longText = parsed.rawString.length > 120;
    const truncated = longText ? `${parsed.rawString.slice(0, 120)}...` : parsed.rawString;
    const expand = longText ? `
      <button class="secondary miniBtn" data-drop-toggle="${id}">View</button>
      <div class="tiny hidden" data-drop-full="${id}" style="margin-top:6px; color:var(--muted);">${escapeHtml(parsed.rawString)}</div>
    ` : '';
    return `
      <div class="drop-details">
        ${parsed.name ? `<div class="name">${escapeHtml(parsed.name)}</div>` : ''}
        ${line2Parts.length ? `<div class="meta">${escapeHtml(line2Parts.join(' ‚Ä¢ '))}</div>` : ''}
        ${chips ? `<div class="chips">${chips}</div>` : ''}
        ${!parsed.name && !line2Parts.length && !chips ? `<div class="meta">${escapeHtml(truncated)}</div>` : ''}
        ${expand}
      </div>
    `;
  }

  function getWeekKey(dateStr) {
    if (!dateStr) return null;
    const date = new Date(`${dateStr}T00:00:00`);
    if (Number.isNaN(date.getTime())) return null;
    const day = date.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    date.setDate(date.getDate() + diff);
    return date.toISOString().split('T')[0];
  }

  function renderTrendChart(type, reports) {
    const container = el('breakdownTrends');
    if (!container) return;
    if (type !== 'retention' && type !== 'drop_list') {
      container.innerHTML = '';
      return;
    }
    if (!breakdownFilters.showTrends) {
      container.innerHTML = '';
      return;
    }
    if (!reports || !reports.length) {
      container.innerHTML = '<div class="trend-card"><div class="tiny" style="color:var(--muted);">No trend data available yet.</div></div>';
      return;
    }
    if (type === 'retention') {
      const points = reports
        .map((report) => {
          const entries = report.data_json ? JSON.parse(report.data_json).instructors || [] : [];
          const vals = entries.map((e) => Number(e.retention_percent)).filter((v) => !Number.isNaN(v));
          const avg = vals.length ? vals.reduce((sum, v) => sum + v, 0) / vals.length : null;
          return { label: formatShortDate(report.uploaded_at), value: avg };
        })
        .filter((p) => p.value !== null)
        .slice(0, 8)
        .reverse();
      if (!points.length) {
        container.innerHTML = '<div class="trend-card"><div class="tiny" style="color:var(--muted);">No retention trend data yet.</div></div>';
        return;
      }
      container.innerHTML = `
        <div class="trend-card">
          <div style="font-weight:700; margin-bottom:8px;">Overall Retention Trend</div>
          <canvas id="retentionTrendChart" height="220"></canvas>
        </div>
      `;
      const ctx = el('retentionTrendChart');
      if (retentionTrendChart) retentionTrendChart.destroy();
      retentionTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: points.map((p) => p.label),
          datasets: [{
            label: 'Retention %',
            data: points.map((p) => Number(p.value.toFixed(1))),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,.15)',
            tension: 0.35,
            fill: true,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { ticks: { callback: (v) => `${v}%` } }
          }
        }
      });
    }
    if (type === 'drop_list') {
      const allEntries = reports.flatMap((report) => {
        const reportParsed = report.data_json ? JSON.parse(report.data_json) : {};
        return reportParsed.entries || [];
      });
      const counts = new Map();
      allEntries.forEach((entry) => {
        const key = getWeekKey(entry.drop_date);
        if (!key) return;
        counts.set(key, (counts.get(key) || 0) + 1);
      });
      const labels = Array.from(counts.keys()).sort();
      if (!labels.length) {
        container.innerHTML = '<div class="trend-card"><div class="tiny" style="color:var(--muted);">No drop trends yet.</div></div>';
        return;
      }
      container.innerHTML = `
        <div class="trend-card">
          <div style="font-weight:700; margin-bottom:8px;">Drops per Week</div>
          <canvas id="dropTrendChart" height="220"></canvas>
        </div>
      `;
      const ctx = el('dropTrendChart');
      if (dropTrendChart) dropTrendChart.destroy();
      dropTrendChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Drops',
            data: labels.map((key) => counts.get(key)),
            backgroundColor: 'rgba(16,185,129,.35)',
            borderColor: '#10b981'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
  }

  function getDismissedNotifications() {
    try {
      return JSON.parse(localStorage.getItem(dismissedNotificationsKey) || '[]');
    } catch (e) {
      return [];
    }
  }

  function dismissNotification(id) {
    const dismissed = new Set(getDismissedNotifications());
    dismissed.add(id);
    localStorage.setItem(dismissedNotificationsKey, JSON.stringify(Array.from(dismissed)));
    renderManagerNotifications(managerNotificationsCache);
  }

  function renderManagerNotifications(notifications) {
    const list = el('managerNotificationsList');
    if (!list) return;
    const dismissed = new Set(getDismissedNotifications());
    const active = notifications.filter((note) => !dismissed.has(note.id));
    if (!active.length) {
      list.innerHTML = '<div class="tiny" style="color:var(--muted);">No notifications right now.</div>';
      return;
    }
    list.innerHTML = active.map((note) => `
      <div class="notification-card ${note.variant}">
        <div style="flex:1;">
          <div style="font-weight:700;">${escapeHtml(note.title)}</div>
          <div class="tiny" style="color:var(--muted); margin-top:4px;">${escapeHtml(note.description)}</div>
          ${note.actionLabel ? `<button class="secondary miniBtn" data-action="${note.action}" style="margin-top:8px;">${escapeHtml(note.actionLabel)}</button>` : ''}
        </div>
        <button class="dismiss" data-dismiss="${note.id}" aria-label="Dismiss notification">‚úï</button>
      </div>
    `).join('');
    list.querySelectorAll('[data-dismiss]').forEach((btn) => {
      btn.addEventListener('click', () => dismissNotification(btn.dataset.dismiss));
    });
    list.querySelectorAll('[data-action]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        if (action === 'retention') {
          setManagerSection('instructors');
          setTrainerTab('retention');
        }
        if (action === 'drop_list') {
          setManagerSection('instructors');
          setTrainerTab('drop');
        }
        if (action === 'aged_accounts') {
          setManagerSection('system');
        }
        if (action === 'bundle_followup') {
          setManagerSection('billing');
        }
      });
    });
  }

  function parseDateFromCell(value) {
    const match = String(value || '').match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (!match) return null;
    const mm = String(match[1]).padStart(2, '0');
    const dd = String(match[2]).padStart(2, '0');
    return new Date(`${match[3]}-${mm}-${dd}T00:00:00`);
  }

  async function loadManagerNotifications(reportSummary) {
    if (!currentLocation) return;
    const notifications = [];
    const latest = reportSummary?.latest || {};
    const now = new Date();
    managerReportTypes.forEach((report) => {
      const latestReport = latest[report.type];
      if (!latestReport) {
        notifications.push({
          id: `missing-${report.type}-${currentLocation.id}`,
          title: `${report.label} missing`,
          description: 'No report uploaded yet.',
          action: report.type,
          actionLabel: 'Upload report',
          variant: 'warning'
        });
        return;
      }
      const uploadedAt = latestReport.uploaded_at ? new Date(latestReport.uploaded_at) : null;
      if (uploadedAt && (now - uploadedAt) / (1000 * 60 * 60 * 24) > 30) {
        notifications.push({
          id: `stale-${report.type}-${latestReport.uploaded_at}`,
          title: `${report.label} stale`,
          description: `Last upload ${formatShortDate(latestReport.uploaded_at)}.`,
          action: report.type,
          actionLabel: 'Review report',
          variant: 'warning'
        });
      }
    });

    try {
      const retentionResp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=retention`);
      const retentionReports = retentionResp.reports || [];
      const latestRetention = retentionReports[0];
      const prevRetention = retentionReports[1];
      if (latestRetention && prevRetention) {
        const current = latestRetention.data_json ? JSON.parse(latestRetention.data_json).instructors || [] : [];
        const prevMap = new Map((prevRetention.data_json ? JSON.parse(prevRetention.data_json).instructors || [] : [])
          .map((row) => [normalizeKey(row.instructor), row]));
        const drops = current.filter((row) => {
          const prev = prevMap.get(normalizeKey(row.instructor));
          if (!prev || row.retention_percent == null || prev.retention_percent == null) return false;
          return Number(row.retention_percent) - Number(prev.retention_percent) < 0;
        });
        if (drops.length) {
          notifications.push({
            id: `retention-drop-${latestRetention.uploaded_at}`,
            title: 'Retention drops detected',
            description: `${drops.length} instructor${drops.length === 1 ? '' : 's'} down vs last upload.`,
            action: 'retention',
            actionLabel: 'View retention',
            variant: 'danger'
          });
        }
      }
    } catch (e) {
      console.warn('Retention notification check failed', e);
    }

    try {
      const agedResp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=aged_accounts`);
      const agedReports = agedResp.reports || [];
      const latestAged = agedReports[0];
      if (latestAged) {
        const parsed = latestAged.data_json ? JSON.parse(latestAged.data_json) : {};
        const rows = parsed.rows || [];
        let bundleExpiring = 0;
        rows.forEach((row) => {
          const rowText = row.join(' ').toLowerCase();
          if (!rowText.includes('bundle') && !rowText.includes('package')) return;
          row.forEach((cell) => {
            const dt = parseDateFromCell(cell);
            if (!dt) return;
            const days = (dt - now) / (1000 * 60 * 60 * 24);
            if (days >= 0 && days <= 7) bundleExpiring += 1;
          });
        });
        if (bundleExpiring) {
          notifications.push({
            id: `bundle-expiring-${latestAged.uploaded_at}`,
            title: 'Bundles expiring soon',
            description: `${bundleExpiring} bundle${bundleExpiring === 1 ? '' : 's'} expiring within 7 days.`,
            action: 'aged_accounts',
            actionLabel: 'Review aged accounts',
            variant: 'warning'
          });
        }
      }
    } catch (e) {
      console.warn('Bundle notification check failed', e);
    }

    try {
      const bundleResp = await api(`/api/bundles?location_id=${currentLocation.id}`);
      const bundles = bundleResp.bundles || [];
      const expiring = bundles.filter((bundle) => {
        if (!bundle.expiration_date) return false;
        const dt = new Date(`${bundle.expiration_date}T00:00:00`);
        const days = (dt - now) / (1000 * 60 * 60 * 24);
        return days >= 0 && days <= 7;
      });
      if (expiring.length) {
        notifications.push({
          id: `bundle-followup-${currentLocation.id}-${expiring.length}`,
          title: 'Bundles expiring within 7 days',
          description: `${expiring.length} bundle${expiring.length === 1 ? '' : 's'} need follow-up.`,
          action: 'bundle_followup',
          actionLabel: 'Open bundle tracker',
          variant: 'warning'
        });
      }
    } catch (e) {
      console.warn('Bundle tracker notification check failed', e);
    }

    managerNotificationsCache = notifications;
    renderManagerNotifications(notifications);
  }

  function ensureClientDateRange() {
    if (!managerSectionFilters.client.start) managerSectionFilters.client.start = todayISO();
    if (!managerSectionFilters.client.end) managerSectionFilters.client.end = todayISO();
    if (el('clientRangeStart')) el('clientRangeStart').value = managerSectionFilters.client.start;
    if (el('clientRangeEnd')) el('clientRangeEnd').value = managerSectionFilters.client.end;
  }

  function getClientDateRange() {
    ensureClientDateRange();
    return {
      start: managerSectionFilters.client.start,
      end: managerSectionFilters.client.end
    };
  }

  async function loadAttendanceSummary() {
    if (!currentLocation) return;
    const { start, end } = getClientDateRange();
    try {
      const resp = await api(`/api/attendance-summary?location_id=${currentLocation.id}&start=${start}&end=${end}`);
      const summary = resp.summary || { totals: {}, dateStats: [], instructorStats: [] };
      renderAttendanceSummary(summary);
      renderAttendanceTrend(summary);
    } catch (e) {
      showInlineError('attendanceSummaryTable', `Attendance summary failed: ${e.message}`, loadAttendanceSummary);
    }
  }

  async function loadGlobalAttendanceTrends() {
    if (!currentLocation) return;
    try {
      const end = todayISO();
      const start = new Date();
      start.setDate(start.getDate() - 60);
      const resp = await api(`/api/attendance-summary?location_id=${currentLocation.id}&start=${start.toISOString().split('T')[0]}&end=${end}`);
      globalAttendanceSummary = resp.summary || null;
      if (globalAttendanceSummary) renderAttendanceTrend(globalAttendanceSummary);
    } catch (e) {
      console.warn('Global attendance trends failed', e);
    }
  }

  function renderAttendanceSummary(summary) {
    const totals = summary.totals || { total: 0, present: 0, absent: 0, rate: 0 };
    const grid = el('clientStatGrid');
    if (grid) {
      grid.innerHTML = `
        <div class="stat-card">
          <div class="tiny" style="color:var(--muted);">Attendance rate</div>
          <div class="value">${totals.rate || 0}%</div>
        </div>
        <div class="stat-card">
          <div class="tiny" style="color:var(--muted);">Present</div>
          <div class="value">${totals.present || 0}</div>
        </div>
        <div class="stat-card danger">
          <div class="tiny" style="color:var(--muted);">Absent</div>
          <div class="value">${totals.absent || 0}</div>
        </div>
      `;
    }
    const alertStrip = el('clientAlertStrip');
    if (alertStrip) {
      alertStrip.innerHTML = [
        renderAlertPill('Absences', totals.absent || 0, totals.absent ? 'rose' : 'slate', 'absences', '‚ùå'),
        renderAlertPill('Attendance rate', `${totals.rate || 0}%`, 'teal', 'attendance', '‚úÖ'),
        renderAlertPill('Roster marked', totals.total || 0, 'slate', 'history', 'üë•')
      ].join('');
      alertStrip.querySelectorAll('[data-alert]').forEach((pill) => {
        pill.addEventListener('click', () => {
          const action = pill.dataset.alert;
          if (action === 'absences') el('clientTabAbsence')?.click();
          if (action === 'attendance') el('clientTabAttendance')?.click();
          if (action === 'history') el('clientTabHistory')?.click();
        });
      });
    }
    const dateRows = (summary.dateStats || []).map((entry) => [
      formatDateUS(entry.date),
      entry.present,
      entry.absent,
      `${entry.rate}%`
    ]);
    const tableHtml = renderTable(['Date', 'Present', 'Absent', 'Rate'], dateRows);
    const target = el('attendanceSummaryTable');
    if (target) target.innerHTML = tableHtml;

    const instructorRows = (summary.instructorStats || []).map((entry) => [
      entry.instructor,
      entry.present,
      entry.absent,
      `${entry.rate}%`
    ]);
    const instTarget = el('attendanceInstructorTable');
    if (instTarget) instTarget.innerHTML = renderTable(['Instructor', 'Present', 'Absent', 'Rate'], instructorRows);
  }

  function renderAttendanceTrend(summary) {
    const container = el('attendanceTrends');
    if (!container) return;
    if (!managerSectionFilters.client.showTrends) {
      container.innerHTML = '<div class="tiny" style="color:var(--muted);">Trends hidden.</div>';
      return;
    }
    const stats = (globalAttendanceSummary?.dateStats || summary.dateStats || []);
    if (!stats.length) {
      container.innerHTML = '<div class="tiny" style="color:var(--muted);">No attendance trends yet.</div>';
      return;
    }
    container.innerHTML = '<canvas id="attendanceTrendChart" height="220"></canvas>';
    const ctx = el('attendanceTrendChart');
    if (attendanceTrendChart) attendanceTrendChart.destroy();
    attendanceTrendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: stats.map((s) => formatDateUS(s.date)),
        datasets: [{
          label: 'Attendance %',
          data: stats.map((s) => s.rate),
          borderColor: '#0ea5e9',
          backgroundColor: 'rgba(14,165,233,0.15)',
          tension: 0
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  }

  async function loadAbsenceTracker() {
    if (!currentLocation) return;
    const { start, end } = getClientDateRange();
    try {
      const resp = await api(`/api/absence-tracker?location_id=${currentLocation.id}&start=${start}&end=${end}`);
      renderAbsenceTracker(resp.rows || []);
    } catch (e) {
      showInlineError('absenceTrackerTable', `Absence tracker failed: ${e.message}`, loadAbsenceTracker);
    }
  }

  function renderAbsenceTracker(rows) {
    const filtered = rows.filter((row) => {
      const inst = managerSectionFilters.client.instructor;
      const status = managerSectionFilters.client.status;
      if (inst && (row.instructor_name || '') !== inst) return false;
      if (status && (row.status || 'new') !== status) return false;
      return true;
    });
    if (!filtered.length) {
      el('absenceTrackerTable').innerHTML = renderEmptyState({
        icon: 'ü´ß',
        title: 'No absences in this range',
        description: 'Try adjusting the date range or filters.',
        actionLabel: 'Adjust filters',
        action: 'filters'
      });
      el('absenceTrackerTable').querySelector('[data-empty-action]')?.addEventListener('click', () => {
        el('clientFiltersAdvanced')?.classList.remove('hidden');
      });
      return;
    }
    const displayRows = filtered.slice(0, 20);
    const rowsHtml = displayRows.map((row) => {
      const status = row.status || 'new';
      const sourceLabel = row.attendance_auto_absent ? 'Auto' : 'Manual';
      const level = parseTypeLevel(row.program || '').level;
      const encodedName = encodeURIComponent(row.swimmer_name);
      const encodedNotes = encodeURIComponent(row.notes || '');
      return `
        <tr>
          <td>${escapeHtml(row.swimmer_name)}</td>
          <td>${formatDateUS(row.date)}<div class="tiny">${escapeHtml(row.start_time || '')}</div></td>
          <td>${escapeHtml(row.instructor_name || '‚Äî')}</td>
          <td>${escapeHtml(level || '‚Äî')}</td>
          <td>${sourceLabel}</td>
          <td><span class="chip">${escapeHtml(status)}</span></td>
          <td>
            <button class="secondary miniBtn" data-action="contacted" data-row="${encodedName}" data-date="${row.date}" data-time="${row.start_time || ''}">Contacted</button>
            <button class="secondary miniBtn" data-action="rescheduled" data-row="${encodedName}" data-date="${row.date}" data-time="${row.start_time || ''}">Rescheduled</button>
            <button class="secondary miniBtn" data-action="complete" data-row="${encodedName}" data-date="${row.date}" data-time="${row.start_time || ''}">Complete</button>
            <button class="secondary miniBtn" data-action="notes" data-row="${encodedName}" data-date="${row.date}" data-time="${row.start_time || ''}" data-notes="${encodedNotes}">Notes</button>
          </td>
        </tr>
      `;
    }).join('');
    const moreCount = filtered.length - displayRows.length;
    el('absenceTrackerTable').innerHTML = `
      ${moreCount > 0 ? `<div class="tiny" style="color:var(--muted); margin-bottom:6px;">Showing first 20 of ${filtered.length} absences.</div>` : ''}
      <table>
        <thead>
          <tr>
            <th>Swimmer</th>
            <th>Date/Time</th>
            <th>Instructor</th>
            <th>Level</th>
            <th>Absent Source</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      </table>
    `;
    el('absenceTrackerTable').querySelectorAll('[data-action]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const action = btn.dataset.action;
        const swimmerName = decodeURIComponent(btn.dataset.row || '');
        const date = btn.dataset.date;
        const time = btn.dataset.time;
        let nextStatus = action;
        let notes = decodeURIComponent(btn.dataset.notes || '');
        if (action === 'notes') {
          const input = prompt('Update notes', notes || '');
          if (input === null) return;
          notes = input;
          nextStatus = null;
        }
        const confirmed = await openProtectedAction({
          title: 'Update absence follow-up',
          message: `Update ${swimmerName} (${formatDateUS(date)})`,
          requireInitials: true,
          requirePin: true
        });
        if (!confirmed.ok) return;
        await api('/api/absence-tracker/update', {
          method: 'POST',
          body: JSON.stringify({
            location_id: currentLocation.id,
            swimmer_name: swimmerName,
            date,
            start_time: time || null,
            status: nextStatus,
            notes,
            pin: confirmed.pin
          })
        });
        loadAbsenceTracker();
      });
    });
  }

  async function loadAttendanceHistory() {
    if (!currentLocation) return;
    const { start, end } = getClientDateRange();
    try {
      const resp = await api(`/api/attendance-history?location_id=${currentLocation.id}&start=${start}&end=${end}&limit=500`);
      renderAttendanceHistory(resp.rows || []);
    } catch (e) {
      showInlineError('attendanceHistoryTable', `Attendance history failed: ${e.message}`, loadAttendanceHistory);
    }
  }

  function getClientDropRange() {
    const range = managerSectionFilters.client.dropRange;
    const start = managerSectionFilters.client.dropStart;
    const end = managerSectionFilters.client.dropEnd;
    return { range, start, end };
  }

  function applyClientDropFilters(entries) {
    if (!entries.length) return entries;
    const { range, start, end } = getClientDropRange();
    const now = new Date();
    let startDate = null;
    let endDate = null;
    if (range !== 'custom') {
      const days = parseInt(range, 10);
      startDate = new Date(now);
      startDate.setDate(now.getDate() - (days - 1));
      endDate = now;
    } else {
      if (start) startDate = new Date(`${start}T00:00:00`);
      if (end) endDate = new Date(`${end}T23:59:59`);
    }
    return entries.filter((entry) => {
      if (!entry.drop_date) return false;
      const dt = new Date(`${entry.drop_date}T00:00:00`);
      if (startDate && dt < startDate) return false;
      if (endDate && dt > endDate) return false;
      return true;
    });
  }

  async function loadClientDropList() {
    if (!currentLocation) return;
    try {
      const resp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=drop_list&include_archived=true`);
      const entries = resp.reports.flatMap((report) => {
        const parsed = report.data_json ? JSON.parse(report.data_json) : {};
        return parsed.entries || [];
      });
      renderClientDropList(entries);
    } catch (e) {
      showInlineError('clientDropListTable', `Drop list failed: ${e.message}`, loadClientDropList);
    }
  }

  function renderClientDropList(entries) {
    const filtered = applyClientDropFilters(entries);
    if (!filtered.length) {
      el('clientDropListTable').innerHTML = renderEmptyState({
        icon: 'üìâ',
        title: 'No drop list entries',
        description: 'Upload a drop list report or widen the date range.',
        actionLabel: 'Go to reports',
        action: 'system'
      });
      el('clientDropListTable').querySelector('[data-empty-action]')?.addEventListener('click', () => setManagerSection('system'));
      return;
    }
    const displayRows = filtered.slice(0, 20);
    const rows = displayRows.map((entry, idx) => [
      formatDateUS(entry.drop_date),
      renderDropDetails(entry, `client-drop-${idx}`)
    ]);
    const moreCount = filtered.length - displayRows.length;
    el('clientDropListTable').innerHTML = `
      ${moreCount > 0 ? `<div class="tiny" style="color:var(--muted); margin-bottom:6px;">Showing first 20 of ${filtered.length} drops.</div>` : ''}
      ${renderTable(['Drop Date', 'Details'], rows)}
    `;
    el('clientDropListTable').querySelectorAll('[data-drop-toggle]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const key = btn.dataset.dropToggle;
        const target = el('clientDropListTable').querySelector(`[data-drop-full="${key}"]`);
        if (target) target.classList.toggle('hidden');
      });
    });
  }

  function renderAttendanceHistory(rows) {
    if (!rows.length) {
      el('attendanceHistoryTable').innerHTML = renderEmptyState({
        icon: 'üìÖ',
        title: 'No attendance history',
        description: 'Select a wider date range to view historical snapshots.'
      });
      return;
    }
    const displayRows = rows.slice(0, 20);
    const tableRows = displayRows.map((row) => [
      formatDateUS(row.date),
      row.start_time || '‚Äî',
      row.swimmer_name,
      row.instructor_name || '‚Äî',
      row.attendance === 1 ? 'Here' : row.attendance === 0 ? 'Absent' : '‚Äî',
      row.attendance_auto_absent ? 'Auto' : 'Manual',
      row.attendance_at || row.updated_at || '‚Äî'
    ]);
    const moreCount = rows.length - displayRows.length;
    el('attendanceHistoryTable').innerHTML = `
      ${moreCount > 0 ? `<div class="tiny" style="color:var(--muted); margin-bottom:6px;">Showing first 20 of ${rows.length} history rows.</div>` : ''}
      ${renderTable(
        ['Date', 'Time', 'Swimmer', 'Instructor', 'Attendance', 'Source', 'Updated at'],
        tableRows
      )}
    `;
  }

  function loadManagerDashboard() {
    ensureClientDateRange();
    renderSidebarLocationOptions();
    if (el('clientDropRange')) {
      el('clientDropRange').value = managerSectionFilters.client.dropRange;
      el('clientDropStart').value = managerSectionFilters.client.dropStart;
      el('clientDropEnd').value = managerSectionFilters.client.dropEnd;
      const isCustom = managerSectionFilters.client.dropRange === 'custom';
      el('clientDropStart').classList.toggle('hidden', !isCustom);
      el('clientDropEnd').classList.toggle('hidden', !isCustom);
    }
    loadManagerReports();
    loadAttendanceSummary();
    loadGlobalAttendanceTrends();
    loadAbsenceTracker();
    loadAttendanceHistory();
    loadClientDropList();
    loadBundles();
    renderRetentionPanel();
    renderDropImpactPanel();
    renderAttendanceImpactPanel();
    const guardAlert = el('guardsAlertStrip');
    if (guardAlert) {
      guardAlert.innerHTML = renderAlertPill('Guard tasks', isWestchesterLocation() ? 'Available' : 'Unavailable', isWestchesterLocation() ? 'teal' : 'slate', 'guard_tasks', 'üõü');
    }
    const systemAlert = el('systemAlertStrip');
    if (systemAlert) {
      systemAlert.innerHTML = renderAlertPill('Reports', managerReportsCache?.reports?.length || 0, 'slate', 'reports', 'üìÅ');
    }
  }

  async function renderSidebarLocationOptions() {
    const bundleSelect = el('bundleLocation');
    if (bundleSelect) {
      bundleSelect.innerHTML = '';
      allLocations.forEach((loc) => {
        const opt = document.createElement('option');
        opt.value = loc.id;
        opt.textContent = loc.name;
        bundleSelect.appendChild(opt);
      });
      bundleSelect.value = currentLocation?.id || allLocations[0]?.id || '';
    }
    const instructorSelect = el('clientInstructorFilter');
    if (instructorSelect) {
      instructorSelect.innerHTML = '<option value="">All instructors</option>';
      try {
        const locId = currentLocation?.id || 1;
        const resp = await api(`/api/instructors?location_id=${locId}`);
        (resp.instructors || []).forEach((inst) => {
          const opt = document.createElement('option');
          opt.value = inst.displayName;
          opt.textContent = inst.displayName;
          instructorSelect.appendChild(opt);
        });
      } catch (e) {
        console.warn('Failed to load instructor filter', e);
      }
    }
  }

  function calculateBundlePreview({ durationWeeks, monthlyPrice, startDate }) {
    const weeks = Number(durationWeeks || 0);
    const monthly = Number(monthlyPrice || 0);
    if (![12, 24, 52].includes(weeks) || !monthly) return null;
    const months = weeks / 4;
    const discountRate = weeks === 12 ? 0.15 : 0.2;
    const discountedMonthly = monthly * (1 - discountRate);
    const totalBilled = discountedMonthly * months;
    const baseTotal = monthly * months;
    const discountAmount = baseTotal - totalBilled;
    const houseCredit = discountAmount + (weeks === 52 ? 50 : 0);
    let expirationDate = '';
    if (startDate) {
      const d = new Date(`${startDate}T00:00:00`);
      d.setDate(d.getDate() + weeks * 7);
      expirationDate = d.toISOString().split('T')[0];
    }
    return { discountedMonthly, totalBilled, houseCredit, expirationDate };
  }

  async function loadBundles() {
    if (!currentLocation) return;
    try {
      const locId = Number(el('bundleLocation')?.value || currentLocation.id);
      const resp = await api(`/api/bundles?location_id=${locId}`);
      renderBundles(resp.bundles || []);
    } catch (e) {
      showInlineError('bundleTable', `Bundle tracker failed: ${e.message}`, loadBundles);
    }
  }

  function renderBundles(bundles) {
    const sorted = [...bundles].sort((a, b) => (a.expiration_date || '').localeCompare(b.expiration_date || ''));
    const now = new Date();
    const expiring = sorted.filter((bundle) => {
      if (!bundle.expiration_date) return false;
      const dt = new Date(`${bundle.expiration_date}T00:00:00`);
      const days = (dt - now) / (1000 * 60 * 60 * 24);
      return days >= 0 && days <= 7;
    });

    const statGrid = el('billingStatGrid');
    if (statGrid) {
      statGrid.innerHTML = `
        <div class="stat-card">
          <div class="tiny" style="color:var(--muted);">Active bundles</div>
          <div class="value">${sorted.length}</div>
        </div>
        <div class="stat-card alert">
          <div class="tiny" style="color:var(--muted);">Expiring in 7 days</div>
          <div class="value">${expiring.length}</div>
        </div>
      `;
    }
    const billingAlert = el('billingAlertStrip');
    if (billingAlert) {
      billingAlert.innerHTML = [
        renderAlertPill('Bundles', sorted.length, 'slate', 'bundles', 'üì¶'),
        renderAlertPill('Expiring soon', expiring.length, expiring.length ? 'amber' : 'slate', 'bundle_followup', '‚è∞')
      ].join('');
      billingAlert.querySelectorAll('[data-alert]').forEach((pill) => {
        pill.addEventListener('click', () => {
          if (pill.dataset.alert === 'bundle_followup') setManagerSection('billing');
        });
      });
    }

    const followUp = el('bundleNeedsFollowUp');
    if (followUp) {
      if (!expiring.length) {
        followUp.innerHTML = '<div class="tiny" style="color:var(--muted);">No bundles expiring in the next 7 days.</div>';
      } else {
        followUp.innerHTML = expiring.map((bundle) => `
          <div class="notification-card warning" style="margin-bottom:8px;">
            <div style="flex:1;">
              <div style="font-weight:700;">${escapeHtml(bundle.customer_name)}</div>
              <div class="tiny" style="color:var(--muted);">Expires ${formatDateUS(bundle.expiration_date)} ‚Ä¢ ${escapeHtml(bundle.phone || 'No phone')}</div>
            </div>
            <span class="chip amber">Follow up</span>
          </div>
        `).join('');
      }
    }

    if (!sorted.length) {
      el('bundleTable').innerHTML = renderEmptyState({
        icon: 'üì¶',
        title: 'No bundles saved yet',
        description: 'Add a bundle above to track billing follow-ups.'
      });
      return;
    }
    const rows = sorted.map((bundle) => `
      <tr data-bundle-id="${bundle.id}">
        <td>${escapeHtml(bundle.customer_name)}</td>
        <td>${escapeHtml(bundle.phone || '‚Äî')}</td>
        <td>${formatDateUS(bundle.start_date)}</td>
        <td>${bundle.duration_weeks}w</td>
        <td class="table-num">$${Number(bundle.discounted_monthly || 0).toFixed(2)}</td>
        <td class="table-num">$${Number(bundle.total_billed || 0).toFixed(2)}</td>
        <td class="table-num">$${Number(bundle.house_credit || 0).toFixed(2)}</td>
        <td>${formatDateUS(bundle.expiration_date)}</td>
        <td>
          <button class="secondary miniBtn" data-bundle-action="edit" data-bundle-id="${bundle.id}">Edit</button>
          <button class="danger miniBtn" data-bundle-action="delete" data-bundle-id="${bundle.id}">Delete</button>
        </td>
      </tr>
    `).join('');
    el('bundleTable').innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Customer</th>
            <th>Phone</th>
            <th>Start</th>
            <th>Duration</th>
            <th class="table-num">Discounted Monthly</th>
            <th class="table-num">Total Billed</th>
            <th class="table-num">House Credit</th>
            <th>Expires</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    el('bundleTable').querySelectorAll('[data-bundle-action]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.bundleId;
        const action = btn.dataset.bundleAction;
        const bundle = sorted.find((b) => String(b.id) === String(id));
        if (!bundle) return;
        if (action === 'edit') {
          populateBundleForm(bundle);
        } else if (action === 'delete') {
          deleteBundle(bundle);
        }
      });
    });
  }

  function populateBundleForm(bundle) {
    bundleEditingId = bundle.id;
    el('bundleLocation').value = bundle.location_id;
    el('bundleCustomer').value = bundle.customer_name || '';
    el('bundlePhone').value = bundle.phone || '';
    el('bundleStartDate').value = bundle.start_date || '';
    el('bundleDuration').value = bundle.duration_weeks || '12';
    el('bundleMonthlyPrice').value = bundle.monthly_price || '';
    el('bundleNotes').value = bundle.notes || '';
    el('bundleSaveBtn').textContent = 'Update bundle';
  }

  function resetBundleForm() {
    bundleEditingId = null;
    el('bundleCustomer').value = '';
    el('bundlePhone').value = '';
    el('bundleStartDate').value = '';
    el('bundleDuration').value = '12';
    el('bundleMonthlyPrice').value = '';
    el('bundleNotes').value = '';
    el('bundleSaveBtn').textContent = 'Save bundle';
  }

  async function deleteBundle(bundle) {
    const confirmed = await openProtectedAction({
      title: 'Delete bundle',
      message: `Delete bundle for ${bundle.customer_name}?`,
      impactSummary: 'This will permanently remove the bundle record.',
      requireDelete: true,
      requireInitials: true,
      requirePin: true,
      requireConfirmCheckbox: true
    });
    if (!confirmed.ok) return;
    await api(`/api/bundles/${bundle.id}`, {
      method: 'DELETE',
      body: JSON.stringify({ pin: confirmed.pin })
    });
    resetBundleForm();
    loadBundles();
  }

  let exportContext = null;
  function openExportModal({ title, onExport }) {
    exportContext = { onExport };
    el('exportModalTitle').textContent = title || 'Export';
    el('exportScopeSelect').value = '';
    showModal('exportModal', true);
  }

  async function exportBundles(scope) {
    const locId = Number(el('bundleLocation')?.value || currentLocation?.id || 1);
    let list = [];
    if (scope === 'full') {
      const results = await Promise.all((allLocations || []).map(async (loc) => {
        const resp = await api(`/api/bundles?location_id=${loc.id}`);
        return (resp.bundles || []).map((bundle) => ({ ...bundle, location_name: loc.name }));
      }));
      list = results.flat();
    } else {
      const resp = await api(`/api/bundles?location_id=${locId}`);
      list = resp.bundles || [];
    }
    if (!list.length) {
      alert('No bundles to export.');
      return;
    }
    const headers = [
      'Location','Customer','Phone','Start Date','Duration Weeks','Monthly Price','Discounted Monthly','Total Billed','House Credit','Expiration Date','Notes'
    ];
    const rows = list.map((b) => [
      b.location_name || currentLocation?.name || '',
      b.customer_name,
      b.phone || '',
      b.start_date || '',
      b.duration_weeks,
      b.monthly_price,
      b.discounted_monthly,
      b.total_billed,
      b.house_credit,
      b.expiration_date,
      b.notes || ''
    ]);
    const csv = [headers, ...rows].map(buildCsvRow).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `bundles_${locId}_${todayISO()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  async function buildGlobalSearchIndex() {
    const results = [];
    rosterCache.forEach((kid) => {
      results.push({
        type: 'Roster',
        title: kid.swimmer_name,
        subtitle: `${kid.instructor_name || 'Unassigned'} ‚Ä¢ ${kid.start_time || ''}`,
        jump: () => {
          el('viewSelect').value = 'roster';
          el('panelRoster').classList.remove('hidden');
          el('panelVirtualDesk').classList.add('hidden');
          setCategoryTheme('instructors');
          if (el('rosterSearch')) {
            el('rosterSearch').value = kid.swimmer_name || '';
            searchFilter = kid.swimmer_name || '';
            el('searchClear')?.classList.toggle('hidden', !searchFilter);
          }
          loadRoster();
        }
      });
    });

    if (managerReportsCache?.latest) {
      Object.values(managerReportsCache.latest).forEach((report) => {
        results.push({
          type: 'Report',
          title: `${report.report_type.replace('_', ' ')} report`,
          subtitle: `Uploaded ${formatShortDate(report.uploaded_at)}`,
          jump: () => setManagerSection('system')
        });
      });
    }

    try {
      const bundleResp = await api(`/api/bundles?location_id=${currentLocation?.id || 1}`);
      (bundleResp.bundles || []).forEach((bundle) => {
        results.push({
          type: 'Bundle',
          title: bundle.customer_name,
          subtitle: `Expires ${formatDateUS(bundle.expiration_date)}`,
          jump: () => setManagerSection('billing')
        });
      });
    } catch (e) {
      console.warn('Global search bundle fetch failed', e);
    }

    globalSearchResults = results;
  }

  function openGlobalSearch() {
    showModal('globalSearchModal', true);
    el('globalSearchInput').value = '';
    el('globalSearchResults').innerHTML = '<div class="tiny" style="color:var(--muted);">Type to search...</div>';
    buildGlobalSearchIndex().then(() => {
      const query = el('globalSearchInput').value;
      if (query) runGlobalSearch(query);
    });
    el('globalSearchInput').focus();
  }

  function runGlobalSearch(query) {
    const list = el('globalSearchResults');
    const q = String(query || '').trim().toLowerCase();
    if (!q) {
      list.innerHTML = '<div class="tiny" style="color:var(--muted);">Type to search...</div>';
      return;
    }
    const results = globalSearchResults.filter((item) => {
      return item.title.toLowerCase().includes(q) || item.subtitle.toLowerCase().includes(q);
    }).slice(0, 20);
    if (!results.length) {
      list.innerHTML = '<div class="tiny" style="color:var(--muted);">No matches found.</div>';
      return;
    }
    list.innerHTML = results.map((item, idx) => `
      <div class="card" data-search-index="${idx}" style="margin-top:8px; cursor:pointer;">
        <div style="font-weight:700;">${escapeHtml(item.title)}</div>
        <div class="tiny" style="color:var(--muted);">${escapeHtml(item.type)} ‚Ä¢ ${escapeHtml(item.subtitle)}</div>
      </div>
    `).join('');
    list.querySelectorAll('[data-search-index]').forEach((row) => {
      row.addEventListener('click', () => {
        const index = Number(row.dataset.searchIndex);
        const selected = results[index];
        openPreviewDrawer(selected);
      });
    });
  }

  function openPreviewDrawer(item) {
    previewTarget = item;
    el('previewTitle').textContent = `${item.type} preview`;
    el('previewContent').innerHTML = `
      <div style="font-weight:700;">${escapeHtml(item.title)}</div>
      <div class="tiny" style="color:var(--muted); margin-top:4px;">${escapeHtml(item.subtitle)}</div>
    `;
    el('previewBackdrop').style.display = 'block';
    el('previewDrawer').classList.add('open');
  }

  function closePreviewDrawer() {
    previewTarget = null;
    el('previewBackdrop').style.display = 'none';
    el('previewDrawer').classList.remove('open');
  }

  function setTrainerTab(tab) {
    const retentionBtn = el('trainerTabRetention');
    const dropBtn = el('trainerTabDropImpact');
    const attendanceBtn = el('trainerTabAttendanceImpact');
    retentionBtn?.classList.toggle('active', tab === 'retention');
    dropBtn?.classList.toggle('active', tab === 'drop');
    attendanceBtn?.classList.toggle('active', tab === 'attendance');
    el('trainerRetentionPanel')?.classList.toggle('hidden', tab !== 'retention');
    el('trainerDropImpactPanel')?.classList.toggle('hidden', tab !== 'drop');
    el('trainerAttendanceImpactPanel')?.classList.toggle('hidden', tab !== 'attendance');
  }

  async function renderRetentionPanel() {
    if (!currentLocation || !el('retentionTable')) return;
    try {
      const resp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=retention`);
      const reports = resp.reports || [];
      const latest = reports[0];
      const previous = reports[1];
      const currentRows = latest?.data_json ? JSON.parse(latest.data_json).instructors || [] : [];
      const prevRows = previous?.data_json ? JSON.parse(previous.data_json).instructors || [] : [];
      const prevMap = new Map(prevRows.map((row) => [normalizeKey(row.instructor), row]));

      let sortMode = el('retentionSortSelect')?.value || 'alpha';
      const rows = currentRows.map((row) => {
        const prev = prevMap.get(normalizeKey(row.instructor)) || {};
        const deltaPercent = row.retention_percent != null && prev.retention_percent != null
          ? row.retention_percent - prev.retention_percent
          : null;
        const deltaSwimmers = row.swimmer_count != null && prev.swimmer_count != null
          ? row.swimmer_count - prev.swimmer_count
          : null;
        const status = prev.retention_percent == null ? 'NEW' : (deltaPercent < 0 ? 'Drop' : 'Stable');
        return {
          instructor: row.instructor,
          newPercent: row.retention_percent,
          lastPercent: prev.retention_percent,
          deltaPercent,
          newSwimmers: row.swimmer_count,
          lastSwimmers: prev.swimmer_count,
          deltaSwimmers,
          status
        };
      });

      if (sortMode === 'best') {
        rows.sort((a, b) => (b.newPercent ?? -999) - (a.newPercent ?? -999));
      } else if (sortMode === 'worst') {
        rows.sort((a, b) => (a.newPercent ?? 999) - (b.newPercent ?? 999));
      } else {
        rows.sort((a, b) => String(a.instructor || '').localeCompare(String(b.instructor || '')));
      }

      const tableRows = rows.map((row) => [
        row.instructor,
        formatPercent(row.newPercent),
        formatPercent(row.lastPercent),
        formatDelta(row.deltaPercent, '%', 1),
        row.newSwimmers ?? '‚Äî',
        row.lastSwimmers ?? '‚Äî',
        formatDelta(row.deltaSwimmers, '', 0),
        row.status === 'Drop' ? '‚ö†Ô∏è Drop' : row.status
      ]);

      el('retentionTable').innerHTML = `
        <div class="row" style="margin-bottom:8px;">
          <span class="pill tiny">Sort</span>
          <select id="retentionSortSelect">
            <option value="alpha">A ‚Üí Z</option>
            <option value="best">Best ‚Üí Worst</option>
            <option value="worst">Worst ‚Üí Best</option>
          </select>
        </div>
        ${tableRows.length ? renderTable(
          ['Instructor', 'New Retention %', 'Last Retention %', 'Œî%', 'New Swimmers', 'Last Swimmers', 'Œî Swimmers', 'Status'],
          tableRows,
          { alignRight: [1,2,3,4,5,6] }
        ) : '<div class="tiny" style="color:var(--muted);">No retention uploads yet.</div>'}
      `;
      const sortSelect = el('retentionSortSelect');
      if (sortSelect) {
        sortSelect.value = sortMode;
        sortSelect.onchange = () => renderRetentionPanel();
      }

      renderRetentionTrends(reports);
      const drops = rows.filter((row) => row.deltaPercent != null && row.deltaPercent < 0).length;
      const alertStrip = el('instructorsAlertStrip');
      if (alertStrip) {
        alertStrip.innerHTML = [
          renderAlertPill('Instructors', rows.length, 'slate', 'retention', 'üéì'),
          renderAlertPill('Retention drops', drops, drops ? 'rose' : 'slate', 'drop', '‚ö†Ô∏è')
        ].join('');
        alertStrip.querySelectorAll('[data-alert]').forEach((pill) => {
          pill.addEventListener('click', () => {
            if (pill.dataset.alert === 'retention') setTrainerTab('retention');
            if (pill.dataset.alert === 'drop') setTrainerTab('drop');
          });
        });
      }
      const statsGrid = el('instructorsStatGrid');
      if (statsGrid) {
        const avgRetention = rows.length
          ? Math.round((rows.reduce((acc, r) => acc + (Number(r.newPercent) || 0), 0) / rows.length) * 10) / 10
          : 0;
        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="tiny" style="color:var(--muted);">Avg retention</div>
            <div class="value">${avgRetention}%</div>
          </div>
          <div class="stat-card ${drops ? 'danger' : ''}">
            <div class="tiny" style="color:var(--muted);">Retention drops</div>
            <div class="value">${drops}</div>
          </div>
        `;
      }
    } catch (e) {
      showInlineError('retentionTable', `Retention data failed: ${e.message}`, renderRetentionPanel);
    }
  }

  async function deleteLatestReport(reportType) {
    if (!currentLocation) return;
    const resp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=${reportType}`);
    const latest = resp.reports?.[0];
    if (!latest) {
      alert('No uploads available to delete.');
      return;
    }
    const confirmed = await openProtectedAction({
      title: 'Delete latest upload',
      message: `Delete latest ${reportType.replace('_',' ')} upload?`,
      impactSummary: `Upload date: ${formatShortDate(latest.uploaded_at)}\nThis will remove the upload from this location.`,
      requireDelete: true,
      requireInitials: true,
      requirePin: true,
      requireConfirmCheckbox: true
    });
    if (!confirmed.ok) return;
    await api('/api/manager-reports/delete', {
      method: 'POST',
      body: JSON.stringify({ report_id: latest.id, initials: confirmed.initials, pin: confirmed.pin })
    });
    loadManagerReports();
    if (reportType === 'drop_list') {
      loadClientDropList();
      renderDropImpactPanel();
    }
  }

  function renderRetentionTrends(reports) {
    const container = el('retentionTrends');
    if (!container) return;
    if (!managerSectionFilters.instructors.showTrends) {
      container.innerHTML = '<div class="tiny" style="color:var(--muted);">Trends hidden.</div>';
      return;
    }
    if (!reports.length) {
      container.innerHTML = '<div class="tiny" style="color:var(--muted);">No retention trend data yet.</div>';
      return;
    }
    const points = reports.map((report) => {
      const parsed = report.data_json ? JSON.parse(report.data_json) : {};
      const values = (parsed.instructors || []).map((r) => Number(r.retention_percent)).filter((v) => !Number.isNaN(v));
      const avg = values.length ? values.reduce((a, b) => a + b, 0) / values.length : 0;
      return { date: report.uploaded_at, value: avg };
    }).reverse();
    container.innerHTML = '<canvas id="retentionTrendChart" height="220"></canvas>';
    const ctx = el('retentionTrendChart');
    if (retentionTrendChart) retentionTrendChart.destroy();
    retentionTrendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: points.map((p) => formatShortDate(p.date)),
        datasets: [{
          label: 'Retention %',
          data: points.map((p) => Number(p.value.toFixed(1))),
          borderColor: '#2563eb',
          backgroundColor: 'rgba(37,99,235,0.15)',
          tension: 0
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  }

  async function renderDropImpactPanel() {
    if (!currentLocation || !el('dropImpactTable')) return;
    try {
      const dropResp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=drop_list&include_archived=true`);
      const allEntries = dropResp.reports.flatMap((report) => {
        const parsed = report.data_json ? JSON.parse(report.data_json) : {};
        return parsed.entries || [];
      });
      const entries = applyDropFilters(allEntries);
      if (!entries.length) {
        el('dropImpactTable').innerHTML = '<div class="tiny" style="color:var(--muted);">No drop list entries yet.</div>';
        return;
      }

      const endDate = todayISO();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 180);
      const historyResp = await api(`/api/attendance-history?location_id=${currentLocation.id}&start=${startDate.toISOString().split('T')[0]}&end=${endDate}&limit=2000`);
      const history = historyResp.rows || [];

      const bySwimmer = new Map();
      history.forEach((row) => {
        const key = normalizeKey(row.swimmer_name);
        if (!bySwimmer.has(key)) bySwimmer.set(key, []);
        bySwimmer.get(key).push(row);
      });

      const instructorMap = new Map();
      entries.forEach((entry) => {
        const parsed = parseDropDetails(entry.raw || []);
        if (!parsed.name) return;
        const key = normalizeKey(parsed.name);
        const historyRows = bySwimmer.get(key) || [];
        if (!historyRows.length) return;
        const dropDate = entry.drop_date || endDate;
        const lastFourStart = new Date(`${dropDate}T00:00:00`);
        lastFourStart.setDate(lastFourStart.getDate() - 28);
        const lastFourCounts = {};
        const historicalCounts = {};
        historyRows.forEach((row) => {
          const inst = row.instructor_name || 'Unassigned';
          historicalCounts[inst] = (historicalCounts[inst] || 0) + 1;
          const rowDate = new Date(`${row.date}T00:00:00`);
          if (rowDate >= lastFourStart) {
            lastFourCounts[inst] = (lastFourCounts[inst] || 0) + 1;
          }
        });
        const pickInstructor = (counts) => {
          const entries = Object.entries(counts);
          if (!entries.length) return null;
          entries.sort((a, b) => b[1] - a[1]);
          if (entries.length > 1 && entries[0][1] === entries[1][1]) return null;
          return entries[0][0];
        };
        let attribution = pickInstructor(lastFourCounts);
        let source = 'last 4 weeks';
        if (!attribution) {
          attribution = pickInstructor(historicalCounts) || 'Unassigned';
          source = 'historical';
        }
        if (!instructorMap.has(attribution)) {
          instructorMap.set(attribution, []);
        }
        instructorMap.get(attribution).push({
          swimmer: parsed.name,
          dropDate: entry.drop_date,
          source
        });
      });

      if (!instructorMap.size) {
        el('dropImpactTable').innerHTML = '<div class="tiny" style="color:var(--muted);">No instructor attribution yet.</div>';
        return;
      }

      const rows = Array.from(instructorMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      const tableRows = rows.map(([instructor, swimmers], idx) => `
        <tr>
          <td>${escapeHtml(instructor)}</td>
          <td class="table-num">${swimmers.length}</td>
          <td><button class="secondary miniBtn" data-drop-expand="${idx}">View</button></td>
        </tr>
        <tr class="hidden" id="dropImpactDetail-${idx}">
          <td colspan="3">
            <div class="tiny" style="color:var(--muted);">
              ${swimmers.map((s) => `${escapeHtml(s.swimmer)} ‚Ä¢ ${formatDateUS(s.dropDate)} (${escapeHtml(s.source)})`).join('<br>')}
            </div>
          </td>
        </tr>
      `).join('');

      el('dropImpactTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Instructor</th>
              <th class="table-num">Drops</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      `;
      el('dropImpactTable').querySelectorAll('[data-drop-expand]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = btn.dataset.dropExpand;
          const row = el(`dropImpactDetail-${idx}`);
          if (row) row.classList.toggle('hidden');
        });
      });
    } catch (e) {
      showInlineError('dropImpactTable', `Drop impact failed: ${e.message}`, renderDropImpactPanel);
    }
  }

  async function renderAttendanceImpactPanel() {
    if (!currentLocation || !el('attendanceImpactTable')) return;
    try {
      const end = todayISO();
      const start = new Date();
      start.setDate(start.getDate() - 30);
      const resp = await api(`/api/attendance-summary?location_id=${currentLocation.id}&start=${start.toISOString().split('T')[0]}&end=${end}`);
      const allRows = (resp.summary?.instructorStats || []).map((row) => [
        row.instructor,
        row.present,
        row.absent,
        `${row.rate}%`
      ]);
      if (!allRows.length) {
        el('attendanceImpactTable').innerHTML = '<div class="tiny" style="color:var(--muted);">No attendance impact data yet.</div>';
        return;
      }
      const displayRows = allRows.slice(0, 20);
      const moreCount = allRows.length - displayRows.length;
      el('attendanceImpactTable').innerHTML = `
        ${moreCount > 0 ? `<div class="tiny" style="color:var(--muted); margin-bottom:6px;">Showing first 20 of ${allRows.length} instructors.</div>` : ''}
        ${renderTable(['Instructor', 'Present', 'Absent', 'Attendance %'], displayRows)}
      `;
    } catch (e) {
      showInlineError('attendanceImpactTable', `Attendance impact failed: ${e.message}`, renderAttendanceImpactPanel);
    }
  }

  function buildCsvRow(values) {
    return values.map((val) => {
      const s = String(val ?? '');
      if (s.includes('"') || s.includes(',') || s.includes('\n')) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }).join(',');
  }

  function exportBreakdownCsv(data, meta) {
    const lines = [];
    lines.push(buildCsvRow(['Location', meta.location || '']));
    lines.push(buildCsvRow(['Date/Range', meta.dateRange || '']));
    lines.push(buildCsvRow(['Time Block', meta.timeBlock || 'N/A']));
    lines.push(buildCsvRow(['Filters', meta.filters || '']));
    lines.push(buildCsvRow(['Generated', new Date().toISOString()]));
    lines.push('');
    data.headers.forEach((row) => lines.push(buildCsvRow(row)));
    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `${currentBreakdownType}_${meta.location || 'report'}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  async function loadBreakdown() {
    if (!currentLocation) return;
    renderBreakdownFilters();
    const resp = await api(`/api/manager-reports/data?location_id=${currentLocation.id}&report_type=${currentBreakdownType}&include_archived=${managerRole === 'admin'}`);
    const reports = resp.reports || [];
    const latest = reports[0];
    const content = el('breakdownContent');
    content.innerHTML = '<div class="tiny" style="color:var(--muted); padding:10px;">No report data available.</div>';
    renderTrendChart(currentBreakdownType, reports);
    if (!latest) return;
    const deleteBtn = el('breakdownDeleteBtn');
    if (deleteBtn) {
      deleteBtn.classList.toggle('hidden', managerRole !== 'admin');
      deleteBtn.onclick = async () => {
        if (managerRole !== 'admin') return;
        const confirmed = await openProtectedAction({
          title: 'Delete report upload',
          message: 'Type DELETE and enter initials to delete this upload.',
          requireDelete: true,
          requireInitials: true,
          requirePin: true,
          requireConfirmCheckbox: true,
          impactSummary: 'This will permanently remove the selected report upload.'
        });
        if (!confirmed.ok) return;
        await api('/api/manager-reports/delete', {
          method: 'POST',
          body: JSON.stringify({ report_id: latest.id, initials: confirmed.initials, pin: confirmed.pin })
        });
        await loadManagerReports();
        loadBreakdown();
      };
    }
    const parsed = latest.data_json ? JSON.parse(latest.data_json) : {};
    const warnings = latest.warnings_json ? JSON.parse(latest.warnings_json) : [];
    renderWarningBanner(warnings);
    el('breakdownMeta').textContent = `Latest upload: ${formatShortDate(latest.uploaded_at)}`;

    if (currentBreakdownType === 'aged_accounts') {
      const headers = parsed.headers || [];
      const rows = parsed.rows || [];
      const tableRows = rows.map((row) => row.map((col) => escapeHtml(col)));
      content.innerHTML = renderTable(headers, tableRows);
    }

    if (currentBreakdownType === 'retention') {
      const current = parsed.instructors || [];
      const previous = reports[1]?.data_json ? JSON.parse(reports[1].data_json).instructors || [] : [];
      const prevMap = new Map(previous.map((i) => [String(i.instructor || '').toLowerCase(), i]));
      const rows = current.map((row) => {
        const prev = prevMap.get(String(row.instructor || '').toLowerCase());
        if (!prev) {
          return {
            instructor: row.instructor,
            newPercent: row.retention_percent,
            lastPercent: null,
            deltaPercent: null,
            newSwimmers: row.swimmer_count,
            lastSwimmers: null,
            deltaSwimmers: null,
            status: renderBadge('NEW', 'teal')
          };
        }
        const deltaPercent = row.retention_percent != null && prev.retention_percent != null
          ? row.retention_percent - prev.retention_percent
          : null;
        const deltaSwimmers = row.swimmer_count != null && prev.swimmer_count != null
          ? row.swimmer_count - prev.swimmer_count
          : null;
        const status = typeof deltaPercent === 'number' && deltaPercent < 0
          ? renderBadge('‚ö†Ô∏è Drop', 'rose')
          : renderBadge('Stable', 'slate');
        return {
          instructor: row.instructor,
          newPercent: row.retention_percent,
          lastPercent: prev.retention_percent,
          deltaPercent,
          newSwimmers: row.swimmer_count,
          lastSwimmers: prev.swimmer_count,
          deltaSwimmers,
          status
        };
      });
      const headers = ['Instructor', 'New Retention %', 'Last Retention %', 'Œî%', 'New Swimmers', 'Last Swimmers', 'Œî Swimmers', 'Status'];
      const tableRows = rows.map((row) => [
        escapeHtml(row.instructor || '‚Äî'),
        `<span class="table-num">${formatPercent(row.newPercent)}</span>`,
        `<span class="table-num">${formatPercent(row.lastPercent)}</span>`,
        `<span class="table-num">${formatDelta(row.deltaPercent, '%', 1)}</span>`,
        `<span class="table-num">${row.newSwimmers ?? '‚Äî'}</span>`,
        `<span class="table-num">${row.lastSwimmers ?? '‚Äî'}</span>`,
        `<span class="table-num">${formatDelta(row.deltaSwimmers, '', 0)}</span>`,
        row.status
      ]);
      content.innerHTML = renderTable(headers, tableRows);
    }

    if (currentBreakdownType === 'drop_list') {
      const allEntries = reports.flatMap((report) => {
        const reportParsed = report.data_json ? JSON.parse(report.data_json) : {};
        return reportParsed.entries || [];
      });
      const entries = applyDropFilters(allEntries);
      const headers = ['Drop Date', 'Details'];
      const tableRows = entries.map((entry, idx) => [
        escapeHtml(formatDateUS(entry.drop_date)),
        renderDropDetails(entry, `breakdown-${idx}`)
      ]);
      content.innerHTML = renderTable(headers, tableRows);
      content.querySelectorAll('[data-drop-toggle]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.dropToggle;
          const target = content.querySelector(`[data-drop-full="${key}"]`);
          if (target) target.classList.toggle('hidden');
        });
      });
    }

    el('breakdownExportCsv').onclick = () => {
      if (blockIfReadOnly('Export')) return;
      const meta = {
        location: currentLocation?.name || '',
        dateRange: latest.report_date || latest.uploaded_at || '',
        filters: currentBreakdownType === 'drop_list'
          ? `Range: ${breakdownFilters.dropRange}${breakdownFilters.dropRange === 'custom' ? ` (${breakdownFilters.dropStart} ‚Üí ${breakdownFilters.dropEnd})` : ''}`
          : 'None'
      };
      let headers = [];
      if (currentBreakdownType === 'aged_accounts') {
        headers = [[...parsed.headers], ...parsed.rows];
      } else if (currentBreakdownType === 'retention') {
        const previous = reports[1]?.data_json ? JSON.parse(reports[1].data_json).instructors || [] : [];
        const prevMap = new Map(previous.map((i) => [String(i.instructor || '').toLowerCase(), i]));
        headers = [['Instructor', 'New Retention %', 'Last Retention %', 'Œî%', 'New Swimmers', 'Last Swimmers', 'Œî Swimmers', 'Status'],
          ...(parsed.instructors || []).map((row) => {
            const prev = prevMap.get(String(row.instructor || '').toLowerCase());
            if (!prev) {
              return [row.instructor, formatPercent(row.retention_percent), '', '', row.swimmer_count ?? '', '', '', 'NEW'];
            }
            const deltaPercent = row.retention_percent != null && prev.retention_percent != null
              ? row.retention_percent - prev.retention_percent
              : null;
            const deltaSwimmers = row.swimmer_count != null && prev.swimmer_count != null
              ? row.swimmer_count - prev.swimmer_count
              : null;
            const status = typeof deltaPercent === 'number' && deltaPercent < 0 ? 'Drop' : 'Stable';
            return [
              row.instructor,
              formatPercent(row.retention_percent),
              formatPercent(prev.retention_percent),
              formatDelta(deltaPercent, '%', 1),
              row.swimmer_count ?? '',
              prev.swimmer_count ?? '',
              formatDelta(deltaSwimmers, '', 0),
              status
            ];
          })
        ];
      } else {
        const allEntries = reports.flatMap((report) => {
          const reportParsed = report.data_json ? JSON.parse(report.data_json) : {};
          return reportParsed.entries || [];
        });
        headers = [['Drop Date', 'Details'], ...(applyDropFilters(allEntries).map((entry) => [entry.drop_date || '', (entry.raw || []).join(' ‚Ä¢ ')]))];
      }
      exportBreakdownCsv({ headers }, meta);
    };

    el('breakdownExportPdf').onclick = () => {
      if (blockIfReadOnly('Export')) return;
      const printWindow = window.open('', '_blank');
      if (!printWindow) return;
      printWindow.document.write(`<html><head><title>Export</title></head><body>${content.innerHTML}</body></html>`);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };
  }

  function updateAnnouncementsVisibility() {
    const viewSelect = el('viewSelect');
    const panelAnnouncements = el('panelAnnouncements');
    const panelRoster = el('panelRoster');
    const announcementsOption = viewSelect?.querySelector('option[value="announcements"]');
    const hasAnnouncements = Boolean(currentLocation && currentLocation.name === 'SwimLabs Westchester');

    if (announcementsOption) {
      announcementsOption.hidden = !hasAnnouncements;
      announcementsOption.disabled = !hasAnnouncements;
    }

    if (!hasAnnouncements) {
      if (viewSelect && viewSelect.value === 'announcements') {
        viewSelect.value = 'roster';
        panelRoster?.classList.remove('hidden');
        panelAnnouncements?.classList.add('hidden');
      }
      return;
    }

    if (panelAnnouncements && viewSelect?.value === 'announcements') {
      panelAnnouncements.classList.remove('hidden');
    }
  }

  function isWestchesterLocation() {
    return !!(currentLocation && currentLocation.name === 'SwimLabs Westchester');
  }

  function updateGuardTasksVisibility() {
    const isWestchester = isWestchesterLocation();
    const guardNav = el('managerNavGuards');
    if (guardNav) guardNav.style.display = isWestchester ? '' : 'none';
    const lifeguardOption = el('viewSelect')?.querySelector('option[value="lifeguard"]');
    if (lifeguardOption) lifeguardOption.hidden = !isWestchester;
    if (!isWestchester && el('viewSelect')?.value === 'lifeguard') {
      el('viewSelect').value = 'roster';
      el('panelGuardTasks').classList.add('hidden');
      el('panelRoster').classList.remove('hidden');
    }
    const guardTasksPanel = el('panelGuardTasks');
    if (!isWestchester && !guardTasksPanel.classList.contains('hidden')) {
      el('viewSelect').value = 'roster';
      guardTasksPanel.classList.add('hidden');
      el('panelRoster').classList.remove('hidden');
    }
    const guardSection = el('managerSectionGuards');
    if (guardSection) guardSection.style.display = isWestchester ? '' : 'none';
    const guardBtn = el('openGuardTasksBtn');
    if (guardBtn) guardBtn.style.display = isWestchester ? '' : 'none';
  }

  el('locationSelect').addEventListener('change', async (e) => {
    const locId = e.target.value;
    currentLocation = allLocations.find(l => l.id == locId);
    localStorage.setItem('location_id', locId);
    
    try {
      await api('/api/set-location', {
        method: 'POST',
        body: JSON.stringify({ location_id: locId })
      });
      
      updateAnnouncementsVisibility();
      updateGuardTasksVisibility();
      if (!isWestchesterLocation()) {
        const viewValue = el('viewSelect')?.value;
        if (viewValue === 'announcements' || viewValue === 'lifeguard') {
          el('viewSelect').value = 'roster';
          el('panelRoster').classList.remove('hidden');
          el('panelAnnouncements').classList.add('hidden');
          el('panelLifeguard').classList.add('hidden');
          el('panelGuardTasks').classList.add('hidden');
        }
      }
      await loadManagerReports();
      if (el('panelVirtualDesk') && !el('panelVirtualDesk').classList.contains('hidden')) {
        loadManagerDashboard();
      }
      await loadStatus();
      await loadBlocks();
      if (currentBlock) await loadRoster();
      
    } catch (e) {
      alert('Failed to switch location: ' + e.message);
    }
  });

  function escapeHtml(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function renderBadge(text, variant = 'slate') {
    return `<span class="chip ${variant}">${escapeHtml(text)}</span>`;
  }

  function renderAlertPill(label, value, variant = '', action = '', icon = '') {
    const cls = variant ? `chip ${variant}` : 'chip';
    const tag = action ? 'button' : 'span';
    const attrs = action ? ` data-alert="${action}"` : '';
    const iconHtml = icon ? `<span class="icon-circle" style="width:22px; height:22px;">${escapeHtml(icon)}</span>` : '';
    return `<${tag} class="pill"${attrs}>${iconHtml}<span class="${cls}">${escapeHtml(label)}</span> <strong>${escapeHtml(String(value))}</strong></${tag}>`;
  }

  function renderCard(title, body, actions = '') {
    return `
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <h3 style="margin:0; font-size:18px;">${escapeHtml(title)}</h3>
          <div class="spacer"></div>
          ${actions || ''}
        </div>
        ${body || ''}
      </div>
    `;
  }

  function renderEmptyState({ icon = '‚ú®', title = 'All set!', description = '', actionLabel = '', action = '' } = {}) {
    return `
      <div class="card" style="text-align:center;">
        <div class="icon-circle" style="width:42px; height:42px; margin:0 auto 8px;">${escapeHtml(icon)}</div>
        <div style="font-weight:800;">${escapeHtml(title)}</div>
        <div class="tiny" style="color:var(--muted); margin-top:6px;">${escapeHtml(description)}</div>
        ${actionLabel ? `<button class="secondary miniBtn" data-empty-action="${action}" style="margin-top:10px;">${escapeHtml(actionLabel)}</button>` : ''}
      </div>
    `;
  }

  function renderTable(headers, rows, options = {}) {
    const alignRight = new Set(options.alignRight || []);
    let html = '<table><thead><tr>';
    headers.forEach((h, idx) => {
      const cls = alignRight.has(idx) ? ' class="table-num"' : '';
      html += `<th${cls}>${escapeHtml(h)}</th>`;
    });
    html += '</tr></thead><tbody>';
    rows.forEach((row) => {
      html += '<tr>';
      row.forEach((col, idx) => {
        const cls = alignRight.has(idx) ? ' class="table-num"' : '';
        html += `<td${cls}>${col}</td>`;
      });
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }

  function renderIconButton(icon, title, extraClass = '') {
    return `<button class="secondary actionIconBtn ${extraClass}" title="${escapeHtml(title)}">${escapeHtml(icon)}</button>`;
  }

  function renderModal(title, content, actions = '') {
    return `
      <div class="modal">
        <h3>${escapeHtml(title)}</h3>
        <div>${content || ''}</div>
        <div class="modalFooter">${actions || ''}</div>
      </div>
    `;
  }

  function fmtTime(time24){
    if(!time24) return '‚Äî';
    const parts = String(time24).split(':');
    const hh = parseInt(parts[0], 10);
    const mm = parseInt(parts[1] || '0', 10);
    const ampm = hh >= 12 ? 'PM' : 'AM';
    const h12 = ((hh + 11) % 12) + 1;
    if(mm === 0) return `${h12} ${ampm}`;
    return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
  }

  function fmtCurrentTime(date, timeZone) {
    try {
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone,
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
      const parts = formatter.formatToParts(date);
      const hour = parts.find((p) => p.type === 'hour')?.value;
      const minute = parts.find((p) => p.type === 'minute')?.value;
      const dayPeriod = parts.find((p) => p.type === 'dayPeriod')?.value;
      if (hour && minute && dayPeriod) {
        return `${hour}:${minute}${dayPeriod}`;
      }
      return formatter.format(date).replace(/\s+/g, '');
    } catch (e) {
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      const displayMinutes = String(minutes).padStart(2, '0');
      return `${displayHours}:${displayMinutes}${ampm}`;
    }
  }

  function parseTypeLevel(program){
    const p = String(program || '').trim();
    if(!p) return { type: '‚Äî', level: '‚Äî' };
    const up = p.toUpperCase();
    if(up.startsWith('GROUP:')){
      const level = p.split(':').slice(1).join(':').trim();
      return { type: 'Group', level: level || '‚Äî' };
    }
    // Non-group
    return { type: p, level: '‚Äî' };
  }

  function cleanInstructorLabel(name){
    const raw = String(name || '');
    const withoutDates = raw
      .replace(/\s+\(?\d{1,2}\/\d{1,2}\/\d{2,4}\)?/g, '')
      .replace(/\s+\d{4}-\d{2}-\d{2}/g, '')
      .replace(/\s+\d{1,2}-\d{1,2}-\d{2,4}/g, '');
    const cleaned = withoutDates.replace(/\s+/g, ' ').trim();
    return cleaned || '‚Äî';
  }

  function getSubMeta(kid){
    const rawInstructor = cleanInstructorLabel(kid?.instructor_name || '');
    const rawSub = cleanInstructorLabel(kid?.substitute_instructor || '');
    const rawOriginal = cleanInstructorLabel(kid?.original_instructor || '');
    const hasMarker = /\*|\(sub\)|\bsub\b/i.test(rawInstructor);
    const cleanedInstructor = rawInstructor.replace(/\(sub\)/ig, '').replace(/\*/g, '').trim();
    const cleanedSub = rawSub.replace(/\(sub\)/ig, '').replace(/\*/g, '').trim();

    let hasSub = Boolean(kid?.is_substitute || rawSub || rawOriginal || hasMarker);
    let subName = cleanedSub || cleanedInstructor || rawSub || rawInstructor;
    let originalName = rawOriginal || '';

    if (!originalName && cleanedSub && cleanedInstructor && cleanedSub !== cleanedInstructor) {
      originalName = cleanedInstructor;
    }

    return {
      hasSub,
      subName: subName || '‚Äî',
      originalName
    };
  }

  function getProgramColorClass(program){
    const p = String(program || '').toUpperCase().trim();
    if(!p) return '';

    // Check for GROUP programs
    if(p.startsWith('GROUP:')) return 'program-group';

    // Check for SEMI-PRIVATE
    if(p.includes('SEMI') && p.includes('PRIVATE')) return 'program-semi-private';
    if(p.includes('SEMI-PRIVATE')) return 'program-semi-private';

    // Check for PRIVATE (but not semi-private)
    if(p.includes('PRIVATE')) return 'program-private';

    // Check for PARENT-TOT
    if(p.includes('PARENT') && p.includes('TOT')) return 'program-parent-tot';
    if(p.includes('PARENTTOT')) return 'program-parent-tot';

    // Check for TRIAL (could be in program name or as a flag indicator)
    if(p.includes('TRIAL')) return 'program-trial';

    return '';
  }

  const apiBase = (() => {
    const metaBase = document.querySelector('meta[name="api-base"]')?.content?.trim();
    const base = (window.API_BASE || metaBase || '').trim();
    if (!base) return '';
    let cleaned = base;
    try {
      const url = new URL(base, window.location.origin);
      if (url.username || url.password) {
        url.username = '';
        url.password = '';
        cleaned = `${url.origin}${url.pathname}${url.search}${url.hash}`;
      }
    } catch (err) {
      // Leave base as-is if it cannot be parsed as a URL.
    }
    return cleaned.endsWith('/') ? cleaned.slice(0, -1) : cleaned;
  })();

  function apiUrl(path) {
    if (!path) return path;
    const isAbsolute = /^https?:\/\//i.test(path);
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    const base = apiBase || window.location.origin;
    const rawUrl = isAbsolute ? path : `${base}${normalizedPath}`;
    try {
      const url = new URL(rawUrl);
      if (url.username || url.password) {
        url.username = '';
        url.password = '';
      }
      return url.toString();
    } catch (err) {
      return rawUrl;
    }
  }

  async function api(path, opts={}){
    const res = await fetch(apiUrl(path), {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    const data = await res.json().catch(() => ({}));
    if(!res.ok || data.ok === false){
      const details = data && data.details ? ` | ${typeof data.details === 'string' ? data.details : JSON.stringify(data.details)}` : '';
      const msg = (data.error || `Request failed: ${res.status}`) + details;
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(text, kind){
    const s = el('status');
    s.textContent = text;
    s.classList.remove('ok','warn');
    if(kind) s.classList.add(kind);
  }

  const categoryClasses = ['category-client', 'category-billing', 'category-instructors', 'category-guards', 'category-system', 'category-danger'];
  function setCategoryTheme(category) {
    document.body.classList.remove(...categoryClasses);
    const cls = `category-${category}`;
    if (categoryClasses.includes(cls)) {
      document.body.classList.add(cls);
    }
  }

  function categoryForManagerSection(section) {
    switch (section) {
      case 'billing':
        return 'billing';
      case 'instructors':
        return 'instructors';
      case 'guards':
        return 'guards';
      case 'system':
        return 'system';
      default:
        return 'client';
    }
  }
  function toast(msg){
    const prev = el('status').textContent;
    setStatus(msg, 'ok');
    setTimeout(() => {
      if (el('status').textContent === msg) el('status').textContent = prev;
    }, 1800);
  }


  function showModal(id, on=true){
    el(id).style.display = on ? 'flex' : 'none';
  }

  function openPinModal(mode) {
    const title = mode === 'admin' ? 'Admin Access' : 'Manager Access';
    el('pinModal').querySelector('h3').textContent = title;
    showModal('pinModal', true);
    el('pinInput').value = '';
    el('pinError').style.display = 'none';
    el('pinLockout').style.display = 'none';
    el('pinInput').focus();
  }

  function openProtectedAction({ title, message, requireDelete = false, requireInitials = true, requirePin = false, locationOptions = null, locationSelected = null, impactSummary = '', requireConfirmCheckbox = false, confirmLabel = 'I understand the impact.' } = {}) {
    return new Promise((resolve) => {
      const modalId = 'confirmModal';
      el('confirmTitle').textContent = title || 'Confirm action';
      el('confirmMessage').textContent = message || '';
      const impactField = el('confirmImpactField');
      const checkboxField = el('confirmCheckboxField');
      impactField.classList.toggle('hidden', !impactSummary);
      el('confirmImpactText').textContent = impactSummary || '';
      checkboxField.classList.toggle('hidden', !requireConfirmCheckbox);
      el('confirmCheckboxInput').checked = false;
      el('confirmCheckboxLabel').textContent = confirmLabel;
      el('confirmDeleteField').style.display = requireDelete ? 'block' : 'none';
      el('confirmInitialsField').style.display = requireInitials ? 'block' : 'none';
      el('confirmPinField').style.display = requirePin ? 'block' : 'none';
      el('confirmLocationField').style.display = locationOptions ? 'block' : 'none';
      el('confirmDeleteInput').value = '';
      el('confirmInitialsInput').value = '';
      el('confirmPinInput').value = '';
      if (locationOptions) {
        const select = el('confirmLocationSelect');
        select.innerHTML = '';
        locationOptions.forEach((opt) => {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          if (locationSelected && String(locationSelected) === String(opt.value)) {
            o.selected = true;
          }
          select.appendChild(o);
        });
      }

      const cleanup = () => {
        el('confirmSubmit').onclick = null;
        el('confirmCancel').onclick = null;
      };

      el('confirmCancel').onclick = () => {
        cleanup();
        showModal(modalId, false);
        resolve({ ok: false });
      };

      el('confirmSubmit').onclick = () => {
        const deleteValue = el('confirmDeleteInput').value.trim().toUpperCase();
        const initials = el('confirmInitialsInput').value.trim().toUpperCase();
        const pin = el('confirmPinInput').value.trim();
        const confirmChecked = el('confirmCheckboxInput').checked;
        if (requireDelete && deleteValue !== 'DELETE') {
          alert('Please type DELETE to confirm.');
          return;
        }
        if (requireInitials && !initials) {
          alert('Initials are required.');
          return;
        }
        if (requirePin && pin.length < 4) {
          alert('Manager PIN is required.');
          return;
        }
        if (requireConfirmCheckbox && !confirmChecked) {
          alert('Please confirm the impact checkbox.');
          return;
        }
        const locationValue = locationOptions ? el('confirmLocationSelect').value : null;
        if (locationOptions && !locationValue) {
          alert('Please select a location.');
          return;
        }
        cleanup();
        showModal(modalId, false);
        resolve({ ok: true, initials, pin, location_value: locationValue });
      };

      showModal(modalId, true);
    });
  }

  function blockIfReadOnly(actionLabel = 'This action') {
    if (!readOnlyMode) return false;
    alert(`${actionLabel} is disabled while read-only mode is enabled.`);
    return true;
  }

  function applyReadOnlyUI() {
    const banner = el('readOnlyBanner');
    if (banner) banner.classList.toggle('hidden', !readOnlyMode);
    const disableIds = [
      'importBtn', 'uploadHtmlBtn', 'exportServerBtn', 'importServerBtn',
      'addSwimmerBtn', 'exportVirtualDeskBtn', 'attendanceReportExportCSV',
      'attendanceReportExportJSON', 'instructorReportExportCSV', 'instructorReportExportJSON',
      'guardTasksReset', 'guardRotationAdd', 'guardTasksShuffle', 'guardTasksSnapshot',
      'bulkMarkPresent', 'bulkClearAttendance',
      'bundleSaveBtn', 'bundleResetBtn', 'bundleExportBtn',
      'deleteLatestDropListBtn'
    ];
    disableIds.forEach((id) => {
      const node = el(id);
      if (node) node.disabled = readOnlyMode;
    });
    document.querySelectorAll('.reportUploadBtn').forEach((btn) => {
      btn.disabled = readOnlyMode;
    });
  }

  function applyRoleUI() {
    const canManage = managerRole === 'admin' || managerRole === 'manager';
    const bulkActions = el('bulkAttendanceActions');
    if (bulkActions) bulkActions.style.display = canManage ? 'flex' : 'none';
    document.querySelectorAll('.admin-only').forEach((node) => {
      const isAdmin = managerRole === 'admin';
      node.disabled = !isAdmin;
      node.classList.toggle('disabled', !isAdmin);
      if (!isAdmin) {
        node.setAttribute('title', 'Admin only. Request Admin Access.');
      } else {
        node.removeAttribute('title');
      }
    });
    const systemLock = el('managerNavSystemLock');
    if (systemLock) {
      systemLock.classList.add('hidden');
    }
  }

  function syncDeviceUI(){
    el('deviceModeLabel').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('deviceModeSelect').value = deviceMode;
    el('zoneMode').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('managerCodeField').style.display = (deviceMode === 'deck') ? 'block' : 'none';
    updateDeckModeState();
  }

  async function updateDeckModeState() {
    const isDeck = deviceMode === 'deck';
    document.body.classList.toggle('deck-mode', isDeck);
    if (isDeck) {
      window.onbeforeunload = (e) => {
        e.preventDefault();
        e.returnValue = '';
      };
      if ('wakeLock' in navigator) {
        try {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => {
            wakeLock = null;
          });
        } catch (err) {
          console.warn('Wake lock failed:', err);
        }
      }
    } else {
      window.onbeforeunload = null;
      if (wakeLock) {
        wakeLock.release().catch(() => {});
        wakeLock = null;
      }
    }
    updateDeckDateWarning();
  }

  function updateDeckDateWarning() {
    const warning = el('deckDateWarning');
    if (!warning) return;
    const rosterDate = el('rosterDate')?.value;
    const today = getTodayISO();
    const show = deviceMode === 'deck' && rosterDate && rosterDate !== today;
    warning.classList.toggle('hidden', !show);
  }

  function setLastAnnouncementUI(last){
    const at = last?.at ? new Date(last.at) : null;
    el('lastAt').textContent = at ? at.toLocaleTimeString() : 'None';
    el('lastText').textContent = last?.text || 'None';
  }

  function setSelectedBlockUI(){
    el('selectedBlock').textContent = currentBlock ? fmtTime(currentBlock) : 'None';
    [...el('blocks').querySelectorAll('button[data-time]')].forEach(b => {
      b.classList.toggle('active', b.dataset.time === currentBlock);
    });
    el('addSwimmerBtn').disabled = !currentBlock;
  }

  function getTodayISO(){
    return new Date().toISOString().split('T')[0];
  }

  function applyManagerDateRange(range){
    managerDateRange = range;
    if (el('managerRangeStart')) el('managerRangeStart').value = range?.start || '';
    if (el('managerRangeEnd')) el('managerRangeEnd').value = range?.end || '';

    const hint = el('managerRangeHint');
    if (hint) {
      hint.textContent = range
        ? `Saved range: ${range.start} ‚Üí ${range.end}. Applies to reports + guard tasks.`
        : 'Saved range syncs report defaults and guard tasks.';
    }

    if (range?.start && range?.end) {
      if (el('attendanceReportStartDate')) el('attendanceReportStartDate').value = range.start;
      if (el('attendanceReportEndDate')) el('attendanceReportEndDate').value = range.end;
      if (el('instructorReportStartDate')) el('instructorReportStartDate').value = range.start;
      if (el('instructorReportEndDate')) el('instructorReportEndDate').value = range.end;
      if (el('guardTasksDate') && !el('guardTasksDate').value) el('guardTasksDate').value = range.start;
    }
  }

  async function loadReadOnlyMode() {
    try {
      const resp = await api('/api/read-only');
      readOnlyMode = !!resp.read_only;
      applyReadOnlyUI();
    } catch (e) {
      console.error('Failed to load read-only mode:', e);
    }
  }

  async function loadStatus(){
    const st = await api('/api/status');

    const activeDate = st.activeDate || st.todayISO;
    if (activeDate) {
      activeDateISO = activeDate;
    }
    const ttsOk = (st.piperBinExists && st.voiceModelExists);
    const ttsMsg = ttsOk ? 'TTS ready' : 'TTS missing (piper/model)';
    const rosterMsg = st.htmlExists ? `Roster loaded (${Math.round((st.htmlSizeBytes||0)/1024)} KB)` : 'No roster uploaded yet';

    setStatus(`${ttsMsg} ‚Ä¢ ${rosterMsg}`, (ttsOk ? 'ok' : 'warn'));

    const di = el('rosterDate');
    if (di && activeDate) di.value = activeDate;

    setLastAnnouncementUI(st.lastAnnouncement);
    el('blockHint').textContent = '';
    updateDeckDateWarning();

    if (st.managerDateRange) {
      applyManagerDateRange(st.managerDateRange);
    }
  }

  async function loadBlocks(){
    const locId = currentLocation?.id || 1;
    const b = await api(`/api/blocks?location_id=${locId}`);
    const wrap = el('blocks');
    wrap.innerHTML = '';

    blocksList = (b.blocks || []);

    const issuesResp = await api(`/api/safety-issues?location_id=${locId}&date=${activeDateISO || ''}`);
    const safetyMap = new Map((issuesResp.issues || []).map((i) => [i.start_time, i]));

    blocksList.forEach((t) => {
      const holder = document.createElement('div');
      holder.style.display = 'flex';
      holder.style.gap = '6px';
      holder.style.alignItems = 'center';

      const btn = document.createElement('button');
      btn.textContent = fmtTime(t);
      btn.dataset.time = t;
      btn.addEventListener('click', () => {
        currentBlock = t;
        setSelectedBlockUI();
        loadRoster();
      });
      holder.appendChild(btn);

      const issueBtn = document.createElement('button');
      issueBtn.className = 'miniBtn';
      issueBtn.title = 'Flag safety issue for this block';
      issueBtn.textContent = safetyMap.has(t) ? '‚ö†Ô∏è' : '‚öë';
      issueBtn.style.minWidth = '40px';
      issueBtn.addEventListener('click', async (event) => {
        event.stopPropagation();
        const existing = safetyMap.get(t);
        const note = prompt(
          `Safety issue for ${fmtTime(t)}.\n\nEnter details (leave blank to clear):`,
          existing?.note || ''
        );
        if (note === null) return;
        try {
          await api('/api/safety-issues', {
            method: 'POST',
            body: JSON.stringify({
              date: activeDateISO,
              start_time: t,
              location_id: currentLocation?.id || 1,
              note
            })
          });
          await loadBlocks();
          toast('Safety issue updated');
        } catch (err) {
          alert('Safety issue failed: ' + (err.message || err));
        }
      });
      holder.appendChild(issueBtn);

      if (safetyMap.has(t)) {
        holder.title = safetyMap.get(t)?.note || 'Safety issue flagged';
      }

      wrap.appendChild(holder);
    });

    if(!currentBlock && (b.blocks || []).length){
      currentBlock = b.blocks[0];
    }

    setSelectedBlockUI();
    if(currentBlock) await loadRoster();
    scheduleAutoAnnouncements();
  }


  function parseBlockDateTime(dateISO, time24, timeZone){
    if(!dateISO || !time24) return null;
    const [y,m,d] = dateISO.split('-').map(n=>parseInt(n,10));
    const [hh,mm] = String(time24).split(':').map(n=>parseInt(n,10));
    if(!y||!m||!d||Number.isNaN(hh)) return null;
    const utcGuess = new Date(Date.UTC(y, (m-1), d, hh, mm||0, 0, 0));
    const offsetMinutes = getTimeZoneOffsetMinutes(utcGuess, timeZone);
    return new Date(utcGuess.getTime() - offsetMinutes * 60000);
  }

  function scheduleAutoAnnouncements(){
    // clear existing timers
    autoTimers.forEach(id => clearTimeout(id));
    autoTimers = [];

    // Reset next announcement tracking
    nextAnnouncementTime = null;

    if(!activeDateISO || !blocksList.length) {
      stopCountdown();
      return;
    }

    const now = new Date();
    const timeZone = getLocationTimeZone();

    blocksList.forEach((t, idxBlock) => {
      const classAt = parseBlockDateTime(activeDateISO, t, timeZone);
      if(!classAt) return;

      const announceAt = new Date(classAt.getTime() - 3*60*1000);
      const delay = announceAt.getTime() - now.getTime();
      if(delay <= 0) return; // too late, don't back-announce

      // cap: only schedule within 36 hours to avoid weird multi-day timers
      if(delay > 36*60*60*1000) return;

      const id = setTimeout(async () => {
        try{
          // First block: call-up only. Subsequent blocks: pick-up + call-up.
          const timeLabel = fmtTime(t);
          const text = (idxBlock === 0)
            ? `Attention. ${timeLabel} classes. Instructors, please call up your first swimmer.`
            : `Attention. ${timeLabel} classes. Front desk, please pick up swimmers for this time block. Instructors, please call up your next swimmer.`;

          const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
          setLastAnnouncementUI(resp.lastAnnouncement);

          // After announcement, reschedule to update next timer
          setTimeout(() => scheduleAutoAnnouncements(), 1000);
        }catch(e){
          // don't spam alerts for background timers
          console.error('auto announcement failed', e);
        }
      }, delay);

      autoTimers.push(id);

      // Track the earliest announcement time
      if (!nextAnnouncementTime || announceAt < nextAnnouncementTime) {
        nextAnnouncementTime = announceAt;
      }
    });

    // Start countdown if we have scheduled announcements
    if (nextAnnouncementTime) {
      startCountdown();
    } else {
      stopCountdown();
    }
  }

  function startCountdown() {
    // Clear existing interval
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }

    // Update immediately
    updateCountdown();

    // Update every second
    countdownInterval = setInterval(updateCountdown, 1000);
  }

  function stopCountdown() {
    // Show timer pill but with dash
    el('nextAnnouncementTimer').textContent = '‚Äî';
    el('nextAnnouncementPill').style.display = '';
  }

  function updateCountdown() {
    const now = new Date();
    const timeZone = getLocationTimeZone();

    // Update current time display
    el('currentTime').textContent = fmtCurrentTime(now, timeZone);

    if (!nextAnnouncementTime) {
      el('nextAnnouncementTimer').textContent = '‚Äî';
      el('nextAnnouncementTimer').style.color = '#04D9FF';
      el('nextAnnouncementPill').style.display = '';
      return;
    }

    const diff = nextAnnouncementTime - now;

    // If time has passed, show NOW for 3 seconds
    if (diff <= 0) {
      el('nextAnnouncementTimer').textContent = 'NOW';
      el('nextAnnouncementTimer').style.color = '#22c55e';
      setTimeout(() => {
        stopCountdown();
      }, 3000);
      return;
    }

    // Calculate minutes and seconds
    const totalSeconds = Math.floor(diff / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    // Format as :MM or :SS
    let display = '';
    if (minutes > 0) {
      display = `:${String(minutes).padStart(2, '0')}`;
    } else {
      display = `:${String(seconds).padStart(2, '0')}`;
    }

    // Update the display
    el('nextAnnouncementTimer').textContent = display;
    el('nextAnnouncementTimer').style.color = '#04D9FF';
    el('nextAnnouncementPill').style.display = '';
  }

  function sortKids(kids){
    const sortBy = el('sortBy').value;
    const key = (s) => String(s || '').toLowerCase();

    const arr = [...kids];
    arr.sort((a,b) => {
      if(sortBy === 'instructor'){
        const ia = key(a.instructor_name);
        const ib = key(b.instructor_name);
        if(ia !== ib) return ia.localeCompare(ib);
        return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
      }
      return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
    });
    return arr;
  }

  function renderAttendance(kid){
    const w = document.createElement('div');
    w.className = 'attWrap';

    const mk = (label, cls, val, title) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = `attBtn ${cls}`;
      b.textContent = label;
      b.title = title;
      b.setAttribute('aria-label', title);
      b.classList.toggle('active', kid.attendance === val);
      b.addEventListener('click', async () => {
        try{
          if (readOnlyMode) return;
          // toggle behavior: clicking active sets to null
          const next = (kid.attendance === val) ? null : val;
          await api('/api/attendance', {
            method:'POST',
            body: JSON.stringify({
              start_time: currentBlock,
              swimmer_name: kid.swimmer_name,
              attendance: next,
              device_mode: deviceMode
            })
          });
          kid.attendance = next;
          loadRoster();
        }catch(e){
          alert(e.message);
        }
      });
      return b;
    };

    w.appendChild(mk('‚úÖ','here',1,'Mark here'));
    w.appendChild(mk('‚ùå','absent',0,'Mark absent'));
    w.appendChild(mk('‚≠ò','clear',null,'Clear attendance'));
    return w;
  }

  function renderFlags(kid){
    const row = document.createElement('div');
    row.className = 'flagRow';

    // Only show ACTIVE flags to save space
    if (kid.flag_new) {
      const emoji = document.createElement('span');
      emoji.className = 'flagBadge';
      emoji.textContent = '‚≠ê';
      emoji.title = 'First time (tap to remove)';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_new'));
      row.appendChild(emoji);
    }

    if (kid.flag_makeup) {
      const emoji = document.createElement('span');
      emoji.className = 'flagBadge';
      emoji.textContent = 'üîÑ';
      emoji.title = 'Makeup (tap to remove)';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_makeup'));
      row.appendChild(emoji);
    }

    if (kid.flag_policy) {
      const emoji = document.createElement('span');
      emoji.className = 'flagBadge';
      emoji.textContent = 'üìú';
      emoji.title = 'Policy (tap to remove)';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_policy'));
      row.appendChild(emoji);
    }

    if (kid.flag_owes) {
      const emoji = document.createElement('span');
      emoji.className = 'flagBadge';
      emoji.textContent = 'üí≥';
      emoji.title = 'Balance (tap to remove)';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_owes'));
      row.appendChild(emoji);
    }

    if (kid.flag_trial) {
      const emoji = document.createElement('span');
      emoji.className = 'flagBadge';
      emoji.textContent = 'üß™';
      emoji.title = 'Trial (tap to remove)';
      emoji.style.cursor = 'pointer';
      emoji.addEventListener('click', () => toggleFlag(kid, 'flag_trial'));
      row.appendChild(emoji);
    }

    return row;
  }

  async function toggleFlag(kid, flagKey) {
    try {
      if (readOnlyMode) return;
      const flags = {
        flag_new: !!kid.flag_new,
        flag_makeup: !!kid.flag_makeup,
        flag_policy: !!kid.flag_policy,
        flag_owes: !!kid.flag_owes,
        flag_trial: !!kid.flag_trial
      };
      flags[flagKey] = !flags[flagKey];
      
      const resp = await api('/api/update-flags', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name: kid.swimmer_name,
          device_mode: deviceMode,
          flags
        })
      });
      
      kid.flag_new = resp.flags.flag_new;
      kid.flag_makeup = resp.flags.flag_makeup;
      kid.flag_policy = resp.flags.flag_policy;
      kid.flag_owes = resp.flags.flag_owes;
      kid.flag_trial = resp.flags.flag_trial;
      loadRoster();
    } catch(e) {
      alert(e.message);
    }
  }

  function openEditModal(kid) {
    // TODO: Implement edit modal
    alert(`Edit ${kid.swimmer_name}\n\nEdit functionality coming soon!\n\nFor now, you can:\n- Click icons to remove them\n- Use zone button to change zone\n- Use attendance buttons`);
  }

  function renderZoneChip(kid){
    const z = kid.zone ? `Zone ${kid.zone}` : '‚Äî';
    const chip = document.createElement('div');
    chip.className = 'zone' + (deviceMode === 'deck' ? ' locked' : '');
    chip.textContent = z;
    chip.title = (deviceMode === 'deck') ? 'Deck mode: requires manager code' : 'Click to change zone';
    chip.addEventListener('click', () => {
      zoneTarget = kid;
      el('zoneWho').textContent = kid.swimmer_name;
      el('zoneSelect').value = String(kid.zone || 1);
      el('managerCode').value = '';
      syncDeviceUI();
      showModal('zoneModal', true);
    });
    return chip;
  }

  async function loadRoster(){
    if(!currentBlock){
      el('roster').innerHTML = '';
      el('rosterMeta').textContent = '';
      return;
    }

    const locId = currentLocation?.id || 1;
    const data = await api(`/api/blocks/${encodeURIComponent(currentBlock)}?location_id=${locId}`);
    rosterCache = data.kids || [];
    let kids = sortKids(rosterCache);

    // Apply search filter
    const totalCount = kids.length;
    if (searchFilter.trim()) {
      const query = searchFilter.toLowerCase();
      kids = kids.filter(kid => {
        const name = (kid.swimmer_name || '').toLowerCase();
        const instructor = (kid.instructor_name || '').toLowerCase();
        const substitute = (kid.substitute_instructor || '').toLowerCase();
        const original = (kid.original_instructor || '').toLowerCase();
        const zone = (kid.zone || '').toString().toLowerCase();
        const program = (kid.program || '').toLowerCase();

        return name.includes(query) ||
               instructor.includes(query) ||
               substitute.includes(query) ||
               original.includes(query) ||
               zone.includes(query) ||
               program.includes(query);
      });
    }

    // Update roster meta with filter info
    if (searchFilter.trim()) {
      el('rosterMeta').textContent = `(Showing ${kids.length} of ${totalCount} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;
    } else {
      el('rosterMeta').textContent = `(${kids.length} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;
    }

    const tbody = el('roster');
    tbody.innerHTML = '';

    for(const kid of kids){
      const tr = document.createElement('tr');

      if (kid.attendance_auto_absent) {
        tr.classList.add('row-auto-absent');
      }

      // Attendance
      const tdAtt = document.createElement('td');
      tdAtt.appendChild(renderAttendance(kid));
      tr.appendChild(tdAtt);

      const subMeta = getSubMeta(kid);
      const instructorDisplay = cleanInstructorLabel(subMeta.subName || kid.instructor_name || '');

      // Swimmer (with badges + flags)
      const tdName = document.createElement('td');
      tdName.className = 'rosterCell';
      const nameLine = document.createElement('div');
      nameLine.className = 'level rosterCell';
      nameLine.textContent = kid.swimmer_name || '‚Äî';

      if (kid.attendance_auto_absent) {
        const autoChip = document.createElement('span');
        autoChip.className = 'chip auto-absent';
        autoChip.textContent = 'auto-absent';
        nameLine.appendChild(autoChip);
      }

      if(kid.is_addon){
        const b = document.createElement('span');
        b.className = 'badge addon';
        b.textContent = 'ADD-ON';
        nameLine.appendChild(b);
      }

      if(kid.zone_overridden){
        const b = document.createElement('span');
        b.className = 'badge over';
        b.textContent = 'OVERRIDE';
        nameLine.appendChild(b);
      }

      if (kid.is_addon) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'secondary miniBtn';
        removeBtn.textContent = 'üóëÔ∏è';
        removeBtn.title = 'Remove add-on swimmer';
        removeBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const confirmed = await openProtectedAction({
            title: 'Remove add-on swimmer',
            message: `Type DELETE and enter initials to remove ${kid.swimmer_name}.`,
            requireDelete: true,
            requireInitials: true,
            impactSummary: 'This removes the add-on swimmer from the roster.',
            requireConfirmCheckbox: true
          });
          if (!confirmed.ok) return;
          try{
            await api('/api/remove-addon', {
              method:'POST',
              body: JSON.stringify({
                start_time: currentBlock,
                swimmer_name: kid.swimmer_name,
                device_mode: deviceMode,
                initials: confirmed.initials
              })
            });
            loadRoster();
          }catch(e){
            alert(e.message);
          }
        });
        nameLine.appendChild(removeBtn);
      }

      tdName.appendChild(nameLine);
      tdName.appendChild(renderFlags(kid));
      tr.appendChild(tdName);

      // Age
      const tdAge = document.createElement('td');
      tdAge.className = 'nowrap rosterCell';
      tdAge.textContent = kid.age_text || '‚Äî';
      tr.appendChild(tdAge);

      // Type / Level
      const tl = parseTypeLevel(kid.program);
      const tdType = document.createElement('td');
      tdType.className = 'rosterCell';
      tdType.textContent = tl.type;
      tr.appendChild(tdType);

      const tdLevel = document.createElement('td');
      tdLevel.className = 'rosterCell';
      tdLevel.textContent = tl.level;
      tr.appendChild(tdLevel);

      // Instructor (compact, no date, optional sub line)
      const tdInst = document.createElement('td');
      tdInst.className = 'rosterCell';
      const instStack = document.createElement('div');
      instStack.style.display = 'flex';
      instStack.style.flexDirection = 'column';
      instStack.style.gap = '4px';

      const instLine = document.createElement('div');
      instLine.style.fontWeight = '700';
      instLine.textContent = instructorDisplay;
      instStack.appendChild(instLine);

      if (subMeta.hasSub) {
        const subLine = document.createElement('div');
        if (subMeta.originalName) {
          subLine.innerHTML = `<span class="chip amber">SUB for ${escapeHtml(subMeta.originalName)}</span>`;
        } else {
          subLine.innerHTML = `<span class="chip amber">SUB</span>`;
        }
        instStack.appendChild(subLine);
      }

      tdInst.appendChild(instStack);
      tr.appendChild(tdInst);

      // Zone
      const tdZone = document.createElement('td');
      tdZone.className = 'rosterCell';
      tdZone.appendChild(renderZoneChip(kid));
      tr.appendChild(tdZone);

      // Action
      const tdAction = document.createElement('td');
      tdAction.className = 'rosterCell';
      tdAction.innerHTML = renderIconButton('üì£', 'Announce swimmer');
      const callBtn = tdAction.querySelector('button');
      callBtn.addEventListener('click', async () => {
        try{
          await api('/api/call-parent', {
            method:'POST',
            body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
          });
        }catch(e){
          alert(e.message);
        }
      });

      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  }

  // ---- Announcements ----
  async function speakTyped(text){
    const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
    setLastAnnouncementUI(resp.lastAnnouncement);
  }

  // ---- Wire up UI ----
  // View selector dropdown
  el('viewSelect').addEventListener('change', async (e) => {
    const view = e.target.value;
    lastPanel = view;

    // Hide all panels
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.add('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.add('hidden');

    if (view === 'roster') {
      el('panelRoster').classList.remove('hidden');
      setCategoryTheme('instructors');
    } else if (view === 'lifeguard') {
      showLifeguardPanel();
      setCategoryTheme('guards');
    } else if (view === 'announcements') {
      el('panelAnnouncements').classList.remove('hidden');
      setCategoryTheme('guards');
    } else if (view === 'virtualDesk') {
      // Check PIN authentication
      const pinAuth = sessionStorage.getItem('manager_pin_auth');
      const pinExpiry = sessionStorage.getItem('manager_pin_expiry');

      if (pinAuth && pinExpiry && Date.now() < parseInt(pinExpiry)) {
        managerRole = sessionStorage.getItem('manager_role') || 'manager';
        showVirtualDeskPanel();
      } else {
        pendingPinPanel = 'virtualDesk';
        openPinModal('manager');
      }
    } else if (view === 'admin') {
      // Check PIN authentication
      const pinAuth = sessionStorage.getItem('admin_pin_auth');
      const pinExpiry = sessionStorage.getItem('admin_pin_expiry');

      if (pinAuth && pinExpiry && Date.now() < parseInt(pinExpiry)) {
        showAdminPanel();
      } else {
        pendingPinPanel = 'admin';
        openPinModal('admin');
      }
    }
  });

  function showVirtualDeskPanel() {
    el('viewSelect').value = 'virtualDesk';
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.remove('hidden');
    el('panelAdmin').classList.add('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.add('hidden');
    setCategoryTheme(categoryForManagerSection(managerSection));
    applyRoleUI();
    setManagerSection(managerSection);
    toggleManagerSidebar(false);

    // Load virtual desk stats and swimmer details
    loadManagerDashboard();
  }

  function showAdminPanel() {
    el('viewSelect').value = 'admin';
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.remove('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.add('hidden');
    setCategoryTheme('system');

    // Load locations and staff
    loadAdminLocations();
    loadStaff();
    loadActivityLog();
  }

  function showLifeguardPanel() {
    showGuardTasksPanel('lifeguard');
  }

  async function loadAdminStats() {
    try {
      const resp = await api('/api/admin/stats');
      if (resp.ok) {
        el('adminStatSwimmers').textContent = resp.stats.swimmers_today;
        el('adminStatAttendance').textContent = resp.stats.attendance_rate + '%';
        el('adminStatTrials').textContent = resp.stats.trials_this_week;
      }
    } catch (e) {
      console.error('Failed to load admin stats:', e);
    }
  }

  const guardTaskTemplates = {
    weekday: {
      opening: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Make sure each pool has a bin' },
        { group: 'Guard 1', label: 'Vacuum pools' },
        { group: 'Guard 2', label: 'Cycle laundry' },
        { group: 'Guard 2', label: 'Empty dehumidifiers' },
        { group: 'Guard 2', label: 'Check playpen' },
        { group: 'Front Desk', label: 'Set up lobby' },
        { group: 'All Guards', label: 'Pick up a walkie' }
      ],
      closing: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Clean pool deck and close deck doors' },
        { group: 'Guard 1', label: 'Empty dehumidifiers' },
        { group: 'Guard 1', label: 'Cycle laundry' },
        { group: 'Guard 1', label: 'Clean bathrooms and leave doors open' },
        { group: 'Guard 2', label: 'Empty and change garbage bags' },
        { group: 'Guard 2', label: 'Vacuum facility including playpen' },
        { group: 'Guard 2', label: 'Mop floors' },
        { group: 'All Guards', label: 'Return walkie' }
      ]
    },
    weekend: {
      opening: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Make sure each pool has a bin' },
        { group: 'Guard 1', label: 'Vacuum pools' },
        { group: 'Guard 2', label: 'Set up lobby' },
        { group: 'Guard 2', label: 'Cycle laundry' },
        { group: 'Guard 2', label: 'Empty dehumidifiers' },
        { group: 'Guard 3 (Up for First Rotation)', label: 'Check playpen' },
        { group: 'Guard 3 (Up for First Rotation)', label: 'Restock snack wall/fridge/coffee station' },
        { group: 'All Guards', label: 'Pick up a walkie' }
      ],
      closing: [
        { group: 'Guard 1', label: 'Chemicals check' },
        { group: 'Guard 1', label: 'Clean pool deck and close deck doors' },
        { group: 'Guard 2', label: 'Empty dehumidifiers' },
        { group: 'Guard 2', label: 'Empty/change garbage bags' },
        { group: 'Guard 2', label: 'Clean bathrooms and leave doors open' },
        { group: 'Guard 2', label: 'Cycle laundry' },
        { group: 'Guard 3 (Down for Last Rotation)', label: 'Vacuum facility including playpen' },
        { group: 'Guard 3 (Down for Last Rotation)', label: 'Mop floors' },
        { group: 'Front Desk', label: 'Tidy playpen' },
        { group: 'Front Desk', label: 'Close lobby' }
      ]
    },
    midday: [
      { group: 'All Guards', label: 'Check bathrooms each rotation' },
      { group: 'All Guards', label: 'Sweep and mop' },
      { group: 'All Guards', label: 'Clean toilet' },
      { group: 'All Guards', label: 'Stock toilet paper' },
      { group: 'All Guards', label: 'Clean mirrors/hand railings/doorknobs/walls' },
      { group: 'All Guards', label: 'Sign bathroom log' },
      { group: 'All Guards', label: 'Empty dehumidifiers' },
      { group: 'All Guards', label: 'Midday chemical check' },
      { group: 'All Guards', label: 'Laundry (client towels only)' },
      { group: 'All Guards', label: "Don‚Äôt start washer with fewer than 5 towels" },
      { group: 'All Guards', label: "Don‚Äôt change washer settings" },
      { group: 'All Guards', label: 'Use heavy duty setting for the dryer' },
      { group: 'All Guards', label: 'Hand vacuum/sweep/dry mop: Lobby/Bathrooms/Staff room/Locker rooms' },
      { group: 'All Guards', label: 'Deck windows when time allows' }
    ]
  };

  let guardState = null;

  function buildGuardTasks(template) {
    return template.map((item, idx) => ({
      id: `task_${idx}_${Math.random().toString(36).slice(2, 7)}`,
      label: item.label || item,
      group: item.group || null,
      initials: '',
      custom: false
    }));
  }

  function isWeekendDate(dateStr) {
    if (!dateStr) return false;
    const d = new Date(`${dateStr}T00:00:00`);
    const day = d.getDay();
    return day === 0 || day === 6;
  }

  function normalizeGuardTasks(list) {
    return (list || []).map((task) => ({
      ...task,
      group: task.group || null,
      initials: task.initials || (task.done ? '‚úì' : '')
    }));
  }

  async function loadGuardState(date) {
    if (!date) return null;
    const weekend = isWeekendDate(date);
    const dayType = weekend ? 'weekend' : 'weekday';
    try {
      const locId = currentLocation?.id || 1;
      const resp = await api(`/api/guard-tasks?location_id=${locId}&date=${date}`);
      if (resp.task?.data_json) {
        const parsed = JSON.parse(resp.task.data_json);
        return {
          date,
          dayType,
          guardNames: parsed.guardNames || { 1: '', 2: '', 3: '' },
          opening: normalizeGuardTasks(parsed.opening || buildGuardTasks(guardTaskTemplates[dayType].opening)),
          midday: normalizeGuardTasks(parsed.midday || buildGuardTasks(guardTaskTemplates.midday)),
          closing: normalizeGuardTasks(parsed.closing || buildGuardTasks(guardTaskTemplates[dayType].closing)),
          rotation: parsed.rotation || [],
          notes: parsed.notes || '',
          autoShuffleDone: parsed.autoShuffleDone || false
        };
      }
    } catch (e) {
      console.error('Failed to load guard tasks:', e);
    }
    return {
      date,
      dayType,
      guardNames: { 1: '', 2: '', 3: '' },
      opening: normalizeGuardTasks(buildGuardTasks(guardTaskTemplates[dayType].opening)),
      midday: normalizeGuardTasks(buildGuardTasks(guardTaskTemplates.midday)),
      closing: normalizeGuardTasks(buildGuardTasks(guardTaskTemplates[dayType].closing)),
      rotation: [],
      notes: '',
      autoShuffleDone: false
    };
  }

  async function saveGuardState() {
    if (!guardState?.date || readOnlyMode) return;
    const locId = currentLocation?.id || 1;
    try {
      await api('/api/guard-tasks', {
        method: 'POST',
        body: JSON.stringify({
          location_id: locId,
          date: guardState.date,
          data: guardState
        })
      });
    } catch (e) {
      console.error('Failed to save guard tasks:', e);
    }
  }

  function shuffleNames(list) {
    const arr = [...list];
    for (let i = arr.length - 1; i > 0; i -= 1) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function getGuardInputNames() {
    return [
      el('guardName1').value.trim(),
      el('guardName2').value.trim(),
      el('guardName3').value.trim()
    ];
  }

  function applyGuardNames(names, autoShuffled = false) {
    guardState.guardNames = {
      1: names[0] || '',
      2: names[1] || '',
      3: names[2] || ''
    };
    if (autoShuffled) {
      guardState.autoShuffleDone = true;
    }
    saveGuardState();
    renderGuardTasks();
  }

  function maybeAutoShuffleGuards() {
    if (!guardState || guardState.dayType !== 'weekend' || guardState.autoShuffleDone) return;
    const names = getGuardInputNames();
    if (names.filter(Boolean).length < 3) return;
    applyGuardNames(shuffleNames(names), true);
  }

  function setGuardMeta() {
    if (!guardState?.date) return;
    const allTasks = [...guardState.opening, ...guardState.midday, ...guardState.closing];
    const doneCount = allTasks.filter(t => (t.initials || '').trim().length > 0).length;
    const totalCount = allTasks.length;
    const locName = currentLocation?.name || 'Unknown location';
    const dayLabel = guardState.dayType === 'weekend' ? 'Weekend' : 'Weekday';
    el('guardTasksMeta').textContent = `${locName} ‚Ä¢ ${guardState.date} ‚Ä¢ ${dayLabel} ‚Ä¢ ${doneCount}/${totalCount} tasks complete`;
  }

  function renderGuardSection(list, containerId, sectionKey) {
    const container = el(containerId);
    container.innerHTML = '';
    let lastGroup = null;
    const canEdit = managerRole === 'admin' || managerRole === 'manager';
    list.forEach((task) => {
      if (task.group && task.group !== lastGroup) {
        const group = document.createElement('div');
        group.className = 'guard-group-title';
        group.textContent = task.group;
        container.appendChild(group);
        lastGroup = task.group;
      }
      const row = document.createElement('div');
      const isDone = (task.initials || '').trim().length > 0;
      row.className = `guard-task ${isDone ? 'done' : ''}`;

      const label = document.createElement('span');
      label.textContent = task.label;
      if (isDone) {
        label.style.color = 'rgba(159,176,208,.85)';
        label.style.fontWeight = '700';
        const check = document.createElement('span');
        check.textContent = ' ‚úÖ';
        label.appendChild(check);
      }
      row.appendChild(label);

      const initials = document.createElement('input');
      initials.type = 'text';
      initials.maxLength = 4;
      initials.placeholder = 'Initials';
      initials.required = true;
      initials.setAttribute('aria-label', 'Initials required to mark complete');
      initials.value = task.initials || '';
      initials.disabled = readOnlyMode;
      initials.addEventListener('input', () => {
        task.initials = initials.value.toUpperCase();
        saveGuardState();
        renderGuardTasks();
      });
      row.appendChild(initials);

      if (task.custom && canEdit && !readOnlyMode) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'miniBtn';
        removeBtn.textContent = '‚úï';
        removeBtn.addEventListener('click', () => {
          guardState[sectionKey] = guardState[sectionKey].filter(t => t.id !== task.id);
          saveGuardState();
          renderGuardTasks();
        });
        row.appendChild(removeBtn);
      }

      container.appendChild(row);
    });
  }

  function addCustomGuardTask(sectionKey) {
    if (!guardState || !guardState[sectionKey]) return;
    const canEdit = managerRole === 'admin' || managerRole === 'manager';
    if (!canEdit) {
      alert('Templates are locked for guards. Ask a manager to edit.');
      return;
    }
    if (readOnlyMode) {
      alert('Read-only mode is enabled.');
      return;
    }
    const groupInput = prompt('Task group (optional):', '');
    if (groupInput === null) return;
    const labelInput = prompt('Task label:');
    if (!labelInput) return;
    const applyTodayOnly = confirm('Apply change only for today?\n\nOK = today only\nCancel = update template going forward');
    guardState[sectionKey].push({
      id: `task_custom_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
      label: labelInput.trim(),
      group: groupInput.trim() || null,
      initials: '',
      custom: true
    });
    if (!applyTodayOnly) {
      if (sectionKey === 'midday') {
        guardTaskTemplates.midday.push({ group: groupInput.trim() || 'All Guards', label: labelInput.trim() });
      } else {
        guardTaskTemplates[guardState.dayType][sectionKey].push({ group: groupInput.trim() || 'All Guards', label: labelInput.trim() });
      }
    }
    saveGuardState();
    renderGuardTasks();
  }

  function renderGuardRotation() {
    const body = el('guardRotationBody');
    body.innerHTML = '';
    const weekend = guardState.dayType === 'weekend';
    const rotationHint = el('guardRotationHint');
    if (weekend) {
      rotationHint.textContent = 'Weekend rotation starts with Guard 2 + 3, then 3 + 1, then 1 + 2 (repeat). Example: Block 1 = 2+3, Block 2 = 3+1, Block 3 = 1+2, Block 4 = 2+3.';
      const guardLabels = {
        1: guardState.guardNames?.[1] ? `Guard 1 (${guardState.guardNames[1]})` : 'Guard 1',
        2: guardState.guardNames?.[2] ? `Guard 2 (${guardState.guardNames[2]})` : 'Guard 2',
        3: guardState.guardNames?.[3] ? `Guard 3 (${guardState.guardNames[3]})` : 'Guard 3'
      };
      const pattern = [
        [2, 3],
        [3, 1],
        [1, 2]
      ];
      const totalBlocks = 6;
      for (let i = 0; i < totalBlocks; i += 1) {
        const pair = pattern[i % pattern.length];
        const tr = document.createElement('tr');

        const tdBlock = document.createElement('td');
        tdBlock.textContent = `Block ${i + 1}`;
        tr.appendChild(tdBlock);

        const tdGuard = document.createElement('td');
        tdGuard.textContent = `${guardLabels[pair[0]]} + ${guardLabels[pair[1]]}`;
        tr.appendChild(tdGuard);

        const tdZone = document.createElement('td');
        tdZone.textContent = 'Rotation';
        tr.appendChild(tdZone);

        const tdRemove = document.createElement('td');
        tr.appendChild(tdRemove);

        body.appendChild(tr);
      }
      return;
    }

    rotationHint.textContent = 'Weekdays have no rotation unless updated manually.';
    guardState.rotation.forEach((entry, idx) => {
      const tr = document.createElement('tr');

      const tdTime = document.createElement('td');
      const timeInput = document.createElement('input');
      timeInput.value = entry.time || '';
      timeInput.disabled = readOnlyMode;
      timeInput.addEventListener('input', () => {
        entry.time = timeInput.value;
        saveGuardState();
      });
      tdTime.appendChild(timeInput);
      tr.appendChild(tdTime);

      const tdGuard = document.createElement('td');
      const guardInput = document.createElement('input');
      guardInput.value = entry.guard || '';
      guardInput.disabled = readOnlyMode;
      guardInput.addEventListener('input', () => {
        entry.guard = guardInput.value;
        saveGuardState();
      });
      tdGuard.appendChild(guardInput);
      tr.appendChild(tdGuard);

      const tdZone = document.createElement('td');
      const zoneInput = document.createElement('input');
      zoneInput.value = entry.zone || '';
      zoneInput.disabled = readOnlyMode;
      zoneInput.addEventListener('input', () => {
        entry.zone = zoneInput.value;
        saveGuardState();
      });
      tdZone.appendChild(zoneInput);
      tr.appendChild(tdZone);

      const tdRemove = document.createElement('td');
      const removeBtn = document.createElement('button');
      removeBtn.className = 'miniBtn';
      removeBtn.textContent = '‚úï';
      removeBtn.addEventListener('click', () => {
        guardState.rotation.splice(idx, 1);
        saveGuardState();
        renderGuardRotation();
      });
      tdRemove.appendChild(removeBtn);
      tr.appendChild(tdRemove);

      body.appendChild(tr);
    });
  }

  function renderGuardTasks() {
    if (!guardState) return;
    const canEdit = managerRole === 'admin' || managerRole === 'manager';
    const openingTitle = el('guardOpeningTitle');
    const closingTitle = el('guardClosingTitle');
    if (openingTitle) {
      openingTitle.textContent = guardState.dayType === 'weekend'
        ? 'üåÖ Opening Checklist (Weekends ‚Äî 3 Guards)'
        : 'üåÖ Opening Checklist (Weekdays ‚Äî 2 Guards)';
    }
    if (closingTitle) {
      closingTitle.textContent = guardState.dayType === 'weekend'
        ? 'üåô Closing Checklist (Weekends ‚Äî 3 Guards)'
        : 'üåô Closing Checklist (Weekdays ‚Äî 2 Guards)';
    }
    renderGuardSection(guardState.opening, 'guardOpeningList', 'opening');
    renderGuardSection(guardState.midday, 'guardMiddayList', 'midday');
    renderGuardSection(guardState.closing, 'guardClosingList', 'closing');
    renderGuardRotation();
    el('guardNotes').value = guardState.notes || '';
    el('guardName1').value = guardState.guardNames?.[1] || '';
    el('guardName2').value = guardState.guardNames?.[2] || '';
    el('guardName3').value = guardState.guardNames?.[3] || '';
    el('guardRotationAdd').style.display = guardState.dayType === 'weekend' ? 'none' : '';
    document.querySelectorAll('.guardAddTask').forEach((btn) => {
      btn.style.display = canEdit && !readOnlyMode ? '' : 'none';
    });
    el('guardTasksReset').disabled = !canEdit || readOnlyMode;
    el('guardTasksShuffle').disabled = readOnlyMode;
    el('guardTasksSnapshot').disabled = !canEdit || readOnlyMode;
    el('guardNotes').disabled = readOnlyMode;
    setGuardMeta();
  }

  async function showGuardTasksPanel(fromPanel) {
    if (!isWestchesterLocation()) {
      el('viewSelect').value = 'roster';
      el('panelRoster').classList.remove('hidden');
      return;
    }
    lastPanel = fromPanel;
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.add('hidden');
    el('panelVirtualDesk').classList.add('hidden');
    el('panelAdmin').classList.add('hidden');
    el('panelLifeguard').classList.add('hidden');
    el('panelGuardTasks').classList.remove('hidden');

    const defaultDate = managerDateRange?.start || activeDateISO || getTodayISO();
    const dateInput = el('guardTasksDate');
    if (dateInput && !dateInput.value) dateInput.value = defaultDate;
    guardState = await loadGuardState(dateInput.value);
    renderGuardTasks();
  }

  async function loadAdminLocations() {
    try {
      const resp = await api('/api/locations');
      const list = el('locationsList');
      list.innerHTML = '';

      (resp.locations || []).forEach(loc => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,0.03); border-radius:8px;';

        const info = document.createElement('div');
        info.innerHTML = `<strong>${loc.name}</strong> (${loc.code}) <span class="tiny" style="color:var(--muted);">${loc.brand}</span>`;
        item.appendChild(info);

        const actions = document.createElement('div');
        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.style.cssText = 'padding:4px 12px; font-size:12px;';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeLocation(loc.id, loc.name));
        actions.appendChild(delBtn);
        item.appendChild(actions);

        list.appendChild(item);
      });

      const overrideSelect = el('overrideLocationSelect');
      const newStaffOverride = el('newStaffLocationOverride');
      if (overrideSelect) {
        overrideSelect.innerHTML = '';
        (resp.locations || []).forEach(loc => {
          const opt = document.createElement('option');
          opt.value = loc.code || loc.name;
          opt.textContent = loc.name;
          overrideSelect.appendChild(opt);
        });
      }
      if (newStaffOverride) {
        newStaffOverride.innerHTML = '<option value="">(select location)</option>';
        (resp.locations || []).forEach(loc => {
          const opt = document.createElement('option');
          opt.value = loc.code || loc.name;
          opt.textContent = loc.name;
          newStaffOverride.appendChild(opt);
        });
      }
    } catch (e) {
      console.error('Failed to load admin locations:', e);
    }
  }

  async function loadActivityLog() {
    try {
      const resp = await api('/api/admin/activity-log');
      const container = el('activityLogTable');
      if (!resp.entries || !resp.entries.length) {
        container.innerHTML = '<div class="tiny" style="color:var(--muted); padding:8px;">No activity yet.</div>';
        return;
      }
      let html = '<table><thead><tr><th>Time</th><th>Action</th><th>Initials</th><th>Location</th></tr></thead><tbody>';
      resp.entries.forEach((entry) => {
        const locName = entry.location_id
          ? (allLocations.find((loc) => loc.id === entry.location_id)?.name || entry.location_id)
          : '';
        html += '<tr>';
        html += `<td>${formatShortDate(entry.created_at || entry.at || '')}</td>`;
        html += `<td>${escapeHtml(entry.action || '')}</td>`;
        html += `<td>${escapeHtml(entry.initials || '')}</td>`;
        html += `<td>${escapeHtml(locName)}</td>`;
        html += '</tr>';
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    } catch (e) {
      console.error('Failed to load activity log:', e);
    }
  }

  async function loadStaff() {
    try {
      const resp = await api('/api/staff');
      const list = el('staffList');
      list.innerHTML = '';

      (resp.staff || []).forEach(staff => {
        const item = document.createElement('div');
        item.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:6px; background:rgba(255,255,255,0.03); border-radius:8px;';

        const info = document.createElement('div');

        // Format birthday to show only month/day (remove year)
        let birthdayDisplay = '';
        if (staff.birthday) {
          const parts = staff.birthday.split('/');
          if (parts.length >= 2) {
            birthdayDisplay = `${parts[0]}/${parts[1]}`; // MM/DD only
          }
        }

        // Build info HTML with phone and birthday
        let infoHTML = `<strong>${staff.firstName} ${staff.lastName}</strong>`;
        infoHTML += ` <span class="tiny" style="color:var(--muted);">${staff.state || 'Unknown'}</span>`;
        if (staff.phone) {
          infoHTML += `<br><span class="tiny" style="color:var(--muted);">üìû ${staff.phone}</span>`;
        }
        if (birthdayDisplay) {
          infoHTML += ` <span class="tiny" style="color:var(--muted);">üéÇ ${birthdayDisplay}</span>`;
        }

        info.innerHTML = infoHTML;
        item.appendChild(info);

        const actions = document.createElement('div');
        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.style.cssText = 'padding:4px 12px; font-size:12px;';
        delBtn.textContent = 'Remove';
        delBtn.addEventListener('click', () => removeStaff({
          scope: 'state',
          firstName: staff.firstName,
          lastName: staff.lastName,
          state: staff.state
        }));
        actions.appendChild(delBtn);
        item.appendChild(actions);

        list.appendChild(item);
      });

      const overrideStaffSelect = el('overrideStaffSelect');
      if (overrideStaffSelect) {
        overrideStaffSelect.innerHTML = '';
        (resp.staff || []).forEach(staff => {
          const opt = document.createElement('option');
          opt.value = `${staff.firstName} ${staff.lastName}`;
          opt.textContent = `${staff.firstName} ${staff.lastName} (${staff.state || 'State'})`;
          overrideStaffSelect.appendChild(opt);
        });
      }

      const overrideList = el('overrideList');
      if (overrideList) {
        const overrides = resp.overrides || {};
        const entries = Object.entries(overrides);
        if (!entries.length) {
          overrideList.textContent = 'No location overrides yet.';
        } else {
          overrideList.innerHTML = entries.map(([key, value]) => {
            const added = (value.add || []).map((i) => `${i.firstName} ${i.lastName}`).join(', ') || 'None';
            const removed = (value.remove || []).join(', ') || 'None';
            return `<div><strong>${key}</strong> ‚Ä¢ Added: ${added} ‚Ä¢ Removed: ${removed}</div>`;
          }).join('');
        }
      }
    } catch (e) {
      console.error('Failed to load staff:', e);
    }
  }

  function parseFullName(value) {
    const parts = String(value || '').trim().split(' ');
    if (parts.length < 2) return { firstName: '', lastName: '' };
    return { firstName: parts[0], lastName: parts.slice(1).join(' ') };
  }

  el('overrideRemoveBtn').addEventListener('click', async () => {
    const locKey = el('overrideLocationSelect').value;
    const staffValue = el('overrideStaffSelect').value;
    const { firstName, lastName } = parseFullName(staffValue);
    if (!locKey || !firstName || !lastName) {
      alert('Select a location and staff member.');
      return;
    }
    const confirmed = await openProtectedAction({
      title: 'Remove staff from location',
      message: `Type DELETE and enter initials to remove ${firstName} ${lastName} from ${locKey}.`,
      requireDelete: true,
      requireInitials: true
    });
    if (!confirmed.ok) return;
    try {
      await api('/api/admin/staff/override-remove', {
        method: 'POST',
        body: JSON.stringify({
          location_key: locKey,
          firstName,
          lastName,
          initials: confirmed.initials
        })
      });
      loadStaff();
    } catch (e) {
      alert(`Failed to update override: ${e.message}`);
    }
  });

  el('overrideRestoreBtn').addEventListener('click', async () => {
    const locKey = el('overrideLocationSelect').value;
    const staffValue = el('overrideStaffSelect').value;
    const { firstName, lastName } = parseFullName(staffValue);
    if (!locKey || !firstName || !lastName) {
      alert('Select a location and staff member.');
      return;
    }
    const confirmed = await openProtectedAction({
      title: 'Restore staff to location',
      message: `Enter initials to restore ${firstName} ${lastName} for ${locKey}.`,
      requireDelete: false,
      requireInitials: true
    });
    if (!confirmed.ok) return;
    try {
      await api('/api/admin/staff/override-restore', {
        method: 'POST',
        body: JSON.stringify({ location_key: locKey, firstName, lastName })
      });
      loadStaff();
    } catch (e) {
      alert(`Failed to restore override: ${e.message}`);
    }
  });

  async function removeLocation(id, name) {
    const confirmed = await openProtectedAction({
      title: 'Remove location',
      message: `Type DELETE and enter initials to remove ${name}.`,
      requireDelete: true,
      requireInitials: true
    });
    if (!confirmed.ok) return;

    try {
      await api('/api/admin/remove-location', {
        method: 'POST',
        body: JSON.stringify({ id, initials: confirmed.initials })
      });
      alert(`Location "${name}" removed successfully.`);
      loadAdminLocations();
      await loadLocations(); // Also update main dropdown
    } catch (e) {
      alert(`Failed to remove location: ${e.message}`);
    }
  }

  async function removeStaff(payload) {
    const confirmed = await openProtectedAction({
      title: 'Remove staff member',
      message: 'Type DELETE and enter initials to remove this staff member.',
      requireDelete: true,
      requireInitials: true
    });
    if (!confirmed.ok) return;

    try {
      await api('/api/admin/remove-staff', {
        method: 'POST',
        body: JSON.stringify({ ...payload, initials: confirmed.initials })
      });
      alert('Staff member removed successfully.');
      loadStaff();
    } catch (e) {
      alert(`Failed to remove staff: ${e.message}`);
    }
  }

  // Store swimmer data globally for attendance modal
  let swimmersData = [];

  // Load detailed swimmer information for Virtual Desk
  async function loadSwimmerDetails() {
    try {
      const date = activeDateISO || new Date().toISOString().split('T')[0];
      const location_id = currentLocation?.id || 1;

      const resp = await api(`/api/virtual-desk/swimmers?date=${date}&location_id=${location_id}`);

      if (!resp.ok || !resp.swimmers) {
        el('swimmerDetailsTable').innerHTML = '<p style="color:var(--muted); text-align:center; padding:20px;">No swimmers found for today.</p>';
        return;
      }

      // Store data globally
      swimmersData = resp.swimmers;

      // Apply sorting
      let swimmers = swimmersData;
      const sortBy = el('swimmerSortBy').value;

      if (sortBy === 'name') {
        swimmers.sort((a, b) => a.swimmer_name.localeCompare(b.swimmer_name));
      } else if (sortBy === 'time') {
        swimmers.sort((a, b) => a.start_time.localeCompare(b.start_time));
      } else if (sortBy === 'instructor') {
        swimmers.sort((a, b) => (a.instructor_name || '').localeCompare(b.instructor_name || ''));
      } else if (sortBy === 'attendance_rate') {
        swimmers.sort((a, b) => (b.stats?.attendance_rate || 0) - (a.stats?.attendance_rate || 0));
      } else if (sortBy === 'missed') {
        swimmers.sort((a, b) => (b.stats?.missed || 0) - (a.stats?.missed || 0));
      } else if (sortBy === 'balance') {
        const statusOrder = { 'owes': 3, 'policy': 2, 'current': 1 };
        swimmers.sort((a, b) => (statusOrder[b.balance_status] || 0) - (statusOrder[a.balance_status] || 0));
      }

      // Build table
      let html = '<table><thead><tr>';
      html += '<th>Swimmer</th>';
      html += '<th>Time</th>';
      html += '<th>Program</th>';
      html += '<th>Instructor</th>';
      html += '<th>Total Classes</th>';
      html += '<th>Attended</th>';
      html += '<th>Missed</th>';
      html += '<th>Attendance %</th>';
      html += '<th>Balance</th>';
      html += '<th>Flags</th>';
      html += '</tr></thead><tbody>';

      swimmers.forEach(s => {
        html += '<tr>';

        // Swimmer name
        html += `<td><strong>${s.swimmer_name}</strong>`;
        if (s.age_text) html += `<br><span class="tiny" style="color:var(--muted);">${s.age_text}</span>`;
        html += '</td>';

        // Time
        html += `<td>${fmtTime(s.start_time)}</td>`;

        // Program
        html += `<td><span class="tiny">${s.program || '‚Äî'}</span></td>`;

        // Instructor
        html += '<td>';
        if (s.substitute_instructor) {
          html += `<span style="font-weight:700;">${s.substitute_instructor}</span>`;
          html += `<span class="badge" style="background:rgba(251,191,36,0.15); color:#fbbf24; border-color:rgba(251,191,36,0.3); margin-left:4px; font-size:10px;">SUB</span>`;
          if (s.instructor_name) html += `<br><span class="tiny" style="color:var(--muted); text-decoration:line-through;">${s.instructor_name}</span>`;
        } else {
          html += s.instructor_name || '‚Äî';
        }
        html += '</td>';

        // Stats
        html += `<td style="text-align:center;">${s.stats?.total_classes || 0}</td>`;
        html += `<td style="text-align:center; color:var(--good);">${s.stats?.attended || 0}</td>`;
        html += `<td style="text-align:center; color:var(--bad);">${s.stats?.missed || 0}</td>`;

        // Attendance rate with color (clickable)
        const rate = s.stats?.attendance_rate || 0;
        let rateColor = 'var(--good)';
        if (rate < 70) rateColor = 'var(--bad)';
        else if (rate < 85) rateColor = 'var(--warn)';
        const swimmerIndex = swimmers.indexOf(s);
        html += `<td style="text-align:center;">`;
        html += `<span onclick="showAttendanceHistory(${swimmerIndex})" style="color:${rateColor}; font-weight:700; cursor:pointer; text-decoration:underline; padding:4px 8px; border-radius:4px; background:rgba(255,255,255,0.05);">${rate}%</span>`;
        html += `</td>`;

        // Balance - show actual dollar amount or status
        html += '<td style="text-align:center;">';
        if (s.balance_amount !== null && s.balance_amount !== undefined) {
          const balStr = s.balance_amount < 0 ? `-$${Math.abs(s.balance_amount).toFixed(2)}` : `$${s.balance_amount.toFixed(2)}`;
          const balColor = s.balance_amount > 0 ? 'var(--bad)' : s.balance_amount < 0 ? 'var(--good)' : 'var(--muted)';
          html += `<span style="color:${balColor}; font-weight:700;">${balStr}</span>`;
        } else if (s.balance_status === 'owes') {
          html += '<span class="badge" style="background:rgba(239,68,68,0.15); color:#ef4444; border-color:rgba(239,68,68,0.3);">Owes</span>';
        } else if (s.balance_status === 'policy') {
          html += '<span class="badge" style="background:rgba(245,158,11,0.15); color:#f59e0b; border-color:rgba(245,158,11,0.3);">Policy</span>';
        } else {
          html += '<span class="tiny" style="color:var(--muted);">‚Äî</span>';
        }
        html += '</td>';

        // Flags
        html += '<td>';
        const flags = [];
        if (s.flags?.new) flags.push('<span class="badge" style="background:rgba(34,197,94,0.15); color:#22c55e;">New</span>');
        if (s.flags?.makeup) flags.push('<span class="badge" style="background:rgba(59,130,246,0.15); color:#3b82f6;">Makeup</span>');
        if (s.flags?.trial) flags.push('<span class="badge" style="background:rgba(234,179,8,0.15); color:#eab308;">Trial</span>');
        if (s.is_addon) flags.push('<span class="badge addon">Add-on</span>');
        html += flags.join(' ') || '‚Äî';
        html += '</td>';

        html += '</tr>';
      });

      html += '</tbody></table>';

      el('swimmerDetailsTable').innerHTML = html;

    } catch (e) {
      console.error('Failed to load swimmer details:', e);
      el('swimmerDetailsTable').innerHTML = `<p style="color:var(--bad); text-align:center; padding:20px;">Error: ${e.message}</p>`;
    }
  }

  // Event handlers for swimmer details view
  el('swimmerSortBy')?.addEventListener('change', loadSwimmerDetails);
  el('refreshSwimmers')?.addEventListener('click', loadSwimmerDetails);

  // Show attendance history modal
  window.showAttendanceHistory = function(swimmerIndex) {
    const swimmer = swimmersData[swimmerIndex];
    if (!swimmer || !swimmer.attendance_history) return;

    el('attendanceHistoryTitle').textContent = `Attendance History: ${swimmer.swimmer_name}`;

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>Date</th>';
    html += '<th>Time</th>';
    html += '<th>Status</th>';
    html += '<th>Program</th>';
    html += '<th>Instructor</th>';
    html += '</tr></thead><tbody>';

    swimmer.attendance_history.forEach(record => {
      const statusText = record.attendance === 1 ? 'Attended' : record.attendance === 0 ? 'Missed' : '‚Äî';
      const statusColor = record.attendance === 1 ? 'var(--good)' : record.attendance === 0 ? 'var(--bad)' : 'var(--muted)';

      html += '<tr>';
      html += `<td>${record.date}</td>`;
      html += `<td>${fmtTime(record.start_time)}</td>`;
      html += `<td style="color:${statusColor}; font-weight:700;">${statusText}</td>`;
      html += `<td><span class="tiny">${record.program || '‚Äî'}</span></td>`;
      html += `<td>${record.instructor_name || '‚Äî'}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';

    // Add summary
    const attended = swimmer.stats?.attended || 0;
    const missed = swimmer.stats?.missed || 0;
    const rate = swimmer.stats?.attendance_rate || 0;

    html += '<div style="margin-top:16px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">';
    html += '<div style="display:flex; gap:20px; justify-content:center;">';
    html += `<div><span class="tiny" style="color:var(--muted);">Total:</span> <strong>${swimmer.stats?.total_classes || 0}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Attended:</span> <strong style="color:var(--good);">${attended}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Missed:</span> <strong style="color:var(--bad);">${missed}</strong></div>`;
    html += `<div><span class="tiny" style="color:var(--muted);">Rate:</span> <strong style="color:var(--good);">${rate}%</strong></div>`;
    html += '</div></div>';

    el('attendanceHistoryContent').innerHTML = html;
    showModal('attendanceHistoryModal', true);
  };

  el('attendanceHistoryClose').addEventListener('click', () => showModal('attendanceHistoryModal', false));
  el('attendanceHistoryModal').addEventListener('click', (e) => {
    if (e.target === el('attendanceHistoryModal')) showModal('attendanceHistoryModal', false);
  });

  function formatBytes(bytes) {
    if (!bytes && bytes !== 0) return '‚Äî';
    const units = ['B', 'KB', 'MB', 'GB'];
    let size = bytes;
    let idx = 0;
    while (size >= 1024 && idx < units.length - 1) {
      size /= 1024;
      idx += 1;
    }
    return `${size.toFixed(size >= 10 || idx === 0 ? 0 : 1)} ${units[idx]}`;
  }

  function formatShortDate(dateStr) {
    if (!dateStr) return '‚Äî';
    const parts = String(dateStr).split('T')[0].split('-');
    if (parts.length !== 3) return dateStr;
    return `${parts[1]}/${parts[2]}/${parts[0]}`;
  }

  async function uploadManagerReport(reportType, file) {
    if (!currentLocation) {
      alert('Select a location before uploading a report.');
      return;
    }
    if (blockIfReadOnly('Report uploads')) return;
    const button = document.querySelector(`.reportUploadBtn[data-report-type="${reportType}"]`);
    const originalLabel = button ? button.textContent : null;
    try {
      if (button) {
        button.disabled = true;
        button.textContent = 'Uploading...';
      }
      const previewForm = new FormData();
      previewForm.append('report', file);
      previewForm.append('report_type', reportType);
      const previewResp = await fetch(apiUrl('/api/manager-reports/preview'), {
        method: 'POST',
        body: previewForm
      });
      const previewData = await previewResp.json().catch(() => ({}));
      if (!previewResp.ok || previewData.ok === false) {
        throw new Error(previewData.error || 'Preview failed');
      }
      const summary = previewData.summary || {};
      const detectedLocation = summary.location_name || '';
      const warningText = (summary.warnings || []).join(' ‚Ä¢ ') || 'No warnings detected.';
      const messageLines = [
        `Report type: ${reportType.replace('_',' ')}`,
        `Detected location: ${detectedLocation || 'Not detected'}`,
        `Report date: ${summary.report_date || 'Unknown'}`,
        `Rows detected: ${summary.row_count ?? '‚Äî'}`,
        `Warnings: ${warningText}`
      ];

      const matchedLocation = detectedLocation
        ? allLocations.find(loc => loc.name.toLowerCase() === detectedLocation.toLowerCase())
        : null;
      const forceLocationPick = reportType === 'drop_list' || !matchedLocation;
      let locationOptions = null;
      if (forceLocationPick) {
        locationOptions = [
          { value: '', label: 'Select location‚Ä¶' },
          ...(allLocations || []).map(loc => ({ value: String(loc.id), label: loc.name }))
        ];
      }

      const confirmResult = await openProtectedAction({
        title: 'Confirm report upload',
        message: messageLines.join('\n'),
        requireDelete: false,
        requireInitials: true,
        requirePin: true,
        locationOptions,
        locationSelected: matchedLocation?.id || null
      });
      if (!confirmResult.ok) return;

      const selectedLocationId = forceLocationPick
        ? confirmResult.location_value
        : matchedLocation.id;

      const formData = new FormData();
      formData.append('report', file);
      formData.append('report_type', reportType);
      formData.append('location_id', selectedLocationId);
      formData.append('initials', confirmResult.initials);
      formData.append('pin', confirmResult.pin);
      const response = await fetch(apiUrl('/api/manager-reports/upload'), {
        method: 'POST',
        body: formData
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok || data.ok === false) {
        throw new Error(data.error || 'Report upload failed');
      }
      await loadManagerReports();
      alert('Report uploaded successfully.');
    } catch (e) {
      alert(`Upload failed: ${e.message}`);
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = originalLabel || 'Upload';
      }
    }
  }

  async function loadServerExports() {
    const locId = currentLocation?.id || 1;
    const resp = await api(`/api/server-exports?location_id=${locId}`);
    const list = resp.exports || [];
    el('serverExportLocation').textContent = currentLocation?.name || 'Unknown';

    if (!list.length) {
      el('serverExportList').innerHTML = '<div class="tiny" style="color:var(--muted); padding:8px;">No server backups found.</div>';
      return;
    }

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>File</th><th>Modified</th><th>Size</th><th>Action</th>';
    html += '</tr></thead><tbody>';
    list.forEach((item) => {
      html += '<tr>';
      html += `<td><span class="tiny">${escapeHtml(item.filename)}</span></td>`;
      html += `<td>${formatShortDate(item.modified_at)}</td>`;
      html += `<td>${formatBytes(item.size)}</td>`;
      html += `<td><button class="secondary" data-file="${escapeHtml(item.filename)}">Import</button></td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';
    el('serverExportList').innerHTML = html;

    el('serverExportList').querySelectorAll('button[data-file]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const filename = btn.getAttribute('data-file');
        if (!filename) return;
        const confirmed = await openProtectedAction({
          title: 'Import server backup',
          message: `Type DELETE and enter initials to import ${filename}.`,
          requireDelete: true,
          requireInitials: true
        });
        if (!confirmed.ok) return;
        try {
          btn.disabled = true;
          await api('/api/import-server', {
            method: 'POST',
            body: JSON.stringify({
              location_id: currentLocation?.id || 1,
              filename,
              initials: confirmed.initials
            })
          });
          showModal('serverImportModal', false);
          await loadStatus();
          await loadBlocks();
          await loadRoster();
          toast('Server import complete');
        } catch (err) {
          alert('Import failed: ' + (err.message || err));
        } finally {
          btn.disabled = false;
        }
      });
    });
  }

  async function loadTrialReport() {
    const locId = currentLocation?.id || 1;
    const days = 30;
    el('trialDaysLabel').textContent = String(days);
    const resp = await api(`/api/trials?location_id=${locId}&days=${days}`);
    const trials = resp.trials || [];

    if (!trials.length) {
      el('trialSummary').textContent = 'No trial swimmers found for this period.';
      el('trialReportTable').innerHTML = '';
      return;
    }

    const statusCounts = trials.reduce((acc, t) => {
      const status = t.follow_up?.status || 'new';
      acc[status] = (acc[status] || 0) + 1;
      return acc;
    }, {});
    const summary = Object.entries(statusCounts)
      .map(([status, count]) => `${status}: ${count}`)
      .join(' ‚Ä¢ ');
    el('trialSummary').textContent = `Total trials: ${trials.length} ‚Ä¢ ${summary}`;

    let html = '<table style="width:100%;"><thead><tr>';
    html += '<th>Swimmer</th><th>Last Seen</th><th>Program</th><th>Instructor</th><th>Visits</th><th>Status</th><th>Last Contact</th><th>Next Follow-up</th><th>Notes</th><th>Save</th>';
    html += '</tr></thead><tbody>';

    trials.forEach((t) => {
      const follow = t.follow_up || {};
      const status = follow.status || 'new';
      html += '<tr>';
      html += `<td><strong>${escapeHtml(t.swimmer_name)}</strong></td>`;
      html += `<td>${formatShortDate(t.last_date)}</td>`;
      html += `<td><span class="tiny">${escapeHtml(t.program || '‚Äî')}</span></td>`;
      html += `<td>${escapeHtml(t.instructor_name || '‚Äî')}</td>`;
      html += `<td style="text-align:center;">${t.trial_visits || 0}</td>`;
      html += '<td>';
      html += `<select data-field="status" data-swimmer="${escapeHtml(t.swimmer_name)}">`;
      ['new','contacted','scheduled','converted','lost'].forEach((opt) => {
        html += `<option value="${opt}" ${opt === status ? 'selected' : ''}>${opt}</option>`;
      });
      html += '</select>';
      html += '</td>';
      html += `<td><input type="date" data-field="last_contact" data-swimmer="${escapeHtml(t.swimmer_name)}" value="${escapeHtml(follow.last_contact_at || '')}" /></td>`;
      html += `<td><input type="date" data-field="next_follow" data-swimmer="${escapeHtml(t.swimmer_name)}" value="${escapeHtml(follow.next_follow_up_at || '')}" /></td>`;
      html += `<td><input type="text" data-field="notes" data-swimmer="${escapeHtml(t.swimmer_name)}" value="${escapeHtml(follow.notes || '')}" placeholder="Notes" /></td>`;
      html += `<td><button class="secondary" data-action="save" data-swimmer="${escapeHtml(t.swimmer_name)}">Save</button></td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    el('trialReportTable').innerHTML = html;

    el('trialReportTable').querySelectorAll('button[data-action="save"]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const swimmer = btn.getAttribute('data-swimmer');
        if (!swimmer) return;
        const safeSwimmer = escapeSelector(swimmer);
        const status = el('trialReportTable').querySelector(`select[data-field="status"][data-swimmer="${safeSwimmer}"]`)?.value;
        const lastContact = el('trialReportTable').querySelector(`input[data-field="last_contact"][data-swimmer="${safeSwimmer}"]`)?.value || '';
        const nextFollow = el('trialReportTable').querySelector(`input[data-field="next_follow"][data-swimmer="${safeSwimmer}"]`)?.value || '';
        const notes = el('trialReportTable').querySelector(`input[data-field="notes"][data-swimmer="${safeSwimmer}"]`)?.value || '';
        try {
          btn.disabled = true;
          await api('/api/trials/followup', {
            method: 'POST',
            body: JSON.stringify({
              swimmer_name: swimmer,
              location_id: currentLocation?.id || 1,
              status,
              last_contact_at: lastContact || null,
              next_follow_up_at: nextFollow || null,
              notes
            })
          });
          toast('Follow-up saved');
        } catch (err) {
          alert('Save failed: ' + (err.message || err));
        } finally {
          btn.disabled = false;
        }
      });
    });
  }

  el('trialCloseBtn').addEventListener('click', () => showModal('trialFollowupModal', false));
  el('trialFollowupModal').addEventListener('click', (e) => {
    if (e.target === el('trialFollowupModal')) showModal('trialFollowupModal', false);
  });
  el('trialRefreshBtn').addEventListener('click', loadTrialReport);

  el('serverImportClose').addEventListener('click', () => showModal('serverImportModal', false));
  el('serverImportModal').addEventListener('click', (e) => {
    if (e.target === el('serverImportModal')) showModal('serverImportModal', false);
  });
  el('serverExportRefresh').addEventListener('click', loadServerExports);

  // Add Location Modal
  el('addLocationBtn').addEventListener('click', () => {
    el('newLocationName').value = '';
    el('newLocationShortCode').value = '';
    el('newLocationBrand').value = 'swimlabs';
    showModal('addLocationModal', true);
  });

  el('addLocationCancel').addEventListener('click', () => showModal('addLocationModal', false));
  el('addLocationModal').addEventListener('click', (e) => {
    if (e.target === el('addLocationModal')) showModal('addLocationModal', false);
  });

  el('addLocationSave').addEventListener('click', async () => {
    const name = el('newLocationName').value.trim();
    const short_code = el('newLocationShortCode').value.trim();
    const brand = el('newLocationBrand').value;

    if (!name) {
      alert('Location name is required');
      return;
    }

    try {
      await api('/api/admin/add-location', {
        method: 'POST',
        body: JSON.stringify({ name, short_code, brand })
      });
      alert(`Location "${name}" added successfully.`);
      showModal('addLocationModal', false);
      loadAdminLocations();
      // Reload location dropdown
      await loadLocations();
    } catch (e) {
      alert(`Failed to add location: ${e.message}`);
    }
  });

  // Add Staff Modal
  el('addStaffBtn').addEventListener('click', () => {
    el('newStaffFirstName').value = '';
    el('newStaffLastName').value = '';
    el('newStaffScope').value = 'state';
    el('newStaffState').value = 'New York';
    el('newStaffLocationOverride').value = '';
    el('newStaffPhone').value = '';
    el('newStaffBirthday').value = '';
    syncStaffScopeUI();
    showModal('addStaffModal', true);
  });

  function syncStaffScopeUI() {
    const scope = el('newStaffScope').value;
    const stateField = el('newStaffState').closest('.field');
    const locationField = el('newStaffLocationOverride').closest('.field');
    if (stateField) stateField.style.display = scope === 'state' ? 'block' : 'none';
    if (locationField) locationField.style.display = scope === 'override' ? 'block' : 'none';
  }

  el('newStaffScope').addEventListener('change', syncStaffScopeUI);

  el('addStaffCancel').addEventListener('click', () => showModal('addStaffModal', false));
  el('addStaffModal').addEventListener('click', (e) => {
    if (e.target === el('addStaffModal')) showModal('addStaffModal', false);
  });

  el('addStaffSave').addEventListener('click', async () => {
    const firstName = el('newStaffFirstName').value.trim();
    const lastName = el('newStaffLastName').value.trim();
    const scope = el('newStaffScope').value;
    const state = el('newStaffState').value;
    const location_key = el('newStaffLocationOverride').value;
    const phone = el('newStaffPhone').value.trim();
    const birthday = el('newStaffBirthday').value.trim();

    if (!firstName || !lastName) {
      alert('First name and last name are required');
      return;
    }
    if (scope === 'override' && !location_key) {
      alert('Location override selection is required');
      return;
    }

    try {
      await api('/api/admin/add-staff', {
        method: 'POST',
        body: JSON.stringify({ firstName, lastName, scope, state, location_key, phone, birthday })
      });
      alert(`Staff member "${firstName} ${lastName}" added successfully.`);
      showModal('addStaffModal', false);
      loadStaff();
    } catch (e) {
      alert(`Failed to add staff: ${e.message}`);
    }
  });

  // PIN modal handlers
  el('pinCancel').addEventListener('click', () => {
    showModal('pinModal', false);
  });

  el('pinSubmit').addEventListener('click', async () => {
    const pin = el('pinInput').value.trim();

    if (!pin || pin.length !== 4) {
      el('pinError').textContent = 'Please enter a 4-digit PIN';
      el('pinError').style.display = 'block';
      return;
    }

    try {
      const pinType = pendingPinPanel === 'admin' ? 'admin' : 'manager';
      const resp = await api('/api/verify-pin', {
        method: 'POST',
        body: JSON.stringify({ pin, pin_type: pinType })
      });

      if (resp.ok && resp.authenticated) {
        // Success!
        if (pinType === 'admin') {
          sessionStorage.setItem('admin_pin_auth', 'true');
          sessionStorage.setItem('admin_pin_expiry', resp.expires_at.toString());
          managerRole = 'admin';
          sessionStorage.setItem('manager_role', 'admin');
        } else {
          sessionStorage.setItem('manager_pin_auth', 'true');
          sessionStorage.setItem('manager_pin_expiry', resp.expires_at.toString());
          sessionStorage.setItem('manager_role', resp.role || 'manager');
          managerRole = resp.role || 'manager';
        }

        showModal('pinModal', false);

        // Show the panel that requested auth
        if (pendingPinPanel === 'admin') {
          showAdminPanel();
        } else {
          showVirtualDeskPanel();
        }
        pendingPinPanel = null;
      }
    } catch (e) {
      if (e.message.includes('Too many failed attempts')) {
        el('pinError').style.display = 'none';
        el('pinLockout').style.display = 'block';
      } else {
        el('pinLockout').style.display = 'none';
        el('pinError').textContent = e.message || 'Incorrect PIN. Try again.';
        el('pinError').style.display = 'block';
      }
      el('pinInput').value = '';
      el('pinInput').focus();
    }
  });

  // Allow Enter key to submit PIN
  el('pinInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      el('pinSubmit').click();
    }
  });

  // Manager navigation + tabs
  ['managerNavClient', 'managerNavBilling', 'managerNavInstructors', 'managerNavGuards', 'managerNavSystem'].forEach((id) => {
    const btn = el(id);
    if (btn) {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('disabled')) return;
        const section = btn.dataset.managerSection;
        if (!section) return;
        setManagerSection(section);
      });
    }
  });

  const clientTabAttendance = el('clientTabAttendance');
  if (clientTabAttendance) {
    clientTabAttendance.addEventListener('click', () => {
      clientTabAttendance.classList.add('active');
      el('clientTabAbsence')?.classList.remove('active');
      el('clientTabHistory')?.classList.remove('active');
      el('clientAttendanceReport')?.classList.remove('hidden');
      el('clientAbsenceTracker')?.classList.add('hidden');
      el('clientAttendanceHistory')?.classList.add('hidden');
    });
  }
  const clientTabAbsence = el('clientTabAbsence');
  if (clientTabAbsence) {
    clientTabAbsence.addEventListener('click', () => {
      clientTabAbsence.classList.add('active');
      el('clientTabAttendance')?.classList.remove('active');
      el('clientTabHistory')?.classList.remove('active');
      el('clientAttendanceReport')?.classList.add('hidden');
      el('clientAbsenceTracker')?.classList.remove('hidden');
      el('clientAttendanceHistory')?.classList.add('hidden');
      loadAbsenceTracker();
    });
  }
  const clientTabHistory = el('clientTabHistory');
  if (clientTabHistory) {
    clientTabHistory.addEventListener('click', () => {
      clientTabHistory.classList.add('active');
      el('clientTabAttendance')?.classList.remove('active');
      el('clientTabAbsence')?.classList.remove('active');
      el('clientAttendanceReport')?.classList.add('hidden');
      el('clientAbsenceTracker')?.classList.add('hidden');
      el('clientAttendanceHistory')?.classList.remove('hidden');
      loadAttendanceHistory();
    });
  }

  el('trainerTabRetention')?.addEventListener('click', () => setTrainerTab('retention'));
  el('trainerTabDropImpact')?.addEventListener('click', () => setTrainerTab('drop'));
  el('trainerTabAttendanceImpact')?.addEventListener('click', () => setTrainerTab('attendance'));
  el('instructorTrendsToggle')?.addEventListener('click', () => {
    managerSectionFilters.instructors.showTrends = !managerSectionFilters.instructors.showTrends;
    el('instructorTrendsToggle').textContent = managerSectionFilters.instructors.showTrends ? 'Hide trends' : 'Show trends';
    renderRetentionPanel();
  });

  el('openGuardTasksBtn')?.addEventListener('click', () => showGuardTasksPanel('virtualDesk'));

  el('clientFiltersToggle')?.addEventListener('click', () => {
    el('clientFiltersAdvanced')?.classList.toggle('hidden');
  });
  el('clientTrendsToggle')?.addEventListener('click', () => {
    managerSectionFilters.client.showTrends = !managerSectionFilters.client.showTrends;
    el('clientTrendsToggle').textContent = managerSectionFilters.client.showTrends ? 'Hide trends' : 'Show trends';
    loadAttendanceSummary();
  });
  el('clientRangeStart')?.addEventListener('change', () => {
    managerSectionFilters.client.start = el('clientRangeStart').value;
    loadAttendanceSummary();
    loadAbsenceTracker();
    loadAttendanceHistory();
  });
  el('clientRangeEnd')?.addEventListener('change', () => {
    managerSectionFilters.client.end = el('clientRangeEnd').value;
    loadAttendanceSummary();
    loadAbsenceTracker();
    loadAttendanceHistory();
  });
  el('clientInstructorFilter')?.addEventListener('change', () => {
    managerSectionFilters.client.instructor = el('clientInstructorFilter').value;
    loadAbsenceTracker();
  });
  el('clientStatusFilter')?.addEventListener('change', () => {
    managerSectionFilters.client.status = el('clientStatusFilter').value;
    loadAbsenceTracker();
  });

  el('clientDropApply')?.addEventListener('click', () => {
    managerSectionFilters.client.dropRange = el('clientDropRange').value;
    managerSectionFilters.client.dropStart = el('clientDropStart').value;
    managerSectionFilters.client.dropEnd = el('clientDropEnd').value;
    loadClientDropList();
  });
  el('clientDropRange')?.addEventListener('change', () => {
    const isCustom = el('clientDropRange').value === 'custom';
    el('clientDropStart').classList.toggle('hidden', !isCustom);
    el('clientDropEnd').classList.toggle('hidden', !isCustom);
  });

  el('bundleSaveBtn')?.addEventListener('click', async () => {
    const payload = {
      location_id: Number(el('bundleLocation')?.value || currentLocation?.id || 1),
      customer_name: el('bundleCustomer')?.value.trim(),
      phone: el('bundlePhone')?.value.trim(),
      notes: el('bundleNotes')?.value.trim(),
      start_date: el('bundleStartDate')?.value,
      duration_weeks: Number(el('bundleDuration')?.value || 12),
      monthly_price: Number(el('bundleMonthlyPrice')?.value || 0)
    };
    const preview = calculateBundlePreview({
      durationWeeks: payload.duration_weeks,
      monthlyPrice: payload.monthly_price,
      startDate: payload.start_date
    });
    if (!payload.customer_name) {
      alert('Customer name is required.');
      return;
    }
    if (!preview) {
      alert('Please enter a valid monthly price and duration (12/24/52 weeks).');
      return;
    }
    const confirmed = await openProtectedAction({
      title: bundleEditingId ? 'Update bundle' : 'Save bundle',
      message: `Discounted monthly: $${preview.discountedMonthly.toFixed(2)}\nTotal billed: $${preview.totalBilled.toFixed(2)}\nHouse credit: $${preview.houseCredit.toFixed(2)}\nExpires: ${formatDateUS(preview.expirationDate)}`,
      requireInitials: true,
      requirePin: true
    });
    if (!confirmed.ok) return;
    if (bundleEditingId) {
      await api(`/api/bundles/${bundleEditingId}`, {
        method: 'PUT',
        body: JSON.stringify({ ...payload, pin: confirmed.pin })
      });
    } else {
      await api('/api/bundles', {
        method: 'POST',
        body: JSON.stringify({ ...payload, pin: confirmed.pin })
      });
    }
    resetBundleForm();
    loadBundles();
  });

  el('bundleResetBtn')?.addEventListener('click', () => resetBundleForm());

  el('bundleExportBtn')?.addEventListener('click', async () => {
    openExportModal({
      title: 'Export bundles',
      onExport: (scope) => exportBundles(scope)
    });
  });
  el('bundleLocation')?.addEventListener('change', () => {
    loadBundles();
  });

  el('deleteLatestDropListBtn')?.addEventListener('click', () => deleteLatestReport('drop_list'));

  el('sidebarToggleBtn')?.addEventListener('click', () => toggleManagerSidebar(false));
  window.addEventListener('scroll', handleManagerScroll);

  el('openShortcutsBtn')?.addEventListener('click', () => showModal('shortcutsModal', true));
  el('shortcutsClose')?.addEventListener('click', () => showModal('shortcutsModal', false));

  el('globalSearchBtn')?.addEventListener('click', () => openGlobalSearch());
  el('globalSearchClose')?.addEventListener('click', () => showModal('globalSearchModal', false));
  el('globalSearchInput')?.addEventListener('input', (e) => runGlobalSearch(e.target.value));
  el('globalSearchModal')?.addEventListener('click', (e) => {
    if (e.target === el('globalSearchModal')) showModal('globalSearchModal', false);
  });

  el('previewClose')?.addEventListener('click', closePreviewDrawer);
  el('previewBackdrop')?.addEventListener('click', closePreviewDrawer);
  el('previewJumpBtn')?.addEventListener('click', () => {
    if (previewTarget && typeof previewTarget.jump === 'function') {
      previewTarget.jump();
    }
    closePreviewDrawer();
  });

  el('exportModalCancel')?.addEventListener('click', () => showModal('exportModal', false));
  el('exportModalConfirm')?.addEventListener('click', () => {
    const scope = el('exportScopeSelect').value;
    if (!scope) {
      alert('Please choose an export scope.');
      return;
    }
    if (exportContext?.onExport) {
      exportContext.onExport(scope);
    }
    showModal('exportModal', false);
  });

  el('guardTasksBack').addEventListener('click', () => {
    if (lastPanel === 'virtualDesk') {
      showVirtualDeskPanel();
    } else if (lastPanel === 'lifeguard') {
      el('viewSelect').value = 'roster';
      el('panelRoster').classList.remove('hidden');
      el('panelGuardTasks').classList.add('hidden');
    } else {
      el('viewSelect').value = 'roster';
      el('panelRoster').classList.remove('hidden');
      el('panelGuardTasks').classList.add('hidden');
    }
  });

  el('guardTasksDate').addEventListener('change', async () => {
    guardState = await loadGuardState(el('guardTasksDate').value);
    renderGuardTasks();
  });

  ['guardName1', 'guardName2', 'guardName3'].forEach((id, idx) => {
    el(id).addEventListener('input', () => {
      if (!guardState) return;
      if (readOnlyMode) return;
      guardState.guardNames = guardState.guardNames || { 1: '', 2: '', 3: '' };
      guardState.guardNames[idx + 1] = el(id).value.trim();
      saveGuardState();
      renderGuardTasks();
      maybeAutoShuffleGuards();
    });
  });

  el('guardTasksShuffle').addEventListener('click', () => {
    if (!guardState) return;
    if (readOnlyMode) return;
    const names = getGuardInputNames().filter(Boolean);
    const minCount = guardState.dayType === 'weekend' ? 3 : 2;
    if (names.length < minCount) {
      alert(`Enter at least ${minCount} guard names to randomize.`);
      return;
    }
    applyGuardNames(shuffleNames(names), true);
  });

  el('guardRotationAdd').addEventListener('click', () => {
    if (readOnlyMode) return;
    guardState.rotation.push({ time: '', guard: '', zone: '' });
    saveGuardState();
    renderGuardRotation();
  });

  el('guardTasksSnapshot').addEventListener('click', async () => {
    if (!guardState) return;
    if (readOnlyMode) return;
    const confirmed = await openProtectedAction({
      title: 'Save guard task snapshot',
      message: 'Enter initials to save a manual snapshot for this day.',
      requireDelete: false,
      requireInitials: true
    });
    if (!confirmed.ok) return;
    await api('/api/guard-tasks', {
      method: 'POST',
      body: JSON.stringify({
        location_id: currentLocation?.id || 1,
        date: guardState.date,
        data: guardState,
        initials: confirmed.initials
      })
    });
  });

  el('guardNotes').addEventListener('input', () => {
    if (!guardState) return;
    if (readOnlyMode) return;
    guardState.notes = el('guardNotes').value;
    saveGuardState();
  });

  el('guardTasksReset').addEventListener('click', async () => {
    const date = el('guardTasksDate').value;
    if (!date) return;
    const confirmed = await openProtectedAction({
      title: 'Clear all guard tasks',
      message: 'Type DELETE and enter initials to clear all tasks for this day.',
      requireDelete: true,
      requireInitials: true
    });
    if (!confirmed.ok) return;
    await api('/api/guard-tasks/clear', {
      method: 'POST',
      body: JSON.stringify({ location_id: currentLocation?.id || 1, date, initials: confirmed.initials })
    });
    guardState = await loadGuardState(date);
    renderGuardTasks();
  });

  document.querySelectorAll('.guardAddTask').forEach((btn) => {
    btn.addEventListener('click', () => {
      const section = btn.dataset.section;
      addCustomGuardTask(section);
    });
  });

  // Virtual Desk Export
  el('exportVirtualDeskBtn')?.addEventListener('click', async () => {
    if (!currentLocation || !activeDateISO) {
      alert('Please select a location and date first.');
      return;
    }
    if (blockIfReadOnly('Export')) return;
    const format = prompt('Export format: Enter "csv" or "json" (default: csv)', 'csv');
    if (format === null) return;
    const fmt = format.toLowerCase() === 'json' ? 'json' : 'csv';
    window.location.href = `/api/reports/virtual-desk/export?date=${activeDateISO}&location_id=${currentLocation.id}&format=${fmt}`;
  });

  // Open Attendance Report Modal
  el('openAttendanceReportBtn')?.addEventListener('click', openAttendanceReport);
  el('openInstructorReportBtn')?.addEventListener('click', openInstructorReport);

  function openAttendanceReport() {
    if (managerDateRange?.start && managerDateRange?.end) {
      el('attendanceReportStartDate').value = managerDateRange.start;
      el('attendanceReportEndDate').value = managerDateRange.end;
    } else {
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      el('attendanceReportEndDate').value = today.toISOString().split('T')[0];
      el('attendanceReportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    el('attendanceReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Select a date range and click "Generate Report" to view attendance analytics.</div>`;
    showModal('attendanceReportModal', true);
  }

  function openInstructorReport() {
    if (managerDateRange?.start && managerDateRange?.end) {
      el('instructorReportStartDate').value = managerDateRange.start;
      el('instructorReportEndDate').value = managerDateRange.end;
    } else {
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      el('instructorReportEndDate').value = today.toISOString().split('T')[0];
      el('instructorReportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    el('instructorReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Select a date range and click "Generate Report" to view instructor analytics.</div>`;
    showModal('instructorReportModal', true);
  }

  function toISODate(date) {
    return date.toISOString().split('T')[0];
  }

  function getWeekRange(date = new Date()) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    const start = new Date(d);
    start.setDate(d.getDate() + diff);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);
    return { start: toISODate(start), end: toISODate(end) };
  }

  function getMonthRange(date = new Date()) {
    const start = new Date(date.getFullYear(), date.getMonth(), 1);
    const end = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    return { start: toISODate(start), end: toISODate(end) };
  }

  function setManagerRangeInputsOnly(range) {
    if (el('managerRangeStart')) el('managerRangeStart').value = range.start;
    if (el('managerRangeEnd')) el('managerRangeEnd').value = range.end;
  }

  el('managerRangeWeek')?.addEventListener('click', () => setManagerRangeInputsOnly(getWeekRange()));
  el('managerRangeNextTwo')?.addEventListener('click', () => {
    const start = new Date();
    const end = new Date();
    end.setDate(start.getDate() + 13);
    setManagerRangeInputsOnly({ start: toISODate(start), end: toISODate(end) });
  });
  el('managerRangeMonth')?.addEventListener('click', () => setManagerRangeInputsOnly(getMonthRange()));
  el('managerRangeSave')?.addEventListener('click', async () => {
    const start = el('managerRangeStart')?.value;
    const end = el('managerRangeEnd')?.value;
    if (!start || !end) {
      alert('Please select both start and end dates.');
      return;
    }
    try {
      const resp = await api('/api/manager-date-range', {
        method: 'POST',
        body: JSON.stringify({ start, end })
      });
      applyManagerDateRange(resp.range);
      toast('Manager date brackets saved');
    } catch (err) {
      alert('Save failed: ' + (err.message || err));
    }
  });

  el('managerTabOverviewBtn')?.addEventListener('click', () => setManagerTab('overview'));
  el('managerTabReportsBtn')?.addEventListener('click', () => setManagerTab('reports'));

  // Attendance Report Handlers
  el('attendanceReportGenerate')?.addEventListener('click', async () => {
    const startDate = el('attendanceReportStartDate').value;
    const endDate = el('attendanceReportEndDate').value;
    if (!startDate || !endDate) {
      alert('Please select both start and end dates.');
      return;
    }
    if (!currentLocation) {
      alert('Please select a location first.');
      return;
    }

    el('attendanceReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Loading report...</div>`;

    try {
      const resp = await api(`/api/reports/attendance?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}`);
      if (!resp.ok) throw new Error(resp.error || 'Failed to generate report');

      const report = resp.report;
      const summary = report.summary;

      let html = `
        <div style="margin-bottom:20px;">
          <div class="row" style="gap:12px; flex-wrap:wrap;">
            <div class="card" style="flex:1; min-width:140px; background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.2);">
              <div class="tiny" style="color:var(--muted);">Attendance Rate</div>
              <div style="font-size:24px; font-weight:900; color:#22c55e;">${summary.overall_attendance_rate}%</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2);">
              <div class="tiny" style="color:var(--muted);">Total Swimmers</div>
              <div style="font-size:24px; font-weight:900; color:#3b82f6;">${summary.unique_swimmers}</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(234,179,8,0.08); border-color: rgba(234,179,8,0.2);">
              <div class="tiny" style="color:var(--muted);">Class Entries</div>
              <div style="font-size:24px; font-weight:900; color:#eab308;">${summary.total_entries}</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(168,85,247,0.08); border-color: rgba(168,85,247,0.2);">
              <div class="tiny" style="color:var(--muted);">Days Tracked</div>
              <div style="font-size:24px; font-weight:900; color:#a855f7;">${summary.days_with_classes}</div>
            </div>
          </div>
        </div>

        <div class="row" style="gap:12px; margin-bottom:16px; flex-wrap:wrap;">
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#22c55e;">${summary.total_present}</div>
            <div class="tiny" style="color:var(--muted);">Present</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#ef4444;">${summary.total_absent}</div>
            <div class="tiny" style="color:var(--muted);">Absent</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#f97316;">${summary.total_trials}</div>
            <div class="tiny" style="color:var(--muted);">Trials</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#06b6d4;">${summary.total_new_swimmers}</div>
            <div class="tiny" style="color:var(--muted);">New</div>
          </div>
          <div class="card" style="flex:1; min-width:80px; text-align:center;">
            <div style="font-size:20px; font-weight:700; color:#8b5cf6;">${summary.total_makeups}</div>
            <div class="tiny" style="color:var(--muted);">Makeups</div>
          </div>
        </div>

        <h4 style="margin:16px 0 8px; font-size:14px;">By Program</h4>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                <th style="padding:8px;">Program</th>
                <th style="padding:8px;">Total</th>
                <th style="padding:8px;">Present</th>
                <th style="padding:8px;">Absent</th>
                <th style="padding:8px;">Rate</th>
              </tr>
            </thead>
            <tbody>
              ${report.by_program.map(p => `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                  <td style="padding:8px;">${p.program || 'Unknown'}</td>
                  <td style="padding:8px;">${p.total}</td>
                  <td style="padding:8px; color:#22c55e;">${p.present}</td>
                  <td style="padding:8px; color:#ef4444;">${p.absent}</td>
                  <td style="padding:8px;"><span style="color:${p.attendance_rate >= 80 ? '#22c55e' : p.attendance_rate >= 60 ? '#eab308' : '#ef4444'}">${p.attendance_rate}%</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${report.low_attendance_swimmers.length > 0 ? `
          <h4 style="margin:16px 0 8px; font-size:14px; color:#ef4444;">Low Attendance Swimmers (&lt;70%)</h4>
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                  <th style="padding:8px;">Swimmer</th>
                  <th style="padding:8px;">Classes</th>
                  <th style="padding:8px;">Attended</th>
                  <th style="padding:8px;">Missed</th>
                  <th style="padding:8px;">Rate</th>
                </tr>
              </thead>
              <tbody>
                ${report.low_attendance_swimmers.map(s => `
                  <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                    <td style="padding:8px;">${s.swimmer_name}</td>
                    <td style="padding:8px;">${s.total_classes}</td>
                    <td style="padding:8px; color:#22c55e;">${s.attended}</td>
                    <td style="padding:8px; color:#ef4444;">${s.missed}</td>
                    <td style="padding:8px; color:#ef4444;">${s.attendance_rate}%</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      `;

      el('attendanceReportContent').innerHTML = html;
    } catch (e) {
      el('attendanceReportContent').innerHTML = `<div class="tiny" style="color:#ef4444; text-align:center; padding:40px;">Error: ${e.message}</div>`;
    }
  });

  el('attendanceReportExportCSV').addEventListener('click', () => {
    const startDate = el('attendanceReportStartDate').value;
    const endDate = el('attendanceReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/attendance/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=csv`;
  });

  el('attendanceReportExportJSON').addEventListener('click', () => {
    const startDate = el('attendanceReportStartDate').value;
    const endDate = el('attendanceReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/attendance/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=json`;
  });

  el('attendanceReportClose').addEventListener('click', () => showModal('attendanceReportModal', false));
  el('attendanceReportModal').addEventListener('click', (e) => { if(e.target === el('attendanceReportModal')) showModal('attendanceReportModal', false); });

  // Instructor Report Handlers
  el('instructorReportGenerate')?.addEventListener('click', async () => {
    const startDate = el('instructorReportStartDate').value;
    const endDate = el('instructorReportEndDate').value;
    if (!startDate || !endDate) {
      alert('Please select both start and end dates.');
      return;
    }
    if (!currentLocation) {
      alert('Please select a location first.');
      return;
    }

    el('instructorReportContent').innerHTML = `<div class="tiny" style="color:var(--muted); text-align:center; padding:40px;">Loading report...</div>`;

    try {
      const resp = await api(`/api/reports/instructors?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}`);
      if (!resp.ok) throw new Error(resp.error || 'Failed to generate report');

      const report = resp.report;
      const summary = report.summary;

      let html = `
        <div style="margin-bottom:20px;">
          <div class="row" style="gap:12px; flex-wrap:wrap;">
            <div class="card" style="flex:1; min-width:140px; background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2);">
              <div class="tiny" style="color:var(--muted);">Total Instructors</div>
              <div style="font-size:24px; font-weight:900; color:#3b82f6;">${summary.total_instructors}</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.2);">
              <div class="tiny" style="color:var(--muted);">Avg Attendance Rate</div>
              <div style="font-size:24px; font-weight:900; color:#22c55e;">${summary.average_attendance_rate}%</div>
            </div>
            <div class="card" style="flex:1; min-width:140px; background: rgba(234,179,8,0.08); border-color: rgba(234,179,8,0.2);">
              <div class="tiny" style="color:var(--muted);">Total Class Entries</div>
              <div style="font-size:24px; font-weight:900; color:#eab308;">${summary.total_class_entries}</div>
            </div>
          </div>
        </div>

        ${report.highlights.top_by_attendance.length > 0 ? `
          <h4 style="margin:16px 0 8px; font-size:14px;">Top Performers (by Class Attendance Rate)</h4>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:16px;">
            ${report.highlights.top_by_attendance.map((i, idx) => `
              <div class="card" style="flex:1; min-width:150px; text-align:center; background: ${idx === 0 ? 'rgba(234,179,8,0.15)' : 'rgba(255,255,255,0.05)'};">
                <div style="font-size:11px; color:var(--muted);">#${idx + 1}</div>
                <div style="font-weight:700; font-size:14px;">${i.name}</div>
                <div style="font-size:20px; font-weight:900; color:#22c55e;">${i.attendance_rate}%</div>
                <div class="tiny" style="color:var(--muted);">${i.total_entries} entries</div>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <h4 style="margin:16px 0 8px; font-size:14px;">All Instructors</h4>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:rgba(255,255,255,0.05); text-align:left;">
                <th style="padding:8px;">Instructor</th>
                <th style="padding:8px;">Days</th>
                <th style="padding:8px;">Entries</th>
                <th style="padding:8px;">Swimmers</th>
                <th style="padding:8px;">Present</th>
                <th style="padding:8px;">Absent</th>
                <th style="padding:8px;">Rate</th>
                <th style="padding:8px;">Programs</th>
              </tr>
            </thead>
            <tbody>
              ${report.instructors.map(i => `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
                  <td style="padding:8px; font-weight:600;">${i.instructor_name}</td>
                  <td style="padding:8px;">${i.days_worked}</td>
                  <td style="padding:8px;">${i.total_class_entries}</td>
                  <td style="padding:8px;">${i.unique_swimmers}</td>
                  <td style="padding:8px; color:#22c55e;">${i.swimmers_present}</td>
                  <td style="padding:8px; color:#ef4444;">${i.swimmers_absent}</td>
                  <td style="padding:8px;"><span style="color:${i.class_attendance_rate >= 80 ? '#22c55e' : i.class_attendance_rate >= 60 ? '#eab308' : '#ef4444'}">${i.class_attendance_rate}%</span></td>
                  <td style="padding:8px;">${i.programs_taught}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      el('instructorReportContent').innerHTML = html;
    } catch (e) {
      el('instructorReportContent').innerHTML = `<div class="tiny" style="color:#ef4444; text-align:center; padding:40px;">Error: ${e.message}</div>`;
    }
  });

  el('instructorReportExportCSV').addEventListener('click', () => {
    const startDate = el('instructorReportStartDate').value;
    const endDate = el('instructorReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/instructors/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=csv`;
  });

  el('instructorReportExportJSON').addEventListener('click', () => {
    const startDate = el('instructorReportStartDate').value;
    const endDate = el('instructorReportEndDate').value;
    if (!currentLocation || !startDate || !endDate) {
      alert('Please generate a report first.');
      return;
    }
    window.location.href = `/api/reports/instructors/export?location_id=${currentLocation.id}&start_date=${startDate}&end_date=${endDate}&format=json`;
  });

  el('instructorReportClose').addEventListener('click', () => showModal('instructorReportModal', false));
  el('instructorReportModal').addEventListener('click', (e) => { if(e.target === el('instructorReportModal')) showModal('instructorReportModal', false); });

  el('adminNavClearRoster')?.addEventListener('click', async () => {
    if (blockIfReadOnly('Clear roster')) return;
    const locationName = currentLocation?.name || 'Unknown';
    const confirmed = await openProtectedAction({
      title: 'Clear roster',
      message: `Type DELETE and enter initials to clear the roster for ${locationName}.`,
      requireDelete: true,
      requireInitials: true
    });
    if (!confirmed.ok) return;

    try {
      const resp = await api('/api/clear-roster', {
        method: 'POST',
        body: JSON.stringify({
          location_id: currentLocation?.id || 1,
          initials: confirmed.initials
        })
      });

      if (resp.ok) {
        alert(`‚úÖ Roster Cleared!\n\nDeleted ${resp.deleted_count} swimmers for ${locationName}.\n\nBackup saved to: ${resp.backup_file || 'N/A'}`);
        await loadBlocks();
        await loadRoster();
      }
    } catch (e) {
      alert(`‚ùå Clear Failed\n\n${e.message}`);
    }
  });

  async function runAdminClearAll({ startDate, endDate, label, title = 'Clear all rosters' }) {
    if (blockIfReadOnly('Clear rosters')) return;
    if ((startDate && !endDate) || (!startDate && endDate)) {
      alert('Please set both a start and end date to delete a window.');
      return;
    }
    const hasWindow = Boolean(startDate && endDate);
    const windowLabel = hasWindow
      ? `Date window: ${label || `${startDate} ‚Üí ${endDate}`}\n\n`
      : 'Date window: ALL DATES\n\n';
    const confirmed = await openProtectedAction({
      title,
      message: `Type DELETE and enter initials to clear all rosters.\n\n${windowLabel}`,
      impactSummary: 'This wipes every uploaded roster across all locations.',
      requireDelete: true,
      requireInitials: true,
      requirePin: true,
      requireConfirmCheckbox: true
    });
    if (!confirmed.ok) return;

    try {
      const resp = await api('/api/clear-roster-all', {
        method: 'POST',
        body: JSON.stringify({
          start_date: startDate || null,
          end_date: endDate || null,
          initials: confirmed.initials,
          pin: confirmed.pin
        })
      });

      if (resp.ok) {
        const rangeNote = resp.start_date && resp.end_date
          ? `Date window: ${resp.start_date} ‚Üí ${resp.end_date}\n\n`
          : '';
        alert(`‚úÖ All Rosters Cleared!\n\n${rangeNote}Deleted ${resp.deleted_count} total swimmers.\n\nBackup saved to: ${resp.backup_file || 'N/A'}`);
        await loadBlocks();
        await loadRoster();
      }
    } catch (e) {
      alert(`‚ùå Clear Failed\n\n${e.message}`);
    }
  }

  const adminClearWindowBtn = el('adminClearWindow');
  if (adminClearWindowBtn) {
    adminClearWindowBtn.addEventListener('click', async () => {
      const startDate = el('adminClearAllStartDate')?.value || '';
      const endDate = el('adminClearAllEndDate')?.value || '';
      if (!startDate || !endDate) {
        alert('Please set both a start and end date to clear a window.');
        return;
      }
      await runAdminClearAll({
        startDate,
        endDate,
        label: `${startDate} ‚Üí ${endDate}`
      });
    });
  }

  el('adminNavClearAllRosters')?.addEventListener('click', async () => {
    await runAdminClearAll({ startDate: null, endDate: null, label: 'ALL DATES' });
  });

  el('masterRosterResetBtn')?.addEventListener('click', async () => {
    await runAdminClearAll({ startDate: null, endDate: null, label: 'ALL DATES', title: 'MASTER ROSTER RESET' });
  });

  async function handleReadOnlyToggle() {
    const confirmed = await openProtectedAction({
      title: 'Toggle read-only mode',
      message: 'Enter initials to toggle read-only mode for this device.',
      requireDelete: false,
      requireInitials: true
    });
    if (!confirmed.ok) return;
    try {
      const resp = await api('/api/read-only', {
        method: 'POST',
        body: JSON.stringify({ read_only: !readOnlyMode, initials: confirmed.initials })
      });
      readOnlyMode = !!resp.read_only;
      applyReadOnlyUI();
    } catch (e) {
      alert(`Failed to toggle read-only mode: ${e.message}`);
    }
  }

  el('toggleReadOnlyBtn').addEventListener('click', handleReadOnlyToggle);
  el('toggleReadOnlyBtnManager').addEventListener('click', handleReadOnlyToggle);

  el('activityLogRefresh').addEventListener('click', () => {
    loadActivityLog();
  });

  el('settingsBtn').addEventListener('click', () => {
    syncDeviceUI();
    showModal('settingsModal', true);
  });
  el('settingsClose').addEventListener('click', () => showModal('settingsModal', false));
  el('settingsModal').addEventListener('click', (e) => { if(e.target === el('settingsModal')) showModal('settingsModal', false); });

  el('settingsSave').addEventListener('click', () => {
    deviceMode = el('deviceModeSelect').value;
    localStorage.setItem('deviceMode', deviceMode);
    syncDeviceUI();
    showModal('settingsModal', false);
    loadRoster();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (el('previewDrawer')?.classList.contains('open')) {
        closePreviewDrawer();
      }
      if (el('globalSearchModal')?.style.display === 'flex') {
        showModal('globalSearchModal', false);
      }
      return;
    }
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) return;
    if (!(e.ctrlKey || e.metaKey)) return;
    if (e.key.toLowerCase() === 'b') {
      e.preventDefault();
      toggleManagerSidebar(!managerSidebarCollapsed);
    }
    if (e.key.toLowerCase() === 'k') {
      e.preventDefault();
      openGlobalSearch();
    }
    if (e.key.toLowerCase() === 'e') {
      e.preventDefault();
      openExportModal({
        title: 'Export bundles',
        onExport: (scope) => exportBundles(scope)
      });
    }
    if (e.key === '1') {
      e.preventDefault();
      setManagerSection('client');
    }
    if (e.key === '2') {
      e.preventDefault();
      setManagerSection('billing');
    }
  });

  el('importBtn').addEventListener('click', async () => {
    if (blockIfReadOnly('Roster import')) return;
    try{
      el('importBtn').disabled = true;
      await api('/api/import-today', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      await loadStatus();
      await loadBlocks();
    }catch(e){
      alert(e.message);
    }finally{
      el('importBtn').disabled = false;
    }
  });

  document.querySelectorAll('.reportUploadBtn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const reportType = btn.dataset.reportType;
      const input = document.querySelector(`.reportFileInput[data-report-type="${reportType}"]`);
      if (input) input.click();
    });
  });

  document.querySelectorAll('.reportFileInput').forEach((input) => {
    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reportType = input.dataset.reportType;
      await uploadManagerReport(reportType, file);
      input.value = '';
    });
  });

  // HTML Upload handlers
  el('uploadHtmlBtn').addEventListener('click', () => {
    if (blockIfReadOnly('HTML upload')) return;
    el('htmlFileInput').click();
  });

  el('htmlFileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      if (blockIfReadOnly('HTML upload')) return;
      el('uploadHtmlBtn').disabled = true;
      el('uploadHtmlBtn').textContent = 'Uploading...';

      const previewForm = new FormData();
      previewForm.append('html', file);
      previewForm.append('location_id', currentLocation?.id || 1);
      const previewResp = await fetch(apiUrl('/api/upload-html/preview'), {
        method: 'POST',
        body: previewForm
      });
      const previewData = await previewResp.json().catch(() => ({}));
      if (!previewResp.ok || previewData.ok === false) {
        throw new Error(previewData.error || 'Preview failed');
      }
      const summary = previewData.summary || {};
      const confirmUpload = await openProtectedAction({
        title: 'Confirm roster upload',
        message: `Location: ${summary.location || 'Unknown'}\nDate range: ${summary.date_start || '‚Äî'} ‚Üí ${summary.date_end || '‚Äî'}\nSwimmers detected: ${summary.count ?? '‚Äî'}`,
        requireDelete: false,
        requireInitials: false
      });
      if (!confirmUpload.ok) return;

      // Use FormData for clean file upload without credential issues
      const formData = new FormData();
      formData.append('html', file);
      formData.append('location_id', currentLocation?.id || 1);

      const response = await fetch(apiUrl('/api/upload-html'), {
        method: 'POST',
        body: formData
        // No headers, no credentials - browser handles multipart automatically
      });

      const result = await response.json().catch(() => ({}));

      if (!response.ok) {
        throw new Error(result.error || `Upload failed: ${response.statusText}`);
      }

      if (result.ok) {
        alert(`Success! Imported ${result.count} swimmers`);
        await loadStatus();
        await loadBlocks();
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (e) {
      alert(`Upload failed: ${e.message}`);
      console.error('Upload error details:', e);
    } finally {
      el('uploadHtmlBtn').disabled = false;
      el('uploadHtmlBtn').textContent = 'Upload HTML';
      el('htmlFileInput').value = '';
    }
  });

  el('exportServerBtn').addEventListener('click', async () => {
    if (blockIfReadOnly('Export')) return;
    try {
      el('exportServerBtn').disabled = true;
      const date = el('rosterDate').value || activeDateISO;
      const resp = await api('/api/export-server', {
        method: 'POST',
        body: JSON.stringify({
          location_id: currentLocation?.id || 1,
          date
        })
      });
      alert(`‚úÖ Exported ${resp.count} swimmers to server.\n\nFile: ${resp.filename}`);
    } catch (err) {
      alert('Export failed: ' + (err.message || err));
    } finally {
      el('exportServerBtn').disabled = false;
    }
  });

  el('importServerBtn').addEventListener('click', async () => {
    if (blockIfReadOnly('Import')) return;
    await loadServerExports();
    showModal('serverImportModal', true);
  });

  el('setDateBtn').addEventListener('click', async () => {
    const d = el('rosterDate').value;
    if (!d) return;
    try{
      await api('/api/set-active-date', { method:'POST', body: JSON.stringify({date:d}) });
      await loadStatus();
      await loadBlocks();
      await loadRoster();
      updateDeckDateWarning();
      toast('Roster date updated');
    }catch(err){
      alert('Set date failed: ' + (err.message || err));
    }
  });

  el('sortBy').addEventListener('change', () => loadRoster());

  el('bulkMarkPresent').addEventListener('click', async () => {
    if (!currentBlock) {
      alert('Select a time block first.');
      return;
    }
    if (blockIfReadOnly('Bulk attendance')) return;
    const confirmed = await openProtectedAction({
      title: 'Mark all present',
      message: 'Type DELETE and enter initials to mark all swimmers present for this block.',
      requireDelete: true,
      requireInitials: true,
      impactSummary: `This will mark every swimmer as Here for ${fmtTime(currentBlock)}.`,
      requireConfirmCheckbox: true
    });
    if (!confirmed.ok) return;
    await api('/api/attendance/bulk', {
      method: 'POST',
      body: JSON.stringify({
        start_time: currentBlock,
        attendance: 1,
        location_id: currentLocation?.id || 1,
        initials: confirmed.initials
      })
    });
    loadRoster();
  });

  el('bulkClearAttendance').addEventListener('click', async () => {
    if (!currentBlock) {
      alert('Select a time block first.');
      return;
    }
    if (blockIfReadOnly('Bulk attendance')) return;
    const confirmed = await openProtectedAction({
      title: 'Clear attendance',
      message: 'Type DELETE and enter initials to clear all attendance for this block.',
      requireDelete: true,
      requireInitials: true,
      impactSummary: `This will clear attendance for every swimmer in ${fmtTime(currentBlock)}.`,
      requireConfirmCheckbox: true
    });
    if (!confirmed.ok) return;
    await api('/api/attendance/bulk', {
      method: 'POST',
      body: JSON.stringify({
        start_time: currentBlock,
        attendance: null,
        location_id: currentLocation?.id || 1,
        initials: confirmed.initials
      })
    });
    loadRoster();
  });

  // Load instructors for dropdown
  async function loadInstructors() {
    try {
      const locId = currentLocation?.id || 1;
      const resp = await api(`/api/instructors?location_id=${locId}`);
      const select = el('addInstructor');

      // Clear existing options
      select.innerHTML = '';

      // Add blank option
      const blankOpt = document.createElement('option');
      blankOpt.value = '';
      blankOpt.textContent = '(select instructor)';
      select.appendChild(blankOpt);

      // Add instructor options
      (resp.instructors || []).forEach(instructor => {
        const opt = document.createElement('option');
        opt.value = instructor.displayName;
        opt.textContent = instructor.displayName;
        select.appendChild(opt);
      });

    } catch (e) {
      console.error('Failed to load instructors:', e);
      const select = el('addInstructor');
      select.innerHTML = '<option value="">(error loading instructors)</option>';
    }
  }

  // Add-on modal
  el('addSwimmerBtn').addEventListener('click', async () => {
    if (blockIfReadOnly('Add swimmer')) return;
    if(!currentBlock) return;
    el('addName').value = '';
    el('addAge').value = '';
    el('addInstructor').value = '';
    el('addZone').value = '';
    el('addProgram').value = 'GROUP: Beginner 1';
    el('addTime').value = fmtTime(currentBlock);

    // Load instructors for current location
    await loadInstructors();

    showModal('addModal', true);
  });
  el('addCancel').addEventListener('click', () => showModal('addModal', false));
  el('addModal').addEventListener('click', (e) => { if(e.target === el('addModal')) showModal('addModal', false); });

  el('addSave').addEventListener('click', async () => {
    if (blockIfReadOnly('Add swimmer')) return;
    try{
      const swimmer_name = el('addName').value.trim();
      if(!swimmer_name){
        alert('Swimmer name is required');
        return;
      }
      await api('/api/add-swimmer', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name,
          age_text: el('addAge').value.trim() || null,
          program: el('addProgram').value,
          instructor_name: el('addInstructor').value.trim() || null,
          zone: el('addZone').value || null,
          location_id: currentLocation?.id || 1,
          device_mode: deviceMode
        })
      });
      showModal('addModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Zone modal
  el('zoneCancel').addEventListener('click', () => showModal('zoneModal', false));
  el('zoneModal').addEventListener('click', (e) => { if(e.target === el('zoneModal')) showModal('zoneModal', false); });

  el('zoneSave').addEventListener('click', async () => {
    if(!zoneTarget) return;
    try{
      if (readOnlyMode) return;
      const payload = {
        start_time: currentBlock,
        swimmer_name: zoneTarget.swimmer_name,
        new_zone: el('zoneSelect').value,
        device_mode: deviceMode,
        manager_code: (deviceMode === 'deck') ? el('managerCode').value : undefined
      };
      await api('/api/update-zone', { method:'POST', body: JSON.stringify(payload) });
      showModal('zoneModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Announcements
  el('speakBtn').addEventListener('click', async () => {
    try{
      const text = el('customText').value.trim();
      await speakTyped(text);
    }catch(e){
      alert(e.message);
    }
  });

  el('clearBtn').addEventListener('click', () => { el('customText').value = ''; });

  el('repeatBtn').addEventListener('click', async () => {
    try{
      const resp = await api('/api/repeat-last', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('forceTimeBtn').addEventListener('click', async () => {
    try{
      if(!currentBlock){
        alert('Select a time block first');
        return;
      }
      const resp = await api('/api/force-time-announcement', {
        method:'POST',
        body: JSON.stringify({ start_time: currentBlock, device_mode: deviceMode })
      });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('presetFrontDeck').addEventListener('click', () => {
    el('customText').value = 'Front desk to deck';
  });
  el('presetCodeGreen').addEventListener('click', () => {
    el('customText').value = 'Code green';
  });
  el('presetCodeBrown').addEventListener('click', () => {
    el('customText').value = 'Code Brown';
  });

  // Search functionality
  el('rosterSearch').addEventListener('input', (e) => {
    searchFilter = e.target.value;

    // Show/hide clear button
    const clearBtn = el('searchClear');
    if (searchFilter.trim()) {
      clearBtn.classList.remove('hidden');
    } else {
      clearBtn.classList.add('hidden');
    }

    // Reload roster with filter
    if (currentBlock) {
      loadRoster();
    }
  });

  el('searchClear').addEventListener('click', () => {
    searchFilter = '';
    el('rosterSearch').value = '';
    el('searchClear').classList.add('hidden');

    // Reload roster without filter
    if (currentBlock) {
      loadRoster();
    }
  });

  // Boot
  (async function init(){
    try{
      syncDeviceUI();
      const mgrExpiry = sessionStorage.getItem('manager_pin_expiry');
      if (mgrExpiry && Date.now() < parseInt(mgrExpiry)) {
        managerRole = sessionStorage.getItem('manager_role') || 'manager';
      }
      applyRoleUI();
      el('buildStamp').textContent = new Date().toLocaleString();
      await loadLocations();
      await loadReadOnlyMode();
      await loadStatus();
      await loadBlocks();
    }catch(e){
      setStatus(e.message || 'Failed to load', 'warn');
    }finally{
      // Start clock update (runs independently of announcements)
      startCountdown();
    }
  })();
</script>
</body>
</html>
