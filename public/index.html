bash -lc cat > /mnt/data/index.html <<'HTML'
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SwimLabs Announcer</title>
  <style>
    :root{
      --bg:#070b14;
      --cardA:rgba(255,255,255,.06);
      --cardB:rgba(255,255,255,.03);
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --btn:#1f2a44;
      --btn2:#2a3a63;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(255,255,255,.06);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:18px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, #0e1b3a 0%, var(--bg) 55%) fixed;
      color:var(--text);
    }
    .wrap{ max-width: 1250px; margin: 0 auto; }
    .topbar{ display:flex; align-items:flex-end; gap:12px; flex-wrap:wrap; padding-bottom: 4px; }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:14px; }
    .tiny{ font-size:12px; }
    .right{ margin-left:auto; }
    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin-top:14px;
      box-shadow: 0 12px 34px rgba(0,0,0,.30);
      backdrop-filter: blur(8px);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .spacer{ flex:1; }

    .tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    button{
      border:1px solid var(--line);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    button:hover{ filter: brightness(1.08); }
    button:active{ transform: translateY(1px); }
    button.primary{ border-color: rgba(34,197,94,.45); }
    button.secondary{ border-color: rgba(245,158,11,.35); }
    button.danger{ border-color: rgba(239,68,68,.35); }

    button.tab{ padding:9px 12px; border-radius:999px; background: transparent; border-color: transparent; }
    button.tab.active{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.14);
      outline: 2px solid rgba(255,255,255,.10);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      padding:7px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      line-height: 1.2;
      white-space: nowrap;
    }
    .pill strong{ color: var(--text); font-weight:900; }
    .ok{ color: var(--good); font-weight:900; }
    .warn{ color: var(--warn); font-weight:900; }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 520px 1fr; } }

    .blocks{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .blocks button{ min-width: 120px; }
    .blocks button.active{
      outline:2px solid rgba(255,255,255,.18);
      border-color: rgba(255,255,255,.28);
      filter: brightness(1.10);
    }

    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size:14px;
      line-height: 1.4;
    }

    /* readable black inputs + dropdowns */
    select, input[type="text"], input[type="password"]{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: #000;
      color: #fff;
      font-weight:900;
      outline: none;
      cursor:pointer;
    }
    input[type="text"], input[type="password"]{
      cursor:text;
      font-weight:800;
    }
    select option{
      background:#000;
      color:#fff;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:10px;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    thead th{
      position: sticky;
      top: 0;
      background: rgba(10, 16, 34, .92);
      backdrop-filter: blur(8px);
      z-index: 5;
      border-bottom: 1px solid var(--line2);
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align: top;
      font-size:14px;
    }
    th{ color:var(--muted); font-weight:900; font-size:12px; text-transform: uppercase; letter-spacing: .5px; }
    tbody tr:hover{ background: rgba(255,255,255,.035); }

    .zone{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.04);
      font-size:13px;
      font-weight:900;
      white-space: nowrap;
      cursor: pointer;
      user-select:none;
    }
    .zone.locked{ cursor: not-allowed; opacity:.85; }

    .hidden{ display:none; }

    .level{ font-weight:900; color: rgba(232,238,252,.95); line-height: 1.2; }
    .nowrap{ white-space: nowrap; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      margin-left:8px;
      vertical-align: middle;
    }
    .badge.addon{ border-color: rgba(245,158,11,.40); }
    .badge.over{ border-color: rgba(34,197,94,.35); }

    /* Attendance buttons */
    .attWrap{ display:flex; gap:6px; align-items:center; }
    .attBtn{
      padding:7px 9px;
      border-radius:12px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .attBtn.here.active{ border-color: rgba(34,197,94,.5); background: rgba(34,197,94,.12); }
    .attBtn.absent.active{ border-color: rgba(239,68,68,.5); background: rgba(239,68,68,.12); }
    .attBtn.clear.active{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.08); }

    /* Flags */
    .flags{ display:flex; gap:8px; margin-top:6px; align-items:center; flex-wrap:wrap; }
    .flag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:26px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      font-size:16px;
      opacity:.35;
      transition: filter .12s ease, opacity .12s ease, transform .05s ease;
    }
    .flag:hover{ filter: brightness(1.15); }
    .flag:active{ transform: translateY(1px); }
    .flag.on{ opacity:1; border-color: rgba(255,255,255,.22); background: rgba(255,255,255,.08); }
    .flagHelp{ font-size:12px; color: rgba(159,176,208,.9); margin-left:8px; }

    /* Modal */
    .modalBackdrop{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, rgba(20,26,50,.92), rgba(10,12,24,.92));
      border:1px solid var(--line2);
      border-radius:18px;
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .modal h3{ margin:4px 0 10px; font-size:16px; }
    .modal .grid2{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media(min-width: 640px){ .modal .grid2{ grid-template-columns: 1fr 1fr; } }
    .field label{
      display:block;
      font-size:12px;
      color: var(--muted);
      font-weight:900;
      margin-bottom:6px;
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .field .hint{
      margin-top:6px;
      font-size:12px;
      color: rgba(159,176,208,.85);
      line-height:1.35;
    }
    .modalFooter{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1>SwimLabs Announcer</h1>
      <div class="muted" id="status">Loading‚Ä¶</div>
    </div>

    <div class="right row">
      <div class="tabs">
        <button class="tab active" id="tabRoster">Roster</button>
        <button class="tab" id="tabAnnouncements">Announcements</button>
      </div>
      <span class="pill">Device: <strong id="deviceModeLabel">Deck</strong></span>
      <button id="settingsBtn" title="Settings">‚öôÔ∏è</button>
      <span class="pill">Last: <strong id="lastAt">None</strong></span>
    </div>
  </div>

  <div id="panelRoster">
    <div class="card">
      <div class="row">
        <button class="primary" id="importBtn">Import Today</button>
        <button class="secondary" id="exportBtn">Export CSV</button>
        <div class="spacer"></div>
        <span class="pill tiny">Auto announcement runs about 3 minutes before each time block.</span>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Time Blocks <span id="blockHint" class="muted"></span></div>
        <div class="spacer"></div>
        <div class="pill">Selected: <strong id="selectedBlock">None</strong></div>
      </div>
      <div class="blocks" id="blocks"></div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill">Roster <span id="rosterMeta" class="muted"></span></div>
        <div class="spacer"></div>
        <button class="secondary" id="addSwimmerBtn">+ Add swimmer</button>
        <span class="pill">Sort</span>
        <select id="sortBy">
          <option value="instructor" selected>Instructor + A-Z</option>
          <option value="name">Swimmer A-Z</option>
        </select>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px;">Attendance</th>
            <th>Swimmer</th>
            <th style="width:110px;">Age</th>
            <th style="width:150px;">Type</th>
            <th style="width:170px;">Level</th>
            <th style="width:170px;">Instructor</th>
            <th style="width:140px;">Zone</th>
            <th style="width:170px;">Action</th>
          </tr>
        </thead>
        <tbody id="roster"></tbody>
      </table>

      <div class="tiny" style="margin-top:10px; color: rgba(159,176,208,.92); line-height:1.4;">
        Flags: ‚≠ê First time, üìã Makeup, üìù Missing waiver, üí≤ Unpaid, üÖ£ Trial. Click to toggle.
      </div>
    </div>
  </div>

  <div id="panelAnnouncements" class="hidden">
    <div class="grid">
      <div class="card">
        <div class="row" style="margin-bottom:10px;">
          <button class="secondary" id="repeatBtn">Repeat last</button>
          <button class="secondary" id="forceTimeBtn">Force time-block</button>
        </div>

        <textarea id="customText" placeholder="Type an announcement here, then click Speak."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="speakBtn">Speak typed message</button>
          <button class="danger" id="clearBtn">Clear</button>
        </div>

        <div class="card" style="margin-top:12px; background: rgba(255,255,255,.03);">
          <div class="pill" style="margin-bottom:8px;">Last announcement</div>
          <div id="lastText" class="tiny" style="line-height:1.45; color: rgba(232,238,252,.92);">None</div>
        </div>
      </div>

      <div class="card">
        <div class="pill" style="margin-bottom:10px;">Quick presets</div>
        <div class="row">
          <button class="secondary" id="presetFrontDeck">Front desk to deck</button>
          <button class="secondary" id="presetCodeGreen">Code Green</button>
          <button class="secondary" id="presetCodeBrown">Code Brown</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modalBackdrop" id="settingsModal">
  <div class="modal">
    <h3>Device settings</h3>
    <div class="field">
      <label>Set device mode</label>
      <select id="deviceModeSelect">
        <option value="deck">Deck (tablet)</option>
        <option value="frontdesk">Front Desk (computer)</option>
      </select>
      <div class="hint">Deck requires manager approval to change zones.</div>
    </div>
    <div class="modalFooter">
      <button class="secondary" id="settingsClose">Close</button>
      <button class="primary" id="settingsSave">Save</button>
    </div>
  </div>
</div>

<!-- Add Swimmer Modal -->
<div class="modalBackdrop" id="addModal">
  <div class="modal">
    <h3>Add swimmer (Add-on)</h3>

    <div class="grid2">
      <div class="field">
        <label>Swimmer name</label>
        <input type="text" id="addName" placeholder="First Last" />
      </div>

      <div class="field">
        <label>Age (optional)</label>
        <input type="text" id="addAge" placeholder="Example: 6y 2m" />
      </div>

      <div class="field">
        <label>Class type</label>
        <select id="addProgram">
          <option value="GROUP: Beginner 1">GROUP: Beginner 1</option>
          <option value="GROUP: Beginner 2">GROUP: Beginner 2</option>
          <option value="GROUP: Beginner 3">GROUP: Beginner 3</option>
          <option value="GROUP: Beginner 4">GROUP: Beginner 4</option>
          <option value="GROUP: Intermediate 1">GROUP: Intermediate 1</option>
          <option value="GROUP: Intermediate 2">GROUP: Intermediate 2</option>
          <option value="GROUP: Intermediate 3">GROUP: Intermediate 3</option>
          <option value="GROUP: Advanced 1">GROUP: Advanced 1</option>
          <option value="GROUP: Advanced 2">GROUP: Advanced 2</option>
          <option value="Private">Private</option>
          <option value="Semi-Private">Semi-Private</option>
          <option value="ParentTot">ParentTot</option>
          <option value="Toddler Transition">Toddler Transition</option>
          <option value="Adult">Adult</option>
        </select>
      </div>

      <div class="field">
        <label>Instructor (optional)</label>
        <input type="text" id="addInstructor" placeholder="Example: Nova H" />
      </div>

      <div class="field">
        <label>Zone (optional)</label>
        <select id="addZone">
          <option value="">(leave blank)</option>
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field">
        <label>Time block</label>
        <input type="text" id="addTime" disabled />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="addCancel">Cancel</button>
      <button class="primary" id="addSave">Add swimmer</button>
    </div>
  </div>
</div>

<!-- Zone Override Modal -->
<div class="modalBackdrop" id="zoneModal">
  <div class="modal">
    <h3>Change zone</h3>

    <div class="row">
      <span class="pill">Swimmer: <strong id="zoneWho">‚Äî</strong></span>
      <div class="spacer"></div>
      <span class="pill">Mode: <strong id="zoneMode">Deck</strong></span>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div class="field">
        <label>New zone</label>
        <select id="zoneSelect">
          <option value="1">Zone 1</option>
          <option value="2">Zone 2</option>
          <option value="3">Zone 3</option>
          <option value="4">Zone 4</option>
        </select>
      </div>

      <div class="field" id="managerCodeField">
        <label>Manager code (required on Deck)</label>
        <input type="password" id="managerCode" placeholder="Enter code" />
      </div>
    </div>

    <div class="modalFooter">
      <button class="secondary" id="zoneCancel">Cancel</button>
      <button class="primary" id="zoneSave">Save zone</button>
    </div>
  </div>
</div>

<script>
  let currentBlock = null;
  let zoneTarget = null;
  let deviceMode = localStorage.getItem('deviceMode') || 'deck';

  const el = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  function fmtTime(time24){
    if(!time24) return '‚Äî';
    const parts = String(time24).split(':');
    const hh = parseInt(parts[0], 10);
    const mm = parseInt(parts[1] || '0', 10);
    const ampm = hh >= 12 ? 'PM' : 'AM';
    const h12 = ((hh + 11) % 12) + 1;
    if(mm === 0) return `${h12} ${ampm}`;
    return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
  }

  function parseTypeLevel(program){
    const p = String(program || '').trim();
    if(!p) return { type: '‚Äî', level: '‚Äî' };
    const up = p.toUpperCase();
    if(up.startsWith('GROUP:')){
      const level = p.split(':').slice(1).join(':').trim();
      return { type: 'Group', level: level || '‚Äî' };
    }
    // Non-group
    return { type: p, level: '‚Äî' };
  }

  async function api(path, opts={}){
    const res = await fetch(path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    const data = await res.json().catch(() => ({}));
    if(!res.ok || data.ok === false){
      const msg = data.error || `Request failed: ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function setStatus(text, kind){
    const s = el('status');
    s.textContent = text;
    s.classList.remove('ok','warn');
    if(kind) s.classList.add(kind);
  }

  function showModal(id, on=true){
    el(id).style.display = on ? 'flex' : 'none';
  }

  function syncDeviceUI(){
    el('deviceModeLabel').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('deviceModeSelect').value = deviceMode;
    el('zoneMode').textContent = deviceMode === 'frontdesk' ? 'Front Desk' : 'Deck';
    el('managerCodeField').style.display = (deviceMode === 'deck') ? 'block' : 'none';
  }

  function setLastAnnouncementUI(last){
    const at = last?.at ? new Date(last.at) : null;
    el('lastAt').textContent = at ? at.toLocaleTimeString() : 'None';
    el('lastText').textContent = last?.text || 'None';
  }

  function setSelectedBlockUI(){
    el('selectedBlock').textContent = currentBlock ? fmtTime(currentBlock) : 'None';
    [...el('blocks').querySelectorAll('button')].forEach(b => {
      b.classList.toggle('active', b.dataset.time === currentBlock);
    });
    el('addSwimmerBtn').disabled = !currentBlock;
  }

  async function loadStatus(){
    const st = await api('/api/status');
    const fileMsg = st.fileExists ? `Roll sheet found (${Math.round((st.fileSizeBytes||0)/1024)} KB)` : `Missing roll sheet: ${st.expectedFilename}`;
    const ttsMsg = (st.piperBinExists && st.voiceModelExists) ? 'TTS ready' : 'TTS missing (piper/model)';
    const ok = st.fileExists && st.piperBinExists && st.voiceModelExists;
    setStatus(`${fileMsg} ‚Ä¢ ${ttsMsg}`, ok ? 'ok' : 'warn');
    setLastAnnouncementUI(st.lastAnnouncement);
    el('blockHint').textContent = `(Today: ${st.todayISO})`;
  }

  async function loadBlocks(){
    const b = await api('/api/blocks');
    const wrap = el('blocks');
    wrap.innerHTML = '';

    (b.blocks || []).forEach((t) => {
      const btn = document.createElement('button');
      btn.textContent = fmtTime(t);
      btn.dataset.time = t;
      btn.addEventListener('click', () => {
        currentBlock = t;
        setSelectedBlockUI();
        loadRoster();
      });
      wrap.appendChild(btn);
    });

    if(!currentBlock && (b.blocks || []).length){
      currentBlock = b.blocks[0];
    }

    setSelectedBlockUI();
    if(currentBlock) await loadRoster();
  }

  function sortKids(kids){
    const sortBy = el('sortBy').value;
    const key = (s) => String(s || '').toLowerCase();

    const arr = [...kids];
    arr.sort((a,b) => {
      if(sortBy === 'instructor'){
        const ia = key(a.instructor_name);
        const ib = key(b.instructor_name);
        if(ia !== ib) return ia.localeCompare(ib);
        return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
      }
      return key(a.swimmer_name).localeCompare(key(b.swimmer_name));
    });
    return arr;
  }

  function renderAttendance(kid){
    const w = document.createElement('div');
    w.className = 'attWrap';

    const mk = (label, cls, val) => {
      const b = document.createElement('div');
      b.className = `attBtn ${cls}`;
      b.textContent = label;
      b.classList.toggle('active', kid.attendance === val);
      b.addEventListener('click', async () => {
        try{
          // toggle behavior: clicking active sets to null
          const next = (kid.attendance === val) ? null : val;
          await api('/api/attendance', {
            method:'POST',
            body: JSON.stringify({
              start_time: currentBlock,
              swimmer_name: kid.swimmer_name,
              attendance: next,
              device_mode: deviceMode
            })
          });
          kid.attendance = next;
          loadRoster();
        }catch(e){
          alert(e.message);
        }
      });
      return b;
    };

    w.appendChild(mk('Here','here',1));
    w.appendChild(mk('Absent','absent',0));
    w.appendChild(mk('Clear','clear',null));
    return w;
  }

  function renderFlags(kid){
    const flags = {
      flag_new: !!kid.flag_new,
      flag_makeup: !!kid.flag_makeup,
      flag_policy: !!kid.flag_policy,
      flag_owes: !!kid.flag_owes,
      flag_trial: !!kid.flag_trial
    };

    const row = document.createElement('div');
    row.className = 'flags';

    const mk = (emoji, key, title) => {
      const f = document.createElement('div');
      f.className = 'flag' + (flags[key] ? ' on' : '');
      f.textContent = emoji;
      f.title = title;
      f.addEventListener('click', async () => {
        try{
          flags[key] = !flags[key];
          const resp = await api('/api/update-flags', {
            method:'POST',
            body: JSON.stringify({
              start_time: currentBlock,
              swimmer_name: kid.swimmer_name,
              device_mode: deviceMode,
              flags
            })
          });
          kid.flag_new = resp.flags.flag_new;
          kid.flag_makeup = resp.flags.flag_makeup;
          kid.flag_policy = resp.flags.flag_policy;
          kid.flag_owes = resp.flags.flag_owes;
          kid.flag_trial = resp.flags.flag_trial;
          loadRoster();
        }catch(e){
          alert(e.message);
        }
      });
      return f;
    };

    row.appendChild(mk('‚≠ê','flag_new','First time'));
    row.appendChild(mk('üìã','flag_makeup','Makeup'));
    row.appendChild(mk('üìù','flag_policy','Missing waiver / policy'));
    row.appendChild(mk('üí≤','flag_owes','Unpaid / owes money'));
    row.appendChild(mk('üÖ£','flag_trial','Trial'));

    return row;
  }

  function renderZoneChip(kid){
    const z = kid.zone ? `Zone ${kid.zone}` : '‚Äî';
    const chip = document.createElement('div');
    chip.className = 'zone' + (deviceMode === 'deck' ? ' locked' : '');
    chip.textContent = z;
    chip.title = (deviceMode === 'deck') ? 'Deck mode: requires manager code' : 'Click to change zone';
    chip.addEventListener('click', () => {
      zoneTarget = kid;
      el('zoneWho').textContent = kid.swimmer_name;
      el('zoneSelect').value = String(kid.zone || 1);
      el('managerCode').value = '';
      syncDeviceUI();
      showModal('zoneModal', true);
    });
    return chip;
  }

  async function loadRoster(){
    if(!currentBlock){
      el('roster').innerHTML = '';
      el('rosterMeta').textContent = '';
      return;
    }

    const data = await api(`/api/blocks/${encodeURIComponent(currentBlock)}`);
    const kids = sortKids(data.kids || []);
    el('rosterMeta').textContent = `(${kids.length} swimmers ‚Ä¢ ${fmtTime(currentBlock)})`;

    const tbody = el('roster');
    tbody.innerHTML = '';

    for(const kid of kids){
      const tr = document.createElement('tr');

      // Attendance
      const tdAtt = document.createElement('td');
      tdAtt.appendChild(renderAttendance(kid));
      tr.appendChild(tdAtt);

      // Swimmer (with badges + flags)
      const tdName = document.createElement('td');
      const nameLine = document.createElement('div');
      nameLine.className = 'level';
      nameLine.textContent = kid.swimmer_name || '‚Äî';

      if(kid.is_addon){
        const b = document.createElement('span');
        b.className = 'badge addon';
        b.textContent = 'ADD-ON';
        nameLine.appendChild(b);
      }

      if(kid.zone_overridden){
        const b = document.createElement('span');
        b.className = 'badge over';
        b.textContent = 'OVERRIDE';
        nameLine.appendChild(b);
      }

      tdName.appendChild(nameLine);
      tdName.appendChild(renderFlags(kid));
      tr.appendChild(tdName);

      // Age
      const tdAge = document.createElement('td');
      tdAge.className = 'nowrap';
      tdAge.textContent = kid.age_text || '‚Äî';
      tr.appendChild(tdAge);

      // Type / Level
      const tl = parseTypeLevel(kid.program);
      const tdType = document.createElement('td');
      tdType.textContent = tl.type;
      tr.appendChild(tdType);

      const tdLevel = document.createElement('td');
      tdLevel.textContent = tl.level;
      tr.appendChild(tdLevel);

      // Instructor
      const tdInst = document.createElement('td');
      tdInst.textContent = kid.instructor_name || '‚Äî';
      tr.appendChild(tdInst);

      // Zone
      const tdZone = document.createElement('td');
      tdZone.appendChild(renderZoneChip(kid));
      tr.appendChild(tdZone);

      // Action
      const tdAction = document.createElement('td');

      const callBtn = document.createElement('button');
      callBtn.className = 'secondary';
      callBtn.textContent = 'Call parent';
      callBtn.addEventListener('click', async () => {
        try{
          await api('/api/call-parent', {
            method:'POST',
            body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
          });
        }catch(e){
          alert(e.message);
        }
      });
      tdAction.appendChild(callBtn);

      if(kid.is_addon){
        const rm = document.createElement('button');
        rm.className = 'danger';
        rm.style.marginLeft = '8px';
        rm.textContent = 'Remove';
        rm.addEventListener('click', async () => {
          if(!confirm(`Remove add-on swimmer: ${kid.swimmer_name}?`)) return;
          try{
            await api('/api/remove-addon', {
              method:'POST',
              body: JSON.stringify({ start_time: currentBlock, swimmer_name: kid.swimmer_name, device_mode: deviceMode })
            });
            loadRoster();
          }catch(e){
            alert(e.message);
          }
        });
        tdAction.appendChild(rm);
      }

      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  }

  // ---- Announcements ----
  async function speakTyped(text){
    const resp = await api('/api/speak', { method:'POST', body: JSON.stringify({ text, device_mode: deviceMode }) });
    setLastAnnouncementUI(resp.lastAnnouncement);
  }

  // ---- Wire up UI ----
  el('tabRoster').addEventListener('click', () => {
    el('tabRoster').classList.add('active');
    el('tabAnnouncements').classList.remove('active');
    el('panelRoster').classList.remove('hidden');
    el('panelAnnouncements').classList.add('hidden');
  });

  el('tabAnnouncements').addEventListener('click', () => {
    el('tabAnnouncements').classList.add('active');
    el('tabRoster').classList.remove('active');
    el('panelRoster').classList.add('hidden');
    el('panelAnnouncements').classList.remove('hidden');
  });

  el('settingsBtn').addEventListener('click', () => {
    syncDeviceUI();
    showModal('settingsModal', true);
  });
  el('settingsClose').addEventListener('click', () => showModal('settingsModal', false));
  el('settingsModal').addEventListener('click', (e) => { if(e.target === el('settingsModal')) showModal('settingsModal', false); });

  el('settingsSave').addEventListener('click', () => {
    deviceMode = el('deviceModeSelect').value;
    localStorage.setItem('deviceMode', deviceMode);
    syncDeviceUI();
    showModal('settingsModal', false);
    loadRoster();
  });

  el('importBtn').addEventListener('click', async () => {
    try{
      el('importBtn').disabled = true;
      await api('/api/import-today', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      await loadStatus();
      await loadBlocks();
    }catch(e){
      alert(e.message);
    }finally{
      el('importBtn').disabled = false;
    }
  });

  el('exportBtn').addEventListener('click', () => {
    window.location.href = '/api/export-attendance';
  });

  el('sortBy').addEventListener('change', () => loadRoster());

  // Add-on modal
  el('addSwimmerBtn').addEventListener('click', () => {
    if(!currentBlock) return;
    el('addName').value = '';
    el('addAge').value = '';
    el('addInstructor').value = '';
    el('addZone').value = '';
    el('addProgram').value = 'GROUP: Beginner 1';
    el('addTime').value = fmtTime(currentBlock);
    showModal('addModal', true);
  });
  el('addCancel').addEventListener('click', () => showModal('addModal', false));
  el('addModal').addEventListener('click', (e) => { if(e.target === el('addModal')) showModal('addModal', false); });

  el('addSave').addEventListener('click', async () => {
    try{
      const swimmer_name = el('addName').value.trim();
      if(!swimmer_name){
        alert('Swimmer name is required');
        return;
      }
      await api('/api/add-swimmer', {
        method:'POST',
        body: JSON.stringify({
          start_time: currentBlock,
          swimmer_name,
          age_text: el('addAge').value.trim() || null,
          program: el('addProgram').value,
          instructor_name: el('addInstructor').value.trim() || null,
          zone: el('addZone').value || null,
          device_mode: deviceMode
        })
      });
      showModal('addModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Zone modal
  el('zoneCancel').addEventListener('click', () => showModal('zoneModal', false));
  el('zoneModal').addEventListener('click', (e) => { if(e.target === el('zoneModal')) showModal('zoneModal', false); });

  el('zoneSave').addEventListener('click', async () => {
    if(!zoneTarget) return;
    try{
      const payload = {
        start_time: currentBlock,
        swimmer_name: zoneTarget.swimmer_name,
        new_zone: el('zoneSelect').value,
        device_mode: deviceMode,
        manager_code: (deviceMode === 'deck') ? el('managerCode').value : undefined
      };
      await api('/api/update-zone', { method:'POST', body: JSON.stringify(payload) });
      showModal('zoneModal', false);
      loadRoster();
    }catch(e){
      alert(e.message);
    }
  });

  // Announcements
  el('speakBtn').addEventListener('click', async () => {
    try{
      const text = el('customText').value.trim();
      await speakTyped(text);
    }catch(e){
      alert(e.message);
    }
  });

  el('clearBtn').addEventListener('click', () => { el('customText').value = ''; });

  el('repeatBtn').addEventListener('click', async () => {
    try{
      const resp = await api('/api/repeat-last', { method:'POST', body: JSON.stringify({ device_mode: deviceMode }) });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('forceTimeBtn').addEventListener('click', async () => {
    try{
      if(!currentBlock){
        alert('Select a time block first');
        return;
      }
      const resp = await api('/api/force-time-announcement', {
        method:'POST',
        body: JSON.stringify({ start_time: currentBlock, device_mode: deviceMode })
      });
      setLastAnnouncementUI(resp.lastAnnouncement);
    }catch(e){
      alert(e.message);
    }
  });

  el('presetFrontDeck').addEventListener('click', () => {
    el('customText').value = 'Front desk to deck. Please call the next swimmer.';
  });
  el('presetCodeGreen').addEventListener('click', () => {
    el('customText').value = 'Code Green. Please clear the pool area and wait for instructions.';
  });
  el('presetCodeBrown').addEventListener('click', () => {
    el('customText').value = 'Code Brown. Please clear the pool area immediately.';
  });

  // Boot
  (async function init(){
    try{
      syncDeviceUI();
      await loadStatus();
      await loadBlocks();
    }catch(e){
      setStatus(e.message || 'Failed to load', 'warn');
    }
  })();
</script>
</body>
</html>
HTML

